{
  "properties": {
    "connectionReferences": {
      "shared_visualstudioteamservices": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "cat_sharedvisualstudioteamservices_0080c"
        },
        "api": {
          "name": "shared_visualstudioteamservices"
        }
      },
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "cat_sharedcommondataserviceforapps_3bba0"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        }
      },
      "triggers": {
        "When_an_action_is_performed": {
          "metadata": {
            "operationMetadataId": "29153f94-dbab-4b69-a754-af030f114a9e"
          },
          "type": "OpenApiConnectionWebhook",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "BusinessEventsTrigger",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "catalog": "commoncatalog",
              "category": "powerplatformpipelines",
              "subscriptionRequest/entityname": "none",
              "subscriptionRequest/sdkmessagename": "OnDeploymentCompleted"
            },
            "authentication": "@parameters('$authentication')"
          }
        }
      },
      "actions": {
        "Initialize_Deployment_Profile_ID_=_Empty": {
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "565f9d89-beb7-4042-9ec9-285ac033d2b8"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Deployment Profile ID",
                "type": "string"
              }
            ]
          }
        },
        "Try": {
          "actions": {
            "List_pipelines": {
              "runAfter": {
                "Check_if_Working_Branch_Exists": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "d575ddac-8524-439c-b711-ac23f3138294"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_visualstudioteamservices",
                  "operationId": "ListPipelines",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_visualstudioteamservices"
                },
                "parameters": {
                  "account": "@outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']",
                  "project": "@outputs('Retrieve_the_Profile')?['body/cat_azdoproject']"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Send_an_HTTP_request_to_Azure_DevOps": {
              "runAfter": {
                "Check_if_any_results_for_the_Deployment_Pipeline_in_Folder": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c6514da8-ca1a-45bf-a242-04fbfe488d59"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_visualstudioteamservices",
                  "operationId": "HttpRequest",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_visualstudioteamservices"
                },
                "parameters": {
                  "account": "cattools",
                  "parameters/Method": "POST",
                  "parameters/Uri": "https://dev.azure.com/@{outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']}/@{outputs('Retrieve_the_Profile')?['body/cat_azdoproject']}/_apis/pipelines/@{variables('DeploymentPipelineId')}/runs?api-version=6.0-preview.1",
                  "parameters/Body": "{\n    \"resources\": {\n        \"repositories\": {\n            \"self\": {\n                \"refName\": \"refs/heads/@{variables('PipelineBranch')}\"\n            }\n        }\n    },\n    \"templateParameters\": {\n        \"PipelineDeploymentStage\": \"PostDeployment\"\n      }\n}"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Check_if_Deployment_Solution_Profile_Exists": {
              "actions": {
                "Set_Deployment_Profile_ID_from_Current_Profile_Solution_Profiles": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "3f983e54-cc58-42d9-bad1-16af5e8f1f8d"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Deployment Profile ID",
                    "value": "@{first(body('Retrieve_Current_Profile_for_Solution_from_Solution_Profiles')?['value'])?['_cat_deploymentprofileid_value']}"
                  }
                }
              },
              "runAfter": {
                "Retrieve_Current_Profile_for_Solution_from_Solution_Profiles": [
                  "Succeeded"
                ]
              },
              "else": {
                "actions": {
                  "Retrieve_Current_Profile_for_Solution_from_Requests": {
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "6db7cca8-6745-42bc-8b89-5d1d495481b3"
                    },
                    "type": "OpenApiConnection",
                    "inputs": {
                      "host": {
                        "connectionName": "shared_commondataserviceforapps",
                        "operationId": "ListRecords",
                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                      },
                      "parameters": {
                        "entityName": "cat_deploymentrequests",
                        "$select": "cat_DeploymentProfileId",
                        "fetchXml": "<fetch top=\"1\">\n  <entity name=\"cat_deploymentrequest\">\n    <attribute name=\"cat_deploymentstepid\" />\n    <attribute name=\"cat_deploymentprofileid\" />\n    <attribute name=\"cat_requesttype\" />\n    <attribute name=\"cat_solutionname\" />\n    <filter type=\"and\">\n      <condition attribute=\"cat_requesttype\" operator=\"eq\" value=\"809060004\" />\n      <filter type=\"or\">\n          <condition attribute=\"cat_solutionname\" operator=\"eq\" value=\"@{triggerOutputs()?['body/OutputParameters/ArtifactName']}\" />\n          <condition attribute=\"cat_solutionname\" operator=\"eq\" value=\"@{triggerOutputs()?['body/OutputParameters/ArtifactName']}-@{outputs('Get_Development_Environment')?['body/environmentid']}\" />\n      </filter>\n    </filter>\n    <order attribute=\"createdon\" descending=\"true\" />\n  </entity>\n</fetch>",
                        "$top": 1
                      },
                      "authentication": "@parameters('$authentication')"
                    }
                  },
                  "Check_if_Deployment_Request_Profile_Exists": {
                    "actions": {
                      "Set_Deployment_Profile_ID_from_Current_Profile_Request": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "ba866994-dfb8-4e4e-96d9-fd84d907a9b1"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Deployment Profile ID",
                          "value": "@{first(body('Retrieve_Current_Profile_for_Solution_from_Requests')?['value'])?['_cat_deploymentprofileid_value']}"
                        }
                      }
                    },
                    "runAfter": {
                      "Retrieve_Current_Profile_for_Solution_from_Requests": [
                        "Succeeded"
                      ]
                    },
                    "else": {
                      "actions": {
                        "Retrieve_Default_Profile_for_Solution": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "6db7cca8-6745-42bc-8b89-5d1d495481b3"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "ListRecords",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "cat_deploymentprofiles",
                              "$select": "cat_deploymentprofileid",
                              "fetchXml": "<fetch top=\"1\">\n  <entity name=\"cat_deploymentprofile\">\n    <attribute name=\"cat_deploymentprofileid\" />\n    <filter>\n      <condition attribute=\"cat_defaultdeploymentprofile\" operator=\"eq\" value=\"1\" />\n    </filter>\n  </entity>\n</fetch>",
                              "$top": 1
                            },
                            "authentication": "@parameters('$authentication')"
                          }
                        },
                        "Set_Deployment_Profile_ID_from_Default_Profile": {
                          "runAfter": {
                            "Retrieve_Default_Profile_for_Solution": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ba866994-dfb8-4e4e-96d9-fd84d907a9b1"
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Deployment Profile ID",
                            "value": "@{first(body('Retrieve_Default_Profile_for_Solution')?['value'])?['cat_deploymentprofileid']}"
                          }
                        }
                      }
                    },
                    "expression": {
                      "greater": [
                        "@length(outputs('Retrieve_Current_Profile_for_Solution_from_Requests')?['body/value'])",
                        0
                      ]
                    },
                    "metadata": {
                      "operationMetadataId": "87d262b8-e4bc-44f4-bbfc-187f2da31d3c"
                    },
                    "type": "If"
                  }
                }
              },
              "expression": {
                "greater": [
                  "@length(outputs('Retrieve_Current_Profile_for_Solution_from_Solution_Profiles')?['body/value'])",
                  0
                ]
              },
              "metadata": {
                "operationMetadataId": "c32d81e2-fbb3-4bb9-8172-c242a43f8fcf"
              },
              "type": "If"
            },
            "Retrieve_the_Deployment_Stage_Run": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f4a73cec-e272-4002-bd84-2543ea7bb7b9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "GetItem",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "deploymentstageruns",
                  "recordId": "@triggerOutputs()?['body/InputParameters/StageRunId']"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Retrieve_the_Deployment_Stage": {
              "runAfter": {
                "Retrieve_the_Deployment_Stage_Run": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "cbd3ca43-3e28-4b8d-aada-d181ef4820ab"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "GetItem",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "deploymentstages",
                  "recordId": "@outputs('Retrieve_the_Deployment_Stage_Run')?['body/_deploymentstageid_value']",
                  "$select": "name,_deploymentpipelineid_value"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Retrieve_the_Profile": {
              "runAfter": {
                "Get_the_User's_Email_Who_Requested_the_Deployment": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "5e29fd7e-d0ed-431d-878e-dbbd962e7d5a"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "GetItem",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "cat_deploymentprofiles",
                  "recordId": "@variables('Deployment Profile ID')",
                  "$select": "cat_deploymentprofileid, cat_azdoorganization, cat_azdoproject, cat_repository, cat_repositoryid"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Get_Development_Environment": {
              "runAfter": {
                "Retrieve_the_Deployment_Stage": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "8f5baaae-c583-461b-b5d5-2b9788e59cca"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "GetItem",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "deploymentenvironments",
                  "recordId": "@outputs('Retrieve_the_Deployment_Stage_Run')?['body/_devdeploymentenvironment_value']"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Find_the_Deployment_Pipeline_in_Folder": {
              "runAfter": {
                "List_pipelines": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c5ce978c-988b-4c2d-b729-2c6dbe63c397"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_pipelines')?['body/value']",
                "where": "@and(equals(item()?['name'], concat('deploy-', toLower(outputs('Retrieve_the_Deployment_Stage')?['body/name']), '-', triggerOutputs()?['body/OutputParameters/ArtifactName'])), equals(item()?['folder'], concat('\\', outputs('Retrieve_the_Profile')?['body/cat_repository'], ' - ', triggerOutputs()?['body/OutputParameters/ArtifactName'])))"
              }
            },
            "Find_the_working_branch_if_it_exists": {
              "runAfter": {
                "Set_Pipeline_Branch_to_Working_Branch": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "eeb1f958-d4c4-468b-8c6f-3540b7d90452"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_visualstudioteamservices",
                  "operationId": "HttpRequest",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_visualstudioteamservices"
                },
                "parameters": {
                  "account": "@outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']",
                  "parameters/Method": "GET",
                  "parameters/Uri": "https://dev.azure.com/@{outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']}/@{outputs('Retrieve_the_Profile')?['body/cat_azdoproject']}/_apis/git/repositories/@{outputs('Retrieve_the_Profile')?['body/cat_repositoryid']}/refs?filter=heads/@{variables('PipelineBranch')}&api-version=7.0"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Get_the_User's_Email_Who_Requested_the_Deployment": {
              "runAfter": {
                "Check_if_Deployment_Solution_Profile_Exists": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "ea5cb0f8-8abc-466b-9b29-67245f1bd61b"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "GetItem",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "systemusers",
                  "recordId": "@outputs('Retrieve_the_Deployment_Stage_Run')?['body/_createdby_value']",
                  "$select": "internalemailaddress"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Parse_Working_Branch_Results": {
              "runAfter": {
                "Find_the_working_branch_if_it_exists": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "8f8c2e75-8382-482b-b35f-5e91ed6d4aa6"
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@body('Find_the_working_branch_if_it_exists')",
                "schema": {
                  "type": "object",
                  "properties": {
                    "value": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "name": {
                            "type": "string"
                          },
                          "objectId": {
                            "type": "string"
                          },
                          "creator": {
                            "type": "object",
                            "properties": {
                              "displayName": {
                                "type": "string"
                              },
                              "url": {
                                "type": "string"
                              },
                              "_links": {
                                "type": "object",
                                "properties": {
                                  "avatar": {
                                    "type": "object",
                                    "properties": {
                                      "href": {
                                        "type": "string"
                                      }
                                    }
                                  }
                                }
                              },
                              "id": {
                                "type": "string"
                              },
                              "uniqueName": {
                                "type": "string"
                              },
                              "imageUrl": {
                                "type": "string"
                              },
                              "descriptor": {
                                "type": "string"
                              }
                            }
                          },
                          "url": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "name",
                          "objectId",
                          "creator",
                          "url"
                        ]
                      }
                    },
                    "count": {
                      "type": "integer"
                    }
                  }
                }
              }
            },
            "Check_if_Working_Branch_Exists": {
              "actions": {},
              "runAfter": {
                "Parse_Working_Branch_Results": [
                  "Succeeded"
                ]
              },
              "else": {
                "actions": {
                  "Parse_Solution_Branch_Results": {
                    "runAfter": {
                      "Find_the_solution_branch_if_it_exists": [
                        "Succeeded"
                      ]
                    },
                    "metadata": {
                      "operationMetadataId": "d454ab97-eb93-4f61-87b8-6633adfe6b68"
                    },
                    "type": "ParseJson",
                    "inputs": {
                      "content": "@body('Find_the_solution_branch_if_it_exists')",
                      "schema": {
                        "type": "object",
                        "properties": {
                          "value": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string"
                                },
                                "objectId": {
                                  "type": "string"
                                },
                                "creator": {
                                  "type": "object",
                                  "properties": {
                                    "displayName": {
                                      "type": "string"
                                    },
                                    "url": {
                                      "type": "string"
                                    },
                                    "_links": {
                                      "type": "object",
                                      "properties": {
                                        "avatar": {
                                          "type": "object",
                                          "properties": {
                                            "href": {
                                              "type": "string"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "id": {
                                      "type": "string"
                                    },
                                    "uniqueName": {
                                      "type": "string"
                                    },
                                    "imageUrl": {
                                      "type": "string"
                                    },
                                    "descriptor": {
                                      "type": "string"
                                    }
                                  }
                                },
                                "url": {
                                  "type": "string"
                                }
                              },
                              "required": [
                                "name",
                                "objectId",
                                "creator",
                                "url"
                              ]
                            }
                          },
                          "count": {
                            "type": "integer"
                          }
                        }
                      }
                    }
                  },
                  "Check_if_Solution_Branch_Exists": {
                    "actions": {},
                    "runAfter": {
                      "Parse_Solution_Branch_Results": [
                        "Succeeded"
                      ]
                    },
                    "else": {
                      "actions": {
                        "Retrieve_the_Solution_Repository": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "223ecfeb-60d7-42dc-b2bd-513753486dd1"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_visualstudioteamservices",
                              "operationId": "HttpRequest",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_visualstudioteamservices"
                            },
                            "parameters": {
                              "account": "@outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']",
                              "parameters/Method": "GET",
                              "parameters/Uri": "https://dev.azure.com/@{outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']}/@{outputs('Retrieve_the_Profile')?['body/cat_azdoproject']}/_apis/git/repositories/@{outputs('Retrieve_the_Profile')?['body/cat_repositoryid']}?api-version=4.1"
                            },
                            "authentication": "@parameters('$authentication')"
                          }
                        },
                        "Parse_the_Solution_Repository_Response": {
                          "runAfter": {
                            "Retrieve_the_Solution_Repository": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "cd2b2e04-75d8-4aa9-94b2-aefa47ee541a"
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('Retrieve_the_Solution_Repository')",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                },
                                "url": {
                                  "type": "string"
                                },
                                "project": {
                                  "type": "object",
                                  "properties": {
                                    "id": {
                                      "type": "string"
                                    },
                                    "name": {
                                      "type": "string"
                                    },
                                    "url": {
                                      "type": "string"
                                    },
                                    "state": {
                                      "type": "string"
                                    },
                                    "revision": {
                                      "type": "integer"
                                    },
                                    "visibility": {
                                      "type": "string"
                                    },
                                    "lastUpdateTime": {
                                      "type": "string"
                                    }
                                  }
                                },
                                "defaultBranch": {
                                  "type": "string"
                                },
                                "size": {
                                  "type": "integer"
                                },
                                "remoteUrl": {
                                  "type": "string"
                                },
                                "sshUrl": {
                                  "type": "string"
                                },
                                "webUrl": {
                                  "type": "string"
                                },
                                "_links": {
                                  "type": "object",
                                  "properties": {
                                    "self": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "project": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "web": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "ssh": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "commits": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "refs": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "pullRequests": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "pushes": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        }
                                      }
                                    }
                                  }
                                },
                                "isDisabled": {
                                  "type": "boolean"
                                },
                                "isInMaintenance": {
                                  "type": "boolean"
                                }
                              }
                            }
                          }
                        },
                        "Set_Default_Repo_Branch_from_Response": {
                          "runAfter": {
                            "Parse_the_Solution_Repository_Response": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "b8227edd-2d88-4d7f-bfde-cb628fbb2dc4"
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "PipelineBranch",
                            "value": "@{replace(body('Parse_the_Solution_Repository_Response')?['defaultBranch'], 'refs/heads/','')}"
                          }
                        }
                      }
                    },
                    "expression": {
                      "greater": [
                        "@body('Parse_Solution_Branch_Results')?['count']",
                        0
                      ]
                    },
                    "metadata": {
                      "operationMetadataId": "4e9576f3-920e-4752-9a4c-bf07729d2bba"
                    },
                    "type": "If"
                  },
                  "Set_Pipeline_Branch_to_Solution_Branch": {
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "3bf69c7a-9dc3-4068-b49e-0683adfc866b"
                    },
                    "type": "SetVariable",
                    "inputs": {
                      "name": "PipelineBranch",
                      "value": "@triggerOutputs()?['body/OutputParameters/ArtifactName']"
                    }
                  },
                  "Find_the_solution_branch_if_it_exists": {
                    "runAfter": {
                      "Set_Pipeline_Branch_to_Solution_Branch": [
                        "Succeeded"
                      ]
                    },
                    "metadata": {
                      "operationMetadataId": "aa7259fa-e48e-446b-9c5d-205bb6a3b0b5"
                    },
                    "type": "OpenApiConnection",
                    "inputs": {
                      "host": {
                        "connectionName": "shared_visualstudioteamservices",
                        "operationId": "HttpRequest",
                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_visualstudioteamservices"
                      },
                      "parameters": {
                        "account": "@outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']",
                        "parameters/Method": "GET",
                        "parameters/Uri": "https://dev.azure.com/@{outputs('Retrieve_the_Profile')?['body/cat_azdoorganization']}/@{outputs('Retrieve_the_Profile')?['body/cat_azdoproject']}/_apis/git/repositories/@{outputs('Retrieve_the_Profile')?['body/cat_repositoryid']}/refs?filter=heads/@{variables('PipelineBranch')}&api-version=7.0"
                      },
                      "authentication": "@parameters('$authentication')"
                    }
                  }
                }
              },
              "expression": {
                "greater": [
                  "@body('Parse_Working_Branch_Results')?['count']",
                  0
                ]
              },
              "metadata": {
                "operationMetadataId": "0e850a7e-527f-440b-8623-eb85bee6ae59"
              },
              "type": "If"
            },
            "Set_Pipeline_Branch_to_Working_Branch": {
              "runAfter": {
                "Retrieve_the_Profile": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "1d0ef9f8-1b85-4aa2-8986-b391e158c033"
              },
              "type": "SetVariable",
              "inputs": {
                "name": "PipelineBranch",
                "value": "@{outputs('Get_the_User''s_Email_Who_Requested_the_Deployment')?['body/internalemailaddress']}-@{triggerOutputs()?['body/OutputParameters/ArtifactName']}"
              }
            },
            "Retrieve_Current_Profile_for_Solution_from_Solution_Profiles": {
              "runAfter": {
                "Get_Development_Environment": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "e3318dbf-dea9-4ba0-aa5d-43568ca6e2c8"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "cat_deploymentsolutionprofiles",
                  "$select": "cat_DeploymentProfileId",
                  "fetchXml": "<fetch top=\"1\">\n  <entity name=\"cat_deploymentsolutionprofile\">\n    <attribute name=\"cat_deploymentprofileid\" />\n    <filter type=\"and\">\n          <condition attribute=\"cat_solutionname\" operator=\"eq\" value=\"@{triggerOutputs()?['body/OutputParameters/ArtifactName']}\" />\n          <condition attribute=\"cat_makerenvironmentid\" operator=\"eq\" value=\"@{outputs('Get_Development_Environment')?['body/environmentid']}\" />\n    </filter>\n    <order attribute=\"createdon\" descending=\"true\" />\n  </entity>\n</fetch>"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Check_if_any_results_for_the_Deployment_Pipeline_in_Folder": {
              "actions": {
                "Set_the_Deployment_Pipeline_Id_in_Folder": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "8e5d44a4-5570-4e50-8148-7ebe1141bed2"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "DeploymentPipelineId",
                    "value": "@{first(body('Find_the_Deployment_Pipeline_in_Folder'))?['id']}"
                  }
                }
              },
              "runAfter": {
                "Find_the_Deployment_Pipeline_in_Folder": [
                  "Succeeded"
                ]
              },
              "else": {
                "actions": {
                  "Find_the_Deployment_Pipeline_by_Name": {
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "c5ce978c-988b-4c2d-b729-2c6dbe63c397"
                    },
                    "type": "Query",
                    "inputs": {
                      "from": "@outputs('List_pipelines')?['body/value']",
                      "where": "@equals(item()?['name'], concat('deploy-', toLower(outputs('Retrieve_the_Deployment_Stage')?['body/name']), '-', triggerOutputs()?['body/OutputParameters/ArtifactName']))"
                    }
                  },
                  "Set_the_Deployment_Pipeline_Id_by_Name": {
                    "runAfter": {
                      "Find_the_Deployment_Pipeline_by_Name": [
                        "Succeeded"
                      ]
                    },
                    "metadata": {
                      "operationMetadataId": "58e23d8e-a729-40fa-92aa-85489d827db4"
                    },
                    "type": "SetVariable",
                    "inputs": {
                      "name": "DeploymentPipelineId",
                      "value": "@{first(body('Find_the_Deployment_Pipeline_by_Name'))?['id']}"
                    }
                  }
                }
              },
              "expression": {
                "greater": [
                  "@length(body('Find_the_Deployment_Pipeline_in_Folder'))",
                  0
                ]
              },
              "metadata": {
                "operationMetadataId": "98580a8c-bf36-4387-b854-a78b32e816d3"
              },
              "type": "If"
            }
          },
          "runAfter": {
            "Initialize_Deployment_Pipeline_Id": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "94629852-db90-48be-bcb3-617029c6c2b1"
          },
          "type": "Scope"
        },
        "Initialize_Pipeline_Branch_=_main": {
          "runAfter": {
            "Initialize_Deployment_Profile_ID_=_Empty": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "342fbd60-b8e6-49f7-bce7-b46b58db8bf5"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "PipelineBranch",
                "type": "string",
                "value": "main"
              }
            ]
          }
        },
        "Initialize_Deployment_Pipeline_Id": {
          "runAfter": {
            "Initialize_Pipeline_Branch_=_main": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "aa1a155c-781a-4fd7-a613-fe5beb146f70"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "DeploymentPipelineId",
                "type": "string"
              }
            ]
          }
        }
      }
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}