{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps_1": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Compliance_due_to_heavy_usage": {
          "actions": {
            "Apply_to_each_envt": {
              "actions": {
                "Ignore_Default_if_using_old_env_var_technique": {
                  "actions": {
                    "no-op_-_asked_to_ignore_Default": {
                      "inputs": "No-op. Ignore default if 'Exclude Default environment from Compliance Request flows' is true",
                      "metadata": {
                        "operationMetadataId": "b0ff52ec-15c3-47f2-8136-eea0e50b9f73"
                      },
                      "runAfter": {},
                      "type": "Compose"
                    }
                  },
                  "else": {
                    "actions": {
                      "Send_Compliance_Request_email_for_Apps": {
                        "actions": {
                          "Apply_to_each_envt_App": {
                            "actions": {
                              "Condition:_Audit_apps_that_are_broadly_shared_or_admin_has_requested_audit": {
                                "actions": {
                                  "Check_if_any_of_the_requirements_are_not_yet_complete": {
                                    "actions": {
                                      "Get_Row_-_Send_Audit_Mail_to_Owner_-_Apps": {
                                        "actions": {
                                          "Get_a_row_by_ID": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps_1",
                                                "operationId": "GetItem"
                                              },
                                              "parameters": {
                                                "$select": "admin_body, admin_cc, admin_replyto, admin_sendonbehalf, admin_subject",
                                                "entityName": "admin_customizedemails",
                                                "recordId": "@variables('emailGUID')"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "c34df6f5-d327-47a2-8e25-e33c207762e2"
                                            },
                                            "runAfter": {
                                              "Set_emailGUID_to_localized_row": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "OpenApiConnection"
                                          },
                                          "List_emails_for_preferred_language": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps_1",
                                                "operationId": "ListRecords"
                                              },
                                              "parameters": {
                                                "$filter": "admin_basedon eq '@{outputs('emailGUID_to_en-US')}' and admin_language eq '@{outputs('Run_a_Child_Flow')?['Body']?['userpreferredlanguage']}'",
                                                "$select": "admin_customizedemailid",
                                                "entityName": "admin_customizedemails"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "29188a43-3a3a-46da-a4f6-f162180d8254"
                                            },
                                            "runAfter": {
                                              "emailGUID_to_en-US": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "OpenApiConnection"
                                          },
                                          "Set_emailGUID_to_localized_row": {
                                            "description": "if(greater(length(outputs('List_emails_for_preferred_language')?['body/value']),0), first(body('List_emails_for_preferred_language')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US'))",
                                            "inputs": {
                                              "name": "emailGUID",
                                              "value": "@{if(greater(length(outputs('List_emails_for_preferred_language')?['body/value']),0), first(body('List_emails_for_preferred_language')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US'))}"
                                            },
                                            "metadata": {
                                              "operationMetadataId": "4c1f823f-63a0-4d98-b489-df53e0e934b7"
                                            },
                                            "runAfter": {
                                              "List_emails_for_preferred_language": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "SetVariable"
                                          },
                                          "emailGUID_to_en-US": {
                                            "inputs": "b5bb8e1c-8741-ec11-8c62-00224829bf00",
                                            "metadata": {
                                              "operationMetadataId": "d19afed8-4f91-4914-9cb7-fe89e74e1a6c"
                                            },
                                            "runAfter": {},
                                            "type": "Compose"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "74c8fe2a-d9bd-4ab1-a2a7-1ceffc6c9c18"
                                        },
                                        "runAfter": {
                                          "Update_apps_Risk_Assessment_State_to_Requested": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "Scope"
                                      },
                                      "If_BPF_not_already_started_for_this_app,_start_it": {
                                        "actions": {
                                          "Start_App_Audit_BPF": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps",
                                                "operationId": "CreateRecord"
                                              },
                                              "parameters": {
                                                "entityName": "new_bpf_ffa183a676d64ec9aee6a558129651a2s",
                                                "item/activestagestartedon": "@utcNow()",
                                                "item/bpf_admin_appid@odata.bind": "admin_apps(@{items('Apply_to_each_envt_App')?['admin_appid']})",
                                                "item/bpf_name": "Audit for @{items('Apply_to_each_envt_App')?['admin_displayname']}"
                                              },
                                              "retryPolicy": {
                                                "count": 10,
                                                "interval": "PT10S",
                                                "type": "exponential"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "ac86b0d9-2e77-430a-b3ba-a481ef2b84ca"
                                            },
                                            "runAfter": {},
                                            "type": "OpenApiConnection"
                                          }
                                        },
                                        "expression": {
                                          "equals": [
                                            "@length(outputs('List_BPFs_for_this_App')?['body/value'])",
                                            0
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "5ef038f2-c89f-4a80-a15e-d97a488087ab"
                                        },
                                        "runAfter": {
                                          "List_BPFs_for_this_App": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "If"
                                      },
                                      "List_BPFs_for_this_App": {
                                        "inputs": {
                                          "authentication": "@parameters('$authentication')",
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "connectionName": "shared_commondataserviceforapps_1",
                                            "operationId": "ListRecords"
                                          },
                                          "parameters": {
                                            "$filter": "_bpf_admin_appid_value eq '@{items('Apply_to_each_envt_App')?['admin_appid']}'",
                                            "$select": "businessprocessflowinstanceid",
                                            "entityName": "new_bpf_ffa183a676d64ec9aee6a558129651a2s"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "38657fe9-1fb8-406b-931b-61995e23c97d"
                                        },
                                        "runAfter": {},
                                        "type": "OpenApiConnection"
                                      },
                                      "Send_Audit_Mail_to_Admin_Apps": {
                                        "description": "b5bb8e1c-8741-ec11-8c62-00224829bf00",
                                        "inputs": {
                                          "body": {
                                            "email": "@parameters('Admin eMail')",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID')?['body/admin_replyto'])",
                                            "text": "@{outputs('Get_a_row_by_ID')?['body/admin_subject']} - REASSIGNED TO ADMIN",
                                            "text_1": "REASSIGNED TO ADMIN <br>\n@{outputs('Get_a_row_by_ID')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?appName=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>App Details:</u></b>\n<p><b>Display Name:</b>  @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>  @{items('Apply_to_each_envt_App')?['admin_appenvironmentdisplayname']}</p>\n"
                                          },
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        },
                                        "runAfter": {
                                          "Send_Audit_Mail_to_Owner_Apps": [
                                            "Failed"
                                          ]
                                        },
                                        "type": "Workflow"
                                      },
                                      "Send_Audit_Mail_to_Owner_Apps": {
                                        "description": "b5bb8e1c-8741-ec11-8c62-00224829bf00",
                                        "inputs": {
                                          "body": {
                                            "email": "@variables('varAssignee')",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID')?['body/admin_replyto'])",
                                            "text": "@outputs('Get_a_row_by_ID')?['body/admin_subject']",
                                            "text_1": "@{outputs('Get_a_row_by_ID')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?appName=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>App Details:</u></b>\n<p><b>Display Name:</b>  @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>  @{items('Apply_to_each_envt_App')?['admin_appenvironmentdisplayname']}</p>\n"
                                          },
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        },
                                        "runAfter": {
                                          "Get_Row_-_Send_Audit_Mail_to_Owner_-_Apps": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "Workflow"
                                      },
                                      "Update_apps_Risk_Assessment_State_to_Requested": {
                                        "inputs": {
                                          "authentication": "@parameters('$authentication')",
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "connectionName": "shared_commondataserviceforapps_1",
                                            "operationId": "UpdateRecord"
                                          },
                                          "parameters": {
                                            "entityName": "admin_apps",
                                            "item/admin_adminrequirementriskassessmentstate": 597910001,
                                            "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']"
                                          },
                                          "retryPolicy": {
                                            "count": 10,
                                            "interval": "PT10S",
                                            "type": "exponential"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "9d8bfece-6bfe-4f86-b62f-c6a74c2b0c0d"
                                        },
                                        "runAfter": {
                                          "If_BPF_not_already_started_for_this_app,_start_it": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "OpenApiConnection"
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "If_not_already_submitted_or_complete,_mark_as_submitted": {
                                          "actions": {
                                            "Update_apps_Risk_Assessment_State_to_Submitted": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps_1",
                                                  "operationId": "UpdateRecord"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_apps",
                                                  "item/admin_adminrequirementriskassessmentstate": 597910002,
                                                  "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']"
                                                },
                                                "retryPolicy": {
                                                  "count": 10,
                                                  "interval": "PT10S",
                                                  "type": "exponential"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "12c35ea5-cec4-40f8-905c-5df209828f2e"
                                              },
                                              "runAfter": {},
                                              "type": "OpenApiConnection"
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                                    597910003
                                                  ]
                                                }
                                              },
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                                    597910002
                                                  ]
                                                }
                                              }
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "cceeb40e-9ace-47e5-9bab-58f2e2e2ba9c"
                                          },
                                          "runAfter": {},
                                          "type": "If"
                                        },
                                        "If_not_recently_published,_send_for_testing_and_republish": {
                                          "actions": {
                                            "Get_a_row_by_ID_2": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps_1",
                                                  "operationId": "GetItem"
                                                },
                                                "parameters": {
                                                  "$select": "admin_body, admin_cc, admin_replyto, admin_sendonbehalf, admin_subject",
                                                  "entityName": "admin_customizedemails",
                                                  "recordId": "@variables('emailGUID')"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "c34df6f5-d327-47a2-8e25-e33c207762e2"
                                              },
                                              "runAfter": {
                                                "Set_emailGUID_to_localized_row_2": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "OpenApiConnection"
                                            },
                                            "List_emails_for_preferred_language_2": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps_1",
                                                  "operationId": "ListRecords"
                                                },
                                                "parameters": {
                                                  "$filter": "admin_basedon eq '@{outputs('emailGUID_to_en-US_2')}' and admin_language eq '@{outputs('Run_a_Child_Flow')?['Body']?['userpreferredlanguage']}'",
                                                  "$select": "admin_customizedemailid",
                                                  "entityName": "admin_customizedemails"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "29188a43-3a3a-46da-a4f6-f162180d8254"
                                              },
                                              "runAfter": {
                                                "emailGUID_to_en-US_2": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "OpenApiConnection"
                                            },
                                            "Send_Republish_Mail_to_Admin_Apps": {
                                              "description": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                              "inputs": {
                                                "body": {
                                                  "email": "@variables('varAssignee')",
                                                  "email_1": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_cc'])",
                                                  "email_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'])",
                                                  "email_3": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_replyto'])",
                                                  "text": "@{outputs('Get_a_row_by_ID_2')?['body/admin_subject']}- REASSIGNED TO ADMIN",
                                                  "text_1": "REASSIGNED TO ADMIN <br>\n@{outputs('Get_a_row_by_ID_2')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?appName=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>App Details</u></b>\n<p><b>Display Name:</b> @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>@{items('Apply_to_each_envt_App')?['admin_appenvironmentdisplayname']}</p>\n"
                                                },
                                                "host": {
                                                  "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                              },
                                              "runAfter": {
                                                "Send_Republish_Mail_to_Owner_Apps": [
                                                  "Failed"
                                                ]
                                              },
                                              "type": "Workflow"
                                            },
                                            "Send_Republish_Mail_to_Owner_Apps": {
                                              "description": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                              "inputs": {
                                                "body": {
                                                  "email": "@variables('varAssignee')",
                                                  "email_1": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_cc'])",
                                                  "email_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'])",
                                                  "email_3": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_replyto'])",
                                                  "text": "@outputs('Get_a_row_by_ID_2')?['body/admin_subject']",
                                                  "text_1": "@{outputs('Get_a_row_by_ID_2')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?appName=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>App Details</u></b>\n<p><b>Display Name:</b> @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>@{items('Apply_to_each_envt_App')?['admin_appenvironmentdisplayname']}</p>\n"
                                                },
                                                "host": {
                                                  "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                              },
                                              "runAfter": {
                                                "Get_a_row_by_ID_2": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "Workflow"
                                            },
                                            "Set_emailGUID_to_localized_row_2": {
                                              "description": "if(greater(length(outputs('List_emails_for_preferred_language_2')?['body/value']), 0), first(body('List_emails_for_preferred_language_2')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_2'))",
                                              "inputs": {
                                                "name": "emailGUID",
                                                "value": "@{if(greater(length(outputs('List_emails_for_preferred_language_2')?['body/value']), 0), first(body('List_emails_for_preferred_language_2')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_2'))}"
                                              },
                                              "metadata": {
                                                "operationMetadataId": "4c1f823f-63a0-4d98-b489-df53e0e934b7"
                                              },
                                              "runAfter": {
                                                "List_emails_for_preferred_language_2": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "SetVariable"
                                            },
                                            "Update_apps_Republish_State_to_Requested": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps_1",
                                                  "operationId": "UpdateRecord"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_apps",
                                                  "item/admin_adminrequirementrepublishstate": 597910001,
                                                  "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']"
                                                },
                                                "retryPolicy": {
                                                  "count": 10,
                                                  "interval": "PT10S",
                                                  "type": "exponential"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "146d1792-766a-45fb-9afb-18181a269be7"
                                              },
                                              "runAfter": {},
                                              "type": "OpenApiConnection"
                                            },
                                            "emailGUID_to_en-US_2": {
                                              "inputs": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                              "metadata": {
                                                "operationMetadataId": "d19afed8-4f91-4914-9cb7-fe89e74e1a6c"
                                              },
                                              "runAfter": {
                                                "Update_apps_Republish_State_to_Requested": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "Compose"
                                            }
                                          },
                                          "else": {
                                            "actions": {
                                              "Update_apps_Republish_State_to_Complete": {
                                                "inputs": {
                                                  "authentication": "@parameters('$authentication')",
                                                  "host": {
                                                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                    "connectionName": "shared_commondataserviceforapps_1",
                                                    "operationId": "UpdateRecord"
                                                  },
                                                  "parameters": {
                                                    "entityName": "admin_apps",
                                                    "item/admin_adminrequirementrepublishstate": 597910003,
                                                    "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']"
                                                  }
                                                },
                                                "metadata": {
                                                  "operationMetadataId": "10ecfecb-fcc7-46c4-9359-66c812b658ba"
                                                },
                                                "runAfter": {},
                                                "type": "OpenApiConnection"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "or": [
                                              {
                                                "equals": [
                                                  "@items('Apply_to_each_envt_App')?['admin_apppublished']",
                                                  "@null"
                                                ]
                                              },
                                              {
                                                "less": [
                                                  "@addDays(items('Apply_to_each_envt_App')?['admin_apppublished'], variables('NumberDaysSincePublished'))",
                                                  "@utcNow()"
                                                ]
                                              }
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "38054c5d-652b-44aa-ae97-58a44371520c"
                                          },
                                          "runAfter": {
                                            "If_not_already_submitted_or_complete,_mark_as_submitted": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "If"
                                        }
                                      }
                                    },
                                    "expression": {
                                      "or": [
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_appdescription']\r\n",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_requirement_1']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_requirement_2']\r\n",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_requirement_3']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_requirement_4']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_envt_App')?['admin_requirement_5']",
                                              "@true"
                                            ]
                                          }
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_requirement_6']",
                                            "@null"
                                          ]
                                        }
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "2713395c-57a1-4b74-968b-d512fc3db214"
                                    },
                                    "runAfter": {},
                                    "type": "If"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "No-op,_not_broadly_used_or_shared": {
                                      "inputs": "No-op, not broadly used or shared",
                                      "metadata": {
                                        "operationMetadataId": "b2c59efa-852b-4eb8-abd4-a23ba1f409e2"
                                      },
                                      "runAfter": {},
                                      "type": "Compose"
                                    }
                                  }
                                },
                                "expression": {
                                  "or": [
                                    {
                                      "greaterOrEquals": [
                                        "@add(0, coalesce(items('Apply_to_each_envt_App')?['admin_appsharedusers'], 0))",
                                        "@variables('NumberUsersShared')"
                                      ]
                                    },
                                    {
                                      "greaterOrEquals": [
                                        "@add(0, coalesce(items('Apply_to_each_envt_App')?['admin_appsharedgroups'], 0))",
                                        "@variables('NumberGroupsShared')"
                                      ]
                                    },
                                    {
                                      "greaterOrEquals": [
                                        "@outputs('This_apps_launches_this_month')",
                                        "@variables('NumberLaunchesLast30Days')"
                                      ]
                                    },
                                    {
                                      "not": {
                                        "equals": [
                                          "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                          597910000
                                        ]
                                      }
                                    }
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "16330166-15bd-4af0-bad0-6c50901a3d20"
                                },
                                "runAfter": {
                                  "Get_Session_Count_last_30_days": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "If"
                              },
                              "Get_Assignee_apps": {
                                "actions": {
                                  "Set_Assignee_to_Admin": {
                                    "inputs": {
                                      "name": "varAssignee",
                                      "value": "@parameters('Admin eMail')"
                                    },
                                    "metadata": {
                                      "operationMetadataId": "d6778a8c-1d43-47a0-adac-4bf7de2c65a0"
                                    },
                                    "runAfter": {},
                                    "type": "SetVariable"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Run_a_Child_Flow": {
                                      "inputs": {
                                        "body": {
                                          "text": "@items('Apply_to_each_envt_App')?['_admin_appowner_value']",
                                          "text_1": "@items('Apply_to_each_envt_App')?['admin_appowner/admin_displayname']"
                                        },
                                        "host": {
                                          "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "89e3b046-4975-4c2d-a743-b2c00f942884"
                                      },
                                      "runAfter": {},
                                      "type": "Workflow"
                                    },
                                    "See_if_now_orphaned": {
                                      "actions": {
                                        "Set_variable_to_Approval_the_Admin": {
                                          "inputs": {
                                            "name": "varAssignee",
                                            "value": "@parameters('Admin eMail')"
                                          },
                                          "metadata": {
                                            "operationMetadataId": "f70a1e92-f284-4cda-beb6-8337a8c18758"
                                          },
                                          "runAfter": {},
                                          "type": "SetVariable"
                                        }
                                      },
                                      "else": {
                                        "actions": {
                                          "Set_Assignee_to_app_Owner": {
                                            "inputs": {
                                              "name": "varAssignee",
                                              "value": "@outputs('Run_a_Child_Flow')?['Body']?['useremail']"
                                            },
                                            "metadata": {
                                              "operationMetadataId": "578f6c6d-4084-492e-bc9e-e59e4e0eb47b"
                                            },
                                            "runAfter": {},
                                            "type": "SetVariable"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "equals": [
                                          "@outputs('Run_a_Child_Flow')?['Body']?['userisorphan']",
                                          "True"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "a76192c2-6ad7-4197-ba2c-5476cbeade19"
                                      },
                                      "runAfter": {
                                        "Run_a_Child_Flow": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "If"
                                    }
                                  }
                                },
                                "expression": {
                                  "or": [
                                    {
                                      "equals": [
                                        "@parameters('ProductionEnvironment')",
                                        "no"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_envt_App')?['cr5d5_appisorphaned']",
                                        "yes"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_envt_App')?['admin_appowner/admin_userisserviceprinciple']",
                                        "@true"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_envt_App')?['_admin_appowner_value']",
                                        "@null"
                                      ]
                                    }
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "cff7d5a1-9a8a-416c-a8d9-87d2714a2ee5"
                                },
                                "runAfter": {},
                                "type": "If"
                              },
                              "Get_Session_Count_last_30_days": {
                                "actions": {
                                  "List_launches_for_this_app_last_30_days": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps_1",
                                        "operationId": "ListRecords"
                                      },
                                      "parameters": {
                                        "$filter": "admin_appid eq '@{items('Apply_to_each_envt_App')?['admin_appid']}' and admin_creationtime gt @{addDays(utcNow(), -30)} and admin_operation eq 'LaunchPowerApp'",
                                        "$select": "admin_auditlogid",
                                        "entityName": "admin_auditlogs"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "0739d59d-0ab3-4d5d-89fb-a367558abf87"
                                    },
                                    "runAfter": {},
                                    "runtimeConfiguration": {
                                      "paginationPolicy": {
                                        "minimumItemCount": 100000
                                      }
                                    },
                                    "type": "OpenApiConnection"
                                  },
                                  "This_apps_launches_this_month": {
                                    "inputs": "@length(outputs('List_launches_for_this_app_last_30_days')?['body/value'])",
                                    "metadata": {
                                      "operationMetadataId": "e54d3ffb-bbd8-47d8-8c76-bf160980bba5"
                                    },
                                    "runAfter": {
                                      "List_launches_for_this_app_last_30_days": [
                                        "Succeeded"
                                      ]
                                    },
                                    "type": "Compose"
                                  }
                                },
                                "metadata": {
                                  "operationMetadataId": "4ed49aaa-5a8e-442f-b438-19a9cb48220e"
                                },
                                "runAfter": {
                                  "Get_Assignee_apps": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "Scope"
                              }
                            },
                            "foreach": "@outputs('List_this_envt_apps')?['body/value']",
                            "metadata": {
                              "operationMetadataId": "9d686fa6-3f70-4d3d-892b-3e8b6905adbc"
                            },
                            "runAfter": {
                              "List_this_envt_apps": [
                                "Succeeded"
                              ]
                            },
                            "type": "Foreach"
                          },
                          "List_this_envt_apps": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps_1",
                                "operationId": "ListRecords"
                              },
                              "parameters": {
                                "$expand": "admin_AppOwner($select=admin_userisserviceprinciple, admin_displayname)",
                                "$filter": "_admin_appowner_value ne null and admin_appdeleted ne true and admin_appownerdisplayname ne 'SYSTEM' and admin_appenvironmentid eq '@{items('Apply_to_each_envt')?['admin_environmentid']}'",
                                "$select": "admin_appdescription,admin_displayname,admin_apppublished,admin_appsharedgroups,admin_appsharedusers,admin_requirement_2,admin_requirement_1,admin_requirement_3,admin_requirement_4,admin_requirement_6,admin_makersubmittedrequirements,admin_requirement_5,cr5d5_appisorphaned,_admin_appowner_value, admin_appenvironmentdisplayname, admin_adminrequirementriskassessmentstate, admin_adminrequirementrepublishstate",
                                "entityName": "admin_apps"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "07d52006-6e63-4c00-b1e5-21bf1a6f4299"
                            },
                            "runAfter": {},
                            "runtimeConfiguration": {
                              "paginationPolicy": {
                                "minimumItemCount": 100000
                              }
                            },
                            "type": "OpenApiConnection"
                          }
                        },
                        "metadata": {
                          "operationMetadataId": "0feb9d43-1010-434d-a0e3-d4bb0dfdad3f"
                        },
                        "runAfter": {},
                        "type": "Scope"
                      },
                      "Send_Compliance_Request_email_for_Chatbots": {
                        "actions": {
                          "Apply_to_each_chatbot": {
                            "actions": {
                              "Condition:_Audit_chatbots_that_are_highly_used_or_admin_has_requested_audit": {
                                "actions": {
                                  "Check_if_any_of_the_requirements_are_not_yet_complete_-_bots": {
                                    "actions": {
                                      "Get_Row_-_Send_Audit_Mail_to_Owner_-_Bots": {
                                        "actions": {
                                          "Get_a_row_by_ID_3": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps_1",
                                                "operationId": "GetItem"
                                              },
                                              "parameters": {
                                                "$select": "admin_body, admin_cc, admin_replyto, admin_sendonbehalf, admin_subject",
                                                "entityName": "admin_customizedemails",
                                                "recordId": "@variables('emailGUID')"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "c34df6f5-d327-47a2-8e25-e33c207762e2"
                                            },
                                            "runAfter": {
                                              "Set_emailGUID_to_localized_row_3": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "OpenApiConnection"
                                          },
                                          "List_emails_for_preferred_language_3": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps_1",
                                                "operationId": "ListRecords"
                                              },
                                              "parameters": {
                                                "$filter": "admin_basedon eq '@{outputs('emailGUID_to_en-US_3')}' and admin_language eq '@{outputs('Recheck_Orphan_2')?['Body']?['userpreferredlanguage']}'",
                                                "$select": "admin_customizedemailid",
                                                "entityName": "admin_customizedemails"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "29188a43-3a3a-46da-a4f6-f162180d8254"
                                            },
                                            "runAfter": {
                                              "emailGUID_to_en-US_3": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "OpenApiConnection"
                                          },
                                          "Set_emailGUID_to_localized_row_3": {
                                            "description": "if(greater(length(outputs('List_emails_for_preferred_language_3')?['body/value']), 0), first(body('List_emails_for_preferred_language_3')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_3'))",
                                            "inputs": {
                                              "name": "emailGUID",
                                              "value": "@{if(greater(length(outputs('List_emails_for_preferred_language_3')?['body/value']), 0), first(body('List_emails_for_preferred_language_3')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_3'))}"
                                            },
                                            "metadata": {
                                              "operationMetadataId": "4c1f823f-63a0-4d98-b489-df53e0e934b7"
                                            },
                                            "runAfter": {
                                              "List_emails_for_preferred_language_3": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "SetVariable"
                                          },
                                          "emailGUID_to_en-US_3": {
                                            "inputs": "87853f93-cd41-ec11-8c62-00224829bf00",
                                            "metadata": {
                                              "operationMetadataId": "d19afed8-4f91-4914-9cb7-fe89e74e1a6c"
                                            },
                                            "runAfter": {},
                                            "type": "Compose"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "74c8fe2a-d9bd-4ab1-a2a7-1ceffc6c9c18"
                                        },
                                        "runAfter": {
                                          "Update_bot_Risk_Assessment_State_to_Requested": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "Scope"
                                      },
                                      "If_BPF_not_already_started_for_this_chatbot,_start_it": {
                                        "actions": {
                                          "Start_Chatbot_Approval_Business_Process_Flow": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps",
                                                "operationId": "CreateRecord"
                                              },
                                              "parameters": {
                                                "entityName": "new_chatbotapprovalbpfs",
                                                "item/activestagestartedon": "@utcNow()",
                                                "item/bpf_admin_pvaid@odata.bind": "admin_pvas(@{items('Apply_to_each_chatbot')?['admin_pvaid']})",
                                                "item/bpf_name": "Audit for @{items('Apply_to_each_chatbot')?['admin_pvadisplayname']}"
                                              }
                                            },
                                            "metadata": {
                                              "operationMetadataId": "0103b2ab-19ea-44ae-87d8-27c1308cbb4a"
                                            },
                                            "runAfter": {},
                                            "type": "OpenApiConnection"
                                          }
                                        },
                                        "expression": {
                                          "equals": [
                                            "@length(outputs('List_BPFs_for_this_Chatbot')?['body/value'])",
                                            0
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "e3dca296-c910-46c3-ad71-7874005c701f"
                                        },
                                        "runAfter": {
                                          "List_BPFs_for_this_Chatbot": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "If"
                                      },
                                      "List_BPFs_for_this_Chatbot": {
                                        "inputs": {
                                          "authentication": "@parameters('$authentication')",
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "connectionName": "shared_commondataserviceforapps_1",
                                            "operationId": "ListRecords"
                                          },
                                          "parameters": {
                                            "$filter": "_bpf_admin_pvaid_value eq '@{items('Apply_to_each_chatbot')?['admin_pvaid']}'",
                                            "$select": "businessprocessflowinstanceid",
                                            "entityName": "new_chatbotapprovalbpfs"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "7e033382-64c1-4d2c-8a01-af0b98b26058"
                                        },
                                        "runAfter": {},
                                        "type": "OpenApiConnection"
                                      },
                                      "Send_Audit_Mail_to_Admin_Bots": {
                                        "description": "87853f93-cd41-ec11-8c62-00224829bf00",
                                        "inputs": {
                                          "body": {
                                            "email": "@variables('varAssignee')",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_replyto'])",
                                            "text": "@{outputs('Get_a_row_by_ID_3')?['body/admin_subject']} -- REASSIGNED TO ADMIN",
                                            "text_1": "REASSIGNED TO ADMIN <br>\n@{outputs('Get_a_row_by_ID_3')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?chatbotName=@{items('Apply_to_each_chatbot')?['admin_pvaid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>Chatbot Details</u></b><br>\n<p><b>Display Name: </b> @{items('Apply_to_each_chatbot')?['admin_pvadisplayname']}</p>\n<p><b>Environment: </b> @{items('Apply_to_each_chatbot')?['admin_pvaenvironmentdisplayname']}</p>\n"
                                          },
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        },
                                        "runAfter": {
                                          "Send_Audit_Mail_to_Owner_Bots": [
                                            "Failed"
                                          ]
                                        },
                                        "type": "Workflow"
                                      },
                                      "Send_Audit_Mail_to_Owner_Bots": {
                                        "description": "87853f93-cd41-ec11-8c62-00224829bf00",
                                        "inputs": {
                                          "body": {
                                            "email": "@variables('varAssignee')",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID_3')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_3')?['body/admin_replyto'])",
                                            "text": "@outputs('Get_a_row_by_ID_3')?['body/admin_subject']",
                                            "text_1": "@{outputs('Get_a_row_by_ID_3')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL')}?chatbotName=@{items('Apply_to_each_chatbot')?['admin_pvaid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>Chatbot Details</u></b><br>\n<p><b>Display Name: </b> @{items('Apply_to_each_chatbot')?['admin_pvadisplayname']}</p>\n<p><b>Environment: </b> @{items('Apply_to_each_chatbot')?['admin_pvaenvironmentdisplayname']}</p>\n"
                                          },
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        },
                                        "runAfter": {
                                          "Get_Row_-_Send_Audit_Mail_to_Owner_-_Bots": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "Workflow"
                                      },
                                      "Update_bot_Risk_Assessment_State_to_Requested": {
                                        "inputs": {
                                          "authentication": "@parameters('$authentication')",
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "connectionName": "shared_commondataserviceforapps_1",
                                            "operationId": "UpdateRecord"
                                          },
                                          "parameters": {
                                            "entityName": "admin_pvas",
                                            "item/admin_adminrequirementriskassessmentstate": 597910001,
                                            "recordId": "@items('Apply_to_each_chatbot')?['admin_pvaid']"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "d3df044b-707c-4f52-b20e-68679c13700c"
                                        },
                                        "runAfter": {
                                          "If_BPF_not_already_started_for_this_chatbot,_start_it": [
                                            "Succeeded"
                                          ]
                                        },
                                        "type": "OpenApiConnection"
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "If_not_already_submitted_or_complete,_mark_bot_as_submitted": {
                                          "actions": {
                                            "Update_bots_Risk_Assessment_State_to_Submitted": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps_1",
                                                  "operationId": "UpdateRecord"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_pvas",
                                                  "item/admin_adminrequirementriskassessmentstate": 597910002,
                                                  "recordId": "@items('Apply_to_each_chatbot')?['admin_pvaid']"
                                                }
                                              },
                                              "metadata": {
                                                "operationMetadataId": "c2fcdaa8-6559-43ee-b6ac-14848382f198"
                                              },
                                              "runAfter": {},
                                              "type": "OpenApiConnection"
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                                    597910003
                                                  ]
                                                }
                                              },
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                                    597910002
                                                  ]
                                                }
                                              }
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "67f884d1-52d2-4836-add9-68ae64b68b66"
                                          },
                                          "runAfter": {},
                                          "type": "If"
                                        }
                                      }
                                    },
                                    "expression": {
                                      "or": [
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_chatbot')?['admin_makerrequirementbusinessjustification']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_chatbot')?['admin_makerrequirementaccessmanagement']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_chatbot')?['admin_makerrequirementdependencies']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_chatbot')?['admin_makerrequirementbusinessimpact']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_chatbot')?['admin_mitigationplanprovided']",
                                              "@true"
                                            ]
                                          }
                                        },
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_chatbot')?['admin_chatbotdescription']",
                                            "@null"
                                          ]
                                        }
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "c8a85408-377c-4620-9e9b-e93ed1ec78f4"
                                    },
                                    "runAfter": {},
                                    "type": "If"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "No-op,_not_heavily_used": {
                                      "inputs": "No-op, not heavily used",
                                      "metadata": {
                                        "operationMetadataId": "9477e17b-b44b-4ad0-b87e-17925627be17"
                                      },
                                      "runAfter": {},
                                      "type": "Compose"
                                    }
                                  }
                                },
                                "expression": {
                                  "and": [
                                    {
                                      "greaterOrEquals": [
                                        "@outputs('NumLaunchesWithNullCheck')",
                                        "@variables('NumberChatbotLaunches')"
                                      ]
                                    },
                                    {
                                      "not": {
                                        "equals": [
                                          "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                          597910000
                                        ]
                                      }
                                    }
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "3a834620-9be5-4344-949e-6092a174042c"
                                },
                                "runAfter": {
                                  "NumLaunchesWithNullCheck": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "If"
                              },
                              "Get_Assignee_for_Bots": {
                                "actions": {
                                  "Set_variable_2": {
                                    "inputs": {
                                      "name": "varAssignee",
                                      "value": "@parameters('Admin eMail')"
                                    },
                                    "metadata": {
                                      "operationMetadataId": "4c1af51d-c6f1-4217-a16a-8cf0fad6c610"
                                    },
                                    "runAfter": {},
                                    "type": "SetVariable"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Recheck_Orphan_2": {
                                      "inputs": {
                                        "body": {
                                          "text": "@items('Apply_to_each_chatbot')?['_admin_pvaowner_value']",
                                          "text_1": "@items('Apply_to_each_chatbot')?['admin_pvaowner/admin_displayname']"
                                        },
                                        "host": {
                                          "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ab7dc79c-03d7-46d9-b5e6-4b5522ecf8ee"
                                      },
                                      "runAfter": {},
                                      "type": "Workflow"
                                    },
                                    "See_if_now_orphaned_2": {
                                      "actions": {
                                        "Set_variable_to_Approval_the_Admin_2": {
                                          "inputs": {
                                            "name": "varAssignee",
                                            "value": "@parameters('Admin eMail')"
                                          },
                                          "metadata": {
                                            "operationMetadataId": "302316b0-671f-47c2-b1bc-f67d4cc079c0"
                                          },
                                          "runAfter": {},
                                          "type": "SetVariable"
                                        }
                                      },
                                      "else": {
                                        "actions": {
                                          "Set_Assignee_to_app_Owner_2": {
                                            "inputs": {
                                              "name": "varAssignee",
                                              "value": "@outputs('Recheck_Orphan_2')?['Body']?['useremail']"
                                            },
                                            "metadata": {
                                              "operationMetadataId": "bfee0e05-b688-4624-9f45-81b04b7fe8bd"
                                            },
                                            "runAfter": {},
                                            "type": "SetVariable"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "equals": [
                                          "@outputs('Recheck_Orphan_2')?['Body']?['userisorphan']",
                                          "True"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "83044cd2-6972-4da2-b64b-b50b652c9539"
                                      },
                                      "runAfter": {
                                        "Recheck_Orphan_2": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "If"
                                    }
                                  }
                                },
                                "expression": {
                                  "or": [
                                    {
                                      "equals": [
                                        "@parameters('ProductionEnvironment')",
                                        "no"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_chatbot')?['admin_pvaisorphaned']",
                                        "yes"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_chatbot')?['admin_pvaowner/admin_userisserviceprinciple']",
                                        "@true"
                                      ]
                                    },
                                    {
                                      "equals": [
                                        "@items('Apply_to_each_chatbot')?['_admin_pvaowner_value']",
                                        "@null"
                                      ]
                                    }
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "a68ae48f-87aa-4aa4-8df6-32e84b6baef8"
                                },
                                "runAfter": {},
                                "type": "If"
                              },
                              "NumLaunchesWithNullCheck": {
                                "inputs": "@coalesce(items('Apply_to_each_chatbot')?['admin_pvanumberlaunches'], 0)",
                                "metadata": {
                                  "operationMetadataId": "5cd3f2b9-6aae-4cf1-b81d-b027fcd6e976"
                                },
                                "runAfter": {
                                  "Get_Assignee_for_Bots": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "Compose"
                              }
                            },
                            "foreach": "@outputs('List_chatbots')?['body/value']",
                            "metadata": {
                              "operationMetadataId": "d56186d8-2cde-4a4b-aad9-a3149b3898e9"
                            },
                            "runAfter": {
                              "List_chatbots": [
                                "Succeeded"
                              ]
                            },
                            "type": "Foreach"
                          },
                          "List_chatbots": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "ListRecords"
                              },
                              "parameters": {
                                "$expand": "admin_PVAOwner($select=admin_userisserviceprinciple, admin_displayname)",
                                "$filter": "admin_PVAOwner/admin_displayname ne 'SYSTEM' and admin_pvadeleted ne true and _admin_pvaenvironment_value eq '@{items('Apply_to_each_envt')?['admin_environmentid']}'",
                                "$select": "admin_pvadisplayname,admin_makerrequirementbusinessimpact,admin_makerrequirementbusinessjustification,admin_makersubmittedrequirements,admin_mitigationplanprovided,admin_pvanumberlaunches,admin_pvaisorphaned, admin_pvaenvironmentdisplayname, admin_makerrequirementaccessmanagement, admin_makerrequirementdependencies, admin_pvaid, admin_chatbotdescription, admin_adminrequirementriskassessmentstate, _admin_pvaowner_value",
                                "entityName": "admin_pvas"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "fa5163c6-51cb-4b19-965f-ccce99dd83a2"
                            },
                            "runAfter": {},
                            "runtimeConfiguration": {
                              "paginationPolicy": {
                                "minimumItemCount": 100000
                              }
                            },
                            "type": "OpenApiConnection"
                          }
                        },
                        "metadata": {
                          "operationMetadataId": "f58a0e7a-f063-42d7-b49a-2b80ec1d3629"
                        },
                        "runAfter": {
                          "Send_Compliance_Request_email_for_Apps": [
                            "Succeeded"
                          ]
                        },
                        "type": "Scope"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "equals": [
                          "@items('Apply_to_each_envt')?['admin_environmentsku']",
                          "Default"
                        ]
                      },
                      {
                        "equals": [
                          "@parameters('Exclude Default environment from Compliance Request flows')",
                          "@true"
                        ]
                      }
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "11a24b14-c547-4d7e-b30f-02e02129c6ce"
                  },
                  "runAfter": {},
                  "type": "If"
                }
              },
              "foreach": "@outputs('List_Environments_not_excused_from_compliance')?['body/value']",
              "metadata": {
                "operationMetadataId": "99e6ea0f-c0c6-4ea5-956b-c8d2dfddcdc3"
              },
              "runAfter": {
                "List_Environments_not_excused_from_compliance": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "List_Environments_not_excused_from_compliance": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$filter": "admin_excusefromcomplianceflow ne true and admin_environmentdeleted\nne true",
                  "$select": "admin_environmentsku, admin_environmentname, admin_environmentid",
                  "entityName": "admin_environments"
                }
              },
              "metadata": {
                "operationMetadataId": "179da2b0-82c9-4c17-9470-738cc219be0d"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "metadata": {
            "operationMetadataId": "ab92ac8f-3523-4fcb-b6a3-2343afcb776c"
          },
          "runAfter": {
            "Initialize_emailGUID": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Initialize_NumberChatbotLaunches": {
          "inputs": {
            "variables": [
              {
                "name": "NumberChatbotLaunches",
                "type": "integer",
                "value": "@parameters('Compliance – Chatbots – Number Launches')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "521c896e-c64e-431b-a990-a47b3d2f9f7f"
          },
          "runAfter": {
            "Initialize_NumberLaunchesLast30Days": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_NumberDaysSincePublished": {
          "inputs": {
            "variables": [
              {
                "name": "NumberDaysSincePublished",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Days Since Published')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "de1e511b-2c30-45d4-97ed-4a1ee3168be7"
          },
          "runAfter": {
            "Initialize_NumberGroupsShared": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_NumberGroupsShared": {
          "inputs": {
            "variables": [
              {
                "name": "NumberGroupsShared",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Groups Shared')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "12ef889e-4143-4c8a-90ef-d187f9dc5706"
          },
          "runAfter": {
            "Initialize_NumberUsersShared": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_NumberLaunchesLast30Days": {
          "inputs": {
            "variables": [
              {
                "name": "NumberLaunchesLast30Days",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Launches Last 30 Days')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "08497d29-29f7-421f-b0c0-59501a16a08f"
          },
          "runAfter": {
            "Initialize_NumberDaysSincePublished": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_NumberUsersShared": {
          "inputs": {
            "variables": [
              {
                "name": "NumberUsersShared",
                "type": "integer",
                "value": "@parameters('Compliance Apps - Number Users Shared')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "33d288a8-ceaf-4eb5-9191-1ae4300a1804"
          },
          "runAfter": {
            "Initialize_varAssignee": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_emailGUID": {
          "inputs": {
            "variables": [
              {
                "name": "emailGUID",
                "type": "string"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "dad8eca6-7937-47c0-aa57-f2d48dd1c5a2"
          },
          "runAfter": {
            "Initialize_NumberChatbotLaunches": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_varAssignee": {
          "inputs": {
            "variables": [
              {
                "name": "varAssignee",
                "type": "string"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "be05b098-9f03-4b1b-b8c7-a25a00631dc3"
          },
          "runAfter": {},
          "type": "InitializeVariable"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Admin eMail": {
          "defaultValue": "leeg@pplatform.onmicrosoft.com",
          "metadata": {
            "description": "CoE Admin eMail. Email address used in flows to send notifications to admins; this should be either your email address or a distribution list",
            "schemaName": "admin_AdminMail"
          },
          "type": "String"
        },
        "Compliance Apps - Number Users Shared": {
          "defaultValue": 20,
          "metadata": {
            "description": "If the app is shared with this many or more users, ask for business justification",
            "schemaName": "admin_ComplianceAppsNumberUsersShared"
          },
          "type": "Int"
        },
        "Compliance – Apps – Number Days Since Published": {
          "defaultValue": 60,
          "metadata": {
            "description": "If an app is broadly shared and was last published this many days ago or older, then they are asked to publish to stay compliant",
            "schemaName": "admin_ComplianceAppsNumberDaysSincePublished"
          },
          "type": "Int"
        },
        "Compliance – Apps – Number Groups Shared": {
          "defaultValue": 1,
          "metadata": {
            "description": "If the app is shared with this many or more groups, ask for business justification",
            "schemaName": "admin_ComplianceAppsNumberGroupsShared"
          },
          "type": "Int"
        },
        "Compliance – Apps – Number Launches Last 30 Days": {
          "defaultValue": 30,
          "metadata": {
            "description": "If the app was launched at least this many times in the last 30, ask for business justification",
            "schemaName": "admin_ComplianceAppsNumberLaunchesLast30Days"
          },
          "type": "Int"
        },
        "Compliance – Chatbots – Number Launches": {
          "defaultValue": 50,
          "metadata": {
            "description": "If the chatbot is launched this many or more times, ask for business justification",
            "schemaName": "admin_ComplianceChatbotsNumberLaunches"
          },
          "type": "Int"
        },
        "Developer Compliance Center URL": {
          "defaultValue": "https://web.yammer.com/main/groups/eyJfdHlwZSI6Ikdyb3VwIiwiaWQiOiI1MDMzNjIyIn0/new",
          "metadata": {
            "description": "Leave blank on Import. URL to Developer Compliance Center Canvas App. ",
            "schemaName": "admin_DeveloperComplianceCenterURL"
          },
          "type": "String"
        },
        "Exclude Default environment from Compliance Request flows": {
          "defaultValue": false,
          "metadata": {
            "description": "Set to Yes if you want to Exclude the Default environment from the Admin | Compliance Details request flow",
            "schemaName": "admin_ExcludeDefault"
          },
          "type": "Bool"
        },
        "ProductionEnvironment": {
          "defaultValue": true,
          "metadata": {
            "description": "true by default. set to false if you are creating a dev type envt. this will allow some flows to set target users to the admin instead of object owners",
            "schemaName": "admin_ProductionEnvironment"
          },
          "type": "Bool"
        }
      },
      "triggers": {
        "Recurrence": {
          "metadata": {
            "operationMetadataId": "de85ebb2-658b-4d06-9a9f-27d4f8f899a5"
          },
          "recurrence": {
            "frequency": "Week",
            "interval": 1,
            "schedule": {
              "weekDays": [
                "Monday"
              ]
            }
          },
          "type": "Recurrence"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
