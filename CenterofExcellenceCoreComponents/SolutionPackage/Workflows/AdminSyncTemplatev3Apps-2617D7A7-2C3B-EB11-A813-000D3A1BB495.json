{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerappsforadmins": {
        "api": {
          "name": "shared_powerappsforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Check_if_Environment_Deleted,_terminate_if_true": {
          "actions": {
            "Terminate_for_environments_marked_deleted": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "71b2e356-dc30-46ae-aa5e-90ae51cf707b"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentdeleted']",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "0bf354ac-4265-4bbe-9fed-996958d038bd"
          },
          "runAfter": {},
          "type": "If"
        },
        "Edit_Updated_Apps": {
          "actions": {
            "Apply_to_each_editted": {
              "actions": {
                "Check_if_App_Shared_with_Tenant_Editted": {
                  "actions": {
                    "only_if_not_SP_App_Editted": {
                      "actions": {
                        "Filter_array_Editted": {
                          "inputs": {
                            "from": "@outputs('Get_App_Role_Assignments_as_Admin_Editted')?['body/value']",
                            "where": "@equals(item()?['properties/principal/type'], 'Tenant')"
                          },
                          "metadata": {
                            "operationMetadataId": "762547b1-19a4-4f82-b4ab-b9723ffc5463"
                          },
                          "runAfter": {
                            "Get_App_Role_Assignments_as_Admin_Editted": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query"
                        },
                        "Get_App_Role_Assignments_as_Admin_Editted": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins",
                              "connectionName": "shared_powerappsforadmins",
                              "operationId": "Get-AdminAppRoleAssignment"
                            },
                            "parameters": {
                              "$top": 250,
                              "api-version": "2016-11-01",
                              "app": "@items('Apply_to_each_editted')?['name']",
                              "environment": "@triggerOutputs()?['body/admin_environmentname']"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "8fa7d13a-1dc0-4f11-ab46-c9561baba84f"
                          },
                          "runAfter": {},
                          "runtimeConfiguration": {
                            "paginationPolicy": {
                              "minimumItemCount": 100000
                            }
                          },
                          "type": "OpenApiConnection"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@item()?['properties']?['embeddedApp']?['type']",
                            "SharepointFormApp"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "43cfe8d7-f8e9-4c51-a8ad-1458cfcffd88"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "e1210f45-807b-450f-b3a2-e5a094862197"
                  },
                  "runAfter": {},
                  "type": "Scope"
                },
                "Prepare_App_Connection_References_Updated": {
                  "actions": {
                    "check_if_edited_app_has_connections": {
                      "actions": {
                        "Compose_comma-separated_list_of_edited_connection_references": {
                          "inputs": "@concat(join(body('Select_Connector_Display_Name_edit'), ','), if(empty(items('Apply_to_each_editted')?['properties/databaseReferences']), '', ',Microsoft Dataverse'))",
                          "metadata": {
                            "operationMetadataId": "d54b22d2-3c90-474f-ac90-b8440aed87b5"
                          },
                          "runAfter": {
                            "Select_Connector_Display_Name_edit": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        },
                        "Parse_JSON_-_Connection_References_Edited": {
                          "inputs": {
                            "content": "@items('Apply_to_each_editted')?['properties/connectionReferences']",
                            "schema": {
                              "items": {
                                "properties": {
                                  "apiTier": {
                                    "type": "string"
                                  },
                                  "bypassConsent": {
                                    "type": "boolean"
                                  },
                                  "displayName": {
                                    "type": "string"
                                  },
                                  "iconUri": {
                                    "type": "string"
                                  },
                                  "id": {
                                    "type": "string"
                                  },
                                  "isCustomApiConnection": {
                                    "type": "boolean"
                                  },
                                  "isOnPremiseConnection": {
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "iconUri",
                                  "displayName",
                                  "isOnPremiseConnection",
                                  "isCustomApiConnection",
                                  "bypassConsent",
                                  "id"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "ba2e396c-f0a5-4788-ac2f-332d8a1ca7bb"
                          },
                          "runAfter": {},
                          "type": "ParseJson"
                        },
                        "Select_Connector_Display_Name_edit": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_Edited')",
                            "select": "@item()['displayName']"
                          },
                          "metadata": {
                            "operationMetadataId": "2568ef78-b0dc-4b21-a43b-544d45f18fe7"
                          },
                          "runAfter": {
                            "Parse_JSON_-_Connection_References_Edited": [
                              "Succeeded"
                            ]
                          },
                          "type": "Select"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@items('Apply_to_each_editted')?['properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "ac3f40ca-9e8f-4222-9d0c-b9de86493191"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "ccafb8a2-42cf-45f2-957b-0ceb78684d5c"
                  },
                  "runAfter": {
                    "Check_if_App_Shared_with_Tenant_Editted": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Store_App_Connection_References_Editted": {
                  "actions": {
                    "Check_if_App_Connection_References_are_not_null_Editted": {
                      "actions": {
                        "Apply_to_each_Connection_Reference_2": {
                          "actions": {
                            "Connecor_Name_2": {
                              "inputs": "@last(outputs('split_on_slash_2'))",
                              "metadata": {
                                "operationMetadataId": "0e0b96a7-15c7-49ad-b992-a46b41f628a9"
                              },
                              "runAfter": {
                                "split_on_slash_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            },
                            "ConnectorID_2": {
                              "inputs": "@items('Apply_to_each_Connection_Reference_2')['id']",
                              "metadata": {
                                "operationMetadataId": "92a53fdc-4ca5-4d89-af44-7e5ee5bab2e1"
                              },
                              "runAfter": {},
                              "type": "Compose"
                            },
                            "Filter_current_app_Connector_2": {
                              "inputs": {
                                "from": "@outputs('List_Connectors')?['body/value']",
                                "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_2'))"
                              },
                              "metadata": {
                                "operationMetadataId": "43645f13-c5dc-40f0-a328-f9e6f86d934f"
                              },
                              "runAfter": {
                                "Connecor_Name_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query"
                            },
                            "mark_broken_connector_or_insert_connection_reference_2": {
                              "actions": {
                                "Create_a_new_App_Connection_2": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_connectionreferences",
                                      "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_editted')?['name']})",
                                      "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_app_Connector_2'))?['admin_connectorid']})",
                                      "item/admin_displayname": "@items('Apply_to_each_Connection_Reference_2')?['displayName']"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "dd73d50c-55a9-478f-9ba7-32a626a84284"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "else": {
                                "actions": {
                                  "Mark_app_as_having_broken_connections_2": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_appcontainsbrokenconnections": true,
                                        "recordId": "@items('Apply_to_each_editted')?['name']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "0bcb0846-f80d-46bc-ad9d-88f14c575b22"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "greater": [
                                  "@length(body('Filter_current_app_Connector_2'))",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "9da95403-58d4-4eab-8554-b3255a30076e"
                              },
                              "runAfter": {
                                "Filter_current_app_Connector_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "split_on_slash_2": {
                              "inputs": "@split(outputs('ConnectorID_2'), '/')",
                              "metadata": {
                                "operationMetadataId": "31ea44b2-c53a-40d6-b0e7-ec093e9747f7"
                              },
                              "runAfter": {
                                "ConnectorID_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            }
                          },
                          "foreach": "@body('Filter_non_custom_2')",
                          "metadata": {
                            "operationMetadataId": "9d51fc87-1783-470c-848b-1504f671d660"
                          },
                          "runAfter": {
                            "Filter_non_custom_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Apply_to_each_Custom_Connection_Reference_2": {
                          "actions": {
                            "Connecor_Name_custom_2": {
                              "inputs": "@last(outputs('split_on_slash_custom_2'))",
                              "metadata": {
                                "operationMetadataId": "2e377abf-7bf8-4df5-92ab-a5cfd2653cce"
                              },
                              "runAfter": {
                                "split_on_slash_custom_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            },
                            "ConnectorID_custom_2": {
                              "inputs": "@items('Apply_to_each_Custom_Connection_Reference_2')['id']",
                              "metadata": {
                                "operationMetadataId": "2db84371-4ae6-4809-9ad7-78dc896a0b95"
                              },
                              "runAfter": {},
                              "type": "Compose"
                            },
                            "Filter_current_app_Connector_custom_2": {
                              "inputs": {
                                "from": "@outputs('List_Connectors')?['body/value']",
                                "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_custom_2'))"
                              },
                              "metadata": {
                                "operationMetadataId": "2725b90b-bb61-475e-9fdf-3341d9b4d8d4"
                              },
                              "runAfter": {
                                "Connecor_Name_custom_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query"
                            },
                            "mark_broken_connector_or_insert_connection_reference_for_custom_2": {
                              "actions": {
                                "Create_a_new_App_Connection_for_Custom_2": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_connectionreferences",
                                      "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_editted')?['name']})",
                                      "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_app_Connector_custom_2'))?['admin_connectorid']})",
                                      "item/admin_displayname": "@items('Apply_to_each_Custom_Connection_Reference_2')?['displayName']"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "02de34dd-8ff9-4271-870f-ac3d304e3e4e"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "else": {
                                "actions": {
                                  "Mark_app_as_having_broken_connections_for_custom_2": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_appcontainsbrokenconnections": true,
                                        "recordId": "@items('Apply_to_each_editted')?['name']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "a4347e2f-7535-455b-876e-2ba6ecd77a1f"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "greater": [
                                  "@length(body('Filter_current_app_Connector_custom_2'))",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "505cd208-1340-45cf-a50c-653f069938fc"
                              },
                              "runAfter": {
                                "Filter_current_app_Connector_custom_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "split_on_slash_custom_2": {
                              "inputs": "@split(outputs('ConnectorID_custom_2'), '/')",
                              "metadata": {
                                "operationMetadataId": "1ab7887c-531a-409f-94e7-0d7453d7b06e"
                              },
                              "runAfter": {
                                "ConnectorID_custom_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            }
                          },
                          "foreach": "@body('Filter_custom_2')",
                          "metadata": {
                            "operationMetadataId": "d2df5ee9-8d29-4b9c-8973-83168825c417"
                          },
                          "runAfter": {
                            "Filter_custom_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Filter_custom_2": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_Edited')",
                            "where": "@equals(item()['isCustomApiConnection'], true)"
                          },
                          "metadata": {
                            "operationMetadataId": "6edec7f8-0d3a-452f-9dfc-0d1fe349b4e6"
                          },
                          "runAfter": {
                            "Apply_to_each_Connection_Reference_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query"
                        },
                        "Filter_non_custom_2": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_Edited')",
                            "where": "@equals(item()['isCustomApiConnection'], false)"
                          },
                          "metadata": {
                            "operationMetadataId": "1a0fb779-6ff6-462e-8fe6-80ce20cf0b3c"
                          },
                          "runAfter": {},
                          "type": "Query"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@items('Apply_to_each_editted')?['properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "2f281b10-d732-4f71-bee8-a7c50e1c1d08"
                      },
                      "runAfter": {
                        "Delete_this_apps_existing_connection_references_Editted": [
                          "Succeeded",
                          "Failed"
                        ]
                      },
                      "type": "If"
                    },
                    "Delete_this_apps_existing_connection_references_Editted": {
                      "actions": {
                        "Delete_this_record_2": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "DeleteRecord"
                            },
                            "parameters": {
                              "entityName": "admin_connectionreferences",
                              "recordId": "@items('Delete_this_apps_existing_connection_references_Editted')?['admin_connectionreferenceid']"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "c3596d7d-d5f9-4b49-92b7-40f6bffe6510"
                          },
                          "runAfter": {},
                          "type": "OpenApiConnection"
                        }
                      },
                      "foreach": "@outputs('List_App_Connection_References_Editted')?['body/value']",
                      "metadata": {
                        "operationMetadataId": "0f300b24-c84f-4007-a0e4-4c7b4cccefa0"
                      },
                      "runAfter": {
                        "List_App_Connection_References_Editted": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "List_App_Connection_References_Editted": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords"
                        },
                        "parameters": {
                          "$filter": "admin_App/admin_appid eq @{items('Apply_to_each_editted')?['name']}",
                          "$select": "admin_connectionreferenceid, admin_displayname",
                          "entityName": "admin_connectionreferences"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "b99ce169-5b4b-44be-bcd8-cdeb2109285c"
                      },
                      "runAfter": {},
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      },
                      "type": "OpenApiConnection"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "ecea9c6d-cf48-4886-aef1-ccb987a7371e"
                  },
                  "runAfter": {
                    "Update_App_Details_Editted": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Store_App_Dataverse_References_Editted": {
                  "actions": {
                    "Check_if_App_Database_References_are_not_null_Editted": {
                      "actions": {
                        "Check_if_app_already_stores_CDS_Native_connection": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "ListRecords"
                            },
                            "parameters": {
                              "$filter": "admin_Connector/admin_connectorid eq @{variables('DataverseConnectorGUID')} and admin_App/admin_appid eq @{items('Apply_to_each_editted')?['name']}",
                              "$select": "admin_connectionreferenceid",
                              "entityName": "admin_connectionreferences"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "5926b8f8-eecf-4651-b65d-971c9ba80daf"
                          },
                          "runAfter": {
                            "Mark_app_as_using_dataverse_Editted": [
                              "Succeeded"
                            ]
                          },
                          "type": "OpenApiConnection"
                        },
                        "Condition:_if_app_contains_CDS_Native": {
                          "actions": {
                            "Add_CDS_Native_Connection_Reference": {
                              "inputs": {
                                "authentication": "@parameters('$authentication')",
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "CreateRecord"
                                },
                                "parameters": {
                                  "entityName": "admin_connectionreferences",
                                  "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_editted')?['name']})",
                                  "item/admin_Connector@odata.bind": "admin_connectors(@{variables('DataverseConnectorGUID')})",
                                  "item/admin_displayname": "Microsoft Dataverse"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "6388de0c-f42a-494f-ad06-2feb3cd90884"
                              },
                              "runAfter": {},
                              "type": "OpenApiConnection"
                            }
                          },
                          "expression": {
                            "equals": [
                              "@length(outputs('Check_if_app_already_stores_CDS_Native_connection')?['body/value'])",
                              0
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "5817eaf7-4d82-401b-8fab-e35658141682"
                          },
                          "runAfter": {
                            "Check_if_app_already_stores_CDS_Native_connection": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "Mark_app_as_using_dataverse_Editted": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "UpdateRecord"
                            },
                            "parameters": {
                              "entityName": "admin_apps",
                              "item/admin_appusesdataversetables": true,
                              "recordId": "@items('Apply_to_each_editted')?['name']"
                            },
                            "retryPolicy": {
                              "count": 10,
                              "interval": "PT10S",
                              "type": "exponential"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "d0596839-d1be-4cd3-8f87-4ac9c3661461"
                          },
                          "runAfter": {},
                          "type": "OpenApiConnection"
                        }
                      },
                      "else": {
                        "actions": {
                          "Apply_to_each": {
                            "actions": {
                              "Delete_the_connection": {
                                "inputs": {
                                  "authentication": "@parameters('$authentication')",
                                  "host": {
                                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                    "connectionName": "shared_commondataserviceforapps",
                                    "operationId": "DeleteRecord"
                                  },
                                  "parameters": {
                                    "entityName": "admin_connectionreferences",
                                    "recordId": "@items('Apply_to_each')?['admin_connectionreferenceid']"
                                  }
                                },
                                "metadata": {
                                  "operationMetadataId": "a03bd22b-c70c-4ea9-8610-845e9b2bc24b"
                                },
                                "runAfter": {},
                                "type": "OpenApiConnection"
                              }
                            },
                            "foreach": "@outputs('Fetch_all_CDS_Native_connections')?['body/value']",
                            "metadata": {
                              "operationMetadataId": "e771066a-1df3-454b-aedd-53a279ee551e"
                            },
                            "runAfter": {
                              "Fetch_all_CDS_Native_connections": [
                                "Succeeded"
                              ]
                            },
                            "type": "Foreach"
                          },
                          "Fetch_all_CDS_Native_connections": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "ListRecords"
                              },
                              "parameters": {
                                "$filter": "admin_Connector/admin_connectorid eq @{variables('DataverseConnectorGUID')} and admin_App/admin_appid eq @{items('Apply_to_each_editted')?['name']}",
                                "$select": "admin_connectionreferenceid",
                                "entityName": "admin_connectionreferences"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "c972116a-61dc-41ea-9446-7fa54e2faf66"
                            },
                            "runAfter": {
                              "Mark_app_as_not_using_dataverse_Editted": [
                                "Succeeded"
                              ]
                            },
                            "type": "OpenApiConnection"
                          },
                          "Mark_app_as_not_using_dataverse_Editted": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "UpdateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_apps",
                                "item/admin_appusesdataversetables": false,
                                "recordId": "@items('Apply_to_each_editted')?['name']"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "3e286deb-f037-4848-9e83-a189a29915e1"
                            },
                            "runAfter": {},
                            "type": "OpenApiConnection"
                          }
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@empty(items('Apply_to_each_editted')?['properties/databaseReferences'])",
                            "@true"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "4033c504-4113-49f6-83e5-f10af6425bca"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "e276afb8-0c0a-43a4-a7e9-c2d5428c9358"
                  },
                  "runAfter": {
                    "Store_App_Connection_References_Editted": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Update_App_Details_Editted": {
                  "actions": {
                    "Check_if_Orphan_-_Edit": {
                      "actions": {
                        "Update_Orphaned_App_record_Editted": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "UpdateRecord"
                            },
                            "parameters": {
                              "entityName": "admin_apps",
                              "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                              "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_edited_connection_references')",
                              "item/admin_appcontainsbrokenconnections": false,
                              "item/admin_appcreatedon": "@items('Apply_to_each_editted')?['properties/createdTime']",
                              "item/admin_appdeleted": false,
                              "item/admin_appdescription": "@items('Apply_to_each_editted')?['properties/description']",
                              "item/admin_appenvironmentdisplayname": "@triggerBody()?['admin_displayname']",
                              "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                              "item/admin_appiconuri": "@items('Apply_to_each_editted')?['properties/backgroundImageUri']",
                              "item/admin_appidstring": "@items('Apply_to_each_editted')?['name']",
                              "item/admin_appmodifiedon": "@items('Apply_to_each_editted')?['properties/lastModifiedTime']",
                              "item/admin_appplanclassification": "@coalesce(items('Apply_to_each_editted')?['properties']?['appPlanClassification'], '')",
                              "item/admin_apppublished": "@if(empty(items('Apply_to_each_editted')?['properties']?['lastPublishTime']), items('Apply_to_each_editted')?['properties/createdTime'], items('Apply_to_each_editted')?['properties']?['lastPublishTime'])",
                              "item/admin_appsharedgroups": "@items('Apply_to_each_editted')?['properties/sharedGroupsCount']",
                              "item/admin_appsharedusers": "@items('Apply_to_each_editted')?['properties/sharedUsersCount']",
                              "item/admin_appsharedwithtenant": "@if(greater(length(coalesce(body('Filter_array_Editted'), variables('sharedWith'))), 0), true, false)",
                              "item/admin_displayname": "@items('Apply_to_each_editted')?['properties/displayName']",
                              "item/admin_dlpevaluationstatus": "@items('Apply_to_each_editted')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                              "item/admin_dlplastevaluationdate": "@items('Apply_to_each_editted')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                              "item/admin_iconbackgroundcolor": "@items('Apply_to_each_editted')?['properties/backgroundColor']",
                              "item/admin_powerappsreleaseversion": "@items('Apply_to_each_editted')?['tags/publisherVersion']",
                              "item/admin_powerappstype": "@coalesce(if(equals(items('Apply_to_each_editted')?['properties']?['embeddedApp']?['type'], 'SharepointFormApp'), 597910002, 597910000), 597910000)",
                              "item/admin_sharepointformurl": "@coalesce(items('Apply_to_each_editted')?['properties']?['embeddedApp']?['listUrl'], '')",
                              "item/admin_usescustomapi": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesCustomApi'], '')",
                              "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesOnlyGrandfatheredPremiumApis'], '')",
                              "item/admin_usesonpremisegateway": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesOnPremiseGateway'], '')",
                              "item/admin_usespremiumapi": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesPremiumApi'], '')",
                              "item/cr5d5_appisorphaned": "yes",
                              "recordId": "@items('Apply_to_each_editted')?['name']"
                            },
                            "retryPolicy": {
                              "count": 10,
                              "interval": "PT10S",
                              "type": "exponential"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "f368e0fd-b422-4e3e-b057-4551a7751e21"
                          },
                          "runAfter": {},
                          "type": "OpenApiConnection"
                        }
                      },
                      "else": {
                        "actions": {
                          "Update_App_record_Editted": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "UpdateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_apps",
                                "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                "item/admin_AppOwner@odata.bind": "admin_makers(@{items('Apply_to_each_editted')?['properties/owner/id']})",
                                "item/admin_appcompany": "@outputs('Maker_Check_-_Edit')?['Body']?['usercompany']",
                                "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_edited_connection_references')",
                                "item/admin_appcontainsbrokenconnections": false,
                                "item/admin_appcreatedon": "@items('Apply_to_each_editted')?['properties/createdTime']",
                                "item/admin_appdeleted": false,
                                "item/admin_appdescription": "@items('Apply_to_each_editted')?['properties/description']",
                                "item/admin_appenvironmentdisplayname": "@triggerBody()?['admin_displayname']",
                                "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                "item/admin_appiconuri": "@items('Apply_to_each_editted')?['properties/backgroundImageUri']",
                                "item/admin_appidstring": "@items('Apply_to_each_editted')?['name']",
                                "item/admin_appmodifiedon": "@items('Apply_to_each_editted')?['properties/lastModifiedTime']",
                                "item/admin_appownerdisplayname": "@outputs('Maker_Check_-_Edit')?['Body']?['userdisplayname']",
                                "item/admin_appplanclassification": "@coalesce(items('Apply_to_each_editted')?['properties']?['appPlanClassification'], '')",
                                "item/admin_apppublished": "@if(empty(items('Apply_to_each_editted')?['properties']?['lastPublishTime']), items('Apply_to_each_editted')?['properties/createdTime'], items('Apply_to_each_editted')?['properties']?['lastPublishTime'])",
                                "item/admin_appsharedgroups": "@items('Apply_to_each_editted')?['properties/sharedGroupsCount']",
                                "item/admin_appsharedusers": "@items('Apply_to_each_editted')?['properties/sharedUsersCount']",
                                "item/admin_appsharedwithtenant": "@if(greater(length(coalesce(body('Filter_array_Editted'), variables('sharedWith'))), 0), true, false)",
                                "item/admin_city": "@outputs('Maker_Check_-_Edit')?['Body']?['usercity']",
                                "item/admin_country": "@outputs('Maker_Check_-_Edit')?['Body']?['usercountry']",
                                "item/admin_department": "@outputs('Maker_Check_-_Edit')?['Body']?['userdepartment']",
                                "item/admin_displayname": "@items('Apply_to_each_editted')?['properties/displayName']",
                                "item/admin_dlpevaluationstatus": "@items('Apply_to_each_editted')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                                "item/admin_dlplastevaluationdate": "@items('Apply_to_each_editted')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                                "item/admin_iconbackgroundcolor": "@items('Apply_to_each_editted')?['properties/backgroundColor']",
                                "item/admin_powerappsreleaseversion": "@items('Apply_to_each_editted')?['tags/publisherVersion']",
                                "item/admin_powerappstype": "@coalesce(if(equals(items('Apply_to_each_editted')?['properties']?['embeddedApp']?['type'], 'SharepointFormApp'), 597910002, 597910000), 597910000)",
                                "item/admin_sharepointformurl": "@coalesce(items('Apply_to_each_editted')?['properties']?['embeddedApp']?['listUrl'], '')",
                                "item/admin_usescustomapi": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesCustomApi'], '')",
                                "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesOnlyGrandfatheredPremiumApis'], '')",
                                "item/admin_usesonpremisegateway": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesOnPremiseGateway'], '')",
                                "item/admin_usespremiumapi": "@coalesce(items('Apply_to_each_editted')?['properties']?['usesPremiumApi'], '')",
                                "item/cr5d5_appisorphaned": "no",
                                "recordId": "@items('Apply_to_each_editted')?['name']"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "39f01732-3da8-48fb-86ba-e67be7568cea"
                            },
                            "runAfter": {},
                            "type": "OpenApiConnection"
                          }
                        }
                      },
                      "expression": {
                        "equals": [
                          "@outputs('Maker_Check_-_Edit')?['Body']?['userisorphan']",
                          "True"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "d1b40cef-d175-4c74-9905-af59987b72a2"
                      },
                      "runAfter": {
                        "Maker_Check_-_Edit": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Maker_Check_-_Edit": {
                      "inputs": {
                        "body": {
                          "text": "@items('Apply_to_each_editted')?['properties/owner/id']",
                          "text_1": "@items('Apply_to_each_editted')?['properties/owner/displayName']"
                        },
                        "host": {
                          "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "e9398e06-3143-4271-ab98-745dc5187c02"
                      },
                      "runAfter": {},
                      "type": "Workflow"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "fc2a8665-8b1d-4ced-a235-31ec5593dfca"
                  },
                  "runAfter": {
                    "Prepare_App_Connection_References_Updated": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                }
              },
              "foreach": "@variables('Apps_Editted')",
              "metadata": {
                "operationMetadataId": "1a7a3152-3d88-4c9c-ac3b-2609c974b3d4"
              },
              "runAfter": {},
              "type": "Foreach"
            }
          },
          "metadata": {
            "operationMetadataId": "9f8ae9fd-ff47-4ca8-852a-440c37a3aee8"
          },
          "runAfter": {
            "Set_hadFailure_true_-_add_new_apps": [
              "Succeeded",
              "Skipped",
              "Failed"
            ]
          },
          "type": "Scope"
        },
        "Get_Apps_fails_-_Error_Handling": {
          "actions": {
            "if_any_failures_above": {
              "actions": {
                "Create_a_new_record_-_Sync_Flow_Errors": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "CreateRecord"
                    },
                    "parameters": {
                      "entityName": "admin_syncflowerrorses",
                      "item/admin_environmentname": "@triggerOutputs()?['body/admin_displayname']",
                      "item/admin_flowinstanceurl": "@concat(variables('flowEnvironment'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])",
                      "item/admin_name": "Admin | Sync Template v3 (Apps)"
                    },
                    "retryPolicy": {
                      "count": 10,
                      "interval": "PT10S",
                      "type": "exponential"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "2eb6f8cf-0471-4346-83bb-126d4ffcee6f"
                  },
                  "runAfter": {},
                  "type": "OpenApiConnection"
                },
                "Terminate": {
                  "inputs": {
                    "runError": {
                      "code": "500",
                      "message": "Get Apps Failed"
                    },
                    "runStatus": "Failed"
                  },
                  "metadata": {
                    "operationMetadataId": "1db2a46b-46a0-4f32-b73e-34cc0c2401cf"
                  },
                  "runAfter": {
                    "Create_a_new_record_-_Sync_Flow_Errors": [
                      "Succeeded"
                    ]
                  },
                  "type": "Terminate"
                }
              },
              "expression": {
                "equals": [
                  "@variables('hadFailure')",
                  "@true"
                ]
              },
              "metadata": {
                "operationMetadataId": "3ef7355b-9b12-45ce-80ba-45d0004d309e"
              },
              "runAfter": {},
              "type": "If"
            }
          },
          "metadata": {
            "operationMetadataId": "08c910eb-e3ba-4870-ac01-f196c3f0d478"
          },
          "runAfter": {
            "Set_hadFailure_true_-_editted_apps": [
              "Succeeded",
              "Skipped",
              "Failed"
            ]
          },
          "type": "Scope"
        },
        "Initialize_DataverseConnectorGUID": {
          "inputs": {
            "variables": [
              {
                "name": "DataverseConnectorGUID",
                "type": "string"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "a94331a6-f49a-4bec-870e-eba71b9fbfff"
          },
          "runAfter": {
            "Check_if_Environment_Deleted,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_shared_with_everyone": {
          "inputs": {
            "variables": [
              {
                "name": "sharedWithEveryone",
                "type": "Boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "174e897a-01f1-4872-924b-3c598db87664"
          },
          "runAfter": {
            "Initialize_variable_today": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_updateInCoe": {
          "inputs": {
            "variables": [
              {
                "name": "updateInCoe",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "61d16827-95df-44dd-b696-94d080433923"
          },
          "runAfter": {
            "Initialize_DataverseConnectorGUID": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_Apps_Editted": {
          "inputs": {
            "variables": [
              {
                "name": "Apps_Editted",
                "type": "array"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "208230b2-0ab9-4963-bf3e-e1848871567b"
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_Apps_New": {
          "inputs": {
            "variables": [
              {
                "name": "Apps_New",
                "type": "array"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "d62fc4a8-cd0d-4446-83e2-51b3a705f780"
          },
          "runAfter": {
            "Initialize_variable_Apps_Editted": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_flowEnvironment": {
          "description": "Environment location specific Flow URL - remember / at the end",
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "93d7fd94-334d-4e32-8b6e-a62177dbe787"
          },
          "runAfter": {
            "Initialize_variable_sharedWith": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_fullinventory": {
          "inputs": {
            "variables": [
              {
                "name": "fullinventory",
                "type": "string",
                "value": "@{parameters('FullInventory')}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "123147a1-2b66-46a2-b00c-5da59617652f"
          },
          "runAfter": {
            "Initialize_variable_hadFailure": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_hadFailure": {
          "inputs": {
            "variables": [
              {
                "name": "hadFailure",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "0c613549-625b-48ff-92da-5d1cdc2aa8e1"
          },
          "runAfter": {
            "Initialize_variable_Apps_New": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isNewToCoE": {
          "inputs": {
            "variables": [
              {
                "name": "isNewToCoE",
                "type": "boolean",
                "value": false
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "da60d580-6157-4fda-8254-11370c79ad70"
          },
          "runAfter": {
            "Initialize_updateInCoe": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_sharedWith": {
          "inputs": {
            "variables": [
              {
                "name": "sharedWith",
                "type": "Array"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "dd54511d-64b6-4b8a-ab22-26034d093191"
          },
          "runAfter": {
            "Initialize_shared_with_everyone": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_today": {
          "inputs": {
            "variables": [
              {
                "name": "today",
                "type": "string",
                "value": "@{utcNow()}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "8ca8be5f-f86b-4f1f-bbc6-9651578f9abb"
          },
          "runAfter": {
            "Initialize_variable_isNewToCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Insert_New_Apps": {
          "actions": {
            "Apply_to_each_new": {
              "actions": {
                "Check_if_App_Shared_with_Tenant_New": {
                  "actions": {
                    "only_if_not_SP_App_New": {
                      "actions": {
                        "Filter_array_New": {
                          "inputs": {
                            "from": "@outputs('Get_App_Role_Assignments_as_Admin_New')?['body/value']",
                            "where": "@equals(item()?['properties/principal/type'], 'Tenant')"
                          },
                          "metadata": {
                            "operationMetadataId": "d7074fba-593a-42ac-bae9-5c5f9d7195ca"
                          },
                          "runAfter": {
                            "Get_App_Role_Assignments_as_Admin_New": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query"
                        },
                        "Get_App_Role_Assignments_as_Admin_New": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins",
                              "connectionName": "shared_powerappsforadmins",
                              "operationId": "Get-AdminAppRoleAssignment"
                            },
                            "parameters": {
                              "$top": 250,
                              "api-version": "2016-11-01",
                              "app": "@items('Apply_to_each_new')?['name']",
                              "environment": "@triggerOutputs()?['body/admin_environmentname']"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "8df5f167-05c9-49ba-b8e8-6733d33d9f64"
                          },
                          "runAfter": {},
                          "runtimeConfiguration": {
                            "paginationPolicy": {
                              "minimumItemCount": 100000
                            }
                          },
                          "type": "OpenApiConnection"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@items('Apply_to_each_new')?['properties']?['embeddedApp']?['type']",
                            "SharepointFormApp"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "af6520c8-ccaf-4b7c-b341-4a7314ec5a4d"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "90f16347-c342-49d1-9553-2519c4e98c3d"
                  },
                  "runAfter": {},
                  "type": "Scope"
                },
                "Insert_New_App_Details": {
                  "actions": {
                    "Check_if_Orphan_-_New": {
                      "actions": {
                        "Insert_App_record_(creator_not_found)_New": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "CreateRecord"
                            },
                            "parameters": {
                              "entityName": "admin_apps",
                              "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                              "item/admin_adminrequirementriskassessmentstate": 597910000,
                              "item/admin_appconnections": "@outputs('Compose_comma-separated_text_of_all_connections_used_in_app')",
                              "item/admin_appcontainsbrokenconnections": false,
                              "item/admin_appcreatedon": "@items('Apply_to_each_new')?['properties/createdTime']",
                              "item/admin_appdeleted": false,
                              "item/admin_appdescription": "@items('Apply_to_each_new')?['properties/description']",
                              "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                              "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                              "item/admin_appexcusedfromarchival": false,
                              "item/admin_appiconuri": "@items('Apply_to_each_new')?['properties/backgroundImageUri']",
                              "item/admin_appid": "@items('Apply_to_each_new')?['name']",
                              "item/admin_appidstring": "@items('Apply_to_each_new')?['name']",
                              "item/admin_appmodifiedon": "@items('Apply_to_each_new')?['properties/lastModifiedTime']",
                              "item/admin_appplanclassification": "@coalesce(items('Apply_to_each_new')?['properties']?['appPlanClassification'], '')",
                              "item/admin_apppublished": "@if(empty(items('Apply_to_each_new')?['properties']?['lastPublishTime']), items('Apply_to_each_new')?['properties/createdTime'], items('Apply_to_each_new')?['properties']?['lastPublishTime'])",
                              "item/admin_appsharedgroups": "@items('Apply_to_each_new')?['properties/sharedGroupsCount']",
                              "item/admin_appsharedusers": "@items('Apply_to_each_new')?['properties/sharedUsersCount']",
                              "item/admin_appsharedwithtenant": "@if(greater(length(coalesce(body('Filter_array_new'), variables('sharedWith'))), 0), true, false)",
                              "item/admin_appusesdataversetables": false,
                              "item/admin_displayname": "@items('Apply_to_each_new')?['properties/displayName']",
                              "item/admin_dlpevaluationstatus": "@items('Apply_to_each_new')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                              "item/admin_dlplastevaluationdate": "@items('Apply_to_each_new')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                              "item/admin_iconbackgroundcolor": "@items('Apply_to_each_new')?['properties/backgroundColor']",
                              "item/admin_inappcatalog": false,
                              "item/admin_inappcatalogfeatured": false,
                              "item/admin_powerappsreleaseversion": "@items('Apply_to_each_new')?['tags/publisherVersion']",
                              "item/admin_powerappstype": "@coalesce(if(equals(items('Apply_to_each_new')?['properties']?['embeddedApp']?['type'], 'SharepointFormApp'), 597910002, 597910000), 597910000)",
                              "item/admin_requirement_5": false,
                              "item/admin_sharepointformurl": "@coalesce(items('Apply_to_each_new')?['properties']?['embeddedApp']?['listUrl'], '')",
                              "item/admin_usescustomapi": "@coalesce(items('Apply_to_each_new')?['properties']?['usesCustomApi'], '')",
                              "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(items('Apply_to_each_new')?['properties']?['usesOnlyGrandfatheredPremiumApis'], '')",
                              "item/admin_usesonpremisegateway": "@coalesce(items('Apply_to_each_new')?['properties']?['usesOnPremiseGateway'], '')",
                              "item/admin_usespremiumapi": "@coalesce(items('Apply_to_each_new')?['properties']?['usesPremiumApi'], '')",
                              "item/cr5d5_appisorphaned": "yes"
                            },
                            "retryPolicy": {
                              "count": 10,
                              "interval": "PT10S",
                              "type": "exponential"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "ba6e8de5-636c-48b8-815c-ec273ef2f3eb"
                          },
                          "runAfter": {},
                          "type": "OpenApiConnection"
                        }
                      },
                      "else": {
                        "actions": {
                          "Insert_App_record_New": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "CreateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_apps",
                                "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                "item/admin_AppOwner@odata.bind": "admin_makers(@{items('Apply_to_each_new')?['properties/owner/id']})",
                                "item/admin_adminrequirementriskassessmentstate": 597910000,
                                "item/admin_appcompany": "@outputs('Maker_Check_-_New')?['Body']?['usercompany']",
                                "item/admin_appconnections": "@outputs('Compose_comma-separated_text_of_all_connections_used_in_app')",
                                "item/admin_appcontainsbrokenconnections": false,
                                "item/admin_appcreatedon": "@items('Apply_to_each_new')?['properties/createdTime']",
                                "item/admin_appdeleted": false,
                                "item/admin_appdescription": "@items('Apply_to_each_new')?['properties/description']",
                                "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                "item/admin_appexcusedfromarchival": false,
                                "item/admin_appiconuri": "@items('Apply_to_each_new')?['properties/backgroundImageUri']",
                                "item/admin_appid": "@items('Apply_to_each_new')?['name']",
                                "item/admin_appidstring": "@items('Apply_to_each_new')?['name']",
                                "item/admin_appmodifiedon": "@items('Apply_to_each_new')?['properties/lastModifiedTime']",
                                "item/admin_appownerdisplayname": "@outputs('Maker_Check_-_New')?['Body']?['userdisplayname']",
                                "item/admin_appplanclassification": "@coalesce(items('Apply_to_each_new')?['properties']?['appPlanClassification'], '')",
                                "item/admin_apppublished": "@if(empty(items('Apply_to_each_new')?['properties']?['lastPublishTime']), items('Apply_to_each_new')?['properties/createdTime'], items('Apply_to_each_new')?['properties']?['lastPublishTime'])",
                                "item/admin_appsharedgroups": "@items('Apply_to_each_new')?['properties/sharedGroupsCount']",
                                "item/admin_appsharedusers": "@items('Apply_to_each_new')?['properties/sharedUsersCount']",
                                "item/admin_appsharedwithtenant": "@if(greater(length(coalesce(body('Filter_array_new'), variables('sharedWith'))), 0), true, false)",
                                "item/admin_appusesdataversetables": false,
                                "item/admin_city": "@outputs('Maker_Check_-_New')?['Body']?['usercity']",
                                "item/admin_country": "@outputs('Maker_Check_-_New')?['Body']?['usercountry']",
                                "item/admin_department": "@outputs('Maker_Check_-_New')?['Body']?['userdepartment']",
                                "item/admin_displayname": "@items('Apply_to_each_new')?['properties/displayName']",
                                "item/admin_dlpevaluationstatus": "@items('Apply_to_each_new')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                                "item/admin_dlplastevaluationdate": "@items('Apply_to_each_new')?['properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                                "item/admin_iconbackgroundcolor": "@items('Apply_to_each_new')?['properties/backgroundColor']",
                                "item/admin_inappcatalog": false,
                                "item/admin_inappcatalogfeatured": false,
                                "item/admin_powerappsreleaseversion": "@items('Apply_to_each_new')?['tags/publisherVersion']",
                                "item/admin_powerappstype": "@coalesce(if(equals(items('Apply_to_each_new')?['properties']?['embeddedApp']?['type'], 'SharepointFormApp'), 597910002, 597910000), 597910000)",
                                "item/admin_requirement_5": false,
                                "item/admin_sharepointformurl": "@coalesce(items('Apply_to_each_new')?['properties']?['embeddedApp']?['listUrl'], '')",
                                "item/admin_usescustomapi": "@coalesce(items('Apply_to_each_new')?['properties']?['usesCustomApi'], '')",
                                "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(items('Apply_to_each_new')?['properties']?['usesOnlyGrandfatheredPremiumApis'], '')",
                                "item/admin_usesonpremisegateway": "@coalesce(items('Apply_to_each_new')?['properties']?['usesOnPremiseGateway'], '')",
                                "item/admin_usespremiumapi": "@coalesce(items('Apply_to_each_new')?['properties']?['usesPremiumApi'], '')",
                                "item/cr5d5_appisorphaned": "no"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "b48c784f-da36-4b94-9e22-4c8b3ec75350"
                            },
                            "runAfter": {},
                            "type": "OpenApiConnection"
                          }
                        }
                      },
                      "expression": {
                        "equals": [
                          "@outputs('Maker_Check_-_New')?['Body']?['userisorphan']",
                          "True"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c59b7f13-e4fd-4c52-a21e-2dd55dff54fd"
                      },
                      "runAfter": {
                        "Maker_Check_-_New": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Maker_Check_-_New": {
                      "inputs": {
                        "body": {
                          "text": "@items('Apply_to_each_new')?['properties/owner/id']",
                          "text_1": "@items('Apply_to_each_new')?['properties/owner/displayName']"
                        },
                        "host": {
                          "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "67c2819f-034d-4650-947e-6ca2eb42aba5"
                      },
                      "runAfter": {},
                      "type": "Workflow"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "4d290c09-1157-458a-8b26-cfe9befefdf4"
                  },
                  "runAfter": {
                    "Prepare_App_Connection_References_New": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Prepare_App_Connection_References_New": {
                  "actions": {
                    "check_if_app_has_connections": {
                      "actions": {
                        "Compose_comma-separated_text_of_all_connections_used_in_app": {
                          "inputs": "@concat(join(body('Select_Connector_Display_Name'), ','), if(empty(items('Apply_to_each_new')?['properties/databaseReferences']), '', ',Microsoft Dataverse'))",
                          "metadata": {
                            "operationMetadataId": "87ab24ca-ecdb-476c-8ff9-e44c48012b60"
                          },
                          "runAfter": {
                            "Select_Connector_Display_Name": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        },
                        "Parse_JSON_-_Connection_References_New": {
                          "inputs": {
                            "content": "@items('Apply_to_each_new')?['properties/connectionReferences']",
                            "schema": {
                              "items": {
                                "properties": {
                                  "apiTier": {
                                    "type": "string"
                                  },
                                  "bypassConsent": {
                                    "type": "boolean"
                                  },
                                  "displayName": {
                                    "type": "string"
                                  },
                                  "iconUri": {
                                    "type": "string"
                                  },
                                  "id": {
                                    "type": "string"
                                  },
                                  "isCustomApiConnection": {
                                    "type": "boolean"
                                  },
                                  "isOnPremiseConnection": {
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "iconUri",
                                  "displayName",
                                  "isOnPremiseConnection",
                                  "isCustomApiConnection",
                                  "bypassConsent",
                                  "id"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "5eb73aeb-df0a-46cb-824e-dde6d131f666"
                          },
                          "runAfter": {},
                          "type": "ParseJson"
                        },
                        "Select_Connector_Display_Name": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_New')",
                            "select": "@item()['displayName']"
                          },
                          "metadata": {
                            "operationMetadataId": "238dd0e7-24b0-4e1d-8616-900dd144aa85"
                          },
                          "runAfter": {
                            "Parse_JSON_-_Connection_References_New": [
                              "Succeeded"
                            ]
                          },
                          "type": "Select"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@items('Apply_to_each_new')?['properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "a5819d5c-d3c7-4ca4-8036-63b5affecede"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "3f30e051-043d-4094-8f79-80a34f7da6a1"
                  },
                  "runAfter": {
                    "Check_if_App_Shared_with_Tenant_New": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Store_App_Connection_References_New": {
                  "actions": {
                    "Check_if_App_Connection_References_are_not_null_new": {
                      "actions": {
                        "Apply_to_each_Connection_Reference_new": {
                          "actions": {
                            "Connecor_Name_3": {
                              "inputs": "@last(outputs('split_on_slash_3'))",
                              "metadata": {
                                "operationMetadataId": "6b313c34-dab6-4ddf-acf5-40eaaa86d0d3"
                              },
                              "runAfter": {
                                "split_on_slash_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            },
                            "ConnectorID_3": {
                              "inputs": "@items('Apply_to_each_Connection_Reference_new')['id']",
                              "metadata": {
                                "operationMetadataId": "9c1201f0-cbf2-4378-87d5-b872bbbd16c8"
                              },
                              "runAfter": {},
                              "type": "Compose"
                            },
                            "Filter_current_app_Connector_3": {
                              "inputs": {
                                "from": "@outputs('List_Connectors')?['body/value']",
                                "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_3'))"
                              },
                              "metadata": {
                                "operationMetadataId": "e910b01d-f090-446b-808c-970fdf4ed475"
                              },
                              "runAfter": {
                                "Connecor_Name_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query"
                            },
                            "mark_broken_connector_or_insert_connection_reference_3": {
                              "actions": {
                                "Create_a_new_App_Connection_New": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_connectionreferences",
                                      "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_new')?['name']})",
                                      "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_app_Connector_3'))?['admin_connectorid']})",
                                      "item/admin_displayname": "@items('Apply_to_each_Connection_Reference_new')?['displayName']"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "480c5cb1-a114-4310-b6d8-a1a1de450884"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "else": {
                                "actions": {
                                  "Mark_app_as_having_broken_connections_New": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_appcontainsbrokenconnections": true,
                                        "recordId": "@items('Apply_to_each_new')?['name']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "19e64149-da4f-49b7-9eda-8ec66ef532c6"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "greater": [
                                  "@length(body('Filter_current_app_Connector_3'))",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "119d5d60-6d7d-404c-88ce-a8ef3dca5513"
                              },
                              "runAfter": {
                                "Filter_current_app_Connector_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "split_on_slash_3": {
                              "inputs": "@split(outputs('ConnectorID_3'), '/')",
                              "metadata": {
                                "operationMetadataId": "e5288aa4-054d-4be8-ac1e-e45d9190f6d0"
                              },
                              "runAfter": {
                                "ConnectorID_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            }
                          },
                          "foreach": "@body('Filter_non_custom_new')",
                          "metadata": {
                            "operationMetadataId": "d4ba3472-fbe7-4378-a1b2-3d704db895c5"
                          },
                          "runAfter": {
                            "Filter_non_custom_new": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Apply_to_each_Custom_Connection_Reference_new": {
                          "actions": {
                            "Connecor_Name_custom_3": {
                              "inputs": "@last(outputs('split_on_slash_custom_3'))",
                              "metadata": {
                                "operationMetadataId": "92980f30-3c72-45ba-a3da-a5dfa2fa4d61"
                              },
                              "runAfter": {
                                "split_on_slash_custom_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            },
                            "ConnectorID_custom_3": {
                              "inputs": "@items('Apply_to_each_Custom_Connection_Reference_new')['id']",
                              "metadata": {
                                "operationMetadataId": "10c85748-7532-4917-8f4c-276e11f8caf3"
                              },
                              "runAfter": {},
                              "type": "Compose"
                            },
                            "Filter_current_app_Connector_custom_3": {
                              "inputs": {
                                "from": "@outputs('List_Connectors')?['body/value']",
                                "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_custom_3'))"
                              },
                              "metadata": {
                                "operationMetadataId": "8e0cb69d-ba0a-409d-b1e3-d3f709af76f3"
                              },
                              "runAfter": {
                                "Connecor_Name_custom_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query"
                            },
                            "mark_broken_connector_or_insert_connection_reference_for_custom_3": {
                              "actions": {
                                "Create_a_new_App_Connection_for_Custom_3": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_connectionreferences",
                                      "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_new')?['name']})",
                                      "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_app_Connector_custom_3'))?['admin_connectorid']})",
                                      "item/admin_displayname": "@items('Apply_to_each_Custom_Connection_Reference_new')?['displayName']"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "911ca481-4b11-4fba-9c7d-24426cc3cf74"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "else": {
                                "actions": {
                                  "Mark_app_as_having_broken_connections_for_custom_3": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_appcontainsbrokenconnections": true,
                                        "recordId": "@items('Apply_to_each_new')?['name']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "17c20260-ea84-4615-8f57-2e443470d63c"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "greater": [
                                  "@length(body('Filter_current_app_Connector_custom_3'))",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "9a8e4420-ef42-478d-9d66-78db62f02a97"
                              },
                              "runAfter": {
                                "Filter_current_app_Connector_custom_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "split_on_slash_custom_3": {
                              "inputs": "@split(outputs('ConnectorID_custom_3'), '/')",
                              "metadata": {
                                "operationMetadataId": "61f2b286-0d98-4404-a5d3-bc359fa2e8f6"
                              },
                              "runAfter": {
                                "ConnectorID_custom_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose"
                            }
                          },
                          "foreach": "@body('Filter_custom_3')",
                          "metadata": {
                            "operationMetadataId": "63b4f6ad-a387-43cc-9386-56843479a5a4"
                          },
                          "runAfter": {
                            "Filter_custom_3": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Filter_custom_3": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_New')",
                            "where": "@equals(item()['isCustomApiConnection'], true)"
                          },
                          "metadata": {
                            "operationMetadataId": "f158354b-e6ae-473a-b0a5-e4bee2189d70"
                          },
                          "runAfter": {
                            "Apply_to_each_Connection_Reference_new": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query"
                        },
                        "Filter_non_custom_new": {
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_New')",
                            "where": "@equals(item()['isCustomApiConnection'], false)"
                          },
                          "metadata": {
                            "operationMetadataId": "54e4d945-f9ce-4a01-98f7-ff500134d0bc"
                          },
                          "runAfter": {},
                          "type": "Query"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@items('Apply_to_each_new')?['properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "d7521650-f2cc-42b0-b1a6-54bed5aaa6d0"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "e777bd7f-0021-4137-b4fd-806aad43873e"
                  },
                  "runAfter": {
                    "Insert_New_App_Details": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "Store_App_Dataverse_References_New": {
                  "actions": {
                    "Check_if_App_Database_References_are_not_null_New": {
                      "actions": {
                        "Insert_CDS_Native_Connection_Reference": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "CreateRecord"
                            },
                            "parameters": {
                              "entityName": "admin_connectionreferences",
                              "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each_new')?['name']})",
                              "item/admin_Connector@odata.bind": "admin_connectors(@{variables('DataverseConnectorGUID')})",
                              "item/admin_displayname": "Microsoft Dataverse"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "558b30ca-edb4-409b-baa4-7d85bf38da86"
                          },
                          "runAfter": {
                            "Mark_app_as_using_dataverse_new": [
                              "Succeeded"
                            ]
                          },
                          "type": "OpenApiConnection"
                        },
                        "Mark_app_as_using_dataverse_new": {
                          "inputs": {
                            "authentication": "@parameters('$authentication')",
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "UpdateRecord"
                            },
                            "parameters": {
                              "entityName": "admin_apps",
                              "item/admin_appusesdataversetables": true,
                              "recordId": "@items('Apply_to_each_new')?['name']"
                            },
                            "retryPolicy": {
                              "count": 10,
                              "interval": "PT10S",
                              "type": "exponential"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "4ed45610-1a13-468b-a8d9-47039c33af69"
                          },
                          "runAfter": {},
                          "type": "OpenApiConnection"
                        }
                      },
                      "else": {
                        "actions": {
                          "Mark_app_as_not_using_dataverse_new": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "UpdateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_apps",
                                "item/admin_appusesdataversetables": false,
                                "recordId": "@items('Apply_to_each_new')?['name']"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "c20f37dd-7c00-43af-80b3-6454b9427462"
                            },
                            "runAfter": {},
                            "type": "OpenApiConnection"
                          }
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@empty(items('Apply_to_each_new')?['properties/databaseReferences'])",
                            "@true"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "e496a886-c37b-4d58-95bb-eba441237463"
                      },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "e94b9c52-606c-46af-bcec-3fc44da47b2c"
                  },
                  "runAfter": {
                    "Store_App_Connection_References_New": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                }
              },
              "foreach": "@variables('Apps_New')",
              "metadata": {
                "operationMetadataId": "e8a6a664-114d-4027-911f-57d56921339d"
              },
              "runAfter": {},
              "type": "Foreach"
            }
          },
          "metadata": {
            "operationMetadataId": "e2c40d24-4249-43d8-8404-482ebe76a938"
          },
          "runAfter": {
            "Set_hadFailure_true_-_load_arrays": [
              "Succeeded",
              "Skipped"
            ]
          },
          "type": "Scope"
        },
        "Load_Arrays": {
          "actions": {
            "Apply_to_each_App": {
              "actions": {
                "Get_the_App": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem"
                    },
                    "parameters": {
                      "$select": "admin_appid,admin_appmodifiedon,admin_appsharedgroups,admin_appsharedusers, _admin_appowner_value",
                      "entityName": "admin_apps",
                      "recordId": "@items('Apply_to_each_App')?['name']"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "d36e4a02-a990-4085-8dc6-7634d45a3351"
                  },
                  "runAfter": {
                    "Reset_updateInCoe": [
                      "Succeeded"
                    ]
                  },
                  "type": "OpenApiConnection"
                },
                "Reset_isNewToCoE": {
                  "inputs": {
                    "name": "isNewToCoE",
                    "value": "@false"
                  },
                  "metadata": {
                    "operationMetadataId": "d62b467c-3b8c-4018-8a10-9f1353fd9b24"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "Reset_updateInCoe": {
                  "inputs": {
                    "name": "updateInCoe",
                    "value": "@false"
                  },
                  "metadata": {
                    "operationMetadataId": "40364ca2-26ff-4121-abf5-4234299e2ddf"
                  },
                  "runAfter": {
                    "Reset_isNewToCoE": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "See_if_new_to_CoE": {
                  "actions": {
                    "Append_to_new_array": {
                      "inputs": {
                        "name": "Apps_New",
                        "value": "@items('Apply_to_each_App')"
                      },
                      "metadata": {
                        "operationMetadataId": "ba1daa16-4a36-4f17-a835-e110ed46942d"
                      },
                      "runAfter": {},
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Catch_case_where_coe_last_modified_date_is_null_": {
                        "inputs": {
                          "name": "updateInCoe",
                          "value": "@true"
                        },
                        "metadata": {
                          "operationMetadataId": "16a513f1-0f3d-4cb3-9aca-d76eaa10b3cb"
                        },
                        "runAfter": {
                          "LastDateModfiedCoE": [
                            "Failed"
                          ]
                        },
                        "type": "SetVariable"
                      },
                      "Catch_case_where_product_last_modified_date_is_null": {
                        "inputs": {
                          "name": "updateInCoe",
                          "value": "@true"
                        },
                        "metadata": {
                          "operationMetadataId": "915e3835-2ec8-4b3f-a4cd-96fa6aa6a23a"
                        },
                        "runAfter": {
                          "LastDateModifiedProduct": [
                            "Failed"
                          ]
                        },
                        "type": "SetVariable"
                      },
                      "LastDateModfiedCoE": {
                        "inputs": "@coalesce(formatDateTime(outputs('Get_the_App')?['body/admin_appmodifiedon'], 'yyyy-MM-dd HH:mm:ss'), '')",
                        "metadata": {
                          "operationMetadataId": "f7030464-fb76-40f8-a74d-1d7d7a0bea64"
                        },
                        "runAfter": {
                          "Catch_case_where_product_last_modified_date_is_null": [
                            "Succeeded",
                            "Skipped"
                          ]
                        },
                        "type": "Compose"
                      },
                      "LastDateModifiedProduct": {
                        "inputs": "@formatDateTime(items('Apply_to_each_App')?['properties/lastModifiedTime'], 'yyyy-MM-dd HH:mm:ss')",
                        "metadata": {
                          "operationMetadataId": "90a51684-7388-413f-b2a6-75e2ec2f38c6"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      },
                      "See_if_needs_updated_in_CoE": {
                        "actions": {
                          "Append_to_edit_array": {
                            "inputs": {
                              "name": "Apps_Editted",
                              "value": "@items('Apply_to_each_App')"
                            },
                            "metadata": {
                              "operationMetadataId": "def32a25-709f-4d8f-b3b9-dd4b0d61694e"
                            },
                            "runAfter": {},
                            "type": "AppendToArrayVariable"
                          }
                        },
                        "expression": {
                          "or": [
                            {
                              "equals": [
                                "@variables('fullinventory')",
                                "True"
                              ]
                            },
                            {
                              "not": {
                                "equals": [
                                  "@items('Apply_to_each_App')?['properties/sharedGroupsCount']",
                                  "@outputs('Get_the_App')?['body/admin_appsharedgroups']"
                                ]
                              }
                            },
                            {
                              "not": {
                                "equals": [
                                  "@items('Apply_to_each_App')?['properties/sharedUsersCount']",
                                  "@outputs('Get_the_App')?['body/admin_appsharedusers']"
                                ]
                              }
                            },
                            {
                              "equals": [
                                "@variables('updateInCoe')",
                                "@true"
                              ]
                            },
                            {
                              "less": [
                                "@outputs('LastDateModfiedCoE')",
                                "@outputs('LastDateModifiedProduct')"
                              ]
                            }
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "806a92ee-48e4-4ed6-a125-56ac49ad8abb"
                        },
                        "runAfter": {
                          "Catch_case_where_coe_last_modified_date_is_null_": [
                            "Succeeded",
                            "Skipped"
                          ]
                        },
                        "type": "If"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('isNewToCoE')",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "156e9639-660a-43ee-a689-351151b0568e"
                  },
                  "runAfter": {
                    "Set_variable_isNewToCoE_to_true": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "type": "If"
                },
                "Set_variable_isNewToCoE_to_true": {
                  "inputs": {
                    "name": "isNewToCoE",
                    "value": "@true"
                  },
                  "metadata": {
                    "operationMetadataId": "5f0c7613-5c73-4f83-ad4a-09024fc13b4f"
                  },
                  "runAfter": {
                    "Get_the_App": [
                      "Failed"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@outputs('Get_Apps_as_Admin')?['body/value']",
              "metadata": {
                "operationMetadataId": "f633dfa8-70b3-4b04-bf3c-6abd0d3cf798"
              },
              "runAfter": {
                "Get_Apps_as_Admin": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Get_Apps_as_Admin": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins",
                  "connectionName": "shared_powerappsforadmins",
                  "operationId": "Get-AdminApps"
                },
                "parameters": {
                  "$top": 250,
                  "api-version": "2020-07-01",
                  "environment": "@triggerOutputs()?['body/admin_environmentname']"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "2510bbf9-b8b7-401a-99a2-ea1699a9ddb5"
              },
              "runAfter": {
                "List_Connectors": [
                  "Succeeded"
                ]
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              },
              "type": "OpenApiConnection"
            },
            "List_Connectors": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$select": "admin_displayname, admin_id, admin_name",
                  "entityName": "admin_connectors"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "4b170267-d5f5-4050-898c-f04b6e4db9cd"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "metadata": {
            "operationMetadataId": "d86e7b86-96c8-4a80-a762-1177c48f33b8"
          },
          "runAfter": {
            "Set_DataverseConnectorGUID": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Set_DataverseConnectorGUID": {
          "actions": {
            "List_rows": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$filter": "admin_name eq 'shared_commondataserviceforapps'",
                  "$select": "admin_connectorid",
                  "entityName": "admin_connectors"
                }
              },
              "metadata": {
                "operationMetadataId": "d90b292a-1a93-444f-9094-4612df99214d"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Set_variable_DataverseConnectorGUID": {
              "inputs": {
                "name": "DataverseConnectorGUID",
                "value": "@{first(outputs('List_rows')?['body/value'])?['admin_connectorid']}"
              },
              "metadata": {
                "operationMetadataId": "6ad63870-73ef-4127-a311-a24275cb0398"
              },
              "runAfter": {
                "List_rows": [
                  "Succeeded"
                ]
              },
              "type": "SetVariable"
            }
          },
          "metadata": {
            "operationMetadataId": "3ec723f2-5275-433f-9ecc-1912ab6498cc"
          },
          "runAfter": {
            "Initialize_variable_fullinventory": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Set_hadFailure_true_-_add_new_apps": {
          "inputs": {
            "name": "hadFailure",
            "value": "@true"
          },
          "metadata": {
            "operationMetadataId": "3398f51c-b9a7-4dbd-bb4d-e6300264a879"
          },
          "runAfter": {
            "Insert_New_Apps": [
              "Failed"
            ]
          },
          "type": "SetVariable"
        },
        "Set_hadFailure_true_-_editted_apps": {
          "inputs": {
            "name": "hadFailure",
            "value": "@true"
          },
          "metadata": {
            "operationMetadataId": "35b8ae4e-2508-4bfc-9e17-6419c47400b4"
          },
          "runAfter": {
            "Edit_Updated_Apps": [
              "Failed"
            ]
          },
          "type": "SetVariable"
        },
        "Set_hadFailure_true_-_load_arrays": {
          "inputs": {
            "name": "hadFailure",
            "value": "@true"
          },
          "metadata": {
            "operationMetadataId": "eb1f4cc1-9217-47a6-b294-7cde21e52c73"
          },
          "runAfter": {
            "Load_Arrays": [
              "Failed"
            ]
          },
          "type": "SetVariable"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "FullInventory": {
          "defaultValue": true,
          "metadata": {
            "description": "Determines if you want to only update objects that have changed, or all objects. Defaults to No. Switching to Yes will cause the flows to inventory every single app/flow/etc in the tenant and make the flows long running ",
            "schemaName": "admin_FullInventory"
          },
          "type": "Bool"
        },
        "Power Automate Environment Variable": {
          "defaultValue": "https://us.flow.microsoft.com/manage/environments/",
          "metadata": {
            "description": "Environment, including geographic location, for Power Automate - Ex for US: https://us.flow.microsoft.com/manage/environments/",
            "schemaName": "admin_PowerAutomateEnvironmentVariable"
          },
          "type": "String"
        }
      },
      "triggers": {
        "When_a_record_is_created_or_updated": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "SubscribeWebhookTrigger"
            },
            "parameters": {
              "subscriptionRequest/entityname": "admin_environment",
              "subscriptionRequest/message": 4,
              "subscriptionRequest/scope": 4
            }
          },
          "metadata": {
            "operationMetadataId": "c22023cc-57d8-4462-b092-0805922fe8b7"
          },
          "type": "OpenApiConnectionWebhook"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
