{
  "properties": {
    "connectionReferences": {
      "shared_commondataservice": {
        "api": {
          "name": "shared_commondataservice"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseLegacy"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataservice_1": {
        "api": {
          "name": "shared_commondataservice"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseLegacy"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "runtimeSource": "embedded"
      },
      "shared_office365users": {
        "api": {
          "name": "shared_office365users"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreOffice365Users"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerplatformforadmins": {
        "api": {
          "name": "shared_powerplatformforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Check_if_Dataverse_Environment,_If_false,_terminate": {
          "actions": {
            "Not_a_Dataverse_Environment_=_no_Model_Driven_Apps": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "689ae68e-451f-4ebc-a2c7-d88e3791ef8b"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_hascds']",
              "@false"
            ]
          },
          "metadata": {
            "operationMetadataId": "f3a94262-f642-4be0-ab9a-73daa2b3406d"
          },
          "runAfter": {
            "Check_if_Environment_Deleted._If_true,_terminate": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Dev_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Dev_SKU": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "bbcfb675-340f-47d6-9a0f-6f95df6eb781"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Developer"
            ]
          },
          "metadata": {
            "operationMetadataId": "7458dd25-e5e2-490f-8e00-9eec00fa09db"
          },
          "runAfter": {
            "Check_if_Dataverse_Environment,_If_false,_terminate": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Environment_Deleted._If_true,_terminate": {
          "actions": {
            "Terminate": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "837d6cef-2cf8-4a26-a249-f31b1bdaf84f"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentdeleted']",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "40c06c9d-30e7-41db-8c99-3f4270c0d33a"
          },
          "runAfter": {},
          "type": "If"
        },
        "Check_if_Teams_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Teams_SKU": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "80789eb0-3d60-4bbd-abb9-4134743c4ed5"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Teams"
            ]
          },
          "metadata": {
            "operationMetadataId": "b9187c2f-5e5c-48b1-944c-bf8f054a75a0"
          },
          "runAfter": {
            "Check_if_Dev_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_to_see_if_portal_Model_Driven_App_Exists._Store_in_Portal_COE_Entity": {
          "actions": {
            "Get_Environment_as_Admin": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins",
                  "connectionName": "shared_powerplatformforadmins",
                  "operationId": "GetSingleEnvironment"
                },
                "parameters": {
                  "api-version": "2018-10-01",
                  "environment": "@triggerOutputs()?['body/admin_environmentname']"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "ccd7a125-ae9d-4942-adcd-5ca3ebf16a40"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Loop_Through_each_website_record": {
              "actions": {
                "Get_the_owner_and_first_orphan_check": {
                  "actions": {
                    "Get_ADX_Website_Owner": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice",
                          "operationId": "GetItem_V2"
                        },
                        "parameters": {
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "id": "@body('Parse_Portals_JSON')?['_ownerid_value']",
                          "table": "systemusers"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "55cec539-50d1-4f0c-86a0-51b0fbf7e1c2"
                      },
                      "runAfter": {
                        "Reset_isOrphaned_to_false": [
                          "Succeeded"
                        ]
                      },
                      "type": "OpenApiConnection"
                    },
                    "Get_Azure_AD_object_ID_column_for_system_user_table._See_if_Null": {
                      "actions": {
                        "Set_isOrphaned_to_true": {
                          "inputs": {
                            "name": "isOrphaned",
                            "value": "@true"
                          },
                          "metadata": {
                            "operationMetadataId": "35209919-01fe-4cfd-811a-ce672c790c95"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "equals": [
                          "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']",
                          "@null"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "6eaabe0e-7656-4bb2-b1e8-515ce60ee98a"
                      },
                      "runAfter": {
                        "Get_ADX_Website_Owner": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Reset_isOrphaned_to_false": {
                      "inputs": {
                        "name": "isOrphaned",
                        "value": "@false"
                      },
                      "metadata": {
                        "operationMetadataId": "462572b1-3395-4bf3-8644-a3da0547b9c1"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "686c296a-7773-47a0-a3c7-0275270bcf24"
                  },
                  "runAfter": {
                    "UniqueNameString": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "If_did_not_return_rows_then_new_to_Coe_else_get_portal_GUID": {
                  "actions": {
                    "Set_isNewToCoEto_true": {
                      "inputs": {
                        "name": "isNewToCoE",
                        "value": "@true"
                      },
                      "metadata": {
                        "operationMetadataId": "bc355ca5-1b21-4ee3-a47d-6c96f4a00fb6"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "PortalGUID": {
                        "description": "first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalid']",
                        "inputs": "@first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalid']",
                        "metadata": {
                          "operationMetadataId": "e42d8c9b-abe9-4752-9aae-165ed222ec66"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      },
                      "PortalLastModified": {
                        "description": "first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalmodifiedon']",
                        "inputs": "@first(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])['admin_portalmodifiedon']",
                        "metadata": {
                          "operationMetadataId": "38ac52a5-e186-491e-be7a-e3fcc4cb7c06"
                        },
                        "runAfter": {
                          "PortalGUID": [
                            "Succeeded"
                          ]
                        },
                        "type": "Compose"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@length(outputs('List_Portals_that_match_by_Portal_Unique_Name')?['body/value'])",
                      0
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "88ea4b13-1451-4fd8-93fb-8eabd2d7734d"
                  },
                  "runAfter": {
                    "List_Portals_that_match_by_Portal_Unique_Name": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "List_Portals_that_match_by_Portal_Unique_Name": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_portaluniquename eq '@{outputs('UniqueNameString')}'",
                      "$select": "admin_portalid, admin_portalmodifiedon",
                      "entityName": "admin_portals"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "b9ea12dc-7fca-4c95-8558-c0d5272e0ebd"
                  },
                  "runAfter": {
                    "Get_the_owner_and_first_orphan_check": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 5000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "Parse_Portals_JSON": {
                  "inputs": {
                    "content": "@items('Loop_Through_each_website_record')",
                    "schema": {
                      "properties": {
                        "@@odata.etag": {
                          "type": "string"
                        },
                        "@@odata.id": {
                          "type": "string"
                        },
                        "ItemInternalId": {
                          "type": "string"
                        },
                        "_adx_defaultlanguage_type": {
                          "type": "string"
                        },
                        "_adx_defaultlanguage_value": {
                          "type": "string"
                        },
                        "_adx_footerwebtemplateid_type": {
                          "type": "string"
                        },
                        "_adx_footerwebtemplateid_value": {
                          "type": "string"
                        },
                        "_adx_headerwebtemplateid_type": {
                          "type": "string"
                        },
                        "_adx_headerwebtemplateid_value": {
                          "type": "string"
                        },
                        "_createdby_type": {
                          "type": "string"
                        },
                        "_createdby_value": {
                          "type": "string"
                        },
                        "_modifiedby_type": {
                          "type": "string"
                        },
                        "_modifiedby_value": {
                          "type": "string"
                        },
                        "_ownerid_type": {
                          "type": "string"
                        },
                        "_ownerid_value": {
                          "type": "string"
                        },
                        "_owningbusinessunit_type": {
                          "type": "string"
                        },
                        "_owningbusinessunit_value": {
                          "type": "string"
                        },
                        "_statecode_label": {
                          "type": "string"
                        },
                        "_statuscode_label": {
                          "type": "string"
                        },
                        "adx_name": {
                          "type": "string"
                        },
                        "adx_primarydomainname": {
                          "type": "string"
                        },
                        "adx_website_language": {
                          "type": "integer"
                        },
                        "adx_websiteid": {
                          "type": "string"
                        },
                        "createdon": {
                          "type": "string"
                        },
                        "modifiedon": {
                          "type": "string"
                        },
                        "statecode": {
                          "type": "integer"
                        },
                        "statuscode": {
                          "type": "integer"
                        },
                        "versionnumber": {
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "ad127aca-2cb8-4c0c-ba25-86a8199e2603"
                  },
                  "runAfter": {
                    "Reset_isNewToCOE": [
                      "Succeeded"
                    ]
                  },
                  "type": "ParseJson"
                },
                "Reset_isNewToCOE": {
                  "inputs": {
                    "name": "isNewToCoE",
                    "value": "@false"
                  },
                  "metadata": {
                    "operationMetadataId": "c6d98347-58e5-481b-9872-30349188c9e8"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "See_if_Portal_is_In_COE_Inventory_Table_(admin_portal)": {
                  "actions": {
                    "Only_Proceed_if_Changed_since_last_update_in_CoE_or_FullInventory": {
                      "actions": {
                        "Check_if_made_by_system": {
                          "actions": {
                            "Update_Portal_(created_by_SYSTEM)": {
                              "inputs": {
                                "authentication": "@parameters('$authentication')",
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "UpdateRecord"
                                },
                                "parameters": {
                                  "entityName": "admin_portals",
                                  "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                  "item/admin_appownerdisplayname": "SYSTEM",
                                  "item/admin_hasportalmanagementapp": true,
                                  "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                  "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                  "item/admin_portalisophaned": false,
                                  "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                  "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                  "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                  "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                  "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                  "recordId": "@outputs('PortalGUID')"
                                },
                                "retryPolicy": {
                                  "count": 10,
                                  "interval": "PT10S",
                                  "type": "exponential"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "585c532f-9461-41ea-af3a-2debb4a7c1b1"
                              },
                              "runAfter": {},
                              "type": "OpenApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Recheck_Orphan_status": {
                                "actions": {
                                  "Get_Portal_Owner_Profile_Name_2": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users",
                                        "connectionName": "shared_office365users",
                                        "operationId": "UserProfile_V2"
                                      },
                                      "parameters": {
                                        "$select": "city,country,department,jobTitle,officeLocation,statusCode,userPrincipalName, displayName, id, companyName",
                                        "id": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "9023aed8-55f0-4dcb-9a7a-06a2907ff0b9"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  },
                                  "Switch": {
                                    "cases": {
                                      "200_Success": {
                                        "actions": {
                                          "Find_Portal_Maker": {
                                            "inputs": {
                                              "authentication": "@parameters('$authentication')",
                                              "host": {
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                "connectionName": "shared_commondataserviceforapps",
                                                "operationId": "ListRecords"
                                              },
                                              "parameters": {
                                                "$filter": "admin_makerid eq @{body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']}",
                                                "$select": "admin_makerid",
                                                "entityName": "admin_makers"
                                              },
                                              "retryPolicy": {
                                                "count": 10,
                                                "interval": "PT10S",
                                                "type": "exponential"
                                              }
                                            },
                                            "runAfter": {},
                                            "type": "OpenApiConnection"
                                          },
                                          "Update_or_Insert_App_Maker": {
                                            "actions": {
                                              "Update_Portal_Maker": {
                                                "inputs": {
                                                  "authentication": "@parameters('$authentication')",
                                                  "host": {
                                                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                    "connectionName": "shared_commondataserviceforapps",
                                                    "operationId": "UpdateRecord"
                                                  },
                                                  "parameters": {
                                                    "entityName": "admin_makers",
                                                    "item/admin_city": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/city']",
                                                    "item/admin_company": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/companyName']",
                                                    "item/admin_country": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/country']",
                                                    "item/admin_department": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/department']",
                                                    "item/admin_displayname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/displayName']",
                                                    "item/admin_jobtitle": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/jobTitle']",
                                                    "item/admin_makerisorphaned": false,
                                                    "item/admin_office": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/officeLocation']",
                                                    "item/admin_userprincipalname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/userPrincipalName']",
                                                    "recordId": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']"
                                                  },
                                                  "retryPolicy": {
                                                    "count": 10,
                                                    "interval": "PT10S",
                                                    "type": "exponential"
                                                  }
                                                },
                                                "runAfter": {},
                                                "type": "OpenApiConnection"
                                              }
                                            },
                                            "else": {
                                              "actions": {
                                                "Create_Portal_Maker": {
                                                  "inputs": {
                                                    "authentication": "@parameters('$authentication')",
                                                    "host": {
                                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                      "connectionName": "shared_commondataserviceforapps",
                                                      "operationId": "CreateRecord"
                                                    },
                                                    "parameters": {
                                                      "entityName": "admin_makers",
                                                      "item/admin_city": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/city']",
                                                      "item/admin_company": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/companyName']",
                                                      "item/admin_country": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/country']",
                                                      "item/admin_department": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/department']",
                                                      "item/admin_displayname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/displayName']",
                                                      "item/admin_jobtitle": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/jobTitle']",
                                                      "item/admin_makerid": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']",
                                                      "item/admin_makerisorphaned": false,
                                                      "item/admin_office": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/officeLocation']",
                                                      "item/admin_userprincipalname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/userPrincipalName']"
                                                    },
                                                    "retryPolicy": {
                                                      "count": 10,
                                                      "interval": "PT10S",
                                                      "type": "exponential"
                                                    }
                                                  },
                                                  "runAfter": {},
                                                  "type": "OpenApiConnection"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "greater": [
                                                "@length(outputs('Find_Portal_Maker')?['body/value'])",
                                                0
                                              ]
                                            },
                                            "runAfter": {
                                              "Find_Portal_Maker": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "If"
                                          }
                                        },
                                        "case": 200
                                      },
                                      "404_File_Not_Found": {
                                        "actions": {
                                          "Set_isOrphaned_true_on_recheck": {
                                            "inputs": {
                                              "name": "isOrphaned",
                                              "value": "@true"
                                            },
                                            "runAfter": {},
                                            "type": "SetVariable"
                                          }
                                        },
                                        "case": 404
                                      }
                                    },
                                    "default": {
                                      "actions": {}
                                    },
                                    "expression": "@outputs('Get_Portal_Owner_Profile_Name_2')['statusCode']",
                                    "metadata": {
                                      "operationMetadataId": "ab822301-99e0-42d2-81b5-8e1f6ba5e8cd"
                                    },
                                    "runAfter": {
                                      "Get_Portal_Owner_Profile_Name_2": [
                                        "Succeeded",
                                        "Failed"
                                      ]
                                    },
                                    "type": "Switch"
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "eb58f5f6-2612-4a1b-b7fb-224d8aedb517"
                                },
                                "runAfter": {},
                                "type": "If"
                              },
                              "Update_based_on_Orphan_Status": {
                                "actions": {
                                  "Update_Portal_Record": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_portals",
                                        "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                        "item/admin_PortalOwner@odata.bind": "admin_makers(@{body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']})",
                                        "item/admin_appownerdisplayname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/displayName']",
                                        "item/admin_hasportalmanagementapp": true,
                                        "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                        "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                        "item/admin_portalisophaned": false,
                                        "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                        "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                        "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                        "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                        "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                        "recordId": "@outputs('PortalGUID')"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "c850a1da-7b1a-4ce0-94d7-09fc601731ab"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Update_Portal_Record_(Abandoned)": {
                                      "inputs": {
                                        "authentication": "@parameters('$authentication')",
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "UpdateRecord"
                                        },
                                        "parameters": {
                                          "entityName": "admin_portals",
                                          "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                          "item/admin_appownerdisplayname": "@outputs('Get_Portal_Owner_Profile_Name_2')?['body/displayName']",
                                          "item/admin_hasportalmanagementapp": true,
                                          "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                          "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                          "item/admin_portalisophaned": true,
                                          "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                          "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                          "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                          "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                          "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']",
                                          "recordId": "@outputs('PortalGUID')"
                                        },
                                        "retryPolicy": {
                                          "count": 10,
                                          "interval": "PT10S",
                                          "type": "exponential"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "37838f16-80fc-402d-a4ff-bb8bfae7ab08"
                                      },
                                      "runAfter": {},
                                      "type": "OpenApiConnection"
                                    }
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "6b07c80e-551f-4828-9170-2283ec02018c"
                                },
                                "runAfter": {
                                  "Recheck_Orphan_status": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "If"
                              }
                            }
                          },
                          "expression": {
                            "equals": [
                              "@body('Get_ADX_Website_Owner')?['fullname']",
                              "SYSTEM"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e9f4a851-ebe8-482d-8fc9-a657e02ba077"
                          },
                          "runAfter": {},
                          "type": "If"
                        }
                      },
                      "expression": {
                        "or": [
                          {
                            "less": [
                              "@outputs('lastMod_from_COE')",
                              "@outputs('lastMod_from_Portal')"
                            ]
                          },
                          {
                            "equals": [
                              "@variables('fullInventory')",
                              "True"
                            ]
                          }
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "cfaa55b3-c84e-407f-a9fc-0f56a7011d0b"
                      },
                      "runAfter": {
                        "lastMod_from_Portal": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "lastMod_from_COE": {
                      "description": "coalesce(formatDateTime(outputs('PortalLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "inputs": "@coalesce(formatDateTime(outputs('PortalLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "metadata": {
                        "operationMetadataId": "d9566475-9445-49e5-be86-46f9cdd602c4"
                      },
                      "runAfter": {},
                      "type": "Compose"
                    },
                    "lastMod_from_Portal": {
                      "description": "formatDateTime(body('Parse_Portals_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "inputs": "@formatDateTime(body('Parse_Portals_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "metadata": {
                        "operationMetadataId": "4a80e789-a7e2-4f48-ae8e-5a6348e0a89f"
                      },
                      "runAfter": {
                        "lastMod_from_COE": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    }
                  },
                  "else": {
                    "actions": {
                      "Check_to_see_if_made_by_system_(owner_=_system)": {
                        "actions": {
                          "Create_New_Portal_Record_(Created_By_System)": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "CreateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_portals",
                                "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                "item/admin_appownerdisplayname": "SYSTEM",
                                "item/admin_hasportalmanagementapp": true,
                                "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                "item/admin_portalisophaned": false,
                                "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "5bc7864c-cd4e-4258-935c-29e2a5b5d1c3"
                            },
                            "runAfter": {
                              "This_means_it_was_system_created_and_automated": [
                                "Succeeded"
                              ]
                            },
                            "type": "OpenApiConnection"
                          },
                          "This_means_it_was_system_created_and_automated": {
                            "description": "System Created Path Block",
                            "inputs": "systemcreated",
                            "metadata": {
                              "operationMetadataId": "40c9fa5f-05f8-4239-97fd-163a56ab2148"
                            },
                            "runAfter": {},
                            "type": "Compose"
                          }
                        },
                        "else": {
                          "actions": {
                            "Insert_based_on_orphan_status": {
                              "actions": {
                                "Insert_Portal_Website_": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_portals",
                                      "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                      "item/admin_PortalOwner@odata.bind": "admin_makers(@{body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']})",
                                      "item/admin_hasportalmanagementapp": true,
                                      "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                      "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                      "item/admin_portalisophaned": false,
                                      "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                      "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                      "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                      "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                      "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']"
                                    },
                                    "retryPolicy": {
                                      "count": 10,
                                      "interval": "PT10S",
                                      "type": "exponential"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e2fc1c36-db88-4127-b67d-b44114a89882"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "description": "Add the portal to the inventory either with owner info or as an orphaned portal",
                              "else": {
                                "actions": {
                                  "Insert_Portal_Website": {
                                    "description": "Abandoned",
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "CreateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_portals",
                                        "item/admin_PortalEnvironment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                        "item/admin_hasportalmanagementapp": true,
                                        "item/admin_portalcreatedon": "@body('Parse_Portals_JSON')?['createdon']",
                                        "item/admin_portaldisplayname": "@body('Parse_Portals_JSON')?['adx_name']",
                                        "item/admin_portalisophaned": true,
                                        "item/admin_portalmodifiedon": "@body('Parse_Portals_JSON')?['modifiedon']",
                                        "item/admin_portaluniquename": "@outputs('UniqueNameString')",
                                        "item/admin_portalwebsiteid": "@body('Parse_Portals_JSON')?['adx_websiteid']",
                                        "item/admin_portalwebsitename": "@body('Parse_Portals_JSON')?['adx_primarydomainname']",
                                        "item/admin_portalwebsiterecordstatus": "@body('Parse_Portals_JSON')?['_statecode_label']"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "72332a3f-a3de-4bdb-8c16-77bdc9ee0481"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "e3b68e01-cc00-426d-82b6-538a793459e5"
                              },
                              "runAfter": {
                                "Recheck_Orphan_status_new": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "Recheck_Orphan_status_new": {
                              "actions": {
                                "Get_Portal_Owner_Profile_Name": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users",
                                      "connectionName": "shared_office365users",
                                      "operationId": "UserProfile_V2"
                                    },
                                    "parameters": {
                                      "$select": "city,country,department,jobTitle,officeLocation,statusCode,userPrincipalName, displayName, id, companyName",
                                      "id": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']"
                                    },
                                    "retryPolicy": {
                                      "count": 10,
                                      "interval": "PT10S",
                                      "type": "exponential"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "01f9d966-1608-4ea9-befa-0de3aab472c3"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                },
                                "Switch-_Either_return_success_or_failure_if_user_exists_in_tenant_as_0365_user": {
                                  "cases": {
                                    "200_Success": {
                                      "actions": {
                                        "Find_Portal_Maker_New": {
                                          "inputs": {
                                            "authentication": "@parameters('$authentication')",
                                            "host": {
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                              "connectionName": "shared_commondataserviceforapps",
                                              "operationId": "ListRecords"
                                            },
                                            "parameters": {
                                              "$filter": "admin_makerid eq @{body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']\r\n}",
                                              "$select": "admin_makerid",
                                              "entityName": "admin_makers"
                                            },
                                            "retryPolicy": {
                                              "count": 10,
                                              "interval": "PT10S",
                                              "type": "exponential"
                                            }
                                          },
                                          "runAfter": {},
                                          "type": "OpenApiConnection"
                                        },
                                        "Update_or_Insert_Portal_Maker_New": {
                                          "actions": {
                                            "Update_Portal_Maker_New": {
                                              "inputs": {
                                                "authentication": "@parameters('$authentication')",
                                                "host": {
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                  "connectionName": "shared_commondataserviceforapps",
                                                  "operationId": "UpdateRecord"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_makers",
                                                  "item/admin_city": "@outputs('Get_Portal_Owner_Profile_Name')?['body/city']",
                                                  "item/admin_company": "@outputs('Get_Portal_Owner_Profile_Name')?['body/companyName']",
                                                  "item/admin_country": "@outputs('Get_Portal_Owner_Profile_Name')?['body/country']",
                                                  "item/admin_department": "@outputs('Get_Portal_Owner_Profile_Name')?['body/department']",
                                                  "item/admin_displayname": "@outputs('Get_Portal_Owner_Profile_Name')?['body/displayName']",
                                                  "item/admin_jobtitle": "@outputs('Get_Portal_Owner_Profile_Name')?['body/jobTitle']",
                                                  "item/admin_makerisorphaned": false,
                                                  "item/admin_office": "@outputs('Get_Portal_Owner_Profile_Name')?['body/officeLocation']",
                                                  "item/admin_userprincipalname": "@outputs('Get_Portal_Owner_Profile_Name')?['body/userPrincipalName']",
                                                  "recordId": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']"
                                                },
                                                "retryPolicy": {
                                                  "count": 10,
                                                  "interval": "PT10S",
                                                  "type": "exponential"
                                                }
                                              },
                                              "runAfter": {},
                                              "type": "OpenApiConnection"
                                            }
                                          },
                                          "else": {
                                            "actions": {
                                              "Create_Portal_Maker_New": {
                                                "inputs": {
                                                  "authentication": "@parameters('$authentication')",
                                                  "host": {
                                                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                                    "connectionName": "shared_commondataserviceforapps",
                                                    "operationId": "CreateRecord"
                                                  },
                                                  "parameters": {
                                                    "entityName": "admin_makers",
                                                    "item/admin_city": "@outputs('Get_Portal_Owner_Profile_Name')?['body/city']",
                                                    "item/admin_company": "@outputs('Get_Portal_Owner_Profile_Name')?['body/companyName']",
                                                    "item/admin_country": "@outputs('Get_Portal_Owner_Profile_Name')?['body/country']",
                                                    "item/admin_department": "@outputs('Get_Portal_Owner_Profile_Name')?['body/department']",
                                                    "item/admin_displayname": "@outputs('Get_Portal_Owner_Profile_Name')?['body/displayName']",
                                                    "item/admin_jobtitle": "@outputs('Get_Portal_Owner_Profile_Name')?['body/jobTitle']",
                                                    "item/admin_makerid": "@body('Get_ADX_Website_Owner')?['azureactivedirectoryobjectid']",
                                                    "item/admin_makerisorphaned": false,
                                                    "item/admin_office": "@outputs('Get_Portal_Owner_Profile_Name')?['body/officeLocation']",
                                                    "item/admin_userprincipalname": "@outputs('Get_Portal_Owner_Profile_Name')?['body/userPrincipalName']"
                                                  },
                                                  "retryPolicy": {
                                                    "count": 10,
                                                    "interval": "PT10S",
                                                    "type": "exponential"
                                                  }
                                                },
                                                "runAfter": {},
                                                "type": "OpenApiConnection"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "greater": [
                                              "@length(outputs('Find_Portal_Maker_New')?['body/value'])",
                                              0
                                            ]
                                          },
                                          "runAfter": {
                                            "Find_Portal_Maker_New": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "If"
                                        }
                                      },
                                      "case": 200
                                    },
                                    "404_User_not_found_in_0365_Tenant": {
                                      "actions": {
                                        "Set_isOrphaned_true": {
                                          "inputs": {
                                            "name": "isOrphaned",
                                            "value": "@true"
                                          },
                                          "runAfter": {},
                                          "type": "SetVariable"
                                        }
                                      },
                                      "case": 404
                                    }
                                  },
                                  "default": {
                                    "actions": {}
                                  },
                                  "expression": "@outputs('Get_Portal_Owner_Profile_Name')['statusCode']",
                                  "metadata": {
                                    "operationMetadataId": "e14e8418-5b02-4641-ba81-f3e592b78b11"
                                  },
                                  "runAfter": {
                                    "Get_Portal_Owner_Profile_Name": [
                                      "Succeeded",
                                      "Failed"
                                    ]
                                  },
                                  "type": "Switch"
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "55b330dd-568e-40aa-8225-e58cf28a7214"
                              },
                              "runAfter": {},
                              "type": "If"
                            }
                          }
                        },
                        "expression": {
                          "equals": [
                            "@body('Get_ADX_Website_Owner')?['fullname']",
                            "SYSTEM"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "ba885afe-4f8a-48a8-89fa-bf97e03ac082"
                        },
                        "runAfter": {
                          "isNewToCoE_=true": [
                            "Succeeded"
                          ]
                        },
                        "type": "If"
                      },
                      "isNewToCoE_=true": {
                        "description": "We know that the item is actually new to the CCOE and needs an inventory record",
                        "inputs": "@variables('isNewToCoE')",
                        "metadata": {
                          "operationMetadataId": "2822ff3f-ee50-4bff-b1e0-1a4e499b8c17"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('isNewToCoE')",
                      "@false"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "49ea9c1d-0dde-4533-9204-afae3ea095ef"
                  },
                  "runAfter": {
                    "If_did_not_return_rows_then_new_to_Coe_else_get_portal_GUID": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "UniqueNameString": {
                  "description": "concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Portals_JSON')?['adx_websiteid'])",
                  "inputs": "@concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Portals_JSON')?['adx_websiteid'])",
                  "metadata": {
                    "operationMetadataId": "0e823a25-c53b-4ead-9b2f-5a6846388e44"
                  },
                  "runAfter": {
                    "Parse_Portals_JSON": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                }
              },
              "foreach": "@outputs('List_ADX_Websites')?['body/value']",
              "metadata": {
                "operationMetadataId": "28d6c640-419a-4512-acde-e99a864f36fa"
              },
              "runAfter": {
                "Remove_the_GUID_without_the_prefixes_from_using_old_connector": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Name_Length": {
              "description": "Return index where GUID value starts",
              "inputs": "@sub(length(body('Get_Environment_as_Admin')?['name']), 36)",
              "metadata": {
                "operationMetadataId": "535cc3e6-ce28-456c-b9e3-5a091321d0f8"
              },
              "runAfter": {
                "Get_Environment_as_Admin": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Remove_the_GUID_without_the_prefixes_from_using_old_connector": {
              "inputs": "@substring(body('Get_Environment_as_Admin')?['name'], int(outputs('Name_Length')), 36)",
              "metadata": {
                "operationMetadataId": "389a7b4b-a275-4a5b-8b0d-b4c32f606cd1"
              },
              "runAfter": {
                "Name_Length": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            }
          },
          "metadata": {
            "operationMetadataId": "1c2ecb0f-8c4b-466f-b857-1d11817c04e9"
          },
          "runAfter": {
            "Initialize_variable_fullInventory": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Clean_up_Envt_-_GitHub_1096": {
          "actions": {
            "Delete_all_portals_-_clean_up": {
              "actions": {
                "Delete_a_row_-_clean_up": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "DeleteRecord"
                    },
                    "parameters": {
                      "entityName": "admin_portals",
                      "recordId": "@items('Delete_all_portals_-_clean_up')?['admin_portalid']"
                    },
                    "retryPolicy": {
                      "count": 10,
                      "interval": "PT10S",
                      "type": "exponential"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "07df3330-e8c9-4e47-a3e2-336bd2cf45a2"
                  },
                  "runAfter": {},
                  "type": "OpenApiConnection"
                }
              },
              "foreach": "@outputs('List_portals_for_this_envt_-_clean_up')?['body/value']",
              "metadata": {
                "operationMetadataId": "0cd37228-593c-4203-91c4-6a76b0bf812f"
              },
              "runAfter": {
                "List_portals_for_this_envt_-_clean_up": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "List_portals_for_this_envt_-_clean_up": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$filter": "admin_portaluniquename eq null and _admin_portalenvironment_value eq '@{triggerOutputs()?['body/admin_environmentid']}'",
                  "$select": "admin_portalid",
                  "entityName": "admin_portals"
                }
              },
              "metadata": {
                "operationMetadataId": "17f05698-6ad2-454e-a7c5-b090a67b5bac"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 5000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "description": "Scope added to clean up duplicate records as we changed GUID scheme. Will delete this scope in a few months after repair is complete. ",
          "metadata": {
            "operationMetadataId": "54be14bb-1cd4-4a44-bc6f-c718912447c0"
          },
          "runAfter": {
            "Get_ADX_Websites._Terminate_if_no_portals": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_ADX_Websites._Terminate_if_no_portals": {
          "actions": {
            "List_ADX_Websites": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                  "connectionName": "shared_commondataservice_1",
                  "operationId": "GetItems_V2"
                },
                "parameters": {
                  "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                  "table": "adx_websites"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "8cbbdef7-bbba-4866-9349-a4e98aacf3cc"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 5000
                }
              },
              "type": "OpenApiConnection"
            },
            "Terminate_if_no_portals": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "5c459241-c436-4f36-8320-cb2d57db1cc5"
              },
              "runAfter": {
                "List_ADX_Websites": [
                  "Failed",
                  "TimedOut"
                ]
              },
              "type": "Terminate"
            }
          },
          "metadata": {
            "operationMetadataId": "dfd12277-62e7-4be6-8dd8-29e6050b42a1"
          },
          "runAfter": {
            "Check_if_Teams_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_Portals_Fails_-_Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_environmentname": "@triggerOutputs()?['body/admin_displayname']",
                  "item/admin_flowinstanceurl": "@concat(variables('flowEnvironment'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])",
                  "item/admin_name": "Admin | Sync Template v3 (Portals)"
                }
              },
              "metadata": {
                "operationMetadataId": "d5db16ab-818a-42d4-a4a2-dc62e3ca5d69"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Terminate_": {
              "inputs": {
                "runError": {
                  "code": "500",
                  "message": "Get Model Portals Failed"
                },
                "runStatus": "Failed"
              },
              "metadata": {
                "operationMetadataId": "a2d19b1b-441f-40cf-b755-71547e5f2836"
              },
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "type": "Terminate"
            }
          },
          "metadata": {
            "operationMetadataId": "1b69573d-0cf7-4375-a4ed-b49d90335966"
          },
          "runAfter": {
            "Check_to_see_if_portal_Model_Driven_App_Exists._Store_in_Portal_COE_Entity": [
              "Failed",
              "TimedOut"
            ]
          },
          "type": "Scope"
        },
        "Initialize_variable_flowEnvironment": {
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "bd10579e-5b9f-4b62-be36-4d3cb256e821"
          },
          "runAfter": {
            "Initialize_variable_isOrphaned": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_fullInventory": {
          "inputs": {
            "variables": [
              {
                "name": "fullInventory",
                "type": "string",
                "value": "@{parameters('FullInventory')}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "d8d6dceb-d371-4fe3-ab5e-2fe2d5dd07be"
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isNewToCoE": {
          "inputs": {
            "variables": [
              {
                "name": "isNewToCoE",
                "type": "boolean",
                "value": false
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "2176e2aa-8d64-4f29-9901-4ef53a8bc443"
          },
          "runAfter": {
            "Clean_up_Envt_-_GitHub_1096": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isOrphaned": {
          "inputs": {
            "variables": [
              {
                "name": "isOrphaned",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "f822b097-2d62-4eb3-9e6c-97fd22f13a74"
          },
          "runAfter": {
            "Initialize_variable_today": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_today": {
          "inputs": {
            "variables": [
              {
                "name": "today",
                "type": "string",
                "value": "@{utcNow()}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "d0b9a562-c43d-441d-9b4a-dbb758c64017"
          },
          "runAfter": {
            "Initialize_variable_isNewToCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "FullInventory": {
          "defaultValue": true,
          "metadata": {
            "description": "Determines if you want to only update objects that have changed, or all objects. Defaults to No. Switching to Yes will cause the flows to inventory every single app/flow/etc in the tenant and make the flows long running ",
            "schemaName": "admin_FullInventory"
          },
          "type": "Bool"
        },
        "Power Automate Environment Variable": {
          "defaultValue": "https://us.flow.microsoft.com/manage/environments/",
          "metadata": {
            "description": "Environment, including geographic location, for Power Automate - Ex for US: https://us.flow.microsoft.com/manage/environments/",
            "schemaName": "admin_PowerAutomateEnvironmentVariable"
          },
          "type": "String"
        }
      },
      "triggers": {
        "When_a_new_record_is_created_or_updated": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "SubscribeWebhookTrigger"
            },
            "parameters": {
              "subscriptionRequest/entityname": "admin_environment",
              "subscriptionRequest/message": 4,
              "subscriptionRequest/scope": 4
            }
          },
          "metadata": {
            "operationMetadataId": "845a9182-b274-4610-a101-a97eaa37ea74"
          },
          "type": "OpenApiConnectionWebhook"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
