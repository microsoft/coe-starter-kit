{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerplatformforadmins_1": {
        "api": {
          "name": "shared_powerplatformforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Deleted_Objects_in_Existing_Environments": {
          "actions": {
            "Apply_to_each_environment": {
              "actions": {
                "Call_Canvas_Helper_-_check_deleted": {
                  "inputs": {
                    "body": {
                      "boolean": true,
                      "boolean_1": "@variables('DeleteFromCoE')",
                      "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                      "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                    },
                    "host": {
                      "workflowReferenceName": "2e6ae3e2-8afb-eb11-94ef-002248237d7d"
                    }
                  },
                  "runAfter": {
                    "Call_each_object_type_helper_for_this_environment": [
                      "Succeeded"
                    ]
                  },
                  "type": "Workflow"
                },
                "Call_Cloud_Flows_Helper_-_check_deleted": {
                  "inputs": {
                    "body": {
                      "boolean": true,
                      "boolean_1": "@variables('DeleteFromCoE')",
                      "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                      "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                    },
                    "host": {
                      "workflowReferenceName": "6bd20554-9bfb-eb11-94ef-002248237d7d"
                    }
                  },
                  "runAfter": {
                    "Call_each_object_type_helper_for_this_environment": [
                      "Succeeded"
                    ]
                  },
                  "type": "Workflow"
                },
                "Call_MDA_Helper_-_check_deleted": {
                  "inputs": {
                    "body": {
                      "boolean": true,
                      "boolean_1": "@variables('DeleteFromCoE')",
                      "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                      "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                    },
                    "host": {
                      "workflowReferenceName": "9a470548-58fc-eb11-94ef-002248237f74"
                    }
                  },
                  "runAfter": {
                    "Call_each_object_type_helper_for_this_environment": [
                      "Succeeded"
                    ]
                  },
                  "type": "Workflow"
                },
                "Call_PVA_Helper_-_check_deleted": {
                  "inputs": {
                    "body": {
                      "boolean": true,
                      "boolean_1": "@variables('DeleteFromCoE')",
                      "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                      "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                    },
                    "host": {
                      "workflowReferenceName": "ffd82928-64fc-eb11-94ef-002248237d7d"
                    }
                  },
                  "runAfter": {
                    "Call_each_object_type_helper_for_this_environment": [
                      "Succeeded"
                    ]
                  },
                  "type": "Workflow"
                },
                "Call_each_object_type_helper_for_this_environment": {
                  "inputs": "Call each object type helper for this environment",
                  "runAfter": {},
                  "type": "Compose"
                },
                "check_return_-_Call_Canvas_Helper_-_check_deleted": {
                  "actions": {
                    "set_failure_occurred_true_-_Call_Canvas_Helper_-_check_deleted": {
                      "inputs": {
                        "name": "failureOccurred",
                        "value": "@true"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "expression": {
                    "not": {
                      "equals": [
                        "@outputs('Call_Canvas_Helper_-_check_deleted')?['Body']?['thereturnvalue']",
                        "pass"
                      ]
                    }
                  },
                  "runAfter": {
                    "Call_Canvas_Helper_-_check_deleted": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "check_return_-_Call_Cloud_Flows_Helper_-_check_deleted": {
                  "actions": {
                    "set_failure_occurred_true_-_Call_Cloud_Flows_Helper_-_check_deleted": {
                      "inputs": {
                        "name": "failureOccurred",
                        "value": "@true"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "expression": {
                    "not": {
                      "equals": [
                        "@outputs('Call_Cloud_Flows_Helper_-_check_deleted')?['Body']?['thereturnvalue']",
                        "pass"
                      ]
                    }
                  },
                  "runAfter": {
                    "Call_Cloud_Flows_Helper_-_check_deleted": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "check_return_-_Call_MDA_Helper_-_check_deleted": {
                  "actions": {
                    "set_failure_occurred_true_-_Call_MDA_Helper_-_check_deleted": {
                      "inputs": {
                        "name": "failureOccurred",
                        "value": "@true"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "expression": {
                    "not": {
                      "equals": [
                        "@outputs('Call_MDA_Helper_-_check_deleted')?['Body']?['thereturnvalue']",
                        "pass"
                      ]
                    }
                  },
                  "runAfter": {
                    "Call_MDA_Helper_-_check_deleted": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "check_return_-_Call_PVA_Helper_-_check_deleted": {
                  "actions": {
                    "set_failure_occurred_true_-_Call_PVA_Helper_-_check_deleted": {
                      "inputs": {
                        "name": "failureOccurred",
                        "value": "@true"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "expression": {
                    "not": {
                      "equals": [
                        "@outputs('Call_PVA_Helper_-_check_deleted')?['Body']?['thereturnvalue']",
                        "pass"
                      ]
                    }
                  },
                  "runAfter": {
                    "Call_PVA_Helper_-_check_deleted": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                }
              },
              "foreach": "@outputs('List_CoE_Environments_not_marked_deleted')?['body/value']",
              "runAfter": {},
              "runtimeConfiguration": {
                "concurrency": {
                  "repetitions": 50
                }
              },
              "type": "Foreach"
            }
          },
          "runAfter": {
            "List_CoE_Environments_not_marked_deleted": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Deletes_old_items_from_CoE_inventory": {
          "actions": {
            "Check_if_they_want_to_delete_from_CoE": {
              "actions": {
                "Delete_Each_App": {
                  "actions": {
                    "Delete_App": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_apps",
                          "recordId": "@items('Delete_Each_App')?['admin_appid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_Apps_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_Apps_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_Environment": {
                  "actions": {
                    "Delete_Environment": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_environments",
                          "recordId": "@items('Delete_Each_Environment')?['admin_environmentid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_Envts_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_Envts_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_Flow": {
                  "actions": {
                    "Delete_Flow": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_flows",
                          "recordId": "@items('Delete_Each_Flow')?['admin_flowid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_Flows_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_Flows_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_Flow_Action": {
                  "actions": {
                    "Delete_Flow_Action": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_flowactiondetails",
                          "recordId": "@items('Delete_Each_Flow_Action')?['admin_flowactiondetailid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_Flow_Actions_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_Flow_Actions_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_PVA": {
                  "actions": {
                    "Delete_PVA": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_pvas",
                          "recordId": "@items('Delete_Each_PVA')?['admin_pvaid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_PVAs_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_PVAs_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_PVA_Component": {
                  "actions": {
                    "Delete_PVA_Component": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_pvacomponents",
                          "recordId": "@items('Delete_Each_PVA_Component')?['admin_pvacomponentid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_PVA_Components_Marked_Deleted_To_Delete')?['body/value']",
                  "runAfter": {
                    "List_PVA_Components_Marked_Deleted_To_Delete": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_PVA_Component_Flow_1": {
                  "actions": {
                    "Delete_PVA_Component_Flow_1": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_pvacomponentflowlookups",
                          "recordId": "@items('Delete_Each_PVA_Component_Flow_1')?['admin_pvacomponentflowlookupid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_PVA_Component_Flows_with_Missing_Flow')?['body/value']",
                  "runAfter": {
                    "List_PVA_Component_Flows_with_Missing_Flow": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Delete_Each_PVA_Component_Flow_2": {
                  "actions": {
                    "Delete_PVA_Component_Flow_2": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord"
                        },
                        "parameters": {
                          "entityName": "admin_pvacomponentflowlookups",
                          "recordId": "@items('Delete_Each_PVA_Component_Flow_2')?['admin_pvacomponentflowlookupid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    }
                  },
                  "foreach": "@outputs('List_PVA_Component_Flows_with_Missing_PVA_Component')?['body/value']",
                  "runAfter": {
                    "List_PVA_Component_Flows_with_Missing_PVA_Component": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "List_Apps_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_appdeleted eq true",
                      "$select": "admin_appid",
                      "entityName": "admin_apps"
                    }
                  },
                  "runAfter": {},
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_Envts_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_environmentdeleted eq true",
                      "$select": "admin_environmentid",
                      "entityName": "admin_environments"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_PVA_Component_Flow_2": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_Flow_Actions_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_flowactiondetaildeleted eq true",
                      "$select": "admin_flowactiondetailid",
                      "entityName": "admin_flowactiondetails"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_Flow": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_Flows_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_flowdeleted eq true",
                      "$select": "admin_flowid",
                      "entityName": "admin_flows"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_App": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_PVA_Component_Flows_with_Missing_Flow": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "_admin_flow_value eq null",
                      "$select": "admin_pvacomponentflowlookupid",
                      "entityName": "admin_pvacomponentflowlookups"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_PVA_Component": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_PVA_Component_Flows_with_Missing_PVA_Component": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "_admin_pvacomponent_value eq null",
                      "$select": "admin_pvacomponentflowlookupid",
                      "entityName": "admin_pvacomponentflowlookups"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_PVA_Component_Flow_1": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_PVA_Components_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_componentdeleted eq true",
                      "$select": "admin_pvacomponentid",
                      "entityName": "admin_pvacomponents"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_PVA": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                },
                "List_PVAs_Marked_Deleted_To_Delete": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_pvadeleted eq true",
                      "$select": "admin_pvaid",
                      "entityName": "admin_pvas"
                    }
                  },
                  "runAfter": {
                    "Delete_Each_Flow_Action": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  },
                  "type": "OpenApiConnection"
                }
              },
              "expression": {
                "equals": [
                  "@variables('varDeleteFromCoE')",
                  "yes"
                ]
              },
              "runAfter": {},
              "type": "If"
            }
          },
          "description": "In the event the env var changes, we want to clean the inventory",
          "runAfter": {
            "Initialize_varNoBots": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_Environments": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins",
              "connectionName": "shared_powerplatformforadmins_1",
              "operationId": "Get-AdminEnvironment"
            },
            "parameters": {
              "api-version": "2020-09-01"
            },
            "retryPolicy": {
              "count": 10,
              "interval": "PT10S",
              "type": "exponential"
            }
          },
          "runAfter": {
            "Deletes_old_items_from_CoE_inventory": [
              "Succeeded"
            ]
          },
          "runtimeConfiguration": {
            "paginationPolicy": {
              "minimumItemCount": 100000
            }
          },
          "type": "OpenApiConnection"
        },
        "Initialize_DeleteFromCoE": {
          "inputs": {
            "variables": [
              {
                "name": "DeleteFromCoE",
                "type": "boolean",
                "value": "@if(equals(parameters('Also Delete From CoE'), 'yes'), true, false)"
              }
            ]
          },
          "runAfter": {
            "Initialize_varDeleteFromCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_GuidFound": {
          "inputs": {
            "variables": [
              {
                "name": "GuidFound",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Initialize_failureOccurred": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_failureOccurred": {
          "inputs": {
            "variables": [
              {
                "name": "failureOccurred",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "runAfter": {},
          "type": "InitializeVariable"
        },
        "Initialize_systemMaker": {
          "description": "SYSTEM maker is used to identify the owner record for Environments generated by the system, such as the default environment",
          "inputs": {
            "variables": [
              {
                "name": " systemMaker",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Initialize_GuidFound": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_varDeleteFromCoE": {
          "inputs": {
            "variables": [
              {
                "name": "varDeleteFromCoE",
                "type": "string",
                "value": "@parameters('Also Delete From CoE')"
              }
            ]
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_varNoBots": {
          "inputs": {
            "variables": [
              {
                "name": "varNoBots",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "runAfter": {
            "Initialize_DeleteFromCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_flowEnvironment": {
          "description": "Environment location specific Flow URL - remember / at the end",
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable')"
              }
            ]
          },
          "runAfter": {
            "Initialize_variable_today": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_today": {
          "inputs": {
            "variables": [
              {
                "name": "today",
                "type": "string",
                "value": "@{utcNow()}"
              }
            ]
          },
          "runAfter": {
            "Initialize_systemMaker": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "List_CoE_Environments_not_marked_deleted": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "ListRecords"
            },
            "parameters": {
              "$filter": "admin_environmentdeleted eq false",
              "$select": "admin_environmentid, admin_environmentsku, admin_hascds, admin_environmentname, admin_environmentcdsmetadataname, admin_environmentdeletedon",
              "entityName": "admin_environments"
            },
            "retryPolicy": {
              "count": 10,
              "interval": "PT10S",
              "type": "exponential"
            }
          },
          "runAfter": {
            "Newly_Deleted_Environments": [
              "Succeeded"
            ]
          },
          "runtimeConfiguration": {
            "paginationPolicy": {
              "minimumItemCount": 100000
            }
          },
          "type": "OpenApiConnection"
        },
        "List_CoE_Environments_not_marked_deleted_-_pre_new_deletes": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "ListRecords"
            },
            "parameters": {
              "$filter": "admin_environmentdeleted eq false",
              "$select": "admin_environmentid, admin_environmentsku, admin_environmentname, admin_environmentdeletedon",
              "entityName": "admin_environments"
            },
            "retryPolicy": {
              "count": 10,
              "interval": "PT10S",
              "type": "exponential"
            }
          },
          "runAfter": {
            "Get_Environments": [
              "Succeeded"
            ]
          },
          "runtimeConfiguration": {
            "paginationPolicy": {
              "minimumItemCount": 100000
            }
          },
          "type": "OpenApiConnection"
        },
        "Newly_Deleted_Environments": {
          "actions": {
            "For_Each_non_del_env_in_CoE": {
              "actions": {
                "Find_env_in_tenant": {
                  "inputs": {
                    "from": "@outputs('Get_Environments')?['body/value']",
                    "where": "@equals(item()?['name'], items('For_Each_non_del_env_in_CoE')?['admin_environmentname'])"
                  },
                  "runAfter": {},
                  "type": "Query"
                },
                "If_Not_Found,_mark_it_and_its_objects_as_deleted": {
                  "actions": {
                    "Call_Canvas_Helper_-_delete_all": {
                      "inputs": {
                        "body": {
                          "boolean": false,
                          "boolean_1": "@variables('DeleteFromCoE')",
                          "text": "@outputs('Mark_Environment_as_deleted')?['body/admin_environmentid']",
                          "text_1": "@items('For_Each_non_del_env_in_CoE')?['admin_environmentname']"
                        },
                        "host": {
                          "workflowReferenceName": "2e6ae3e2-8afb-eb11-94ef-002248237d7d"
                        }
                      },
                      "runAfter": {
                        "Mark_Environment_as_deleted": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow"
                    },
                    "Call_Cloud_Flow_Helper_-_delete_all": {
                      "inputs": {
                        "body": {
                          "boolean": false,
                          "boolean_1": "@variables('DeleteFromCoE')",
                          "text": "@outputs('Mark_Environment_as_deleted')?['body/admin_environmentid']",
                          "text_1": "@items('For_Each_non_del_env_in_CoE')?['admin_environmentname']"
                        },
                        "host": {
                          "workflowReferenceName": "6bd20554-9bfb-eb11-94ef-002248237d7d"
                        }
                      },
                      "runAfter": {
                        "Mark_Environment_as_deleted": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow"
                    },
                    "Call_MDA_Helper_-_delete_all": {
                      "inputs": {
                        "body": {
                          "boolean": false,
                          "boolean_1": "@variables('DeleteFromCoE')",
                          "text": "@outputs('Mark_Environment_as_deleted')?['body/admin_environmentid']",
                          "text_1": "@items('For_Each_non_del_env_in_CoE')?['admin_environmentname']"
                        },
                        "host": {
                          "workflowReferenceName": "9a470548-58fc-eb11-94ef-002248237f74"
                        }
                      },
                      "runAfter": {
                        "Mark_Environment_as_deleted": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow"
                    },
                    "Call_PVA_Helper_-_delete_all": {
                      "inputs": {
                        "body": {
                          "boolean": false,
                          "boolean_1": "@variables('DeleteFromCoE')",
                          "text": "@outputs('Mark_Environment_as_deleted')?['body/admin_environmentid']",
                          "text_1": "@items('For_Each_non_del_env_in_CoE')?['admin_environmentname']"
                        },
                        "host": {
                          "workflowReferenceName": "ffd82928-64fc-eb11-94ef-002248237d7d"
                        }
                      },
                      "runAfter": {
                        "Mark_Environment_as_deleted": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow"
                    },
                    "Mark_Environment_as_deleted": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "UpdateRecord"
                        },
                        "parameters": {
                          "entityName": "admin_environments",
                          "item/admin_environmentdeleted": true,
                          "item/admin_environmentdeletedon": "@utcNow()",
                          "recordId": "@items('For_Each_non_del_env_in_CoE')?['admin_environmentid']"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "runAfter": {},
                      "type": "OpenApiConnection"
                    },
                    "check_return_-_Call_Canvas_Helper_-_delete_all": {
                      "actions": {
                        "set_failure_occurred_true_-_Call_Canvas_Helper_-_delete_all": {
                          "inputs": {
                            "name": "failureOccurred",
                            "value": "@true"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Call_Canvas_Helper_-_delete_all')?['Body']?['thereturnvalue']",
                            "pass"
                          ]
                        }
                      },
                      "runAfter": {
                        "Call_Canvas_Helper_-_delete_all": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "check_return_-_Call_Cloud_Flow_Helper_-_delete_all": {
                      "actions": {
                        "set_failure_occurred_true_-_Call_Cloud_Flow_Helper_-_delete_all": {
                          "inputs": {
                            "name": "failureOccurred",
                            "value": "@true"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Call_Cloud_Flow_Helper_-_delete_all')?['Body']?['thereturnvalue']",
                            "pass"
                          ]
                        }
                      },
                      "runAfter": {
                        "Call_Cloud_Flow_Helper_-_delete_all": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "check_return_-_Call_MDA_Helper_-_delete_all": {
                      "actions": {
                        "set_failure_occurred_true_-_Call_MDA_Helper_-_delete_all": {
                          "inputs": {
                            "name": "failureOccurred",
                            "value": "@true"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Call_MDA_Helper_-_delete_all')?['Body']?['thereturnvalue']",
                            "pass"
                          ]
                        }
                      },
                      "runAfter": {
                        "Call_MDA_Helper_-_delete_all": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "check_return_-_Call_PVA_Helper_-_delete_all": {
                      "actions": {
                        "set_failure_occurred_true_-_Call_PVA_Helper_-_delete_all": {
                          "inputs": {
                            "name": "failureOccurred",
                            "value": "@true"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Call_PVA_Helper_-_delete_all')?['Body']?['thereturnvalue']",
                            "pass"
                          ]
                        }
                      },
                      "runAfter": {
                        "Call_PVA_Helper_-_delete_all": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "equals": [
                          "@length(body('Find_env_in_tenant'))",
                          0
                        ]
                      },
                      {
                        "not": {
                          "equals": [
                            "@items('For_Each_non_del_env_in_CoE')?['admin_environmentsku']",
                            "Default"
                          ]
                        }
                      }
                    ]
                  },
                  "runAfter": {
                    "Find_env_in_tenant": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                }
              },
              "foreach": "@outputs('List_CoE_Environments_not_marked_deleted_-_pre_new_deletes')?['body/value']",
              "runAfter": {},
              "runtimeConfiguration": {
                "concurrency": {
                  "repetitions": 50
                }
              },
              "type": "Foreach"
            }
          },
          "runAfter": {
            "List_CoE_Environments_not_marked_deleted_-_pre_new_deletes": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "See_if_anything_failed_above": {
          "actions": {
            "Terminate_Flow_with_Failure": {
              "inputs": {
                "runError": {
                  "code": "500",
                  "message": "Flow failed in at least one scope above"
                },
                "runStatus": "Failed"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@variables('failureOccurred')",
              "@true"
            ]
          },
          "runAfter": {
            "Deleted_Objects_in_Existing_Environments": [
              "Succeeded"
            ]
          },
          "type": "If"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Also Delete From CoE": {
          "defaultValue": "no",
          "metadata": {
            "description": "when we run \"Admin | Sync Template v2 (Check Deleted)\", delete the items from CoE (yes) or just mark deleted (no)",
            "schemaName": "admin_DeleteFromCoE"
          },
          "type": "String"
        },
        "Power Automate Environment Variable": {
          "defaultValue": "https://us.flow.microsoft.com/manage/environments/",
          "metadata": {
            "description": "Environment, including geographic location, for Power Automate - for example https://us.flow.microsoft.com/manage/environments/ for US environments",
            "schemaName": "admin_PowerAutomateEnvironmentVariable"
          },
          "type": "String"
        }
      },
      "triggers": {
        "Recurrence": {
          "recurrence": {
            "frequency": "Week",
            "interval": 2,
            "schedule": {
              "weekDays": [
                "Saturday"
              ]
            }
          },
          "type": "Recurrence"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
