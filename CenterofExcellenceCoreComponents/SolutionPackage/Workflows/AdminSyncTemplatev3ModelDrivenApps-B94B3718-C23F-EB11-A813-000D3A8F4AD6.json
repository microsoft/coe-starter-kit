{
  "properties": {
    "connectionReferences": {
      "shared_commondataservice_1": {
        "api": {
          "name": "shared_commondataservice"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseLegacy"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps_1": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerplatformforadmins_1": {
        "api": {
          "name": "shared_powerplatformforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "actions": {
        "Check_if_CDS,_terminate_if_false": {
          "actions": {
            "Not_CDS_so_no_Model_Driven_Apps": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "1bd5f7b3-aa2f-40c5-a6d0-67bbc2d717bc"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_hascds']",
              "@false"
            ]
          },
          "metadata": {
            "operationMetadataId": "4440a0f2-cf23-484d-9587-6946a6ee7641"
          },
          "runAfter": {
            "Check_if_Environment_Deleted,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Dev_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Dev_Sku": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "07a6b979-9dab-4f94-b95f-c357a54cb75c"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Developer"
            ]
          },
          "metadata": {
            "operationMetadataId": "4dd85ca3-5c81-4d3e-90ee-b5556f9d0877"
          },
          "runAfter": {
            "Check_if_CDS,_terminate_if_false": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Check_if_Environment_Deleted,_terminate_if_true": {
          "actions": {
            "Terminate_for_environments_marked_deleted": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "8393c639-d594-47ab-a1c2-6f3e33f29772"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentdeleted']",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "e165abd0-1603-49f2-a6a0-cf664881dbc2"
          },
          "runAfter": {},
          "type": "If"
        },
        "Check_if_Teams_SKU,_terminate_if_true": {
          "actions": {
            "Inquiry_not_supported_for_Teams_Sku": {
              "inputs": {
                "runStatus": "Succeeded"
              },
              "metadata": {
                "operationMetadataId": "cdfb59d4-ba2b-46ab-a63c-85f710056a20"
              },
              "runAfter": {},
              "type": "Terminate"
            }
          },
          "expression": {
            "equals": [
              "@triggerOutputs()?['body/admin_environmentsku']",
              "Teams"
            ]
          },
          "metadata": {
            "operationMetadataId": "8fb48f9d-524e-4eb4-bbed-1da1ae2b2bd6"
          },
          "runAfter": {
            "Check_if_Dev_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "If"
        },
        "Clean_up_Envt_-_GitHub_1345": {
          "actions": {
            "Delete_all_apps_-_clean_up": {
              "actions": {
                "Delete_a_row_-_clean_up": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "DeleteRecord"
                    },
                    "parameters": {
                      "entityName": "admin_apps",
                      "recordId": "@items('Delete_all_apps_-_clean_up')?['admin_appid']"
                    },
                    "retryPolicy": {
                      "count": 10,
                      "interval": "PT10S",
                      "type": "exponential"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "95d1efb7-3288-4b4e-9a8c-5fd6d923ed5b"
                  },
                  "runAfter": {},
                  "type": "OpenApiConnection"
                }
              },
              "foreach": "@outputs('List_apps_for_this_envt_-_clean_up')?['body/value']",
              "metadata": {
                "operationMetadataId": "2e899c6e-94ad-4327-b108-b4ff60a75965"
              },
              "runAfter": {
                "List_apps_for_this_envt_-_clean_up": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "List_apps_for_this_envt_-_clean_up": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords"
                },
                "parameters": {
                  "$filter": "admin_appuniquename eq null and _admin_appenvironment_value eq '@{triggerOutputs()?['body/admin_environmentid']}' and admin_powerappstype eq 597910001",
                  "$select": "admin_appid",
                  "entityName": "admin_apps"
                }
              },
              "metadata": {
                "operationMetadataId": "7a04584b-9eaf-4a92-bbb8-f9bf2df42138"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 5000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "description": "Scope added to clean up duplicate records as we changed GUID scheme. Will delete this scope in a few months after repair is complete and add to Bad Data cleanup flow instead",
          "metadata": {
            "operationMetadataId": "a12e74a1-a968-4332-9384-61e9257f3adf"
          },
          "runAfter": {
            "Get_App_Modules_Table._Fail_out_if_no_permissions_to_environment": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_App_Modules_Table._Fail_out_if_no_permissions_to_environment": {
          "actions": {
            "Fail_if_no_permissions": {
              "inputs": {
                "runError": {
                  "code": "404",
                  "message": "No Perissions to CDS Table"
                },
                "runStatus": "Failed"
              },
              "metadata": {
                "operationMetadataId": "1584c6a7-1072-4b7f-9404-037001e58632"
              },
              "runAfter": {
                "List_Model_Driven_Apps": [
                  "Failed",
                  "TimedOut"
                ]
              },
              "type": "Terminate"
            },
            "List_Model_Driven_Apps": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                  "connectionName": "shared_commondataservice_1",
                  "operationId": "GetItems_V2"
                },
                "parameters": {
                  "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                  "table": "appmodules"
                }
              },
              "metadata": {
                "operationMetadataId": "3d217051-2de9-4b80-8178-97ce292ab250"
              },
              "runAfter": {},
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              },
              "type": "OpenApiConnection"
            }
          },
          "metadata": {
            "operationMetadataId": "d8f07dd2-ba5f-4af1-aa27-1c57dbaa36ed"
          },
          "runAfter": {
            "Check_if_Teams_SKU,_terminate_if_true": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_Model_Driven_Apps_and_store_in_CoE_CDS_Entity": {
          "actions": {
            "Apply_to_each_Model_Driven_App": {
              "actions": {
                "Get_Owner_and_first_orphan_check": {
                  "actions": {
                    "Get_MDD_App_Creator": {
                      "inputs": {
                        "authentication": "@parameters('$authentication')",
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataservice",
                          "connectionName": "shared_commondataservice_1",
                          "operationId": "GetItem_V2"
                        },
                        "parameters": {
                          "dataset": "@triggerOutputs()?['body/admin_environmentcdsmetadataname']",
                          "id": "@body('Parse_Model_Driven_App_JSON')?['_createdby_value']",
                          "table": "systemusers"
                        },
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT10S",
                          "type": "exponential"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "e9d28fdd-e49e-42d0-9d62-e3c87831d4a0"
                      },
                      "runAfter": {
                        "Reset_isOrphaned_to_false": [
                          "Succeeded"
                        ]
                      },
                      "type": "OpenApiConnection"
                    },
                    "Reset_isOrphaned_to_false": {
                      "inputs": {
                        "name": "isOrphaned",
                        "value": "@false"
                      },
                      "metadata": {
                        "operationMetadataId": "00da8656-41bf-4492-844b-51df54e82976"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    },
                    "See_if_azureactivedirectoryobjectid_is_null": {
                      "actions": {
                        "Set_isOrphaned_to_true": {
                          "inputs": {
                            "name": "isOrphaned",
                            "value": "@true"
                          },
                          "metadata": {
                            "operationMetadataId": "44d023f5-2020-4957-98fa-8cdfd2459db9"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "expression": {
                        "equals": [
                          "@body('Get_MDD_App_Creator')?['azureactivedirectoryobjectid']",
                          "@null"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "43ef7682-68d4-4cf3-8344-3069019e8eed"
                      },
                      "runAfter": {
                        "Get_MDD_App_Creator": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "d56b5bca-a90e-4646-b615-e3dd035f3fac"
                  },
                  "runAfter": {
                    "UniqueNameString": [
                      "Succeeded"
                    ]
                  },
                  "type": "Scope"
                },
                "If_did_not_return_rows_then_new_to_Coe_else_get_app_GUID": {
                  "actions": {
                    "Set_isNewToCoE_to_true": {
                      "inputs": {
                        "name": "isNewToCoE",
                        "value": "@true"
                      },
                      "metadata": {
                        "operationMetadataId": "09147229-a306-46af-8f6f-6182475e6826"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "appGUID": {
                        "description": "first(outputs('List_Model_Driven_Apps_that_match_by_Unique_Name')?['body/value'])['admin_appid']",
                        "inputs": "@first(outputs('List_Model_Driven_Apps_that_match_by_Unique_Name')?['body/value'])['admin_appid']",
                        "metadata": {
                          "operationMetadataId": "ebdfd488-91b6-420d-a508-bbd0be4a1ed2"
                        },
                        "runAfter": {},
                        "type": "Compose"
                      },
                      "appLastModified": {
                        "description": "first(outputs('List_Model_Driven_Apps_that_match_by_Unique_Name')?['body/value'])['admin_appmodifiedon']",
                        "inputs": "@first(outputs('List_Model_Driven_Apps_that_match_by_Unique_Name')?['body/value'])['admin_appmodifiedon']",
                        "metadata": {
                          "operationMetadataId": "21c5d6a6-d76c-4cff-bcbf-2d54eb9275f9"
                        },
                        "runAfter": {
                          "appGUID": [
                            "Succeeded"
                          ]
                        },
                        "type": "Compose"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@length(outputs('List_Model_Driven_Apps_that_match_by_Unique_Name')?['body/value'])",
                      0
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "2dbbc638-9cff-44bf-a085-36ba04cec560"
                  },
                  "runAfter": {
                    "List_Model_Driven_Apps_that_match_by_Unique_Name": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "List_Model_Driven_Apps_that_match_by_Unique_Name": {
                  "inputs": {
                    "authentication": "@parameters('$authentication')",
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "ListRecords"
                    },
                    "parameters": {
                      "$filter": "admin_appuniquename eq '@{outputs('UniqueNameString')}'",
                      "$select": "admin_appid, admin_appmodifiedon",
                      "entityName": "admin_apps"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "2a276946-2b13-4a41-9221-2e7fc69b2505"
                  },
                  "runAfter": {
                    "Get_Owner_and_first_orphan_check": [
                      "Succeeded"
                    ]
                  },
                  "type": "OpenApiConnection"
                },
                "Parse_Model_Driven_App_JSON": {
                  "inputs": {
                    "content": "@items('Apply_to_each_Model_Driven_App')",
                    "schema": {
                      "properties": {
                        "@@odata.etag": {
                          "type": "string"
                        },
                        "@@odata.id": {
                          "type": "string"
                        },
                        "ItemInternalId": {
                          "type": "string"
                        },
                        "_componentstate_label": {
                          "type": "string"
                        },
                        "_createdby_type": {
                          "type": "string"
                        },
                        "_createdby_value": {
                          "type": "string"
                        },
                        "_modifiedby_type": {
                          "type": "string"
                        },
                        "_modifiedby_value": {
                          "type": "string"
                        },
                        "_navigationtype_label": {
                          "type": "string"
                        },
                        "_organizationid_type": {
                          "type": "string"
                        },
                        "_organizationid_value": {
                          "type": "string"
                        },
                        "appmoduleid": {
                          "type": "string"
                        },
                        "appmoduleidunique": {
                          "type": "string"
                        },
                        "componentstate": {
                          "type": "integer"
                        },
                        "createdon": {
                          "type": "string"
                        },
                        "descriptor": {
                          "type": "string"
                        },
                        "formfactor": {
                          "type": "integer"
                        },
                        "isdefault": {
                          "type": "boolean"
                        },
                        "isfeatured": {
                          "type": "boolean"
                        },
                        "ismanaged": {
                          "type": "boolean"
                        },
                        "modifiedon": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "navigationtype": {
                          "type": "integer"
                        },
                        "overwritetime": {
                          "type": "string"
                        },
                        "solutionid": {
                          "type": "string"
                        },
                        "uniquename": {
                          "type": "string"
                        },
                        "versionnumber": {
                          "type": "integer"
                        },
                        "webresourceid": {
                          "type": "string"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "ef1f1de6-3d98-42b8-826a-6b7681eebfc6"
                  },
                  "runAfter": {
                    "Reset_isNewToCoE": [
                      "Succeeded"
                    ]
                  },
                  "type": "ParseJson"
                },
                "Reset_isNewToCoE": {
                  "inputs": {
                    "name": "isNewToCoE",
                    "value": "@false"
                  },
                  "metadata": {
                    "operationMetadataId": "a9269a88-e96d-43d1-ad47-a1ca2245418e"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "See_if_app_already_in_CoE": {
                  "actions": {
                    "Only_proceed_if_changed_since_last_updated_in_CoE_or_FullInventory": {
                      "actions": {
                        "Check_if_made_by_System": {
                          "actions": {
                            "Update_Model_Driven_App_(created_by_SYSTEM)": {
                              "inputs": {
                                "authentication": "@parameters('$authentication')",
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "UpdateRecord"
                                },
                                "parameters": {
                                  "entityName": "admin_apps",
                                  "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                  "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                  "item/admin_appdeleted": false,
                                  "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                  "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                  "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                  "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                  "item/admin_appownerdisplayname": "SYSTEM",
                                  "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                  "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                  "item/admin_powerappstype": 597910001,
                                  "item/cr5d5_appisorphaned": "no",
                                  "recordId": "@outputs('appGUID')"
                                },
                                "retryPolicy": {
                                  "count": 10,
                                  "interval": "PT10S",
                                  "type": "exponential"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "9f8347df-c2e2-465d-934e-9f654d1bea74"
                              },
                              "runAfter": {},
                              "type": "OpenApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Recheck_Orphan_status": {
                                "actions": {
                                  "Check_if_Orphan_-_Edit": {
                                    "actions": {
                                      "Set_isOrphaned_true_Edit": {
                                        "inputs": {
                                          "name": "isOrphaned",
                                          "value": "@true"
                                        },
                                        "metadata": {
                                          "operationMetadataId": "0d04e207-3374-4b41-9512-3960155ee794"
                                        },
                                        "runAfter": {},
                                        "type": "SetVariable"
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "Set_isOrphaned_false_Edit": {
                                          "inputs": {
                                            "name": "isOrphaned",
                                            "value": "@false"
                                          },
                                          "metadata": {
                                            "operationMetadataId": "d9b15f5a-e827-4523-b491-572de606e2ae"
                                          },
                                          "runAfter": {},
                                          "type": "SetVariable"
                                        }
                                      }
                                    },
                                    "expression": {
                                      "equals": [
                                        "@outputs('Maker_Check_-_Edit')?['Body']?['userisorphan']",
                                        "True"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "807c0a4d-cd69-4221-a6fb-5ad369e83842"
                                    },
                                    "runAfter": {
                                      "Maker_Check_-_Edit": [
                                        "Succeeded"
                                      ]
                                    },
                                    "type": "If"
                                  },
                                  "Maker_Check_-_Edit": {
                                    "inputs": {
                                      "body": {
                                        "text": "@body('Get_MDD_App_Creator')?['azureactivedirectoryobjectid']",
                                        "text_1": "@body('Get_MDD_App_Creator')?['fullname']"
                                      },
                                      "host": {
                                        "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "0cb72125-e00e-442f-ad78-33336d02cd52"
                                    },
                                    "runAfter": {},
                                    "type": "Workflow"
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "7c58253e-dc05-4c1e-a3e7-be925414c3ec"
                                },
                                "runAfter": {},
                                "type": "If"
                              },
                              "Update_based_on_Orphan_Status": {
                                "actions": {
                                  "Update_App_record": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                        "item/admin_AppOwner@odata.bind": "admin_makers(@{body('Get_MDD_App_Creator')?['azureactivedirectoryobjectid']})",
                                        "item/admin_appcompany": "@outputs('Maker_Check_-_Edit')?['Body']?['usercompany']",
                                        "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                        "item/admin_appdeleted": false,
                                        "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                        "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                        "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                        "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                        "item/admin_appownerdisplayname": "@outputs('Maker_Check_-_Edit')?['Body']?['userdisplayname']",
                                        "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                        "item/admin_city": "@outputs('Maker_Check_-_Edit')?['Body']?['usercity']",
                                        "item/admin_country": "@outputs('Maker_Check_-_Edit')?['Body']?['usercountry']",
                                        "item/admin_department": "@outputs('Maker_Check_-_Edit')?['Body']?['userdepartment']",
                                        "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                        "item/admin_powerappstype": 597910001,
                                        "item/cr5d5_appisorphaned": "no",
                                        "recordId": "@outputs('appGUID')"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "a4da81fd-67c3-4f93-869c-3bd54e4fed5a"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Update_App_record_(Abandoned)": {
                                      "inputs": {
                                        "authentication": "@parameters('$authentication')",
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "UpdateRecord"
                                        },
                                        "parameters": {
                                          "entityName": "admin_apps",
                                          "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                          "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                          "item/admin_appdeleted": false,
                                          "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                          "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                          "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                          "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                          "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                          "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                          "item/admin_powerappstype": 597910001,
                                          "item/cr5d5_appisorphaned": "yes",
                                          "recordId": "@outputs('appGUID')"
                                        },
                                        "retryPolicy": {
                                          "count": 10,
                                          "interval": "PT10S",
                                          "type": "exponential"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "0ff0e804-2637-488e-bead-c82ff896680e"
                                      },
                                      "runAfter": {},
                                      "type": "OpenApiConnection"
                                    }
                                  }
                                },
                                "expression": {
                                  "equals": [
                                    "@variables('isOrphaned')",
                                    "@false"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "ffa512c0-3246-4327-ba5b-b5067471d34a"
                                },
                                "runAfter": {
                                  "Recheck_Orphan_status": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "If"
                              }
                            }
                          },
                          "expression": {
                            "equals": [
                              "@body('Get_MDD_App_Creator')?['fullname']",
                              "SYSTEM"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "eafb595e-37f7-42b0-ab73-0bb1457c885a"
                          },
                          "runAfter": {},
                          "type": "If"
                        }
                      },
                      "expression": {
                        "or": [
                          {
                            "less": [
                              "@outputs('lastMod_from_CoE')",
                              "@outputs('lastMod_from_MDA')"
                            ]
                          },
                          {
                            "equals": [
                              "@variables('fullInventory')",
                              "True"
                            ]
                          }
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "e3af48b8-78eb-4eb9-b0a2-46a11412de80"
                      },
                      "runAfter": {
                        "lastMod_from_MDA": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "lastMod_from_CoE": {
                      "description": "coalesce(formatDateTime(outputs('appLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "inputs": "@coalesce(formatDateTime(outputs('appLastModified'), 'yyyy-MM-dd HH:mm:ss'), '')",
                      "metadata": {
                        "operationMetadataId": "3c1fbfd3-427a-475b-a4e8-d3bee3597bd5"
                      },
                      "runAfter": {},
                      "type": "Compose"
                    },
                    "lastMod_from_MDA": {
                      "description": "formatDateTime(body('Parse_Model_Driven_App_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "inputs": "@formatDateTime(body('Parse_Model_Driven_App_JSON')?['modifiedon'], 'yyyy-MM-dd HH:mm:ss')",
                      "metadata": {
                        "operationMetadataId": "f4cdb7df-81d3-4d81-bd95-368d9c9a7473"
                      },
                      "runAfter": {
                        "lastMod_from_CoE": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    }
                  },
                  "else": {
                    "actions": {
                      "Check_if_made_by_System_2": {
                        "actions": {
                          "Insert_Model_Driven_App_(created_by_SYSTEM)": {
                            "inputs": {
                              "authentication": "@parameters('$authentication')",
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "connectionName": "shared_commondataserviceforapps",
                                "operationId": "CreateRecord"
                              },
                              "parameters": {
                                "entityName": "admin_apps",
                                "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                "item/admin_appdeleted": false,
                                "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                "item/admin_appownerdisplayname": "SYSTEM",
                                "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                "item/admin_powerappstype": 597910001,
                                "item/cr5d5_appisorphaned": "no"
                              },
                              "retryPolicy": {
                                "count": 10,
                                "interval": "PT10S",
                                "type": "exponential"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "0c8b4dca-724a-484c-b611-a39f46589d2f"
                            },
                            "runAfter": {},
                            "type": "OpenApiConnection"
                          }
                        },
                        "else": {
                          "actions": {
                            "Recheck_Orphan_status_new": {
                              "actions": {
                                "Check_if_Orphan_-_New": {
                                  "actions": {
                                    "Set_Orphan_True": {
                                      "inputs": {
                                        "name": "isOrphaned",
                                        "value": "@true"
                                      },
                                      "metadata": {
                                        "operationMetadataId": "29f4f717-238e-40d5-9074-3696bb77e7e3"
                                      },
                                      "runAfter": {},
                                      "type": "SetVariable"
                                    }
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_Orphan_False": {
                                        "inputs": {
                                          "name": "isOrphaned",
                                          "value": "@false"
                                        },
                                        "metadata": {
                                          "operationMetadataId": "1d42183c-66ec-4e66-a58b-a5740bdb32a7"
                                        },
                                        "runAfter": {},
                                        "type": "SetVariable"
                                      }
                                    }
                                  },
                                  "expression": {
                                    "equals": [
                                      "@outputs('Maker_Check_-_New')?['Body']?['userisorphan']",
                                      "True"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "0ebdfd05-5796-42c2-aa5c-d652fb83d1ce"
                                  },
                                  "runAfter": {
                                    "Maker_Check_-_New": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "If"
                                },
                                "Maker_Check_-_New": {
                                  "inputs": {
                                    "body": {
                                      "text": "@body('Get_MDD_App_Creator')?['azureactivedirectoryobjectid']",
                                      "text_1": "@body('Get_MDD_App_Creator')?['fullname']"
                                    },
                                    "host": {
                                      "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "7087a6a9-70a2-4582-9a54-98d18baeafdf"
                                  },
                                  "runAfter": {},
                                  "type": "Workflow"
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "32a037ad-91fc-4abf-8eef-52f96e7a3133"
                              },
                              "runAfter": {},
                              "type": "If"
                            },
                            "Update_based_on_Orphan_Status_new": {
                              "actions": {
                                "Insert_Model_Driven_App": {
                                  "inputs": {
                                    "authentication": "@parameters('$authentication')",
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "CreateRecord"
                                    },
                                    "parameters": {
                                      "entityName": "admin_apps",
                                      "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                      "item/admin_AppOwner@odata.bind": "admin_makers(@{body('Get_MDD_App_Creator')?['azureactivedirectoryobjectid']})",
                                      "item/admin_appcompany": "@outputs('Maker_Check_-_New')?['Body']?['usercompany']",
                                      "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                      "item/admin_appdeleted": false,
                                      "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                      "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                      "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                      "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                      "item/admin_appownerdisplayname": "@outputs('Maker_Check_-_New')?['Body']?['userdisplayname']",
                                      "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                      "item/admin_city": "@outputs('Maker_Check_-_New')?['Body']?['usercity']",
                                      "item/admin_country": "@outputs('Maker_Check_-_New')?['Body']?['usercountry']",
                                      "item/admin_department": "@outputs('Maker_Check_-_New')?['Body']?['userdepartment']",
                                      "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                      "item/admin_powerappstype": 597910001,
                                      "item/cr5d5_appisorphaned": "no"
                                    },
                                    "retryPolicy": {
                                      "count": 10,
                                      "interval": "PT10S",
                                      "type": "exponential"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "c0df2c48-c29b-4b10-8729-3372617a8473"
                                  },
                                  "runAfter": {},
                                  "type": "OpenApiConnection"
                                }
                              },
                              "else": {
                                "actions": {
                                  "Insert_Model_Driven_App_(Abandoned)": {
                                    "inputs": {
                                      "authentication": "@parameters('$authentication')",
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "CreateRecord"
                                      },
                                      "parameters": {
                                        "entityName": "admin_apps",
                                        "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()?['admin_environmentid']})",
                                        "item/admin_appcreatedon": "@body('Parse_Model_Driven_App_JSON')?['createdon']",
                                        "item/admin_appdeleted": false,
                                        "item/admin_appenvironmentdisplayname": "@triggerOutputs()?['body/admin_displayname']",
                                        "item/admin_appenvironmentid": "@triggerOutputs()?['body/admin_environmentname']",
                                        "item/admin_appidstring": "@body('Parse_Model_Driven_App_JSON')?['ItemInternalId']",
                                        "item/admin_appmodifiedon": "@body('Parse_Model_Driven_App_JSON')?['modifiedon']",
                                        "item/admin_appuniquename": "@outputs('UniqueNameString')",
                                        "item/admin_displayname": "@body('Parse_Model_Driven_App_JSON')?['name']",
                                        "item/admin_powerappstype": 597910001,
                                        "item/cr5d5_appisorphaned": "yes"
                                      },
                                      "retryPolicy": {
                                        "count": 10,
                                        "interval": "PT10S",
                                        "type": "exponential"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "aadf8133-d808-4740-a878-28856f92e1ec"
                                    },
                                    "runAfter": {},
                                    "type": "OpenApiConnection"
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@variables('isOrphaned')",
                                  "@false"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "ad00939d-2631-4ade-9fd9-899b4908e58d"
                              },
                              "runAfter": {
                                "Recheck_Orphan_status_new": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            }
                          }
                        },
                        "expression": {
                          "equals": [
                            "@body('Get_MDD_App_Creator')?['fullname']",
                            "SYSTEM"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "259ef942-df97-440d-af26-f5d0ae9b1a52"
                        },
                        "runAfter": {},
                        "type": "If"
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('isNewToCoE')",
                      "@false"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "8e07d40e-2794-4685-b654-27b5398a9ba3"
                  },
                  "runAfter": {
                    "If_did_not_return_rows_then_new_to_Coe_else_get_app_GUID": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "UniqueNameString": {
                  "description": "concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Model_Driven_App_JSON')?['ItemInternalId'])",
                  "inputs": "@concat(triggerOutputs()?['body/admin_environmentid'], '_', body('Parse_Model_Driven_App_JSON')?['ItemInternalId'])",
                  "metadata": {
                    "operationMetadataId": "c223ff55-c16f-451e-8dcc-bf7389e8d93d"
                  },
                  "runAfter": {
                    "Parse_Model_Driven_App_JSON": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                }
              },
              "foreach": "@outputs('List_Model_Driven_Apps')?['body/value']",
              "metadata": {
                "operationMetadataId": "cdc8616c-7b1e-4d5a-8660-b79f87d20de9"
              },
              "runAfter": {
                "Remove_any_Environment_prefix": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Get_Environment_as_Admin": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins",
                  "connectionName": "shared_powerplatformforadmins_1",
                  "operationId": "GetSingleEnvironment"
                },
                "parameters": {
                  "api-version": "2018-10-01",
                  "environment": "@triggerOutputs()?['body/admin_environmentname']"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "0f6a0822-1516-4149-82c8-281f79ef5663"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Name_Length": {
              "description": "Returns the index where the GUID starts",
              "inputs": "@sub(length(body('Get_Environment_as_Admin')?['name']), 36)",
              "metadata": {
                "operationMetadataId": "1a3bb18b-de13-4f6d-8e61-2c098ee3a0cf"
              },
              "runAfter": {
                "Get_Environment_as_Admin": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Remove_any_Environment_prefix": {
              "description": "Returns the GUID without any prefix (right 36 chars)",
              "inputs": "@substring(body('Get_Environment_as_Admin')?['name'], int(outputs('Name_Length')), 36)",
              "metadata": {
                "operationMetadataId": "f2c01be0-7d1e-4bc2-adc4-e52e38d330e9"
              },
              "runAfter": {
                "Name_Length": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            }
          },
          "metadata": {
            "operationMetadataId": "3664a4c1-048c-4a53-9cda-96938fb348cc"
          },
          "runAfter": {
            "Initialize_variable_fullInventory": [
              "Succeeded"
            ]
          },
          "type": "Scope"
        },
        "Get_Model_Driven_Apps_fails_-_Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "inputs": {
                "authentication": "@parameters('$authentication')",
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_environmentname": "@triggerOutputs()?['body/admin_displayname']",
                  "item/admin_flowinstanceurl": "@concat(variables('flowEnvironment'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])",
                  "item/admin_name": "Admin | Sync Template v3 (Model Driven Apps)"
                },
                "retryPolicy": {
                  "count": 10,
                  "interval": "PT10S",
                  "type": "exponential"
                }
              },
              "metadata": {
                "operationMetadataId": "f0fe5651-38a4-4d5b-9d57-47b2f0bbd227"
              },
              "runAfter": {},
              "type": "OpenApiConnection"
            },
            "Terminate": {
              "inputs": {
                "runError": {
                  "code": "500",
                  "message": "Get Model Driven Apps Failed"
                },
                "runStatus": "Failed"
              },
              "metadata": {
                "operationMetadataId": "61a0b753-29fc-47e6-9a78-a164d4eb98c0"
              },
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "type": "Terminate"
            }
          },
          "metadata": {
            "operationMetadataId": "42131d73-e991-43e4-bee0-5e9bbcf67d02"
          },
          "runAfter": {
            "Get_Model_Driven_Apps_and_store_in_CoE_CDS_Entity": [
              "Failed",
              "TimedOut"
            ]
          },
          "type": "Scope"
        },
        "Initialize_variable_flowEnvironment": {
          "description": "Environment location specific Flow URL - remember / at the end",
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable')"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "488d01e2-63a7-42d8-bab0-0580c2edbc88"
          },
          "runAfter": {
            "Initialize_variable_isOrphaned": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_fullInventory": {
          "description": "Environment location specific Flow URL - remember / at the end",
          "inputs": {
            "variables": [
              {
                "name": "fullInventory",
                "type": "string",
                "value": "@{parameters('FullInventory')}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "95da9491-27b7-4198-bd35-93d3f26bd282"
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isNewToCoE": {
          "inputs": {
            "variables": [
              {
                "name": "isNewToCoE",
                "type": "boolean",
                "value": false
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "c0ef23fd-0915-47d4-bb27-7b2ce1ca1abe"
          },
          "runAfter": {
            "Clean_up_Envt_-_GitHub_1345": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_isOrphaned": {
          "inputs": {
            "variables": [
              {
                "name": "isOrphaned",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "836ccf93-8da7-4ca5-b0c6-5e94f12139a8"
          },
          "runAfter": {
            "Initialize_variable_today": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        },
        "Initialize_variable_today": {
          "inputs": {
            "variables": [
              {
                "name": "today",
                "type": "string",
                "value": "@{utcNow()}"
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "8b698576-d555-4a6e-a42f-55aa650a97ba"
          },
          "runAfter": {
            "Initialize_variable_isNewToCoE": [
              "Succeeded"
            ]
          },
          "type": "InitializeVariable"
        }
      },
      "contentVersion": "1.0.0.0",
      "outputs": {},
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "FullInventory": {
          "defaultValue": true,
          "metadata": {
            "description": "Determines if you want to only update objects that have changed, or all objects. Defaults to No. Switching to Yes will cause the flows to inventory every single app/flow/etc in the tenant and make the flows long running ",
            "schemaName": "admin_FullInventory"
          },
          "type": "Bool"
        },
        "Power Automate Environment Variable": {
          "defaultValue": "https://us.flow.microsoft.com/manage/environments/",
          "metadata": {
            "description": "Environment, including geographic location, for Power Automate - Ex for US: https://us.flow.microsoft.com/manage/environments/",
            "schemaName": "admin_PowerAutomateEnvironmentVariable"
          },
          "type": "String"
        }
      },
      "triggers": {
        "When_a_record_is_created_or_updated": {
          "inputs": {
            "authentication": "@parameters('$authentication')",
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "SubscribeWebhookTrigger"
            },
            "parameters": {
              "subscriptionRequest/entityname": "admin_environment",
              "subscriptionRequest/message": 4,
              "subscriptionRequest/scope": 4
            }
          },
          "metadata": {
            "operationMetadataId": "a0621d41-a585-4c7a-97fc-9e744f8195a9"
          },
          "type": "OpenApiConnectionWebhook"
        }
      }
    }
  },
  "schemaVersion": "1.0.0.0"
}
