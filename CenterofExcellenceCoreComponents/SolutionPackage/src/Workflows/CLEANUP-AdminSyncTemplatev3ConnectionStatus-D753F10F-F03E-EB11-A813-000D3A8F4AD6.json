{
  "properties": {
    "connectionReferences": {
      "shared_flowmanagement": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAutomateManagement"
        },
        "api": {
          "name": "shared_flowmanagement"
        }
      },
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerappsforadmins_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin"
        },
        "api": {
          "name": "shared_powerappsforadmins"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "Inventory and Telemetry in Azure Data Storage account (admin_InventoryandTelemetryinAzureDataStorageaccount)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_InventoryandTelemetryinAzureDataStorageaccount",
            "description": "Have you set up data export in PPAC and is your inventory and telemetry in an Azure Data Storage folder (also referred to as Bring your own Datalake, self-serve analytics feature)"
          }
        }
      },
      "triggers": {
        "Recurrence": {
          "recurrence": {
            "frequency": "Week",
            "interval": 1
          },
          "metadata": {
            "operationMetadataId": "24096466-2b99-4bac-b32c-572f92ff433f"
          },
          "type": "Recurrence"
        }
      },
      "actions": {
        "Clean_Flow_Connection_Status": {
          "actions": {
            "Apply_to_each_Flow": {
              "foreach": "@outputs('List_Flows_with_Unresolved_Connections')?['body/value']",
              "actions": {
                "Get_Flow_as_Admin": {
                  "runAfter": {
                    "ReSet_hasBadConnections_flows": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "f62e1d00-fdfa-422c-b4a4-ec6f6615a64f"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_flowmanagement",
                      "operationId": "AdminGetFlow",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_flowmanagement"
                    },
                    "parameters": {
                      "environmentName": "@items('Apply_to_each_Flow')?['admin_flowenvironment/admin_environmentname']",
                      "flowName": "@items('Apply_to_each_Flow')?['admin_flowid']"
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "ReSet_hasBadConnections_flows": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "d8aff8fe-634a-443d-834c-e84ff36a5cb8"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "hasBadConnections",
                    "value": "@false"
                  }
                },
                "Catch:_Flow_has_been_deleted": {
                  "runAfter": {
                    "Get_Flow_as_Admin": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "9784ed88-6786-438f-803d-39ffda423749"
                  },
                  "type": "Compose",
                  "inputs": "Flow has been deleted"
                },
                "Parse_flow_JSON": {
                  "runAfter": {
                    "Catch:_Flow_has_been_deleted": [
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "688cea10-ebfc-4a1a-b5d1-6f3b563c5082"
                  },
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@body('Get_Flow_as_Admin')",
                    "schema": {
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "properties": {
                          "properties": {
                            "apiId": {
                              "type": "string"
                            },
                            "connectionReferences": {
                              "type": "array"
                            },
                            "createdTime": {
                              "type": "string"
                            },
                            "creator": {
                              "properties": {
                                "objectId": {
                                  "type": "string"
                                },
                                "tenantId": {
                                  "type": "string"
                                },
                                "userId": {
                                  "type": "string"
                                },
                                "userType": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "definitionSummary": {
                              "properties": {
                                "actions": {
                                  "items": {
                                    "properties": {
                                      "kind": {
                                        "type": "string"
                                      },
                                      "type": {
                                        "type": "string"
                                      }
                                    },
                                    "type": "object"
                                  },
                                  "type": "array"
                                },
                                "description": {
                                  "type": "string"
                                },
                                "triggers": {
                                  "items": {
                                    "properties": {
                                      "kind": {
                                        "type": "string"
                                      },
                                      "type": {
                                        "type": "string"
                                      }
                                    },
                                    "type": "object"
                                  },
                                  "type": "array"
                                }
                              },
                              "type": "object"
                            },
                            "displayName": {
                              "type": "string"
                            },
                            "environment": {
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                },
                                "type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "flowFailureAlertSubscribed": {
                              "type": "boolean"
                            },
                            "flowSuspensionReason": {
                              "type": "string"
                            },
                            "lastModifiedTime": {
                              "type": "string"
                            },
                            "provisioningMethod": {
                              "type": "string"
                            },
                            "referencedResources": {
                              "type": "array"
                            },
                            "sharingType": {
                              "type": "string"
                            },
                            "state": {
                              "type": "string"
                            },
                            "triggerSchema": {
                              "properties": {
                                "properties": {
                                  "type": "object"
                                },
                                "type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "userType": {
                              "type": "string"
                            },
                            "workflowEntityId": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "type": {
                          "type": "string"
                        }
                      },
                      "type": "object"
                    }
                  }
                },
                "Prepare_and_Add_Connection_Information_flows": {
                  "actions": {
                    "Select_actions": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "fe4a6a63-c900-412e-ab56-ec7a6ac89c4f"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@body('Parse_flow_JSON')?['properties']?['definitionSummary']?['actions']",
                        "select": "@item()?['type']"
                      }
                    },
                    "add_HTTP_Webhook": {
                      "runAfter": {
                        "add_HTTP": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "39421be2-1c60-4e91-aadd-bdfb8807fb6b"
                      },
                      "type": "Compose",
                      "inputs": "@if(contains(body('Select_actions'), 'HttpWebhook'), ',HttpWebhook', '')"
                    },
                    "add_HTTP": {
                      "runAfter": {
                        "Select_triggers": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "56c398a7-bb69-414c-b192-d1fa9a946eae"
                      },
                      "type": "Compose",
                      "inputs": "@if(contains(body('Select_actions'), 'Http'), ',Http', '')"
                    },
                    "check_if_connection_reference_edit_exist": {
                      "actions": {
                        "Compose_edit_comma_separated_connector_list_flows": {
                          "runAfter": {
                            "Select_Connector_Display_Name_flows": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "080b7d68-d39d-46a9-ae07-afc68b2e8572"
                          },
                          "type": "Compose",
                          "inputs": "@concat(join(body('Select_Connector_Display_Name_flows'), ','), outputs('add_HTTP_Webhook'), outputs('add_HTTP'), outputs('add_HTTP_trigger'))"
                        },
                        "Parse_Connection_JSON": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "9a887e7e-0e27-4aad-8863-db267ee8cf66"
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@outputs('Get_Flow_as_Admin')?['body/properties/connectionReferences']",
                            "schema": {
                              "items": {
                                "properties": {
                                  "apiDefinition": {
                                    "properties": {
                                      "id": {
                                        "type": "string"
                                      },
                                      "name": {
                                        "type": "string"
                                      },
                                      "properties": {
                                        "properties": {
                                          "capabilities": {
                                            "items": {
                                              "type": "string"
                                            },
                                            "type": "array"
                                          },
                                          "changedTime": {
                                            "type": "string"
                                          },
                                          "connectionParameters": {
                                            "properties": {
                                              "token": {
                                                "properties": {
                                                  "oAuthSettings": {
                                                    "properties": {
                                                      "clientId": {
                                                        "type": "string"
                                                      },
                                                      "customParameters": {
                                                        "properties": {
                                                          "loginUri": {
                                                            "properties": {
                                                              "value": {
                                                                "type": "string"
                                                              }
                                                            },
                                                            "type": "object"
                                                          },
                                                          "loginUriAAD": {
                                                            "properties": {
                                                              "value": {
                                                                "type": "string"
                                                              }
                                                            },
                                                            "type": "object"
                                                          },
                                                          "resourceUri": {
                                                            "properties": {
                                                              "value": {
                                                                "type": "string"
                                                              }
                                                            },
                                                            "type": "object"
                                                          }
                                                        },
                                                        "type": "object"
                                                      },
                                                      "identityProvider": {
                                                        "type": "string"
                                                      },
                                                      "properties": {
                                                        "properties": {
                                                          "AzureActiveDirectoryResourceId": {
                                                            "type": "string"
                                                          },
                                                          "IsFirstParty": {
                                                            "type": "string"
                                                          }
                                                        },
                                                        "type": "object"
                                                      },
                                                      "redirectMode": {
                                                        "type": "string"
                                                      },
                                                      "redirectUrl": {
                                                        "type": "string"
                                                      },
                                                      "scopes": {
                                                        "type": "array"
                                                      }
                                                    },
                                                    "type": "object"
                                                  },
                                                  "type": {
                                                    "type": "string"
                                                  }
                                                },
                                                "type": "object"
                                              }
                                            },
                                            "type": "object"
                                          },
                                          "createdTime": {
                                            "type": "string"
                                          },
                                          "description": {
                                            "type": "string"
                                          },
                                          "displayName": {
                                            "type": "string"
                                          },
                                          "iconUri": {
                                            "type": "string"
                                          },
                                          "isCustomApi": {
                                            "type": "boolean"
                                          },
                                          "metadata": {
                                            "properties": {
                                              "brandColor": {
                                                "type": "string"
                                              },
                                              "source": {
                                                "type": "string"
                                              },
                                              "version": {
                                                "properties": {
                                                  "current": {
                                                    "type": "string"
                                                  },
                                                  "previous": {
                                                    "type": "string"
                                                  }
                                                },
                                                "type": "object"
                                              }
                                            },
                                            "type": "object"
                                          },
                                          "primaryRuntimeUrl": {
                                            "type": "string"
                                          },
                                          "purpose": {
                                            "type": "string"
                                          },
                                          "runtimeUrls": {
                                            "items": {
                                              "type": "string"
                                            },
                                            "type": "array"
                                          },
                                          "scopes": {
                                            "properties": {
                                              "will": {
                                                "type": "array"
                                              },
                                              "wont": {
                                                "type": "array"
                                              }
                                            },
                                            "type": "object"
                                          },
                                          "tier": {
                                            "type": "string"
                                          }
                                        },
                                        "type": "object"
                                      },
                                      "type": {
                                        "type": "string"
                                      }
                                    },
                                    "type": "object"
                                  },
                                  "connectionName": {
                                    "type": "string"
                                  },
                                  "displayName": {
                                    "type": "string"
                                  },
                                  "id": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "id"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          }
                        },
                        "Select_Connector_Display_Name_flows": {
                          "runAfter": {
                            "Parse_Connection_JSON": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e91c1cf9-856a-4676-a11b-a84d45f935d5"
                          },
                          "type": "Select",
                          "inputs": {
                            "from": "@body('Parse_Connection_JSON')",
                            "select": "@split(item()['id'], '/')[sub(length(split(item()['id'], '/')), 1)]"
                          }
                        },
                        "Store_Flow_Connection_References_flows": {
                          "actions": {
                            "Insert_Specialty_Connectors": {
                              "actions": {
                                "Check_Http": {
                                  "actions": {
                                    "Create_http-_Flow_Connection_Reference": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "547e63be-5baa-4934-b4a8-87ea02003c9f"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_connectionreferences",
                                          "item/admin_displayname": "Http",
                                          "item/admin_Connector@odata.bind": "admin_connectors(@{outputs('GUID_Http')})",
                                          "item/admin_Flow@odata.bind": "admin_flows(@{outputs('Get_Flow_as_Admin')?['body/name']})"
                                        },
                                        "authentication": "@parameters('$authentication')",
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {},
                                  "expression": {
                                    "greater": [
                                      "@length(outputs('add_HTTP'))",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "99dfa93a-d1a6-4ac1-a930-b41fc056fde1"
                                  },
                                  "type": "If"
                                },
                                "Check_Http_Webhook": {
                                  "actions": {
                                    "Create_http_webhook_-_Flow_Connection_Reference": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "547e63be-5baa-4934-b4a8-87ea02003c9f"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_connectionreferences",
                                          "item/admin_displayname": "Http Webhook",
                                          "item/admin_Connector@odata.bind": "admin_connectors(@{outputs('GUID_HttpWebhook')})",
                                          "item/admin_Flow@odata.bind": "admin_flows(@{outputs('Get_Flow_as_Admin')?['body/name']})"
                                        },
                                        "authentication": "@parameters('$authentication')",
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Check_Http": [
                                      "Succeeded"
                                    ]
                                  },
                                  "expression": {
                                    "greater": [
                                      "@length(outputs('add_HTTP_Webhook'))",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "f445fa2e-c40d-4f24-b081-559c5dedeffc"
                                  },
                                  "type": "If"
                                },
                                "Check_Http_Request_Received": {
                                  "actions": {
                                    "Create_http_trigger_-_Flow_Connection_Reference": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "547e63be-5baa-4934-b4a8-87ea02003c9f"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_connectionreferences",
                                          "item/admin_displayname": "Http Request Received",
                                          "item/admin_Connector@odata.bind": "admin_connectors(@{outputs('GUID_HttpRequestReceived')})",
                                          "item/admin_Flow@odata.bind": "admin_flows(@{outputs('Get_Flow_as_Admin')?['body/name']})"
                                        },
                                        "authentication": "@parameters('$authentication')",
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Check_Http_Webhook": [
                                      "Succeeded"
                                    ]
                                  },
                                  "expression": {
                                    "greater": [
                                      "@length(outputs('add_HTTP_trigger'))",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8a261dcd-33f8-439a-94ea-b08fa30a534c"
                                  },
                                  "type": "If"
                                }
                              },
                              "runAfter": {
                                "Apply_to_each_Flow_Connection_Reference": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "199e1038-75bb-464f-bf13-d06599b26523"
                              },
                              "type": "Scope"
                            },
                            "Filter_id_not_null": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "6222ff27-7396-4d1d-b57e-c8459a2410a5"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Parse_Connection_JSON')",
                                "where": "@not(equals(item()?['id'], null))"
                              }
                            },
                            "Apply_to_each_Flow_Connection_Reference": {
                              "foreach": "@body('Filter_id_not_null')",
                              "actions": {
                                "Connecor_Name_flow": {
                                  "runAfter": {
                                    "split_on_slash_flow": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "2bdbfecf-4cc5-4f4b-b923-4009359b61a3"
                                  },
                                  "type": "Compose",
                                  "inputs": "@last(outputs('split_on_slash_flow'))"
                                },
                                "ConnectorID_flow": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "7126bffd-0070-4260-99c2-f6876f1812a4"
                                  },
                                  "type": "Compose",
                                  "inputs": "@items('Apply_to_each_Flow_Connection_Reference')?['id']"
                                },
                                "Filter_current_flow_Connector": {
                                  "runAfter": {
                                    "Connecor_Name_flow": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "897c293f-3821-492e-b77e-c2531cb3263d"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_Connectors')?['body/value']",
                                    "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_flow'))"
                                  }
                                },
                                "mark_broken_connector_or_insert_connection_reference": {
                                  "actions": {
                                    "Create_a_new_Flow_Connection_Reference": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "547e63be-5baa-4934-b4a8-87ea02003c9f"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_connectionreferences",
                                          "item/admin_displayname": "@coalesce(items('Apply_to_each_Flow_Connection_Reference')?['displayName'], 'No Display Name For Connector')",
                                          "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_flow_Connector'))?['admin_connectorid']})",
                                          "item/admin_Flow@odata.bind": "admin_flows(@{outputs('Get_Flow_as_Admin')?['body/name']})"
                                        },
                                        "authentication": "@parameters('$authentication')",
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_current_flow_Connector": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_hasBadConnections_true": {
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "bc0b1e7a-4908-4978-a625-5d967212c901"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "hasBadConnections",
                                          "value": "@true"
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "greater": [
                                      "@length(body('Filter_current_flow_Connector'))",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e202458e-a803-4b59-9bea-3fece377334f"
                                  },
                                  "type": "If"
                                },
                                "split_on_slash_flow": {
                                  "runAfter": {
                                    "ConnectorID_flow": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "d5ba4b3e-2901-45d6-8c33-8128951eb6e4"
                                  },
                                  "type": "Compose",
                                  "inputs": "@split(outputs('ConnectorID_flow'), '/')"
                                }
                              },
                              "runAfter": {
                                "Filter_id_not_null": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "f38f07cc-348e-496e-8d32-4ce233c4a8b7"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Compose_edit_comma_separated_connector_list_flows": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ecf3d359-d8d1-4215-b0a9-ccb8266c38ef"
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "add_HTTP_trigger": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Get_Flow_as_Admin')?['body/properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "2856e571-8957-4143-864f-3dea6c42f9c2"
                      },
                      "type": "If"
                    },
                    "Select_triggers": {
                      "runAfter": {
                        "Select_actions": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "7a129d07-7d97-4ffa-ac83-2e49b1bc32d8"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@body('Parse_flow_JSON')?['properties']?['definitionSummary']?['triggers']",
                        "select": "@item()?['kind']"
                      }
                    },
                    "add_HTTP_trigger": {
                      "runAfter": {
                        "add_HTTP_Webhook": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "7b07f2a2-f0cb-4dd9-9405-676f3479cdec"
                      },
                      "type": "Compose",
                      "inputs": "@if(contains(body('Select_triggers'), 'Http'), ',HttpRequestReceived', '')"
                    }
                  },
                  "runAfter": {
                    "Delete_Existing_Connections_flows": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "97ef54da-bd17-492e-8a6b-483969811acc"
                  },
                  "type": "Scope"
                },
                "Delete_Existing_Connections_flows": {
                  "actions": {
                    "List_This_Flow_Existing_Connection_References": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "accf2a9b-aa9e-4c5f-8d89-0e67935357a5"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_connectionreferences",
                          "$select": "admin_connectionreferenceid",
                          "$filter": "_admin_flow_value eq '@{items('Apply_to_each_Flow')?['admin_flowid']}'"
                        },
                        "authentication": "@parameters('$authentication')",
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 10,
                          "interval": "PT10S"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Delete_this_flows_existing_connection_references": {
                      "foreach": "@outputs('List_This_Flow_Existing_Connection_References')?['body/value']",
                      "actions": {
                        "Delete_this_flow_connection_record": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "aa12b1bc-8e70-4dc8-a673-29835d438bd2"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_connectionreferences",
                              "recordId": "@items('Delete_this_flows_existing_connection_references')?['admin_connectionreferenceid']"
                            },
                            "authentication": "@parameters('$authentication')",
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        },
                        "catch_-_Delete_this_flow_connection_record": {
                          "runAfter": {
                            "Delete_this_flow_connection_record": [
                              "Failed"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "7deac327-6d1a-445f-9a1c-840817824cc1"
                          },
                          "type": "Compose",
                          "inputs": "catch - Delete this record"
                        }
                      },
                      "runAfter": {
                        "List_This_Flow_Existing_Connection_References": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "aaca116a-bca9-479f-bd2c-8cde2a0cebfd"
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Parse_flow_JSON": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a7c73201-f27f-4814-8479-b8eecafe27d5"
                  },
                  "type": "Scope"
                },
                "if_found_bad_connection,_mark_in_flow_record": {
                  "actions": {
                    "Mark_flow_as_having_broken_connections": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "2cc858d3-4826-4284-83a6-daaee12137cc"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_flows",
                          "recordId": "@outputs('Get_Flow_as_Admin')?['body/name']",
                          "item/admin_flowconnections": "@outputs('Compose_edit_comma_separated_connector_list_flows')",
                          "item/admin_flowcontainsbrokenconnections": true,
                          "item/admin_tempconnectionstringresetcomplete": true
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    }
                  },
                  "runAfter": {
                    "Prepare_and_Add_Connection_Information_flows": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Mark_flow_as_NOT_having_broken_connections": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "003afe18-df8f-4779-b1ea-09408f53b264"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_commondataserviceforapps_1",
                            "operationId": "UpdateRecord",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                          },
                          "parameters": {
                            "entityName": "admin_flows",
                            "recordId": "@outputs('Get_Flow_as_Admin')?['body/name']",
                            "item/admin_flowconnections": "@outputs('Compose_edit_comma_separated_connector_list_flows')",
                            "item/admin_flowcontainsbrokenconnections": false,
                            "item/admin_tempconnectionstringresetcomplete": true
                          },
                          "authentication": "@parameters('$authentication')",
                          "retryPolicy": {
                            "type": "exponential",
                            "count": 10,
                            "interval": "PT10S"
                          }
                        }
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('hasBadConnections')",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "b067c2f5-3f08-410a-8dbf-1a0b13bb3277"
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "List_Flows_with_Unresolved_Connections": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "83aacba7-4da7-4508-9e2e-b69143230771"
              },
              "type": "Foreach"
            },
            "List_Flows_with_Unresolved_Connections": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "a95dbb3c-fba8-476c-ae63-ca12bf9d0515"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_flows",
                  "$select": "admin_flowid, _admin_flowenvironment_value",
                  "$filter": "(admin_flowcontainsbrokenconnections ne false or admin_tempconnectionstringresetcomplete ne true) and admin_flowdeleted ne true",
                  "$expand": "admin_FlowEnvironment($select=admin_environmentname)"
                },
                "authentication": "@parameters('$authentication')",
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            }
          },
          "runAfter": {
            "Get_Connectors": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "2cc24d24-b4e4-4c43-986c-b9e383a86b01"
          },
          "type": "Scope"
        },
        "Get_Failure_Status_Flows": {
          "actions": {
            "Mark_flow_as_failed_-_flows": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "452a73a9-ee7f-400f-859c-98eca3303f1b"
              },
              "type": "SetVariable",
              "inputs": {
                "name": "FlowFailed",
                "value": "@true"
              }
            }
          },
          "runAfter": {
            "Clean_Flow_Connection_Status": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "25e81040-abb5-4ab1-b5a8-d6e9d4e26960"
          },
          "type": "Scope"
        },
        "Initialize_FlowFailed": {
          "runAfter": {
            "Initialize_hasBadConnections": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "eacdf067-3c81-47d8-85e4-e37fd8ce79a0"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "FlowFailed",
                "type": "boolean",
                "value": "@false"
              }
            ]
          }
        },
        "Initialize_hasBadConnections": {
          "runAfter": {
            "If_inventory_in_BYODL_terminate_here": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "f3442490-8447-4c35-b4ba-26a35036df27"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "hasBadConnections",
                "type": "boolean",
                "value": "@false"
              }
            ]
          }
        },
        "Initialize_variable_flowEnvironment": {
          "runAfter": {
            "Initialize_FlowFailed": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "9fe0e3a6-4337-44a1-9126-a391d60f6f7b"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "flowEnvironment",
                "type": "string",
                "value": "@parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)')"
              }
            ]
          },
          "description": "Environment location specific Flow URL - remember / at the end"
        },
        "If_inventory_in_BYODL_terminate_here": {
          "actions": {
            "Terminate_for_BYODL": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "b5f6975a-7731-4f8b-8e27-5fd452e901bb"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Succeeded"
              }
            }
          },
          "runAfter": {},
          "expression": {
            "equals": [
              "@parameters('Inventory and Telemetry in Azure Data Storage account (admin_InventoryandTelemetryinAzureDataStorageaccount)')",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "54988332-a904-4fb7-b5b3-40e6a1ceba99"
          },
          "type": "If"
        },
        "Get_Connectors": {
          "actions": {
            "Specialty_Connectors": {
              "actions": {
                "List_Http": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "ee734f72-173b-4708-8fd1-e88f10195826"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_connectors",
                      "$select": "admin_connectorid",
                      "$filter": "admin_id eq 'Http'",
                      "$top": 1
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "List_HttpWebhook": {
                  "runAfter": {
                    "GUID_Http": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7a39cd19-d939-4096-bfa4-e65155ef439b"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_connectors",
                      "$select": "admin_connectorid",
                      "$filter": "admin_id eq 'HttpWebhook'",
                      "$top": 1
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "List_HttpRequestReceived": {
                  "runAfter": {
                    "GUID_HttpWebhook": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7f9ab01b-be8a-47b6-b309-6d861d8c66ef"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_connectors",
                      "$select": "admin_connectorid",
                      "$filter": "admin_id eq 'HttpRequestReceived'",
                      "$top": 1
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "GUID_Http": {
                  "runAfter": {
                    "List_Http": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "797a9016-a837-4227-9b1f-97a5ab9c3a45"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('List_Http')?['body/value'])?['admin_connectorid']"
                },
                "GUID_HttpWebhook": {
                  "runAfter": {
                    "List_HttpWebhook": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "02224a36-f5e6-4cc3-83a6-d0eb96350a51"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('List_HttpWebhook')?['body/value'])?['admin_connectorid']"
                },
                "GUID_HttpRequestReceived": {
                  "runAfter": {
                    "List_HttpRequestReceived": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "22da2648-aa52-4ba2-9d40-5c689ec1d2e6"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('List_HttpRequestReceived')?['body/value'])?['admin_connectorid']"
                }
              },
              "runAfter": {
                "List_Connectors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "b330093d-15a0-4eab-af9a-467e3a1e56c5"
              },
              "type": "Scope"
            },
            "List_Connectors": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "fe96d307-859d-4cc4-8268-fbd6760bb27a"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_connectors",
                  "$select": "admin_displayname,admin_connectorid,admin_id,admin_name"
                },
                "authentication": "@parameters('$authentication')",
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            }
          },
          "runAfter": {
            "Initialize_variable_flowEnvironment": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "56473474-da9d-4b6e-b82c-a40f81b78bfe"
          },
          "type": "Scope"
        },
        "Clean_App_Connection_Status": {
          "actions": {
            "Apply_to_each": {
              "foreach": "@outputs('List_Apps_with_Unresolved_Connections')?['body/value']",
              "actions": {
                "GetConnectionReferences": {
                  "runAfter": {
                    "Catch:_App_has_been_deleted": [
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1c188300-66f2-4033-9b84-5af32c1ca988"
                  },
                  "type": "Compose",
                  "inputs": "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                  "description": "Because some data sources like CDS are not in the connection refs list for apps, there will be apps that do not have any value for this object. Need to be able to catch that case.  "
                },
                "Get_App_as_Admin": {
                  "runAfter": {
                    "ReSet_hasBadConnections": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a6c0a9e6-b68d-4730-b5f1-c501a5fb02c7"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerappsforadmins_1",
                      "operationId": "Get-AdminApp",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins"
                    },
                    "parameters": {
                      "environment": "@items('Apply_to_each')?['admin_appenvironment/admin_environmentname']",
                      "app": "@items('Apply_to_each')?['admin_appid']",
                      "api-version": "2016-11-01"
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                },
                "ReSet_hasBadConnections": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "c86c35f3-ff45-489f-be55-44379faf52c8"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "hasBadConnections",
                    "value": "@false"
                  }
                },
                "if_found_bad_connection,_mark_in_app_record": {
                  "actions": {
                    "Mark_app_as_having_broken_connections": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "e8eaafa7-15c2-45ff-9b4d-68d953454dee"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_1",
                          "operationId": "UpdateRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_apps",
                          "recordId": "@outputs('Get_App_as_Admin')?['body/name']",
                          "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_connection_references_apps')",
                          "item/admin_appcontainsbrokenconnections": true,
                          "item/admin_tempconnectionstringresetcomplete": true
                        },
                        "authentication": "@parameters('$authentication')",
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 10,
                          "interval": "PT10S"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Prepare_and_Add_App_Connection_References": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Mark_app_as_NOT_having_broken_connections": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "660253e2-2081-4db9-b40e-d4ba089dc47b"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_commondataserviceforapps_1",
                            "operationId": "UpdateRecord",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                          },
                          "parameters": {
                            "entityName": "admin_apps",
                            "recordId": "@outputs('Get_App_as_Admin')?['body/name']",
                            "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_connection_references_apps')",
                            "item/admin_appcontainsbrokenconnections": false,
                            "item/admin_tempconnectionstringresetcomplete": true
                          },
                          "authentication": "@parameters('$authentication')",
                          "retryPolicy": {
                            "type": "exponential",
                            "count": 10,
                            "interval": "PT10S"
                          }
                        }
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@variables('hasBadConnections')",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "45835d80-6d96-4d72-867d-e6d1ef2b991f"
                  },
                  "type": "If"
                },
                "Catch:_App_has_been_deleted": {
                  "runAfter": {
                    "Get_App_as_Admin": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "b92c759e-26f8-47eb-b9c3-83263dc7694e"
                  },
                  "type": "Compose",
                  "inputs": "App has been deleted"
                },
                "Prepare_and_Add_App_Connection_References": {
                  "actions": {
                    "check_if_edited_app_has_connections": {
                      "actions": {
                        "Compose_comma-separated_list_of_connection_references_apps": {
                          "runAfter": {
                            "Select_Connector_Display_Name_apps": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "d54b22d2-3c90-474f-ac90-b8440aed87b5"
                          },
                          "type": "Compose",
                          "inputs": "@concat(join(body('Select_Connector_Display_Name_apps'), ','), if(empty(outputs('Get_App_as_Admin')?['body/properties/databaseReferences']), '', ',shared_commondataserviceforapps'))"
                        },
                        "Parse_JSON_-_Connection_References_apps": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "ba2e396c-f0a5-4788-ac2f-332d8a1ca7bb"
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                            "schema": {
                              "items": {
                                "properties": {
                                  "apiTier": {
                                    "type": "string"
                                  },
                                  "bypassConsent": {
                                    "type": [
                                      "string",
                                      "null",
                                      "boolean"
                                    ]
                                  },
                                  "displayName": {
                                    "type": "string"
                                  },
                                  "iconUri": {
                                    "type": "string"
                                  },
                                  "id": {
                                    "type": "string"
                                  },
                                  "isCustomApiConnection": {
                                    "type": "boolean"
                                  },
                                  "isOnPremiseConnection": {
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "iconUri",
                                  "displayName",
                                  "isOnPremiseConnection",
                                  "isCustomApiConnection",
                                  "id"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          }
                        },
                        "Select_Connector_Display_Name_apps": {
                          "runAfter": {
                            "Parse_JSON_-_Connection_References_apps": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "2568ef78-b0dc-4b21-a43b-544d45f18fe7"
                          },
                          "type": "Select",
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References_apps')",
                            "select": "@split(item()['id'], '/')[sub(length(split(item()['id'], '/')), 1)]"
                          }
                        },
                        "Store_App_Connection_References_flows": {
                          "actions": {
                            "Filter_id_not_null_apps": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "1a0fb779-6ff6-462e-8fe6-80ce20cf0b3c"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Parse_JSON_-_Connection_References_apps')",
                                "where": "@not(equals(item()?['id'], null))"
                              }
                            },
                            "Apply_to_each_Connection_Reference_apps": {
                              "foreach": "@body('Filter_id_not_null_apps')",
                              "actions": {
                                "Connecor_Name_apps": {
                                  "runAfter": {
                                    "split_on_slash_apps": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "0e0b96a7-15c7-49ad-b992-a46b41f628a9"
                                  },
                                  "type": "Compose",
                                  "inputs": "@last(outputs('split_on_slash_apps'))"
                                },
                                "ConnectorID_apps": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "92a53fdc-4ca5-4d89-af44-7e5ee5bab2e1"
                                  },
                                  "type": "Compose",
                                  "inputs": "@items('Apply_to_each_Connection_Reference_apps')['id']"
                                },
                                "Filter_current_app_Connector_apps": {
                                  "runAfter": {
                                    "Connecor_Name_apps": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "43645f13-c5dc-40f0-a328-f9e6f86d934f"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_Connectors')?['body/value']",
                                    "where": "@equals(item()?['admin_name'], outputs('Connecor_Name_apps'))"
                                  }
                                },
                                "mark_broken_connector_or_insert_connection_reference_apps": {
                                  "actions": {
                                    "Create_a_new_App_Connection_Reference": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "dd73d50c-55a9-478f-9ba7-32a626a84284"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_connectionreferences",
                                          "item/admin_displayname": "@items('Apply_to_each_Connection_Reference_apps')?['displayName']",
                                          "item/admin_App@odata.bind": "admin_apps(@{items('Apply_to_each')?['admin_appid']})",
                                          "item/admin_Connector@odata.bind": "admin_connectors(@{first(body('Filter_current_app_Connector_apps'))?['admin_connectorid']})"
                                        },
                                        "authentication": "@parameters('$authentication')"
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_current_app_Connector_apps": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_app_hasBadConnections_true": {
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "001f8681-313e-4737-9d1c-332182dcb40c"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "hasBadConnections",
                                          "value": "@true"
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "greater": [
                                      "@length(body('Filter_current_app_Connector_apps'))",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "9da95403-58d4-4eab-8554-b3255a30076e"
                                  },
                                  "type": "If"
                                },
                                "split_on_slash_apps": {
                                  "runAfter": {
                                    "ConnectorID_apps": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "31ea44b2-c53a-40d6-b0e7-ec093e9747f7"
                                  },
                                  "type": "Compose",
                                  "inputs": "@split(outputs('ConnectorID_apps'), '/')"
                                }
                              },
                              "runAfter": {
                                "Filter_id_not_null_apps": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "9d51fc87-1783-470c-848b-1504f671d660"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Compose_comma-separated_list_of_connection_references_apps": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "c1b484a0-5ac4-4d5b-8564-6023b4b5e259"
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {},
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "ac3f40ca-9e8f-4222-9d0c-b9de86493191"
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {
                    "Delete_Existing_Connections_apps": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "ccafb8a2-42cf-45f2-957b-0ceb78684d5c"
                  },
                  "type": "Scope"
                },
                "Delete_Existing_Connections_apps": {
                  "actions": {
                    "List_App_Connection_References": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "b99ce169-5b4b-44be-bcd8-cdeb2109285c"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_connectionreferences",
                          "$select": "admin_connectionreferenceid, admin_displayname",
                          "$filter": "_admin_app_value eq '@{items('Apply_to_each')?['admin_appid']}'"
                        },
                        "authentication": "@parameters('$authentication')"
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Delete_this_apps_existing_connection_references": {
                      "foreach": "@outputs('List_App_Connection_References')?['body/value']",
                      "actions": {
                        "Delete_this_apps_existing_connection_reference": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "c3596d7d-d5f9-4b49-92b7-40f6bffe6510"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_connectionreferences",
                              "recordId": "@items('Delete_this_apps_existing_connection_references')?['admin_connectionreferenceid']"
                            },
                            "authentication": "@parameters('$authentication')"
                          }
                        },
                        "catch_-_Delete_this_apps_connection_record": {
                          "runAfter": {
                            "Delete_this_apps_existing_connection_reference": [
                              "Failed"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "bcf7dbeb-a508-4b79-9cb0-4c7cc19c756f"
                          },
                          "type": "Compose",
                          "inputs": "catch - fail to delete"
                        }
                      },
                      "runAfter": {
                        "List_App_Connection_References": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "0f300b24-c84f-4007-a0e4-4c7b4cccefa0"
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "GetConnectionReferences": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "5bab4424-6422-43eb-8f03-d6f29288725f"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {
                "List_Apps_with_Unresolved_Connections": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "cdceeb13-0215-48e0-af8e-c3135868d36c"
              },
              "type": "Foreach"
            },
            "List_Apps_with_Unresolved_Connections": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "88598207-b1fc-4402-b5c9-58231d286ae4"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_apps",
                  "$select": "admin_appid, _admin_appenvironment_value",
                  "$filter": "(admin_appcontainsbrokenconnections ne false or admin_tempconnectionstringresetcomplete ne true) and admin_powerappstype ne 597910001 and admin_appdeleted ne true",
                  "$expand": "admin_AppEnvironment($select=admin_environmentname)"
                },
                "authentication": "@parameters('$authentication')",
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            }
          },
          "runAfter": {
            "Get_Connectors": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "5e9a1679-e220-4dc2-857e-caa3981a34cb"
          },
          "type": "Scope"
        },
        "Get_Failure_Status_Apps": {
          "actions": {
            "Mark_flow_as_failed_-_apps": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "a7ced2e9-a3de-4ffd-bab4-cb622676bd19"
              },
              "type": "SetVariable",
              "inputs": {
                "name": "FlowFailed",
                "value": "@true"
              }
            }
          },
          "runAfter": {
            "Clean_App_Connection_Status": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "b75e82a5-865d-4c87-bce3-24027e16169a"
          },
          "type": "Scope"
        },
        "Connection_Status_-_Error_Handling": {
          "actions": {
            "if_either_failed_above,_fail": {
              "actions": {
                "Create_a_new_record_-_Sync_Flow_Errors": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "939cca46-a878-4804-a885-fa2825322338"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "CreateRecord",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_syncflowerrorses",
                      "item/admin_name": "Admin | Sync Template v3 (Connection Status)",
                      "item/admin_flowinstanceurl": "@concat(variables('flowEnvironment'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "Terminate": {
                  "runAfter": {
                    "Update_Last_Run_Fail": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "f23c03c2-4915-45c7-a5b7-a761fbab3b76"
                  },
                  "type": "Terminate",
                  "inputs": {
                    "runStatus": "Failed",
                    "runError": {
                      "code": "500",
                      "message": "Connection Status failed"
                    }
                  }
                },
                "Get_ID_Fail": {
                  "runAfter": {
                    "Create_a_new_record_-_Sync_Flow_Errors": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_coesolutionmetadatas",
                      "$select": "admin_coesolutionmetadataid",
                      "$filter": "admin_objectguid eq @{workflow()?['name']}",
                      "$top": 1
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "Update_Last_Run_Fail": {
                  "runAfter": {
                    "Get_ID_Fail": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "UpdateRecord",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_coesolutionmetadatas",
                      "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                      "item/admin_lastrun": "@utcNow()",
                      "item/admin_lastrunpassed": false
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                }
              },
              "runAfter": {},
              "else": {
                "actions": {
                  "Update_last_run_as_pass": {
                    "actions": {
                      "Update_Last_Run_Successful": {
                        "runAfter": {
                          "Get_ID_Pass": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_commondataserviceforapps",
                            "operationId": "UpdateRecord",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                          },
                          "parameters": {
                            "entityName": "admin_coesolutionmetadatas",
                            "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                            "item/admin_lastrun": "@utcNow()",
                            "item/admin_lastrunpassed": true
                          },
                          "authentication": "@parameters('$authentication')"
                        }
                      },
                      "Get_ID_Pass": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_commondataserviceforapps",
                            "operationId": "ListRecords",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                          },
                          "parameters": {
                            "entityName": "admin_coesolutionmetadatas",
                            "$select": "admin_coesolutionmetadataid",
                            "$filter": "admin_objectguid eq @{workflow()?['name']}",
                            "$top": 1
                          },
                          "authentication": "@parameters('$authentication')"
                        }
                      },
                      "Catch_-_not_ready_to_take_last_run_date": {
                        "runAfter": {
                          "Update_Last_Run_Successful": [
                            "Failed"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "23ac8495-ce60-47c4-a7a3-171a302bd2b9"
                        },
                        "type": "Compose",
                        "inputs": "Catch - not ready to take last run date"
                      }
                    },
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
                    },
                    "type": "Scope"
                  }
                }
              },
              "expression": {
                "equals": [
                  "@variables('FlowFailed')",
                  "@true"
                ]
              },
              "metadata": {
                "operationMetadataId": "92e99d85-352d-4377-b2eb-b5db6939000d"
              },
              "type": "If"
            }
          },
          "runAfter": {
            "Get_Failure_Status_Flows": [
              "Succeeded",
              "Skipped"
            ],
            "Get_Failure_Status_Apps": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "1613eab4-5e05-4e0e-b879-ccfe3f64e388"
          },
          "type": "Scope"
        }
      },
      "outputs": {}
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}