{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdminsEnvRequest"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseEnvRequest"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerappsforadmins_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin2"
        },
        "api": {
          "name": "shared_powerappsforadmins"
        }
      },
      "shared_webcontents": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreHTTPWithAzureAD"
        },
        "api": {
          "name": "shared_webcontents"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_office365users_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Users"
        },
        "api": {
          "name": "shared_office365users"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "Graph URL Environment Variable (admin_GraphURLEnvironmentVariable)": {
          "defaultValue": "https://graph.microsoft.com/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_GraphURLEnvironmentVariable",
            "description": "Inventory - REQUIRED. The URL used to get graph information for your cloud. Ex https://graph.microsoft.com/"
          }
        }
      },
      "triggers": {
        "manual": {
          "metadata": {
            "operationMetadataId": "67710f6e-1529-45ee-bea1-e8c9691bab01"
          },
          "type": "Request",
          "kind": "Button",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "text": {
                  "title": "envtName",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                }
              },
              "required": [
                "text"
              ]
            }
          }
        }
      },
      "actions": {
        "Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_environmentname": "@outputs('EnvtDisplayName')",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            },
            "Terminate": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow_fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Respond_to_a_PowerApp_or_flow_fail": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "027932fc-fda8-479a-b590-799b0e00d7f4"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "returnvalue": "fail"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "returnvalue": {
                      "title": "returnValue",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "runAfter": {
            "Get_Power_Apps_User_Shared_With_Data": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Get_ID_Pass": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Respond_to_a_PowerApp_or_flow": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "b28449e1-bc60-41e2-b88f-3bc1962d6db4"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "returnvalue": "pass"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "returnvalue": {
                      "title": "returnValue",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            },
            "Catch_here": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch here"
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Get_Power_Apps_User_Shared_With_Data": {
          "actions": {
            "Recheck_envt_still_exists,_exit_if_not": {
              "actions": {
                "Get_Environment_as_Admin": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "43975f51-d8e5-4d7d-9648-0f5c8c032525"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerplatformforadmins",
                      "operationId": "GetSingleEnvironment",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                    },
                    "parameters": {
                      "environment": "@triggerBody()['text']",
                      "api-version": "2018-10-01"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "Envt_Deleted_so_Exit": {
                  "actions": {
                    "Respond_to_a_PowerApp_or_flow_2": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "b28449e1-bc60-41e2-b88f-3bc1962d6db4"
                      },
                      "type": "Response",
                      "kind": "PowerApp",
                      "inputs": {
                        "statusCode": 200,
                        "body": {
                          "returnvalue": "pass"
                        },
                        "schema": {
                          "type": "object",
                          "properties": {
                            "returnvalue": {
                              "title": "returnValue",
                              "x-ms-dynamically-added": true,
                              "type": "string"
                            }
                          }
                        }
                      }
                    },
                    "Terminate_for_environments_recently_deleted": {
                      "runAfter": {
                        "Respond_to_a_PowerApp_or_flow_2": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c96f244b-3c1d-43b6-b930-9df94f180269"
                      },
                      "type": "Terminate",
                      "inputs": {
                        "runStatus": "Succeeded"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Environment_as_Admin": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c299c937-0303-4db4-93e9-900fcc68b0c4"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "92d470ee-d893-464b-8e9b-f1588f45626b"
              },
              "type": "Scope"
            },
            "Get_Envt_Names": {
              "actions": {
                "envtGUID": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "df954358-b63e-4486-97ab-c5767747ed56"
                  },
                  "type": "Compose",
                  "inputs": "@substring(triggerBody()['text'], sub(length(triggerBody()['text']), 36), 36)"
                },
                "Get_Envt_from_CoE_inventory": {
                  "runAfter": {
                    "envtGUID": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "113a32c5-e1c3-4a18-8128-ef22c91be344"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_environments",
                      "recordId": "@outputs('envtGUID')",
                      "$select": "admin_displayname"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "EnvtDisplayName": {
                  "runAfter": {
                    "Get_Envt_from_CoE_inventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "992adb7c-40b9-440c-b078-99617c2095d6"
                  },
                  "type": "Compose",
                  "inputs": "@outputs('Get_Envt_from_CoE_inventory')?['body/admin_displayname']"
                }
              },
              "runAfter": {
                "Recheck_envt_still_exists,_exit_if_not": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "2887cefe-51b3-431e-8893-10a77ba6b03d"
              },
              "type": "Scope"
            },
            "Get_Tenant_Size": {
              "actions": {
                "Get_Tenant": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_grouphasguestusers",
                      "$filter": "admin_type eq 'Tenant'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Tenant_Size": {
                  "runAfter": {
                    "Get_Tenant": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "48f03755-078b-4a77-a65a-c271f71274a3"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(length(outputs('Get_Tenant')?['body/value']), 0), 0, coalesce(first(outputs('Get_Tenant')?['body/value'])['admin_groupsize'], 0))"
                },
                "Tenant_Has_Guests": {
                  "runAfter": {
                    "Tenant_Size": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "742f9099-c44a-4507-8318-9b7cfe951276"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(length(outputs('Get_Tenant')?['body/value']), 0), false, coalesce(first(outputs('Get_Tenant')?['body/value'])['admin_grouphasguestusers'], false))"
                },
                "Tenant_User_ID": {
                  "runAfter": {
                    "Tenant_Has_Guests": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "743fc174-feb2-4868-a0aa-7ea896b56596"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(length(outputs('Get_Tenant')?['body/value']), 0), '', coalesce(first(outputs('Get_Tenant')?['body/value'])['admin_powerplatformuserid'], ''))"
                }
              },
              "runAfter": {
                "Cleanup_-_Delete_records_without_lookups": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "ef018126-d754-4db4-afcd-632076b0a4a1"
              },
              "type": "Scope"
            },
            "Get_Apps_as_Admin": {
              "runAfter": {
                "Get_All_Other_Users_Types": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "489d7a10-9a00-4734-99da-85e86d8c749a"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_powerappsforadmins_1",
                  "operationId": "Get-AdminApps",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins"
                },
                "parameters": {
                  "environment": "@triggerBody()['text']",
                  "api-version": "2016-11-01",
                  "$top": 250
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            },
            "Filter_To_Non_Embedded_Apps": {
              "runAfter": {
                "Get_Apps_as_Admin": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "3fff400c-654d-44be-afc9-4f1aea7dbf81"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('Get_Apps_as_Admin')?['body/value']",
                "where": "@not(equals(item()?['properties']?['embeddedApp']?['type'], 'SharepointFormApp'))"
              }
            },
            "Walk_the_Apps_in_this_Envt": {
              "foreach": "@body('Filter_To_Non_Embedded_Apps')",
              "actions": {
                "catch_not_yet_in_inventory": {
                  "runAfter": {
                    "Get_a_record": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "00575e45-924c-4269-a3c9-c56edc47619e"
                  },
                  "type": "Compose",
                  "inputs": "catch not yet in inventory"
                },
                "Update_Roles_Information": {
                  "actions": {
                    "Roles_exist": {
                      "actions": {
                        "Ensure_all_Users_exist": {
                          "actions": {
                            "Filter_out_Tenant_User": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "b54bddce-ff6f-4a74-9f05-33e7327f8ab7"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@outputs('Get_App_Role_Assignments_as_Admin')?['body/value']",
                                "where": "@not(equals(item()?['properties/principal/type'], 'Tenant'))"
                              }
                            },
                            "Actual_Users": {
                              "runAfter": {
                                "Filter_out_Tenant_User": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "ac167fa5-deab-4d82-899c-10dd195581ed"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Filter_out_Tenant_User')",
                                "select": {
                                  "UserID": "@item()?['properties/principal/id']",
                                  "UserType": "@item()?['properties/principal/type']",
                                  "UserName": "@item()?['properties/principal/displayName']"
                                }
                              }
                            },
                            "New_Users_to_Add": {
                              "runAfter": {
                                "Actual_Users": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "b87104d1-5371-4ae2-b545-29b1a3234e7f"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Actual_Users')",
                                "where": "@not(contains(body('Inventory_Users'), item()))"
                              }
                            },
                            "Apply_to_each_New_User_to_Add": {
                              "foreach": "@body('New_Users_to_Add')",
                              "actions": {
                                "Switch_on_new_user_to_add_type": {
                                  "runAfter": {},
                                  "cases": {
                                    "Group": {
                                      "case": "Group",
                                      "actions": {
                                        "ListGroupMembersTransitive": {
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "473a0b49-614a-4ab8-9e7f-fabfb92a68de"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_webcontents",
                                              "operationId": "InvokeHttp",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                                            },
                                            "parameters": {
                                              "request/method": "GET",
                                              "request/url": "@{parameters('Graph URL Environment Variable (admin_GraphURLEnvironmentVariable)')}v1.0/groups/@{items('Apply_to_each_new_User_to_Add')?['UserID']}/transitivemembers?$select=odata.type, id, userType"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_Group_as_Orphan": {
                                          "runAfter": {
                                            "ListGroupMembersTransitive": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "ee2d4654-6ffe-4e13-987b-8b0d19b043f8"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 0,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Enter_Group_Info": {
                                          "actions": {
                                            "Filter_to_just_type_users": {
                                              "runAfter": {},
                                              "metadata": {
                                                "operationMetadataId": "7812b59b-5565-42fc-90e1-32322f07e012"
                                              },
                                              "type": "Query",
                                              "inputs": {
                                                "from": "@outputs('ListGroupMembersTransitive')?['body/value']",
                                                "where": "@equals(item()?['@odata.type'], '#microsoft.graph.user')"
                                              }
                                            },
                                            "Filter_to_Guest_Users": {
                                              "runAfter": {
                                                "Filter_to_just_type_users": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "b2edcec7-6e2f-4ea6-a16b-07637694007a"
                                              },
                                              "type": "Query",
                                              "inputs": {
                                                "from": "@body('Filter_to_just_type_users')",
                                                "where": "@equals(item()?['userType'], 'Guest')"
                                              }
                                            },
                                            "Upsert_New_Group": {
                                              "runAfter": {
                                                "Filter_to_Guest_Users": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "1e0eeb5d-e025-43e1-9b68-bd2da6e10e36"
                                              },
                                              "type": "OpenApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connectionName": "shared_commondataserviceforapps_2",
                                                  "operationId": "UpdateRecord",
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_powerplatformusers",
                                                  "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                                  "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                                  "item/admin_groupsize": "@length(body('Filter_to_just_type_users'))",
                                                  "item/admin_grouphasguestusers": "@if(equals(length(body('Filter_to_Guest_Users')), 0), false, true)",
                                                  "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                                  "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                                  "item/admin_userisorphaned": false,
                                                  "item/admin_userisguest": false
                                                },
                                                "authentication": {
                                                  "type": "Raw",
                                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                                }
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Upsert_Group_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "9f98715f-4fb0-4d7c-bf5c-e87b9b69b4da"
                                          },
                                          "type": "Scope"
                                        }
                                      }
                                    },
                                    "User": {
                                      "case": "User",
                                      "actions": {
                                        "Get_user_profile_(V2)": {
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "2b525fc7-14f9-4419-ae3d-4267eccb6f94"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_office365users_1",
                                              "operationId": "UserProfile_V2",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users"
                                            },
                                            "parameters": {
                                              "id": "@items('Apply_to_each_new_User_to_Add')?['UserID']"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_User_as_Orphan": {
                                          "runAfter": {
                                            "Get_user_profile_(V2)": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "41019a1d-e102-4460-9d75-ecc1f93709b7"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": "@if(equals(outputs('Get_user_profile_(V2)')?['body/userType'], 'Guest'), true, false)"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_New_User": {
                                          "runAfter": {
                                            "Upsert_User_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "7110afbe-a6d1-48c5-8679-1e060eaf0c02"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": false,
                                              "item/admin_userisguest": "@if(equals(outputs('Get_user_profile_(V2)')?['body/userType'], 'Guest'), true, false)"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "ServicePrincipal": {
                                      "case": "ServicePrincipal",
                                      "actions": {
                                        "Look_up_in_AD_for_Service_Principle": {
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "aa370c3e-42f1-4f16-8144-dfc42fc9e94b"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_webcontents",
                                              "operationId": "InvokeHttp",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                                            },
                                            "parameters": {
                                              "request/method": "GET",
                                              "request/url": "@{parameters('Graph URL Environment Variable (admin_GraphURLEnvironmentVariable)')}v1.0/servicePrincipals?$filter=Id eq '@{items('Apply_to_each_new_User_to_Add')?['UserID']}'"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_Service_Principle_as_Orphan": {
                                          "runAfter": {
                                            "Look_up_in_AD_for_Service_Principle": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "02933be4-f388-41ef-ae86-1157070b0445"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_New_Service_Principle": {
                                          "runAfter": {
                                            "Upsert_Service_Principle_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "c63e07bc-ac39-4ee2-ad72-6983e015853a"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": false,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "default": {
                                    "actions": {}
                                  },
                                  "expression": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                  "metadata": {
                                    "operationMetadataId": "0ead0260-3cc4-40cc-b558-5679ab739a40"
                                  },
                                  "type": "Switch"
                                }
                              },
                              "runAfter": {
                                "New_Users_to_Add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "02e8cffb-7cf4-4e39-8a2f-2d7a7bfc5194"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "068933ab-510e-4721-85d8-771a160ad9ea"
                          },
                          "type": "Scope"
                        },
                        "Ensure_all_other_User_Roles_exist": {
                          "actions": {
                            "Find_new_roles_to_add": {
                              "runAfter": {
                                "Select_actual_roles": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "436d44e0-ac8f-42e5-a99f-ea219c37f79a"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_actual_roles')",
                                "where": "@not(contains(body('Select_inventoried_roles'), item()))"
                              }
                            },
                            "Find_removed_roles_to_delete": {
                              "runAfter": {
                                "Apply_to_each_role_to_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "872d6342-a74e-4e76-90c3-aa31d517a857"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_inventoried_roles')",
                                "where": "@not(contains(body('Select_actual_roles'), item()))"
                              }
                            },
                            "Apply_to_each_role_to_add": {
                              "foreach": "@body('Find_new_roles_to_add')",
                              "actions": {
                                "Add_a_new_role": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "81271791-9e2d-4e56-9484-cf74bb03e077"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "CreateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "item/admin_name": "@items('Apply_to_each_role_to_add')?['theUniqueName']",
                                      "item/admin_App@odata.bind": "admin_apps(@{outputs('Get_a_record')?['body/admin_appid']})",
                                      "item/admin_Environment@odata.bind": "admin_environments(@{outputs('envtGUID')})",
                                      "item/admin_PowerPlatformUser@odata.bind": "admin_powerplatformusers(@{items('Apply_to_each_role_to_add')?['theUserID']})",
                                      "item/admin_resourcetype": "App",
                                      "item/admin_resourceuserlink": "@items('Apply_to_each_role_to_add')?['theUniqueName']",
                                      "item/admin_rolename": "@items('Apply_to_each_role_to_add')?['theRole']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Find_new_roles_to_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "020de533-932e-4c58-a689-0bf757c16e3f"
                              },
                              "type": "Foreach"
                            },
                            "Apply_to_each_role_to_delete": {
                              "foreach": "@body('Find_removed_roles_to_delete')",
                              "actions": {
                                "Find_it_to_delete": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "99057e07-7f9c-4c67-9df7-05e9d392e766"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid",
                                      "$filter": "admin_resourceuserlink eq '@{items('Apply_to_each_role_to_delete')?['theUniqueName']}' and admin_rolename eq '@{items('Apply_to_each_role_to_delete')?['theRole']}'"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Delete_the_role": {
                                  "runAfter": {
                                    "Find_it_to_delete": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "97bdb1a0-4cd3-462b-8b1b-8bdff9875310"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "DeleteRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "recordId": "@first(outputs('Find_it_to_delete')?['body/value'])?['admin_powerplatformuserroleid']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Find_removed_roles_to_delete": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "92c5fd92-2225-48d0-8c54-d8b9cd4c937d"
                              },
                              "type": "Foreach"
                            },
                            "Select_actual_roles": {
                              "runAfter": {
                                "Filter_out_actual_tenant_roles": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "d64e772a-96a0-460d-8854-2ee1ccdfa6f5"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Filter_out_actual_tenant_roles')",
                                "select": {
                                  "theUniqueName": "@concat(item()?['name'], items('Walk_the_Apps_in_this_Envt')?['name'])",
                                  "theRole": "@item()?['properties/roleName']",
                                  "theUserID": "@item()?['properties']?['principal']?['id']"
                                }
                              }
                            },
                            "Filter_out_actual_tenant_roles": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "236a3440-250b-48ad-b48b-c8d9f83844e8"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@outputs('Get_App_Role_Assignments_as_Admin')?['body/value']",
                                "where": "@not(equals(item()?['properties/principal/type'], 'Tenant'))"
                              }
                            }
                          },
                          "runAfter": {
                            "Add_Remove_Tenant_Role": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ac0cb6d4-b1d9-45e4-8858-c9f8bc8679a7"
                          },
                          "type": "Scope"
                        },
                        "Get_Counts_for_Apps": {
                          "actions": {
                            "Update_app_sharing_counts": {
                              "runAfter": {
                                "Editor_count": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "613ad207-9d54-4ac8-837e-8312cc6edf13"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "UpdateRecord",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_apps",
                                  "recordId": "@items('Walk_the_Apps_in_this_Envt')?['name']",
                                  "item/admin_appsharededitors": "@outputs('Sum_total_users_Editors')",
                                  "item/admin_appsharedgroups": "@length(body('Filter_to_Groups'))",
                                  "item/admin_appsharedguesteditor": "@if(equals(length(body('Filter_to_Guests_Editors')), 0), false, true)",
                                  "item/admin_appsharedguestuser": "@if(equals(length(body('Filter_to_Guests')), 0), false, true)",
                                  "item/admin_appsharedusers": "@outputs('Sum_total_users')",
                                  "item/admin_appsharedwithtenant": "@outputs('Actual_shows_Shared_with_Tenant')"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                },
                                "retryPolicy": {
                                  "type": "exponential",
                                  "count": 10,
                                  "interval": "PT10S"
                                }
                              }
                            },
                            "Total_user_count": {
                              "actions": {
                                "List_updated_role_list_for_this_app": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d8da4fe0-175f-4c91-864d-17b5cd73878f"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid, admin_rolename",
                                      "$filter": "_admin_app_value eq @{outputs('Get_a_record')?['body/admin_appid']}",
                                      "$expand": "admin_PowerPlatformUser($select=admin_grouphasguestusers, admin_userisguest, admin_groupsize, admin_type)"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Filter_to_Groups": {
                                  "runAfter": {
                                    "List_updated_role_list_for_this_app": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "394e6dd9-fd0f-4aeb-a397-bcbc9c3c5c83"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_app')?['body/value']",
                                    "where": "@equals(item()?['admin_powerplatformuser/admin_type'], 'Group')"
                                  }
                                },
                                "Filter_to_Guests": {
                                  "runAfter": {
                                    "Filter_to_Groups": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8ba06a41-6676-43fa-b981-e00bdc311580"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_app')?['body/value']",
                                    "where": "@or(equals(item()?['admin_powerplatformuser/admin_userisguest'], true), equals(item()?['admin_powerplatformuser/admin_grouphasguestusers'], true))"
                                  }
                                },
                                "Get_Total_User_Count": {
                                  "actions": {
                                    "Select_GroupSize": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "c9ffddbc-6fb8-4356-9302-1f06de5e7ada"
                                      },
                                      "type": "Select",
                                      "inputs": {
                                        "from": "@outputs('List_updated_role_list_for_this_app')?['body/value']",
                                        "select": "@item()?['admin_powerplatformuser/admin_groupsize']"
                                      }
                                    },
                                    "JSON_group_size": {
                                      "runAfter": {
                                        "Select_GroupSize": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ab8d6358-f73c-4acc-a9db-bcc6c1b134f3"
                                      },
                                      "type": "Compose",
                                      "inputs": {
                                        "root": {
                                          "Numbers": "@body('Select_GroupSize')"
                                        }
                                      }
                                    },
                                    "XML_group_size": {
                                      "runAfter": {
                                        "JSON_group_size": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "e99cf5d8-f7b3-451e-850c-73cd2a353812"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xml(outputs('JSON_group_size'))"
                                    },
                                    "Sum_total_users": {
                                      "runAfter": {
                                        "XML_group_size": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "09ee2e0b-25a0-43bf-ae74-992229d3cf33"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xpath(outputs('XML_group_size'), 'sum(/root/Numbers)')"
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_to_Guests": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "71e88d7f-60eb-44de-a811-a01cde34b19c"
                                  },
                                  "type": "Scope"
                                }
                              },
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "303387fe-a50c-4bae-9023-2e1fd786acb0"
                              },
                              "type": "Scope"
                            },
                            "Editor_count": {
                              "actions": {
                                "List_updated_role_list_for_this_app_editors": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d8da4fe0-175f-4c91-864d-17b5cd73878f"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid, admin_rolename",
                                      "$filter": "_admin_app_value eq @{outputs('Get_a_record')?['body/admin_appid']} and admin_rolename eq 'CanEdit'",
                                      "$expand": "admin_PowerPlatformUser($select=admin_grouphasguestusers, admin_userisguest, admin_groupsize, admin_type)"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Filter_to_Group_Editors": {
                                  "runAfter": {
                                    "List_updated_role_list_for_this_app_editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "394e6dd9-fd0f-4aeb-a397-bcbc9c3c5c83"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_app_editors')?['body/value']",
                                    "where": "@equals(item()?['admin_powerplatformuser/admin_type'], 'Group')"
                                  }
                                },
                                "Filter_to_Guests_Editors": {
                                  "runAfter": {
                                    "Filter_to_Group_Editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8ba06a41-6676-43fa-b981-e00bdc311580"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_app_editors')?['body/value']",
                                    "where": "@or(equals(item()?['admin_powerplatformuser/admin_userisguest'], true), equals(item()?['admin_powerplatformuser/admin_grouphasguestusers'], true))"
                                  }
                                },
                                "Get_Total_User_Count_Editors": {
                                  "actions": {
                                    "Select_GroupSize_Editors": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "c9ffddbc-6fb8-4356-9302-1f06de5e7ada"
                                      },
                                      "type": "Select",
                                      "inputs": {
                                        "from": "@outputs('List_updated_role_list_for_this_app_editors')?['body/value']",
                                        "select": "@item()?['admin_powerplatformuser/admin_groupsize']"
                                      }
                                    },
                                    "JSON_group_size_Editors": {
                                      "runAfter": {
                                        "Select_GroupSize_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ab8d6358-f73c-4acc-a9db-bcc6c1b134f3"
                                      },
                                      "type": "Compose",
                                      "inputs": {
                                        "root": {
                                          "Numbers": "@body('Select_GroupSize_Editors')"
                                        }
                                      }
                                    },
                                    "XML_group_size_Editors": {
                                      "runAfter": {
                                        "JSON_group_size_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "e99cf5d8-f7b3-451e-850c-73cd2a353812"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xml(outputs('JSON_group_size_Editors'))"
                                    },
                                    "Sum_total_users_Editors": {
                                      "runAfter": {
                                        "XML_group_size_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "09ee2e0b-25a0-43bf-ae74-992229d3cf33"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xpath(outputs('XML_group_size_Editors'), 'sum(/root/Numbers)')"
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_to_Guests_Editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "71e88d7f-60eb-44de-a811-a01cde34b19c"
                                  },
                                  "type": "Scope"
                                }
                              },
                              "runAfter": {
                                "Total_user_count": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a739c2f6-f207-4fbe-97d5-e133c390547b"
                              },
                              "type": "Scope"
                            }
                          },
                          "runAfter": {
                            "Ensure_all_other_User_Roles_exist": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "2594d35b-d45b-49ed-85c8-b032b2ba334b"
                          },
                          "type": "Scope"
                        },
                        "Add_Remove_Tenant_Role": {
                          "actions": {
                            "Filter_to_actual_tenant_roles": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "afb1ca18-057b-4422-8ee5-7745341f8be8"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@outputs('Get_App_Role_Assignments_as_Admin')?['body/value']",
                                "where": "@equals(item()?['properties/principal/type'], 'Tenant')"
                              }
                            },
                            "Actual_shows_Shared_with_Tenant": {
                              "runAfter": {
                                "Filter_to_actual_tenant_roles": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "d5db1083-ce82-4052-a532-1025f620a88f"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(length(body('Filter_to_actual_tenant_roles')), 0), false, true)"
                            },
                            "If_Actual_Shared_with_Tenant": {
                              "actions": {
                                "If_already_in_Inventory": {
                                  "actions": {
                                    "No_Op_Tenant_already_in_Role_List": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "4b64bc3f-6d08-4024-b9ba-a2d1dbdcaa03"
                                      },
                                      "type": "Compose",
                                      "inputs": "No Op Tenant already in Role List"
                                    }
                                  },
                                  "runAfter": {},
                                  "else": {
                                    "actions": {
                                      "Add_Tenant_User": {
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "0d00f28a-50b3-43f8-9445-52dadea2ba01"
                                        },
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "host": {
                                            "connectionName": "shared_commondataserviceforapps_2",
                                            "operationId": "CreateRecord",
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                          },
                                          "parameters": {
                                            "entityName": "admin_powerplatformuserroles",
                                            "item/admin_name": "@concat(first(body('Filter_to_actual_tenant_roles'))?['name'], outputs('Get_a_record')?['body/admin_appid'])",
                                            "item/admin_App@odata.bind": "admin_apps(@{outputs('Get_a_record')?['body/admin_appid']})",
                                            "item/admin_Environment@odata.bind": "admin_environments(@{outputs('envtGUID')})",
                                            "item/admin_PowerPlatformUser@odata.bind": "admin_powerplatformusers(@{outputs('Tenant_User_ID')})",
                                            "item/admin_resourcetype": "App",
                                            "item/admin_resourceuserlink": "@concat(first(body('Filter_to_actual_tenant_roles'))?['name'], outputs('Get_a_record')?['body/admin_appid'])",
                                            "item/admin_rolename": "CanView"
                                          },
                                          "authentication": {
                                            "type": "Raw",
                                            "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "equals": [
                                      "@outputs('Inventory_Shows_Shared_With_Tenant')",
                                      "@true"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e13613ea-e291-427c-90ea-a388d3f17b90"
                                  },
                                  "type": "If"
                                }
                              },
                              "runAfter": {
                                "Actual_shows_Shared_with_Tenant": [
                                  "Succeeded"
                                ]
                              },
                              "else": {
                                "actions": {
                                  "If_in_Inventory": {
                                    "actions": {
                                      "Delete_All_Tenant_User_Roles": {
                                        "foreach": "@body('Filter_to_tenant_inventoried_roles')",
                                        "actions": {
                                          "Delete_Tenant_User_Role": {
                                            "runAfter": {},
                                            "metadata": {
                                              "operationMetadataId": "ae1db533-7d10-47c5-a603-3d8d48865b78"
                                            },
                                            "type": "OpenApiConnection",
                                            "inputs": {
                                              "host": {
                                                "connectionName": "shared_commondataserviceforapps_2",
                                                "operationId": "DeleteRecord",
                                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                              },
                                              "parameters": {
                                                "entityName": "admin_powerplatformuserroles",
                                                "recordId": "@items('Delete_All_Tenant_User_Roles')?['admin_powerplatformuserroleid']"
                                              },
                                              "authentication": {
                                                "type": "Raw",
                                                "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                              }
                                            }
                                          }
                                        },
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "e7f28ec6-262f-46e8-941f-7f03bd0a1a5b"
                                        },
                                        "type": "Foreach"
                                      }
                                    },
                                    "runAfter": {},
                                    "expression": {
                                      "equals": [
                                        "@outputs('Inventory_Shows_Shared_With_Tenant')",
                                        "@true"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "cba27b12-7cc2-46e5-a384-e952371e9965"
                                    },
                                    "type": "If"
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@outputs('Actual_shows_Shared_with_Tenant')",
                                  "@true"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "c36409a1-fba9-45d8-8077-f0d664ab0125"
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "Ensure_all_Users_exist": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "b3e85e16-a30b-4910-a0f1-2f34176a453e"
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "No_Roles_Exist": [
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "80300340-f77d-4a01-b41a-8628662b70c7"
                      },
                      "type": "Scope"
                    },
                    "No_Roles_Exist": {
                      "actions": {
                        "Delete_all_the_roles": {
                          "actions": {
                            "List_all_roles_for_this_app": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "803b216b-5cc9-46cb-9581-e74a87d33622"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps_2",
                                  "operationId": "ListRecords",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_powerplatformuserroles",
                                  "$select": "admin_powerplatformuserroleid",
                                  "$filter": "_admin_app_value eq @{outputs('Get_a_record')?['body/admin_appid']}"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                }
                              }
                            },
                            "Delete_all_roles_for_this_app": {
                              "foreach": "@outputs('List_all_roles_for_this_app')?['body/value']",
                              "actions": {
                                "Delete_roles_for_this_app": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d35d7848-fc94-4f5d-8e5e-9ffd5806f951"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "DeleteRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "recordId": "@items('Delete_all_roles_for_this_app')?['admin_powerplatformuserroleid']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "List_all_roles_for_this_app": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "94d46914-6e97-4304-b850-612d16305085"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "af844ad1-6b90-4f3e-9fbb-06ae21b7b48b"
                          },
                          "type": "Scope"
                        },
                        "Update_app_sharing_counts_to_zero": {
                          "runAfter": {
                            "Delete_all_the_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "613ad207-9d54-4ac8-837e-8312cc6edf13"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "UpdateRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_apps",
                              "recordId": "@items('Walk_the_Apps_in_this_Envt')?['name']",
                              "item/admin_appsharededitors": 0,
                              "item/admin_appsharedgroups": 0,
                              "item/admin_appsharedguesteditor": false,
                              "item/admin_appsharedguestuser": false,
                              "item/admin_appsharedusers": 0,
                              "item/admin_appsharedwithtenant": false
                            },
                            "authentication": {
                              "type": "Raw",
                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Get_App_Role_Assignments_as_Admin": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c566aade-4cf9-483c-bbba-ab29d5ce7d88"
                      },
                      "type": "Scope"
                    },
                    "Get_Inventoried_Roles": {
                      "actions": {
                        "List_inventoried_roles": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "9331c727-0014-45cb-a9f8-4aa0e2ba9393"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps_2",
                              "operationId": "ListRecords",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_powerplatformuserroles",
                              "$select": "admin_powerplatformuserroleid, admin_name, admin_rolename, _admin_powerplatformuser_value",
                              "$filter": "_admin_environment_value eq @{outputs('envtGUID')} and _admin_app_value eq @{items('Walk_the_Apps_in_this_Envt')?['name']} and admin_resourcetype eq 'App'"
                            },
                            "authentication": {
                              "type": "Raw",
                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                            }
                          }
                        },
                        "Select_inventoried_roles": {
                          "runAfter": {
                            "Filter_to_non_tenant_inventoried_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "adbd1989-bd4b-494e-abe8-d18201be3edb"
                          },
                          "type": "Select",
                          "inputs": {
                            "from": "@body('Filter_to_non_tenant_inventoried_roles')",
                            "select": {
                              "theUniqueName": "@item()?['admin_name']",
                              "theRole": "@item()?['admin_rolename']",
                              "theUserID": "@item()?['_admin_powerplatformuser_value']"
                            }
                          }
                        },
                        "Filter_to_non_tenant_inventoried_roles": {
                          "runAfter": {
                            "Inventory_Shows_Shared_With_Tenant": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "eb28af4d-0e02-4e3e-ad75-e8ba6848a1d3"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('List_inventoried_roles')?['body/value']",
                            "where": "@not(equals(item()?['admin_rolename'], 'Tenant'))"
                          }
                        },
                        "Filter_to_tenant_inventoried_roles": {
                          "runAfter": {
                            "List_inventoried_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "c38d2064-49e2-4dd2-a2bc-389ce0fefa26"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('List_inventoried_roles')?['body/value']",
                            "where": "@equals(item()?['admin_rolename'], 'Tenant')"
                          }
                        },
                        "Inventory_Shows_Shared_With_Tenant": {
                          "runAfter": {
                            "Filter_to_tenant_inventoried_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "38543bb5-7887-45f7-9caf-d423ecc9ce3c"
                          },
                          "type": "Compose",
                          "inputs": "@if(equals(length(body('Filter_to_tenant_inventoried_roles')), 0), false, true)"
                        }
                      },
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "1d1528a4-16a5-4b72-85ec-d3c2f8ec19e9"
                      },
                      "type": "Scope"
                    },
                    "Get_App_Role_Assignments_as_Admin": {
                      "runAfter": {
                        "Get_Inventoried_Roles": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "7d97c9ac-572b-4c8e-9a83-225db4614d14"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_powerappsforadmins_1",
                          "operationId": "Get-AdminAppRoleAssignment",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins"
                        },
                        "parameters": {
                          "environment": "@triggerBody()['text']",
                          "app": "@items('Walk_the_Apps_in_this_Envt')?['name']",
                          "api-version": "2016-11-01",
                          "$top": 250
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "catch_not_yet_in_inventory": [
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3b1d2a5a-d9d5-4129-80f4-c8a20a342cef"
                  },
                  "type": "Scope"
                },
                "Get_a_record": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "58a1b4b1-9ea6-44af-a087-de9645d26eff"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_apps",
                      "recordId": "@items('Walk_the_Apps_in_this_Envt')?['name']"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                }
              },
              "runAfter": {
                "Filter_To_Non_Embedded_Apps": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e2239ac-f88e-4e82-a925-a3650d07fe9c"
              },
              "type": "Foreach",
              "runtimeConfiguration": {
                "concurrency": {
                  "repetitions": 50
                }
              }
            },
            "Get_All_Other_Users_Types": {
              "actions": {
                "Get_Groups": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_grouphasguestusers",
                      "$filter": "admin_type eq 'Group'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_Users": {
                  "runAfter": {
                    "Get_Groups": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest",
                      "$filter": "admin_type eq 'User'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_ServicePrincipals": {
                  "runAfter": {
                    "Get_Users": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest",
                      "$filter": "admin_type eq 'ServicePrincipal'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_Non_Tenant_Users": {
                  "runAfter": {
                    "Get_ServicePrincipals": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest, admin_type, admin_displayname",
                      "$filter": "admin_type ne 'Tenant'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Inventory_Users": {
                  "runAfter": {
                    "Get_Non_Tenant_Users": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "19df4b28-605b-4c15-8ca9-a960522f5ea2"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@outputs('Get_Non_Tenant_Users')?['body/value']",
                    "select": {
                      "UserID": "@item()?['admin_powerplatformuserid']",
                      "UserType": "@item()?['admin_type']",
                      "UserName": "@item()?['admin_displayname']"
                    }
                  }
                }
              },
              "runAfter": {
                "Get_Tenant_Size": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "063f3dc4-8137-4fd4-ba15-efb4c5938012"
              },
              "type": "Scope"
            },
            "Cleanup_-_Delete_records_without_lookups": {
              "actions": {
                "Delete_all_roles_without_lookups": {
                  "foreach": "@outputs('List_roles_without_lookups')?['body/value']",
                  "actions": {
                    "Delete_roles_without_lookups": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "d1f4322f-4982-4cb8-aa15-557c66aeef88"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_2",
                          "operationId": "DeleteRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_powerplatformuserroles",
                          "recordId": "@items('Delete_all_roles_without_lookups')?['admin_powerplatformuserroleid']"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_roles_without_lookups": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "aee10781-22c5-4463-a414-d0f3c255dd4a"
                  },
                  "type": "Foreach"
                },
                "List_roles_without_lookups": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "dcbb3ca5-a2b6-4ff3-8ae8-2686783bf9fa"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformuserroles",
                      "$select": "admin_powerplatformuserroleid",
                      "$filter": "_admin_powerplatformuser_value eq null and _admin_environment_value eq @{outputs('envtGUID')}"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                }
              },
              "runAfter": {
                "Get_Envt_Names": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "71952a90-18fa-4fb6-9b44-b6e5658d245d"
              },
              "type": "Scope",
              "description": "Temp remomove in Fall 2024 - previously we didnt lookup for tenant user"
            }
          },
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "866325b8-169b-4d4f-83f9-45e4f7cf1ce7"
          },
          "type": "Scope"
        }
      },
      "outputs": {}
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}