{
  "properties": {
    "connectionReferences": {
      "shared_powerappsforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin2"
        },
        "api": {
          "name": "shared_powerappsforadmins"
        }
      },
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_office365users": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreOffice365Users"
        },
        "api": {
          "name": "shared_office365users"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_3": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdminsEnvRequest"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "Admin eMail (admin_AdminMail)": {
          "defaultValue": "PPAdmin@powercattools25q2.onmicrosoft.com",
          "type": "String",
          "metadata": {
            "schemaName": "admin_AdminMail",
            "description": "Inventory - CoE Admin eMail. Email address used in flows to send notifications to admins; this should be either your email address or a distribution list"
          }
        },
        "DelayObjectInventory (admin_DelayObjectInventory)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_DelayObjectInventory",
            "description": "Inventory - If Yes, will run a delay step to assist with the Dataverse throttling. Things like solutions, apps, flows, will have delays in the individual envt runs. Default No."
          }
        }
      },
      "triggers": {
        "When_a_row_is_created_or_updated": {
          "metadata": {
            "operationMetadataId": "870e68af-a6ba-4c6c-967f-77e5390963ee"
          },
          "type": "OpenApiConnectionWebhook",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps_2",
              "operationId": "SubscribeWebhookTrigger",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "subscriptionRequest/message": 4,
              "subscriptionRequest/entityname": "admin_environment",
              "subscriptionRequest/scope": 4
            },
            "authentication": "@parameters('$authentication')"
          }
        }
      },
      "actions": {
        "Get_Connection_Identities_and_store_them_in_CoE_CDS_Entity": {
          "actions": {
            "GetCurrentActual": {
              "actions": {
                "Select_connection_and_name": {
                  "runAfter": {
                    "Filter_to_connections_with_accountName": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "9c6dd552-16a6-4eea-bb11-64b58033e383"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@body('Filter_to_connections_with_accountName')",
                    "select": {
                      "connectionName": "@last(split(item()?['properties/apiId'], '/'))",
                      "accountName": "@item()?['properties/accountName']",
                      "connectionCreator": "@item()?['properties']?['createdBy']?['id']",
                      "connectionCreatorUPN": "@item()?['properties']?['createdBy']?['userPrincipalName']"
                    }
                  }
                },
                "Get_distinct_set": {
                  "runAfter": {
                    "Select_connection_and_name": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "19b967ae-b4f4-4191-aa1e-600d0d7fff7c"
                  },
                  "type": "Compose",
                  "inputs": "@intersection(body('Select_connection_and_name'), body('Select_connection_and_name'))"
                },
                "Parsed_Current": {
                  "runAfter": {
                    "Get_distinct_set": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "967f7f67-d689-490c-b732-4ecbb78e6ea4"
                  },
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@outputs('Get_distinct_set')",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "connectionName": {
                            "type": "string"
                          },
                          "accountName": {
                            "type": "string"
                          },
                          "connectionCreator": {
                            "type": "string"
                          },
                          "connectionCreatorUPN": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "connectionName",
                          "accountName",
                          "connectionCreator",
                          "connectionCreatorUPN"
                        ]
                      }
                    }
                  }
                },
                "Filter_to_connections_with_accountName": {
                  "runAfter": {
                    "Get_Connections_as_Admin": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "97531256-757e-46b9-a3c4-8ef4cf6d2062"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@outputs('Get_Connections_as_Admin')?['body/value']",
                    "where": "@and(not(equals(item()?['properties/accountName'], null)), not(equals(item()?['properties/createdBy/userPrincipalName'], null)))"
                  }
                },
                "Get_Connections_as_Admin": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "bab18f06-309d-4485-a8c2-0b9ce6053b46"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerappsforadmins",
                      "operationId": "Get-AdminConnections",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins"
                    },
                    "parameters": {
                      "environment": "@triggerOutputs()?['body/admin_environmentname']",
                      "api-version": "2016-11-01",
                      "$top": 1000
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 20,
                      "interval": "PT20S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                }
              },
              "runAfter": {
                "GetCurrentInventory": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9ce85202-5ccb-40c4-99dc-c715bba1020a"
              },
              "type": "Scope"
            },
            "Remove_deleted_ones_from_inventory": {
              "actions": {
                "RemoveFromInventory": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "f7dee7c5-8dfc-4e13-ba97-26241944a102"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parsed_Inventory')",
                    "where": "@not(contains(body('Parsed_Current'), item()))"
                  }
                },
                "Apply_to_each_identified_to_delete": {
                  "foreach": "@body('RemoveFromInventory')",
                  "actions": {
                    "Delete_it": {
                      "runAfter": {
                        "Find_it_for_ID": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "8427e348-b9d2-4008-819e-e353fd96fa60"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_connectionreferenceidentities",
                          "recordId": "@first(outputs('Find_it_for_ID')?['body/value'])?['admin_connectionreferenceidentityid']"
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "RemoveSpecialChars": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "24fd15d6-ee7c-4419-91cf-8ee304daf0ee"
                      },
                      "type": "Compose",
                      "inputs": "@replace(coalesce(items('Apply_to_each_identified_to_delete')?['connectionCreatorUPN'], ''),'''','''''')"
                    },
                    "Find_it_for_ID": {
                      "runAfter": {
                        "RemoveSpecialChars": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "b5040aaf-adf4-4e13-a4e1-e7aed3815592"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_connectionreferenceidentities",
                          "$select": "admin_name, admin_accountname, admin_connectionreferenceidentityid",
                          "$filter": "_admin_environment_value eq @{triggerOutputs()?['body/admin_environmentid']} and admin_name eq '@{items('Apply_to_each_identified_to_delete')?['connectionName']}' and (admin_connectionreferencecreatordisplayname eq null or admin_connectionreferencecreatordisplayname eq '@{replace(coalesce(items('Apply_to_each_identified_to_delete')?['connectionCreatorUPN'], ''),'''','''''')}')",
                          "$top": 1
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    }
                  },
                  "runAfter": {
                    "RemoveFromInventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "4f49d0d7-18b8-4dad-bcf8-3b7189f8ab69"
                  },
                  "type": "Foreach"
                }
              },
              "runAfter": {
                "GetCurrentActual": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9347f4ab-6fcf-4e10-a946-95fe3dc449e1"
              },
              "type": "Scope"
            },
            "Add_new_ones_to_inventory": {
              "actions": {
                "AddToInventory": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "3e51b4f7-eb14-44c3-95c1-a9f4df780b05"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parsed_Current')",
                    "where": "@not(contains(body('Parsed_Inventory'), item()))"
                  }
                },
                "List_PowerApps_Connectors": {
                  "runAfter": {
                    "AddToInventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "907b2f23-b275-44b3-bb18-91757d4a2482"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_connectors",
                      "$select": "admin_name, admin_connectorid",
                      "$filter": "admin_name ne null"
                    },
                    "authentication": "@parameters('$authentication')"
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Apply_to_each": {
                  "foreach": "@body('AddToInventory')",
                  "actions": {
                    "xTenant_check": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "2e386dfa-d70a-434c-8adf-d6e5e90d0298"
                      },
                      "type": "Compose",
                      "inputs": "@if(contains(variables('HostDomainString'), toLower(last(split(items('Apply_to_each')['accountName'], '@')))), false, true)"
                    },
                    "GetConnectorGUID": {
                      "runAfter": {
                        "xTenant_check": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "82dac28f-eee1-4ded-bd25-33a1a305a234"
                      },
                      "type": "Query",
                      "inputs": {
                        "from": "@outputs('List_PowerApps_Connectors')?['body/value']",
                        "where": "@equals(item()?['admin_name'], items('Apply_to_each')['connectionName'])"
                      }
                    },
                    "ConnectorGUID": {
                      "runAfter": {
                        "GetConnectorGUID": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "a8290743-b8a3-48da-a4bc-c86a51228bfc"
                      },
                      "type": "Compose",
                      "inputs": "@first(body('GetConnectorGUID'))?['admin_connectorid']"
                    },
                    "RemoveSpecialChars_for_Add": {
                      "runAfter": {
                        "ConnectorGUID": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "290cb683-5ad4-451a-931b-86df23bd77df"
                      },
                      "type": "Compose",
                      "inputs": "@items('Apply_to_each')?['connectionCreatorUPN']"
                    },
                    "Get_user_profile_(V2)": {
                      "runAfter": {
                        "RemoveSpecialChars_for_Add": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "6d95db51-1849-4d38-926f-6f172e9d58e8"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_office365users",
                          "operationId": "UserProfile_V2",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users"
                        },
                        "parameters": {
                          "id": "@items('Apply_to_each')?['connectionCreator']"
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "Switch_on_result": {
                      "runAfter": {
                        "Get_user_profile_(V2)": [
                          "Succeeded",
                          "Failed"
                        ]
                      },
                      "cases": {
                        "200_Success": {
                          "case": 200,
                          "actions": {
                            "See_if_already_in_User_Table": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "f2fb034f-3a8d-43be-9641-a57d1a8bc2e6"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps_1",
                                  "operationId": "ListRecords",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_powerplatformusers",
                                  "$select": "admin_powerplatformuserid",
                                  "$filter": "admin_powerplatformuserid eq @{outputs('Get_user_profile_(V2)')?['body/id']}"
                                },
                                "authentication": "@parameters('$authentication')"
                              }
                            },
                            "If_not_already_in_user_table,_add": {
                              "actions": {
                                "Add_new_user": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "68139898-8c08-4985-a39b-8c04332abb47"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_1",
                                      "operationId": "CreateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformusers",
                                      "item/admin_displayname": "@outputs('Get_user_profile_(V2)')?['body/displayName']",
                                      "item/admin_company": "@outputs('Get_user_profile_(V2)')?['body/companyName']",
                                      "item/admin_department": "@outputs('Get_user_profile_(V2)')?['body/department']",
                                      "item/admin_groupsize": 1,
                                      "item/admin_powerplatformuserid": "@outputs('Get_user_profile_(V2)')?['body/id']",
                                      "item/admin_recordguidasstring": "@outputs('Get_user_profile_(V2)')?['body/id']",
                                      "item/admin_type": "User",
                                      "item/admin_useremail": "@outputs('Get_user_profile_(V2)')?['body/mail']",
                                      "item/admin_userisorphaned": false,
                                      "item/admin_userprincipalname": "@outputs('Get_user_profile_(V2)')?['body/userPrincipalName']"
                                    },
                                    "authentication": "@parameters('$authentication')"
                                  }
                                }
                              },
                              "runAfter": {
                                "See_if_already_in_User_Table": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "equals": [
                                  "@length(outputs('See_if_already_in_User_Table')?['body/value'])",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a7b4e9fc-5ebc-482e-aa33-0d7844956b3e"
                              },
                              "type": "If"
                            },
                            "Add_Connection_Identities": {
                              "runAfter": {
                                "If_not_already_in_user_table,_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "79ee55f1-841e-4298-b48f-5bf0c00cd684"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "CreateRecord",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_connectionreferenceidentities",
                                  "item/admin_name": "@items('Apply_to_each')['connectionName']",
                                  "item/admin_accountname": "@items('Apply_to_each')['accountName']",
                                  "item/admin_ConnectionReferenceCreator@odata.bind": "admin_powerplatformusers(@{items('Apply_to_each')?['connectionCreator']})",
                                  "item/admin_connectionreferencecreatordisplayname": "@items('Apply_to_each')?['connectionCreatorUPN']",
                                  "item/admin_Connector@odata.bind": "admin_connectors(@{outputs('ConnectorGUID')})",
                                  "item/admin_Environment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                  "item/admin_noneorcrosstenantidentity": "@outputs('xTenant_check')"
                                },
                                "authentication": "@parameters('$authentication')"
                              }
                            },
                            "catch_connector_not_found": {
                              "runAfter": {
                                "Add_Connection_Identities": [
                                  "Failed"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "c778f493-14be-4511-93a6-7c847db722fa"
                              },
                              "type": "Compose",
                              "inputs": "will be added once connector is inventoried"
                            }
                          }
                        },
                        "404_User_Not_Found": {
                          "case": 404,
                          "actions": {
                            "See_if_Orphan_already_in_User_Table": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "c0c10801-d92c-4f85-b00a-ac9568aa4bc8"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps_3",
                                  "operationId": "ListRecords",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_powerplatformusers",
                                  "$select": "admin_powerplatformuserid",
                                  "$filter": "admin_powerplatformuserid eq @{items('Apply_to_each')?['connectionCreator']}"
                                },
                                "authentication": "@parameters('$authentication')"
                              },
                              "runtimeConfiguration": {
                                "paginationPolicy": {
                                  "minimumItemCount": 100000
                                }
                              }
                            },
                            "If_orphan_not_already_in_user_table,_add": {
                              "actions": {
                                "Get_info_from_SystemUsers_table": {
                                  "actions": {
                                    "Find_user_in_SystemUser_table": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "ff2bc40e-d330-46ef-9ef9-e06ebb554c10"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps_3",
                                          "operationId": "ListRecordsWithOrganization",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "organization": "@triggerOutputs()?['body/admin_environmentcdsinstanceurl']",
                                          "entityName": "systemusers",
                                          "$select": "fullname",
                                          "$filter": "azureactivedirectoryobjectid eq @{items('Apply_to_each')?['connectionCreator']}"
                                        },
                                        "authentication": "@parameters('$authentication')"
                                      }
                                    },
                                    "orphan_user_name": {
                                      "runAfter": {
                                        "Find_user_in_SystemUser_table": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "fecf525c-80d8-4f08-8a50-a173fa883224"
                                      },
                                      "type": "Compose",
                                      "inputs": "@if(equals(length(outputs('Find_user_in_SystemUser_table')?['body/value']), 0), items('Apply_to_each')['accountName'], first(outputs('Find_user_in_SystemUser_table')?['body/value'])?['fullname'])"
                                    }
                                  },
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "55e88a76-62e9-4b3f-b794-629b26d49cb4"
                                  },
                                  "type": "Scope"
                                },
                                "Add_orphan": {
                                  "runAfter": {
                                    "Get_info_from_SystemUsers_table": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "c3df98ab-564f-4429-86e1-e1b32b1cb113"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_3",
                                      "operationId": "CreateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformusers",
                                      "item/admin_displayname": "@outputs('orphan_user_name')",
                                      "item/admin_groupsize": 1,
                                      "item/admin_powerplatformuserid": "@items('Apply_to_each')?['connectionCreator']",
                                      "item/admin_recordguidasstring": "@items('Apply_to_each')?['connectionCreator']",
                                      "item/admin_type": "User",
                                      "item/admin_useremail": "@items('Apply_to_each')?['accountName']",
                                      "item/admin_userisorphaned": true,
                                      "item/admin_userprincipalname": "@items('Apply_to_each')?['connectionCreatorUPN']"
                                    },
                                    "authentication": "@parameters('$authentication')"
                                  }
                                }
                              },
                              "runAfter": {
                                "See_if_Orphan_already_in_User_Table": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "equals": [
                                  "@length(outputs('See_if_Orphan_already_in_User_Table')?['body/value'])",
                                  0
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "7c955ba3-4fc4-4aa5-9faa-d29dd085f63d"
                              },
                              "type": "If"
                            },
                            "Add_Connection_Identities_for_Orphan": {
                              "runAfter": {
                                "If_orphan_not_already_in_user_table,_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "39acf8f0-a70d-4802-a146-a994cc7c2e01"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps_3",
                                  "operationId": "CreateRecord",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_connectionreferenceidentities",
                                  "item/admin_name": "@items('Apply_to_each')['connectionName']",
                                  "item/admin_accountname": "@items('Apply_to_each')['accountName']",
                                  "item/admin_ConnectionReferenceCreator@odata.bind": "admin_powerplatformusers(@{items('Apply_to_each')?['connectionCreator']})",
                                  "item/admin_connectionreferencecreatordisplayname": "@items('Apply_to_each')?['connectionCreatorUPN']",
                                  "item/admin_Connector@odata.bind": "admin_connectors(@{outputs('ConnectorGUID')})",
                                  "item/admin_Environment@odata.bind": "admin_environments(@{triggerOutputs()?['body/admin_environmentid']})",
                                  "item/admin_noneorcrosstenantidentity": "@outputs('xTenant_check')"
                                },
                                "authentication": "@parameters('$authentication')"
                              }
                            },
                            "catch_orphans_connector_not_found": {
                              "runAfter": {
                                "Add_Connection_Identities_for_Orphan": [
                                  "Failed"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "29b6d5bb-1324-4a51-9752-6637cd3bd44e"
                              },
                              "type": "Compose",
                              "inputs": "will be added once connector is inventoried"
                            }
                          }
                        }
                      },
                      "default": {
                        "actions": {}
                      },
                      "expression": "@outputs('Get_user_profile_(V2)')['statusCode']",
                      "metadata": {
                        "operationMetadataId": "9aa43fe4-b0c5-4a6b-aea6-71fd6caf133a"
                      },
                      "type": "Switch"
                    }
                  },
                  "runAfter": {
                    "List_PowerApps_Connectors": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "fe132ea9-6c6f-41f8-a3f8-bdad1af0918b"
                  },
                  "type": "Foreach"
                }
              },
              "runAfter": {
                "Remove_deleted_ones_from_inventory": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "e9ecda2d-1127-4c4c-8adc-7c8b6e609e5f"
              },
              "type": "Scope"
            },
            "GetCurrentInventory": {
              "actions": {
                "List_existing_connection_reference_identities": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "ef9a37bb-132b-457c-a4c9-d0560f83b45e"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_connectionreferenceidentities",
                      "$select": "admin_name, admin_accountname, admin_connectionreferenceidentityid, _admin_connectionreferencecreator_value, admin_connectionreferencecreatordisplayname",
                      "$filter": "_admin_environment_value eq @{triggerOutputs()?['body/admin_environmentid']}"
                    },
                    "authentication": "@parameters('$authentication')"
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Inventory": {
                  "runAfter": {
                    "List_existing_connection_reference_identities": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "223198b2-fbea-4fe9-9e06-10338991d442"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@outputs('List_existing_connection_reference_identities')?['body/value']",
                    "select": {
                      "connectionName": "@item()?['admin_name']",
                      "accountName": "@item()?['admin_accountname']",
                      "connectionCreator": "@item()?['_admin_connectionreferencecreator_value']",
                      "connectionCreatorUPN": "@item()?['admin_connectionreferencecreatordisplayname']"
                    }
                  }
                },
                "Parsed_Inventory": {
                  "runAfter": {
                    "Inventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e691d027-78c3-47cc-a745-67c7314c4e99"
                  },
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@body('Inventory')",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "connectionName": {
                            "type": "string"
                          },
                          "accountName": {
                            "type": "string"
                          },
                          "connectionCreator": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "connectionCreatorUPN": {
                            "type": [
                              "string",
                              "null"
                            ]
                          }
                        },
                        "required": [
                          "connectionName",
                          "accountName"
                        ]
                      }
                    }
                  }
                }
              },
              "runAfter": {
                "Get_Hosts_considered_as_Local_Tenant_": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "fa009654-799d-41f8-9292-f3bdd5c1a736"
              },
              "type": "Scope"
            },
            "Check_if_inventory_still_exists_and_is_not_excused_from_inventory": {
              "actions": {
                "Get_Environment_as_Admin": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "569f0dd5-c9cc-42f3-afaa-663c6b06b4c2"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerplatformforadmins",
                      "operationId": "GetSingleEnvironment",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                    },
                    "parameters": {
                      "environment": "@triggerOutputs()?['body/admin_environmentname']",
                      "api-version": "2018-10-01"
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "Set_EnvtExists": {
                  "runAfter": {
                    "Get_Environment_as_Admin": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "8277f60c-e834-4a4e-bae7-356ac12c1bec"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "EnvtExists",
                    "value": "@false"
                  }
                },
                "Check_if_Environment_Deleted,_terminate_if_true": {
                  "actions": {
                    "Terminate_for_environments_marked_deleted": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "c96f244b-3c1d-43b6-b930-9df94f180269"
                      },
                      "type": "Terminate",
                      "inputs": {
                        "runStatus": "Succeeded"
                      }
                    }
                  },
                  "runAfter": {
                    "Set_EnvtExists": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "expression": {
                    "or": [
                      {
                        "equals": [
                          "@triggerOutputs()?['body/admin_environmentdeleted']",
                          "@true"
                        ]
                      },
                      {
                        "equals": [
                          "@triggerOutputs()?['body/admin_excusefrominventory']",
                          "@true"
                        ]
                      },
                      {
                        "equals": [
                          "@variables('EnvtExists')",
                          "@false"
                        ]
                      }
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "63dea944-5e5f-41f8-afd4-50360d37b9d5"
                  },
                  "type": "If"
                }
              },
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "ac43c1f4-fbd2-4738-98ee-545ec0a24e74"
              },
              "type": "Scope"
            },
            "Get_Hosts_considered_as_Local_Tenant_": {
              "actions": {
                "Get_Host_Domains_EnvVar": {
                  "actions": {
                    "Set_to_current_or_default_-_HostDomain": {
                      "actions": {
                        "Set_HostDomain_-_CurrentValue": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "48e7d428-6134-4592-8a06-b7f1e52518ac"
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "HostDomainString",
                            "value": "@{first(body('ListCurrents-HostDomain')?['value'])?['Value']}"
                          }
                        }
                      },
                      "runAfter": {
                        "ListCurrents-HostDomain": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_HostDomain_-_DefaultValue": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "c20649bc-6bdb-4e9c-bf7c-bad351afd877"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "HostDomainString",
                              "value": "@{first(body('ListDefns-HostDomain')?['value'])?['defaultvalue']}"
                            }
                          }
                        }
                      },
                      "expression": {
                        "greaterOrEquals": [
                          "@length(body('ListCurrents-HostDomain')?['value'])",
                          1
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c2ad9e77-30d4-4855-89ee-691169650c0d"
                      },
                      "type": "If"
                    },
                    "ListCurrents-HostDomain": {
                      "runAfter": {
                        "Get_ID_from_HostDomain": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "db44e18b-c951-43be-8ed2-990fa2721e87"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_1",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "environmentvariablevalues",
                          "$select": "value",
                          "$filter": "_environmentvariabledefinitionid_value eq @{outputs('Get_ID_from_HostDomain')}"
                        },
                        "authentication": "@parameters('$authentication')"
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Get_ID_from_HostDomain": {
                      "runAfter": {
                        "ListDefns-HostDomain": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "35daa390-ef10-4e7a-ad74-4616a48dfc39"
                      },
                      "type": "Compose",
                      "inputs": "@first(body('ListDefns-HostDomain')?['value'])?['environmentvariabledefinitionid']"
                    },
                    "ListDefns-HostDomain": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "3e4048d2-4f28-43c6-8e87-83b68c7c79aa"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_1",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "environmentvariabledefinitions",
                          "$select": "environmentvariabledefinitionid, defaultvalue",
                          "$filter": "schemaname eq 'admin_hostdomains'"
                        },
                        "authentication": "@parameters('$authentication')"
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    }
                  },
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "9dfd2ea1-51ac-467c-ab9b-879bdfec49fa"
                  },
                  "type": "Scope",
                  "description": "Doing it this way because env var needs to be optional"
                },
                "Append_Admin_Emails_Tenant": {
                  "actions": {
                    "adminEmailsHost": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "8700f6f7-c76b-4d31-a154-49e6cd7c8c81"
                      },
                      "type": "Compose",
                      "inputs": "@toLower(last(split(parameters('Admin eMail (admin_AdminMail)'), '@')))"
                    },
                    "Append_or_replace": {
                      "actions": {
                        "Append_admin_emails_host": {
                          "runAfter": {
                            "currentHostString": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "d3e86eac-4f60-4214-a9b5-9cf0435b62ff"
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "HostDomainString",
                            "value": "@{concat(outputs('currentHostString'), ',', outputs('adminEmailsHost'))}"
                          }
                        },
                        "currentHostString": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "fb691630-b6f3-4454-9254-ed446c8e8aaa"
                          },
                          "type": "Compose",
                          "inputs": "@toLower(variables('HostDomainString'))"
                        }
                      },
                      "runAfter": {
                        "adminEmailsHost": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_to_admin_emails_host": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "d048d39f-6c94-4c18-85c9-b62080e7b126"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "HostDomainString",
                              "value": "@{outputs('adminEmailsHost')}"
                            }
                          }
                        }
                      },
                      "expression": {
                        "greater": [
                          "@length(variables('HostDomainString'))",
                          0
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "45e208ad-7e68-40f1-b687-479d7f4a5685"
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {
                    "Get_Host_Domains_EnvVar": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "da97638d-e3fa-4223-b21e-a158ea33e10d"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {
                "Check_if_inventory_still_exists_and_is_not_excused_from_inventory": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "1572e08b-8eed-4ec2-99aa-93e07681a306"
              },
              "type": "Scope"
            }
          },
          "runAfter": {
            "Initialize_HostDomainString": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "f019ff79-eb04-49cc-96a3-a63d560e993c"
          },
          "type": "Scope"
        },
        "Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_environmentname": "@triggerOutputs()?['body/admin_displayname']",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "authentication": "@parameters('$authentication')",
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            },
            "Terminate": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "authentication": "@parameters('$authentication')"
              }
            }
          },
          "runAfter": {
            "Get_Connection_Identities_and_store_them_in_CoE_CDS_Entity": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Get_ID_Pass": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date"
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Initialize_EnvtExists_to_true": {
          "runAfter": {
            "Delay_Object_Inventory": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "e70aa1c3-efb5-415b-96ed-90961b85e008"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "EnvtExists",
                "type": "boolean",
                "value": "@true"
              }
            ]
          }
        },
        "Initialize_HostDomainString": {
          "runAfter": {
            "Initialize_EnvtExists_to_true": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "eb9f0b98-975e-4cf9-9e79-62c636f4fa53"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "HostDomainString",
                "type": "string"
              }
            ]
          }
        },
        "Delay_Object_Inventory": {
          "actions": {
            "Delay_1_to_300_minutes": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f37a4a9d-c5b4-41ed-8484-636dca60ee81"
              },
              "type": "Wait",
              "inputs": {
                "interval": {
                  "count": "@rand(1, 300)",
                  "unit": "Minute"
                }
              },
              "description": "To avoid throttling of the backend to the tenant user, we will randomize the start time of these flows for tenants within a 5 hour range"
            }
          },
          "runAfter": {
            "Check_if_Connection_Identities_can_and_should_be_retrieved_for_this_environment": [
              "Succeeded"
            ]
          },
          "expression": {
            "equals": [
              "@parameters('DelayObjectInventory (admin_DelayObjectInventory)')",
              true
            ]
          },
          "metadata": {
            "operationMetadataId": "49b3d120-232d-4694-b373-a97ecde35cc4"
          },
          "type": "If"
        },
        "Check_if_Connection_Identities_can_and_should_be_retrieved_for_this_environment": {
          "actions": {
            "Terminate,_inquiry_not_supported": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "303cf191-ec29-40ed-b90b-d73833e269c0"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Succeeded"
              }
            }
          },
          "runAfter": {},
          "expression": {
            "or": [
              {
                "equals": [
                  "@triggerOutputs()?['body/admin_environmentdeleted']",
                  "@true"
                ]
              },
              {
                "equals": [
                  "@triggerOutputs()?['body/admin_hascds']",
                  "@false"
                ]
              },
              {
                "equals": [
                  "@triggerOutputs()?['body/admin_excusefrominventory']",
                  "@true"
                ]
              },
              {
                "not": {
                  "equals": [
                    "@triggerOutputs()?['body/admin_environmentruntimestate']",
                    "Enabled"
                  ]
                }
              }
            ]
          },
          "metadata": {
            "operationMetadataId": "9b6688e4-c25b-4e40-9deb-fcf181094357"
          },
          "type": "If"
        }
      }
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}