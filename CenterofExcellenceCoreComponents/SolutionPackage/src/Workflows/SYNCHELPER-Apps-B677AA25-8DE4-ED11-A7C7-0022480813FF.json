{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps_2": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseEnvRequest"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseEnvRequest"
        },
        "runtimeSource": "embedded"
      },
      "shared_powerappsforadmins": {
        "api": {
          "name": "shared_powerappsforadmins"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin2"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "CoE System User ID (admin_CoESystemUserID)": {
          "defaultValue": "6f018471-30d7-ef11-8ee9-000d3a328366",
          "type": "String",
          "metadata": {
            "schemaName": "admin_CoESystemUserID",
            "description": "in the maker table we store a user for system with an id. Storing here so that it can be referenced without having to look it up all the time."
          }
        }
      },
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "Button",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "text": {
                  "title": "envtid",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "text_1": {
                  "title": "envtName",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "text_2": {
                  "title": "appid",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "boolean": {
                  "title": "isBYODL",
                  "type": "boolean",
                  "x-ms-dynamically-added": true,
                  "description": "Please select yes or no",
                  "x-ms-content-hint": "BOOLEAN"
                }
              },
              "required": [
                "text",
                "text_1",
                "text_2",
                "boolean"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "7fed64f0-21fc-4e6d-aeb3-d690abc403b4"
          }
        }
      },
      "actions": {
        "Initialize_ActualConnectionsArray": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ActualConnectionsArray",
                "type": "array"
              }
            ]
          },
          "runAfter": {
            "Initialize_hasBadConnections_to_false": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "1f85714b-7529-407c-be12-a2d19ac31d64"
          }
        },
        "Initialize_hasBadConnections_to_false": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "hasBadConnections",
                "type": "boolean",
                "value": "@false"
              }
            ]
          },
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "aee9429d-e744-40f0-adb3-f247e40e7694"
          }
        },
        "Inventory_this_app": {
          "type": "Scope",
          "actions": {
            "App_does_not_exist_in_tenant": {
              "type": "Scope",
              "actions": {
                "See_if_app_exists_to_mark_deleted": {
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_apps",
                      "recordId": "@triggerBody()['text_2']"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "connectionName": "shared_commondataserviceforapps_2"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "d94dd5f4-301f-42ef-9854-282061bd0e57"
                  }
                },
                "Catch_app_does_not_exist": {
                  "type": "Compose",
                  "inputs": "Catch app does not exist",
                  "runAfter": {
                    "See_if_app_exists_to_mark_deleted": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "256bd0e6-7aeb-4426-a7cd-73df8b2bbb6a"
                  }
                },
                "App_existed_so_mark_deleted": {
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_apps",
                      "recordId": "@triggerBody()['text_2']",
                      "item/admin_appdeleted": true,
                      "item/admin_appdeletedon": "@utcNow()"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "UpdateRecord",
                      "connectionName": "shared_commondataserviceforapps"
                    }
                  },
                  "runAfter": {
                    "Catch_app_does_not_exist": [
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "5ff641be-2724-4a91-be1e-576a51b1c642"
                  }
                }
              },
              "runAfter": {
                "Get_App_as_Admin": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "12fcf2ed-c856-4702-b643-a11674ebeba2"
              }
            },
            "App_exists_in_tenant": {
              "type": "Scope",
              "actions": {
                "Get_Basics": {
                  "type": "Scope",
                  "actions": {
                    "Get_App_from_Inventory": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_apps",
                          "recordId": "@triggerBody()['text_2']",
                          "$expand": "admin_AppEnvironment($select=admin_environmentcdsinstanceurl)"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "GetItem",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      },
                      "runAfter": {
                        "Get_Connectors": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "cd6116f3-610e-48dd-aec4-28f018315df5"
                      }
                    },
                    "Catch_-_new_to_inventory": {
                      "type": "Compose",
                      "inputs": "Catch - new to inventory",
                      "runAfter": {
                        "Get_App_from_Inventory": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "3f869818-4fe3-42ae-bdb6-a0c3f5cd7ccf"
                      }
                    },
                    "Get_Connectors": {
                      "type": "Scope",
                      "actions": {
                        "List_Connectors": {
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_connectors",
                              "$select": "admin_displayname,admin_connectorid,admin_id,admin_name"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "ListRecords",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          },
                          "runtimeConfiguration": {
                            "paginationPolicy": {
                              "minimumItemCount": 100000
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "04a4cbe3-6883-49b0-a362-9d604275e2a5"
                          }
                        },
                        "Specialty_Connectors": {
                          "type": "Scope",
                          "actions": {
                            "List_Dataverse": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "entityName": "admin_connectors",
                                  "$select": "admin_connectorid",
                                  "$filter": "admin_name eq 'shared_commondataserviceforapps'",
                                  "$top": 1
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "ListRecords",
                                  "connectionName": "shared_commondataserviceforapps"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "ee734f72-173b-4708-8fd1-e88f10195826"
                              }
                            },
                            "GUID_Dataverse": {
                              "type": "Compose",
                              "inputs": "@first(outputs('List_Dataverse')?['body/value'])?['admin_connectorid']",
                              "runAfter": {
                                "List_Dataverse": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "797a9016-a837-4227-9b1f-97a5ab9c3a45"
                              }
                            },
                            "hasDataverse": {
                              "type": "Compose",
                              "inputs": "@if(empty(outputs('Get_App_as_Admin')?['body/properties/databaseReferences']), false, true)",
                              "runAfter": {
                                "GUID_Dataverse": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a7f643c4-578a-4a2e-b9ec-ea468da01822"
                              }
                            }
                          },
                          "runAfter": {
                            "List_Connectors": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "b330093d-15a0-4eab-af9a-467e3a1e56c5"
                          }
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "56473474-da9d-4b6e-b82c-a40f81b78bfe"
                      }
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "7b69a62f-c3fd-46e9-b8d4-336f77e0df53"
                  }
                },
                "Upsert_App_Details": {
                  "type": "Scope",
                  "actions": {
                    "Check_if_Orphan": {
                      "type": "If",
                      "expression": {
                        "equals": [
                          "@outputs('IsOrphan')",
                          "@true"
                        ]
                      },
                      "actions": {
                        "Upsert_App_record_(creator_not_found)": {
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_apps",
                              "recordId": "@triggerBody()['text_2']",
                              "item/admin_displayname": "@outputs('Get_App_as_Admin')?['body/properties/displayName']",
                              "item/admin_appalmmode": "@outputs('Get_App_as_Admin')?['body/properties/almMode']",
                              "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_connection_references')",
                              "item/admin_appcreatedon": "@outputs('Get_App_as_Admin')?['body/properties/createdTime']",
                              "item/admin_appdeleted": false,
                              "item/admin_appdeletedon": "@null",
                              "item/admin_appdescription": "@outputs('Get_App_as_Admin')?['body/properties/description']",
                              "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()['text']})",
                              "item/admin_appenvironmentdisplayname": "@outputs('Get_Evnt_Details')?['body/admin_displayname']",
                              "item/admin_appenvironmentid": "@triggerBody()['text_1']",
                              "item/admin_appiconuri": "@outputs('Get_App_as_Admin')?['body/properties/backgroundImageUri']",
                              "item/cr5d5_appisorphaned": "Yes",
                              "item/admin_appisquarantined": "@outputs('AppIsQuarantined')",
                              "item/admin_appmodifiedon": "@outputs('Get_App_as_Admin')?['body/properties/lastModifiedTime']",
                              "item/admin_appplanclassification": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appPlanClassification'], '')",
                              "item/admin_apppublished": "@if(empty(outputs('Get_App_as_Admin')?['body/properties/lastPublishTime']), outputs('Get_App_as_Admin')?['body/properties/createdTime'], outputs('Get_App_as_Admin')?['body/properties/lastPublishTime'])",
                              "item/admin_appsharedwithtenant": "@outputs('isSharedWithTenant')",
                              "item/admin_powerappstype": "@variables('AppType')",
                              "item/admin_appusesdataversetables": "@outputs('hasDataverse')",
                              "item/admin_appdocumentcomplexity_blocksonstart": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/blocksOnStart'], null)",
                              "item/admin_appdocumentcomplexity_controlcount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/controlCount'], null)",
                              "item/admin_appdocumentcomplexity_datasourcecount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/dataSourceCount'], null)",
                              "item/admin_appdocumentcomplexity_namedformulascount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/namedFormulasCount'], null)",
                              "item/admin_appdocumentcomplexity_pcfcontrolcount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/pcfControlCount'], null)",
                              "item/admin_appdocumentcomplexity_startscreenused": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/startScreenUsed'], null)",
                              "item/admin_appdocumentcomplexity_totalrulelengthhistogram": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/totalRuleLengthHistogram'], '')",
                              "item/admin_appdocumentcomplexity_totalrulelengthonstart": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/totalRuleLengthOnStart'], null)",
                              "item/admin_appdocumentcomplexity_uicomponentscount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/uiComponentsCount'], null)",
                              "item/admin_appidstring": "@triggerBody()['text_2']",
                              "item/admin_bypassconsentenabled": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/bypassConsent'], false)",
                              "item/admin_dlpevaluationstatus": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                              "item/admin_dlplastevaluationdate": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                              "item/admin_dlppoliciesviolated": "@outputs('ViolatedPoliciesString')",
                              "item/admin_dlpviolationdetails": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/violationErrorMessage']",
                              "item/admin_hasimplicitconnections": "@outputs('has_Shared_Connection')",
                              "item/admin_hasinsecureimplicitconnections": "@outputs('has_Insecure_Shared_Connection')",
                              "item/admin_iconbackgroundcolor": "@outputs('Get_App_as_Admin')?['body/properties/backgroundColor']",
                              "item/admin_inventoryme": false,
                              "item/admin_powerappsreleaseversion": "@outputs('Get_App_as_Admin')?['body/tags/publisherVersion']",
                              "item/admin_quarantineappdate": "@if(equals(coalesce(outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState/quarantineStatus'], ''), 'Quarantined'), coalesce(outputs('Get_app_from_Inventory')?['admin_quarantineappdate'], outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState/lastUpdated'], utcNow()), null)",
                              "item/admin_recordguidasstring": "@triggerBody()['text_2']",
                              "item/admin_appcontainsbrokenconnections": "@variables('hasBadConnections')",
                              "item/admin_sharepointformurl": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/embeddedApp/listUrl'], '')",
                              "item/admin_usescustomapi": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesCustomApi'], '')",
                              "item/admin_usesonpremisegateway": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesOnPremiseGateway'], '')",
                              "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesOnlyGrandfatheredPremiumApis'], '')",
                              "item/admin_usespremiumapi": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesPremiumApi'], '')"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "UpdateRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "6f8a0c9e-e58c-4111-9c25-9ab90142fb48"
                          }
                        }
                      },
                      "else": {
                        "actions": {
                          "Upsert_App_record": {
                            "type": "OpenApiConnection",
                            "inputs": {
                              "parameters": {
                                "entityName": "admin_apps",
                                "recordId": "@triggerBody()['text_2']",
                                "item/admin_displayname": "@outputs('Get_App_as_Admin')?['body/properties/displayName']",
                                "item/admin_appalmmode": "@outputs('Get_App_as_Admin')?['body/properties/almMode']",
                                "item/admin_appcompany": "@outputs('Get_Maker')?['body/admin_company']",
                                "item/admin_appconnections": "@outputs('Compose_comma-separated_list_of_connection_references')",
                                "item/admin_appcreatedon": "@outputs('Get_App_as_Admin')?['body/properties/createdTime']",
                                "item/admin_appdeleted": false,
                                "item/admin_appdeletedon": "@null",
                                "item/admin_department": "@outputs('Get_Maker')?['body/admin_department']",
                                "item/admin_appdescription": "@outputs('Get_App_as_Admin')?['body/properties/description']",
                                "item/admin_AppEnvironment@odata.bind": "admin_environments(@{triggerBody()['text']})",
                                "item/admin_appenvironmentdisplayname": "@outputs('Get_Evnt_Details')?['body/admin_displayname']",
                                "item/admin_appenvironmentid": "@triggerBody()['text_1']",
                                "item/admin_appiconuri": "@outputs('Get_App_as_Admin')?['body/properties/backgroundImageUri']",
                                "item/cr5d5_appisorphaned": "No",
                                "item/admin_appisquarantined": "@outputs('AppIsQuarantined')",
                                "item/admin_appmodifiedon": "@outputs('Get_App_as_Admin')?['body/properties/lastModifiedTime']",
                                "item/admin_AppOwner@odata.bind": "admin_makers(@{outputs('Get_Maker')?['body/admin_makerid']})",
                                "item/admin_appownerdisplayname": "@outputs('Get_Maker')?['body/admin_displayname']",
                                "item/admin_appplanclassification": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appPlanClassification'], '')",
                                "item/admin_apppublished": "@if(empty(outputs('Get_App_as_Admin')?['body/properties/lastPublishTime']), outputs('Get_App_as_Admin')?['body/properties/createdTime'], outputs('Get_App_as_Admin')?['body/properties/lastPublishTime'])",
                                "item/admin_appsharedwithtenant": "@outputs('isSharedWithTenant')",
                                "item/admin_powerappstype": "@variables('AppType')",
                                "item/admin_appusesdataversetables": "@outputs('hasDataverse')",
                                "item/admin_appdocumentcomplexity_blocksonstart": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/blocksOnStart'], null)",
                                "item/admin_appdocumentcomplexity_controlcount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/controlCount'], null)",
                                "item/admin_appdocumentcomplexity_datasourcecount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/dataSourceCount'], null)",
                                "item/admin_appdocumentcomplexity_namedformulascount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/namedFormulasCount'], null)",
                                "item/admin_appdocumentcomplexity_pcfcontrolcount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/pcfControlCount'], null)",
                                "item/admin_appdocumentcomplexity_startscreenused": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/startScreenUsed'], null)",
                                "item/admin_appdocumentcomplexity_totalrulelengthhistogram": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/totalRuleLengthHistogram'], '')",
                                "item/admin_appdocumentcomplexity_totalrulelengthonstart": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/totalRuleLengthOnStart'], null)",
                                "item/admin_appdocumentcomplexity_uicomponentscount": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/appDocumentComplexity/uiComponentsCount'], null)",
                                "item/admin_appidstring": "@triggerBody()['text_2']",
                                "item/admin_bypassconsentenabled": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/bypassConsent'], false)",
                                "item/admin_city": "@outputs('Get_Maker')?['body/admin_city']",
                                "item/admin_country": "@outputs('Get_Maker')?['body/admin_country']",
                                "item/admin_dlpevaluationstatus": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/status']",
                                "item/admin_dlplastevaluationdate": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/lastEvaluationDate']",
                                "item/admin_dlppoliciesviolated": "@outputs('ViolatedPoliciesString')",
                                "item/admin_dlpviolationdetails": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/violationErrorMessage']",
                                "item/admin_hasimplicitconnections": "@outputs('has_Shared_Connection')",
                                "item/admin_hasinsecureimplicitconnections": "@outputs('has_Insecure_Shared_Connection')",
                                "item/admin_iconbackgroundcolor": "@outputs('Get_App_as_Admin')?['body/properties/backgroundColor']",
                                "item/admin_inventoryme": false,
                                "item/admin_powerappsreleaseversion": "@outputs('Get_App_as_Admin')?['body/tags/publisherVersion']",
                                "item/admin_quarantineappdate": "@if(equals(coalesce(outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState/quarantineStatus'], ''), 'Quarantined'), coalesce(outputs('Get_app_from_Inventory')?['admin_quarantineappdate'], outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState/lastUpdated'], utcNow()), null)",
                                "item/admin_recordguidasstring": "@triggerBody()['text_2']",
                                "item/admin_appcontainsbrokenconnections": "@variables('hasBadConnections')",
                                "item/admin_sharepointformurl": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/embeddedApp/listUrl'], '')",
                                "item/admin_usescustomapi": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesCustomApi'], '')",
                                "item/admin_usesonpremisegateway": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesOnPremiseGateway'], '')",
                                "item/admin_usesonlygrandfatheredpremiumapis": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesOnlyGrandfatheredPremiumApis'], '')",
                                "item/admin_usespremiumapi": "@coalesce(outputs('Get_App_as_Admin')?['body/properties/usesPremiumApi'], '')"
                              },
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "operationId": "UpdateRecord",
                                "connectionName": "shared_commondataserviceforapps"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "23b6eae0-16b7-4115-a9ea-1777db53ede0"
                            }
                          }
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "b35d0e17-ee5b-492e-a12b-b0d65f1fec87"
                      }
                    }
                  },
                  "runAfter": {
                    "Prepare_for_Connection_References_Table": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "b60b7461-053a-4abb-8689-fb8b768a27bd"
                  }
                },
                "Get_App_Type": {
                  "type": "Scope",
                  "actions": {
                    "Switch_App_Type": {
                      "type": "Switch",
                      "expression": "@outputs('Get_App_as_Admin')?['body/appType']",
                      "default": {
                        "actions": {
                          "Set_AppType_to_Sharepoint_or_Canvas": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "AppType",
                              "value": "@coalesce(if(equals(outputs('Get_App_as_Admin')?['body/properties/embeddedApp/type'], 'SharepointFormApp'), 597910002, 597910000), 597910000)"
                            },
                            "metadata": {
                              "operationMetadataId": "c39d0e22-8019-4bcb-83ce-9695a8c77d77"
                            }
                          }
                        }
                      },
                      "cases": {
                        "Case_AppComponentLibrary": {
                          "actions": {
                            "Set_AppType_to_AppComponentLibrary": {
                              "type": "SetVariable",
                              "inputs": {
                                "name": "AppType",
                                "value": 597910004
                              },
                              "metadata": {
                                "operationMetadataId": "1a5d3df1-3926-4854-948b-92163fda82aa"
                              }
                            }
                          },
                          "case": "AppComponentLibrary"
                        },
                        "Case_CustomCanvasPage": {
                          "actions": {
                            "Set_AppType_to_CustomCanvasPage": {
                              "type": "SetVariable",
                              "inputs": {
                                "name": "AppType",
                                "value": 597910003
                              },
                              "metadata": {
                                "operationMetadataId": "f9e1df72-35c1-4045-9bdd-2b85f1eb863e"
                              }
                            }
                          },
                          "case": "CustomCanvasPage"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "a644af7e-94e2-455b-8741-d1f56a34efdd"
                      }
                    }
                  },
                  "runAfter": {
                    "Check_if_App_Shared_with_Tenant_Editted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c8874f2c-f930-4ca4-a286-267b065b0ea5"
                  }
                },
                "Prepare_Connection_String": {
                  "type": "Scope",
                  "actions": {
                    "check_if_connection_reference_exist": {
                      "type": "If",
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                            "@null"
                          ]
                        }
                      },
                      "actions": {
                        "Parse_JSON_-_Connection_References": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                            "schema": {
                              "items": {
                                "properties": {
                                  "apiTier": {
                                    "type": "string"
                                  },
                                  "bypassConsent": {
                                    "type": [
                                      "string",
                                      "null",
                                      "boolean"
                                    ]
                                  },
                                  "displayName": {
                                    "type": "string"
                                  },
                                  "iconUri": {
                                    "type": "string"
                                  },
                                  "id": {
                                    "type": "string"
                                  },
                                  "isCustomApiConnection": {
                                    "type": "boolean"
                                  },
                                  "isOnPremiseConnection": {
                                    "type": "boolean"
                                  }
                                },
                                "required": [
                                  "iconUri",
                                  "displayName",
                                  "isOnPremiseConnection",
                                  "isCustomApiConnection",
                                  "id"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "ba2e396c-f0a5-4788-ac2f-332d8a1ca7bb"
                          }
                        },
                        "Select_Connector_Display_Name": {
                          "type": "Select",
                          "inputs": {
                            "from": "@body('Parse_JSON_-_Connection_References')",
                            "select": "@split(item()['id'], '/')[sub(length(split(item()['id'], '/')), 1)]"
                          },
                          "runAfter": {
                            "Parse_JSON_-_Connection_References": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "2568ef78-b0dc-4b21-a43b-544d45f18fe7"
                          }
                        },
                        "Joined_Connectors_String": {
                          "type": "Compose",
                          "inputs": "@join(union(body('Select_Connector_Display_Name'), body('Select_Connector_Display_Name')), ',')",
                          "runAfter": {
                            "Select_Connector_Display_Name": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ffc1507b-83d4-4202-86a8-598bec15cbf5"
                          }
                        }
                      },
                      "else": {
                        "actions": {}
                      },
                      "metadata": {
                        "operationMetadataId": "2856e571-8957-4143-864f-3dea6c42f9c2"
                      }
                    },
                    "Compose_comma-separated_list_of_connection_references": {
                      "type": "Compose",
                      "inputs": "@concat(coalesce(outputs('Joined_Connectors_String'), ''), if(equals(outputs('hasDataverse'), false), '', ',shared_commondataserviceforapps'))",
                      "runAfter": {
                        "check_if_connection_reference_exist": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "d54b22d2-3c90-474f-ac90-b8440aed87b5"
                      }
                    }
                  },
                  "runAfter": {
                    "Implicit_Connections": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "97ef54da-bd17-492e-8a6b-483969811acc"
                  }
                },
                "Check_if_App_Shared_with_Tenant_Editted": {
                  "type": "Scope",
                  "actions": {
                    "only_if_not_SP_App_Editted": {
                      "type": "If",
                      "expression": {
                        "not": {
                          "equals": [
                            "@outputs('Get_App_as_Admin')?['body/properties/embeddedApp/type']",
                            "SharepointFormApp"
                          ]
                        }
                      },
                      "actions": {
                        "Filter_to_tenant": {
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('Get_App_Role_Assignments_as_Admin')?['body/value']",
                            "where": "@equals(item()?['properties/principal/type'], 'Tenant')"
                          },
                          "runAfter": {
                            "Get_App_Role_Assignments_as_Admin": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "762547b1-19a4-4f82-b4ab-b9723ffc5463"
                          }
                        },
                        "Get_App_Role_Assignments_as_Admin": {
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "environment": "@triggerBody()['text_1']",
                              "app": "@triggerBody()['text_2']",
                              "$top": 250,
                              "api-version": "2016-11-01"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins",
                              "operationId": "Get-AdminAppRoleAssignment",
                              "connectionName": "shared_powerappsforadmins"
                            }
                          },
                          "runtimeConfiguration": {
                            "paginationPolicy": {
                              "minimumItemCount": 100000
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "8fa7d13a-1dc0-4f11-ab46-c9561baba84f"
                          }
                        }
                      },
                      "else": {
                        "actions": {}
                      },
                      "metadata": {
                        "operationMetadataId": "43cfe8d7-f8e9-4c51-a8ad-1458cfcffd88"
                      }
                    },
                    "isSharedWithTenant": {
                      "type": "Compose",
                      "inputs": "@if(or(equals(body('Filter_to_tenant'), null), equals(length(body('Filter_to_tenant')), 0)), false, true)",
                      "runAfter": {
                        "only_if_not_SP_App_Editted": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "ab77f958-bd1f-4461-aef9-dbac61a767eb"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Owner_Details": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e1210f45-807b-450f-b3a2-e5a094862197"
                  }
                },
                "Prepare_for_Connection_References_Table": {
                  "type": "Scope",
                  "actions": {
                    "Get_Inventory_-_App_Connections": {
                      "type": "Scope",
                      "actions": {
                        "List_Connection_References_Inventory": {
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_connectionreferences",
                              "$select": "_admin_app_value, _admin_connector_value, admin_displayname, admin_connectionreferenceid",
                              "$filter": "_admin_app_value eq '@{triggerBody()['text_2']}'"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "ListRecords",
                              "connectionName": "shared_commondataserviceforapps_2"
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "5d30b0a4-a7dd-43c1-abe8-557ae6caa55c"
                          }
                        },
                        "Select_Inventory": {
                          "type": "Select",
                          "inputs": {
                            "from": "@outputs('List_Connection_References_Inventory')?['body/value']",
                            "select": {
                              "AppID": "@item()?['_admin_app_value']",
                              "ConnectorID": "@item()?['_admin_connector_value']",
                              "DisplayName": "@item()?['admin_displayname']"
                            }
                          },
                          "runAfter": {
                            "List_Connection_References_Inventory": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "a8739869-13fd-4515-b665-98d908e4fbfe"
                          }
                        },
                        "Parse_Inventory": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('Select_Inventory')",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "AppID": {
                                    "type": "string"
                                  },
                                  "ConnectorID": {
                                    "type": "string"
                                  },
                                  "DisplayName": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "AppID",
                                  "ConnectorID",
                                  "DisplayName"
                                ]
                              }
                            }
                          },
                          "runAfter": {
                            "Select_Inventory": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e1b5f4c5-fea7-4ae5-98ce-bb4a7421875d"
                          }
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "c2668ca6-b427-4e0c-9677-fe5ea2950497"
                      }
                    },
                    "Get_Actual_-_App_Connections": {
                      "type": "Scope",
                      "actions": {
                        "Check_if_App_Connection_References_are_not_null_and_not_BYODL": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@outputs('Get_App_as_Admin')?['body/properties/connectionReferences']",
                                    "@null"
                                  ]
                                }
                              },
                              {
                                "equals": [
                                  "@triggerBody()['boolean']",
                                  "@false"
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Apply_to_each_Connection_Reference": {
                              "type": "Foreach",
                              "foreach": "@body('Filter_id_not_null')",
                              "actions": {
                                "Connecor_Name": {
                                  "type": "Compose",
                                  "inputs": "@last(outputs('split_on_slash'))",
                                  "runAfter": {
                                    "split_on_slash": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "2bdbfecf-4cc5-4f4b-b923-4009359b61a3"
                                  }
                                },
                                "ConnectorID": {
                                  "type": "Compose",
                                  "inputs": "@items('Apply_to_each_Connection_Reference')?['id']",
                                  "metadata": {
                                    "operationMetadataId": "7126bffd-0070-4260-99c2-f6876f1812a4"
                                  }
                                },
                                "Filter_current_app_Connector": {
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_Connectors')?['body/value']",
                                    "where": "@equals(item()?['admin_name'], outputs('Connecor_Name'))"
                                  },
                                  "runAfter": {
                                    "Connecor_Name": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "897c293f-3821-492e-b77e-c2531cb3263d"
                                  }
                                },
                                "mark_broken_connector_or_insert_connection_reference": {
                                  "type": "If",
                                  "expression": {
                                    "greater": [
                                      "@length(body('Filter_current_app_Connector'))",
                                      0
                                    ]
                                  },
                                  "actions": {
                                    "Append_to_ActualConnectionsArray": {
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "ActualConnectionsArray",
                                        "value": {
                                          "AppID": "@triggerBody()['text_2']",
                                          "ConnectorID": "@first(body('Filter_current_app_Connector'))?['admin_connectorid']",
                                          "DisplayName": "@coalesce(items('Apply_to_each_Connection_Reference')?['displayName'], 'No Display Name For Connector')"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "664cd089-00a3-4664-af43-af5a22e3be67"
                                      }
                                    }
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_hasBadConnections_true": {
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "hasBadConnections",
                                          "value": "@true"
                                        },
                                        "metadata": {
                                          "operationMetadataId": "bc0b1e7a-4908-4978-a625-5d967212c901"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_current_app_Connector": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e202458e-a803-4b59-9bea-3fece377334f"
                                  }
                                },
                                "split_on_slash": {
                                  "type": "Compose",
                                  "inputs": "@split(outputs('ConnectorID'), '/')",
                                  "runAfter": {
                                    "ConnectorID": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "d5ba4b3e-2901-45d6-8c33-8128951eb6e4"
                                  }
                                }
                              },
                              "runAfter": {
                                "Filter_id_not_null": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "f38f07cc-348e-496e-8d32-4ce233c4a8b7"
                              }
                            },
                            "Filter_id_not_null": {
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Parse_JSON_-_Connection_References')",
                                "where": "@not(equals(item()?['id'], null))"
                              },
                              "metadata": {
                                "operationMetadataId": "6222ff27-7396-4d1d-b57e-c8459a2410a5"
                              }
                            }
                          },
                          "else": {
                            "actions": {
                              "Set_ActualConnectionsArray_to_empty": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "ActualConnectionsArray",
                                  "value": []
                                },
                                "metadata": {
                                  "operationMetadataId": "2001b0fe-bc72-4be7-bbb5-456d2203eb6b"
                                }
                              }
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "56abebe1-caad-475c-849a-b3c794bc007f"
                          }
                        },
                        "Parse_Actual": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@variables('ActualConnectionsArray')",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "AppID": {
                                    "type": "string"
                                  },
                                  "ConnectorID": {
                                    "type": "string"
                                  },
                                  "DisplayName": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "AppID",
                                  "ConnectorID",
                                  "DisplayName"
                                ]
                              }
                            }
                          },
                          "runAfter": {
                            "Check_if_App_Database_References_are_not_null_and_not_BYODL": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "8616a0e7-24cc-4399-bcaf-a4a4c31e337f"
                          }
                        },
                        "Check_if_App_Database_References_are_not_null_and_not_BYODL": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@outputs('hasDataverse')",
                                  "@true"
                                ]
                              },
                              {
                                "equals": [
                                  "@triggerBody()['boolean']",
                                  "@false"
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Append_to_ActualConnectionsArray_-_Dataverse": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "ActualConnectionsArray",
                                "value": {
                                  "AppID": "@triggerBody()['text_2']",
                                  "ConnectorID": "@outputs('GUID_Dataverse')",
                                  "DisplayName": "Microsoft Dataverse"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "664cd089-00a3-4664-af43-af5a22e3be67"
                              }
                            }
                          },
                          "else": {
                            "actions": {}
                          },
                          "runAfter": {
                            "Check_if_App_Connection_References_are_not_null_and_not_BYODL": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "04f7f137-d8c3-4d19-bf65-86b3d2a022de"
                          }
                        }
                      },
                      "runAfter": {
                        "Get_Inventory_-_App_Connections": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "dd91af21-3195-4ec7-9c99-4dc28ab0523a"
                      }
                    }
                  },
                  "runAfter": {
                    "Prepare_Connection_String": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e0da0770-9fe9-4a45-8bab-00a5bee141be"
                  }
                },
                "Get_DLP_Policies_Violated": {
                  "type": "Scope",
                  "actions": {
                    "If_violated_policies_exist": {
                      "type": "If",
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@empty(outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/violations'])",
                              "@false"
                            ]
                          },
                          {
                            "greater": [
                              "@length(outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/violations'])",
                              0
                            ]
                          }
                        ]
                      },
                      "actions": {
                        "Append_to_violated_policy_array": {
                          "type": "Foreach",
                          "foreach": "@outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/dataLossPreventionEvaluationResult/violations']",
                          "actions": {
                            "Append_to_PoliciesViolatedArray": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "PoliciesViolatedArray",
                                "value": "@items('Append_to_violated_policy_array')?['policyDisplayName']"
                              },
                              "metadata": {
                                "operationMetadataId": "10472c7a-f36a-4981-9162-1b899f21a3da"
                              }
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "9210281c-4d0d-4a10-9b2b-c228119abd8a"
                          }
                        }
                      },
                      "else": {
                        "actions": {
                          "Set_PoliciesViolatedArray_to_empty_array": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "PoliciesViolatedArray",
                              "value": []
                            },
                            "metadata": {
                              "operationMetadataId": "849243db-984c-439b-924f-1af22d1f2c32"
                            }
                          }
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "0aeda156-1150-41cb-af31-a2c4ba948aa4"
                      }
                    },
                    "ViolatedPoliciesString": {
                      "type": "Compose",
                      "inputs": "@join(union(variables('PoliciesViolatedArray'), variables('PoliciesViolatedArray')), ',')",
                      "runAfter": {
                        "If_violated_policies_exist": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "36be9603-e422-414b-9a53-aff43408b437"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_App_Type": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "43578142-9898-454b-89d2-45c43ebbf825"
                  }
                },
                "Populate_Connection_References_Table": {
                  "type": "Scope",
                  "actions": {
                    "If_BYODL": {
                      "type": "If",
                      "expression": {
                        "equals": [
                          "@triggerBody()['boolean']",
                          "@true"
                        ]
                      },
                      "actions": {
                        "Clear_Connection_Reference_Table_if_not_empty": {
                          "type": "Foreach",
                          "foreach": "@outputs('List_Connection_References_Inventory')?['body/value']",
                          "actions": {
                            "Delete_connection_references_for_BYODL": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "entityName": "admin_connectionreferences",
                                  "recordId": "@items('Clear_Connection_Reference_Table_if_not_empty')?['admin_connectionreferenceid']"
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "DeleteRecord",
                                  "connectionName": "shared_commondataserviceforapps_2"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "2470f400-723f-4b25-a197-244acef8eaa9"
                              }
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "0b06122e-66a5-4574-a305-12dea8befb34"
                          }
                        }
                      },
                      "else": {
                        "actions": {
                          "Add_New_Connections": {
                            "type": "Scope",
                            "actions": {
                              "Apply_to_each_new_connection": {
                                "type": "Foreach",
                                "foreach": "@body('Connections_to_Add')",
                                "actions": {
                                  "Add_a_new_connection": {
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "parameters": {
                                        "entityName": "admin_connectionreferences",
                                        "item/admin_displayname": "@items('Apply_to_each_new_connection')?['DisplayName']",
                                        "item/admin_App@odata.bind": "admin_apps(@{triggerBody()['text_2']})",
                                        "item/admin_Connector@odata.bind": "admin_connectors(@{items('Apply_to_each_new_connection')?['ConnectorID']})"
                                      },
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "operationId": "CreateRecord",
                                        "connectionName": "shared_commondataserviceforapps"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "03632cfb-bcd4-4bef-983d-49c8a477c703"
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Connections_to_Add": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "f18a11e6-cf04-4d3d-b8f8-9c80496b86db"
                                }
                              },
                              "Distinct_Connectors": {
                                "type": "Compose",
                                "inputs": "@union(body('Parse_Actual'), body('Parse_Actual'))",
                                "metadata": {
                                  "operationMetadataId": "be10f057-ac09-4d63-9e95-c0bd9a02bfe5"
                                }
                              },
                              "Connections_to_Add": {
                                "type": "Query",
                                "inputs": {
                                  "from": "@outputs('Distinct_Connectors')",
                                  "where": "@not(contains(body('Parse_Inventory'), item()))"
                                },
                                "runAfter": {
                                  "Distinct_Connectors": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "23111389-de69-49a7-85d9-bee2bb97ba1b"
                                }
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "62895c7d-bd49-4621-bdbc-4be501a75bae"
                            }
                          },
                          "Remove_Deleted_Connections": {
                            "type": "Scope",
                            "actions": {
                              "Connections_to_Remove": {
                                "type": "Query",
                                "inputs": {
                                  "from": "@body('Parse_Inventory')",
                                  "where": "@not(contains(body('Parse_Actual'), item()))"
                                },
                                "metadata": {
                                  "operationMetadataId": "58f582dd-b6f9-4093-8335-9c6f9552c10e"
                                }
                              },
                              "Delete_each": {
                                "type": "Foreach",
                                "foreach": "@body('Connections_to_Remove')",
                                "actions": {
                                  "Find_it_to_delete": {
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "parameters": {
                                        "entityName": "admin_connectionreferences",
                                        "$select": "admin_connectionreferenceid",
                                        "$filter": "_admin_app_value eq '@{triggerBody()['text_2']}' and _admin_connector_value eq '@{items('Delete_each')?['ConnectorID']}' and admin_displayname eq '@{replace(items('Delete_each')?['DisplayName'], '''', '''''')}'"
                                      },
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "operationId": "ListRecords",
                                        "connectionName": "shared_commondataserviceforapps"
                                      }
                                    },
                                    "metadata": {
                                      "operationMetadataId": "13dd4cf4-8f40-47da-9e90-73678a3f25ce"
                                    }
                                  },
                                  "Delete_it": {
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "parameters": {
                                        "entityName": "admin_connectionreferences",
                                        "recordId": "@first(outputs('Find_it_to_delete')?['body/value'])?['admin_connectionreferenceid']"
                                      },
                                      "host": {
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                        "operationId": "DeleteRecord",
                                        "connectionName": "shared_commondataserviceforapps"
                                      }
                                    },
                                    "runAfter": {
                                      "Find_it_to_delete": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "0a53aabb-70d8-45de-8f4a-16d71cf944c3"
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Connections_to_Remove": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "69d2382e-c315-4c8d-8a9f-fd5a11df1d73"
                                }
                              }
                            },
                            "runAfter": {
                              "Add_New_Connections": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "42a6b027-d576-40e4-8bde-c582d2db169e"
                            }
                          }
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "49ebd060-9c54-4fa2-8999-5aeeb875f82f"
                      }
                    }
                  },
                  "runAfter": {
                    "Upsert_App_Details": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e0da0770-9fe9-4a45-8bab-00a5bee141be"
                  }
                },
                "Implicit_Connections": {
                  "type": "Scope",
                  "actions": {
                    "has_Shared_Connection": {
                      "type": "Compose",
                      "inputs": "@if(greater(length(split(string(outputs('Get_App_as_Admin')?['body/properties/connectionReferences']), 'sharedConnectionId')), 1), true, false)",
                      "metadata": {
                        "operationMetadataId": "a24e9994-e602-42eb-9d48-e9866ba78a46"
                      }
                    },
                    "has_Insecure_Shared_Connection": {
                      "type": "Compose",
                      "inputs": "@if(and(equals(outputs('has_Shared_Connection'), true), lessOrEquals(length(split(string(outputs('Get_App_as_Admin')?['body/properties/connectionReferences']), 'executionRestrictions')), 1)), true, false)",
                      "runAfter": {
                        "has_Shared_Connection": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "4761ef5e-0c1c-4d9f-b653-90799475624c"
                      }
                    }
                  },
                  "runAfter": {
                    "Quarantine_State": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1983ded0-b0e2-492f-91eb-655cadff35cc"
                  }
                },
                "Get_Owner_Details": {
                  "type": "Scope",
                  "actions": {
                    "If_not,_add_them": {
                      "type": "If",
                      "expression": {
                        "equals": [
                          "@length(outputs('See_if_already_in_Maker_Table')?['body/value'])",
                          0
                        ]
                      },
                      "actions": {
                        "Maker_Check": {
                          "type": "Workflow",
                          "inputs": {
                            "host": {
                              "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                            },
                            "body": {
                              "text": "@outputs('OwnerID')",
                              "boolean": false
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "9b77404f-4d8e-4e72-992d-f09db75c4167"
                          }
                        }
                      },
                      "else": {
                        "actions": {}
                      },
                      "runAfter": {
                        "See_if_already_in_Maker_Table": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "b0599ae4-1806-47c1-9c32-955838f93048"
                      }
                    },
                    "Get_Maker": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_makers",
                          "recordId": "@outputs('OwnerID')"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "GetItem",
                          "connectionName": "shared_commondataserviceforapps"
                        },
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 20,
                          "interval": "PT20S"
                        }
                      },
                      "runAfter": {
                        "If_not,_add_them": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "ae6d172a-7fcb-44c7-88dc-32f5b1cec2c8"
                      }
                    },
                    "catch_for_orphans_no_id": {
                      "type": "Compose",
                      "inputs": "catch for orphans no id",
                      "runAfter": {
                        "Get_Maker": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "b420ec58-4b1d-4f34-8cf4-880c0c0b82ab"
                      }
                    },
                    "IsOrphan": {
                      "type": "Compose",
                      "inputs": "@if(or(equals(outputs('OwnerID'), null), equals(length(outputs('OwnerID')), 0), equals(outputs('Get_Maker')?['body/admin_makerisorphaned'], true), equals(outputs('Get_Maker')?['body/admin_makerid'], null)), true, false)",
                      "runAfter": {
                        "catch_for_orphans_no_id": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "5ba88760-724b-482e-b7c5-72b125a595a0"
                      }
                    },
                    "OwnerID": {
                      "type": "Compose",
                      "inputs": "@if(equals(outputs('Get_App_as_Admin')?['body/properties/owner/id'], null), if(equals(outputs('Get_App_as_Admin')?['body/properties/owner/displayName'], 'SYSTEM'), parameters('CoE System User ID (admin_CoESystemUserID)'), ''), outputs('Get_App_as_Admin')?['body/properties/owner/id'])",
                      "metadata": {
                        "operationMetadataId": "56cfa7cf-65cb-4e51-b16a-430bc087d28c"
                      }
                    },
                    "See_if_already_in_Maker_Table": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_makers",
                          "$filter": "admin_makerid eq @{outputs('OwnerID')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        },
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 20,
                          "interval": "PT20S"
                        }
                      },
                      "runAfter": {
                        "OwnerID": [
                          "Succeeded"
                        ]
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "6a7ef4f9-5a59-45f9-a290-e89115a2f36d"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Basics": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "615c25ea-17df-47c6-b0b2-1620d61d03c7"
                  }
                },
                "Quarantine_State": {
                  "type": "Scope",
                  "actions": {
                    "AppIsQuarantined": {
                      "type": "Compose",
                      "inputs": "@if(equals(null, outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState']), false, if(equals('Quarantined', outputs('Get_App_as_Admin')?['body/properties/executionRestrictions/appQuarantineState']['quarantineStatus']), true, false))"
                    }
                  },
                  "runAfter": {
                    "Get_DLP_Policies_Violated": [
                      "Succeeded"
                    ]
                  }
                }
              },
              "runAfter": {
                "App_does_not_exist_in_tenant": [
                  "Skipped"
                ]
              },
              "metadata": {
                "operationMetadataId": "618b6e97-814f-452c-910b-65040f4a8f44"
              }
            },
            "Ensure_Envt_Inventoried": {
              "type": "Scope",
              "description": "This is needed for BYODL case as sometimes objects are in the datalake before the envt",
              "actions": {
                "Get_Evnt_Details": {
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_environments",
                      "recordId": "@triggerBody()['text']",
                      "$select": "admin_displayname"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "connectionName": "shared_commondataserviceforapps_2"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "beafe17b-c9e4-4258-a66b-955f2be67e6b"
                  }
                },
                "Exit_Early_no_envt": {
                  "type": "Scope",
                  "actions": {
                    "Respond_to_a_PowerApp_or_flow_true_-_no_envt": {
                      "type": "Response",
                      "kind": "PowerApp",
                      "inputs": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "pass": {
                              "title": "pass",
                              "x-ms-dynamically-added": true,
                              "type": "boolean"
                            }
                          },
                          "additionalProperties": {}
                        },
                        "statusCode": 200,
                        "body": {
                          "pass": "@true"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "5fb23166-e1f4-4a78-8511-67da135104e6"
                      }
                    },
                    "Terminate_if_envt_does_not_yet_exist": {
                      "type": "Terminate",
                      "inputs": {
                        "runStatus": "Succeeded"
                      },
                      "runAfter": {
                        "Respond_to_a_PowerApp_or_flow_true_-_no_envt": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "f892f3e6-adaf-49a5-a0d2-67675fb248f8"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Evnt_Details": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7d2b2713-8b0d-45c7-86cf-976a4ed72643"
                  }
                }
              },
              "metadata": {
                "operationMetadataId": "afed6048-04a7-45dd-8d86-ab6111df3014"
              }
            },
            "Get_App_as_Admin": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "environment": "@triggerBody()['text_1']",
                  "app": "@triggerBody()['text_2']",
                  "api-version": "2023-06-01"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins",
                  "operationId": "Get-AdminApp",
                  "connectionName": "shared_powerappsforadmins"
                }
              },
              "runAfter": {
                "Ensure_Envt_Inventoried": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "ab24ad3a-8661-447f-856c-a44475c90bf5"
              }
            }
          },
          "runAfter": {
            "Initialize_PoliciesViolatedArray": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0bd60414-c89a-4af8-aafd-d8c67ce3e992"
          }
        },
        "Error_Handling": {
          "type": "Scope",
          "actions": {
            "Terminate": {
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              },
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              }
            },
            "Get_ID_Fail": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              }
            },
            "Update_Last_Run_Fail": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              }
            },
            "Respond_to_a_PowerApp_or_flow_false": {
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pass": {
                      "title": "pass",
                      "x-ms-dynamically-added": true,
                      "type": "boolean"
                    }
                  },
                  "additionalProperties": {}
                },
                "statusCode": 200,
                "body": {
                  "pass": "@false"
                }
              },
              "metadata": {
                "operationMetadataId": "765a5dda-0ee4-4094-b4c5-e0e4c2289c02"
              }
            },
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_environmentname": "@outputs('Get_Evnt_Details')?['body/admin_displayname']",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              },
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow_false": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              }
            }
          },
          "runAfter": {
            "Inventory_this_app": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          }
        },
        "Update_last_run_as_pass": {
          "type": "Scope",
          "actions": {
            "Update_Last_Run_Successful": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date",
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              }
            },
            "Respond_to_a_PowerApp_or_flow_true": {
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pass": {
                      "title": "pass",
                      "x-ms-dynamically-added": true,
                      "type": "boolean"
                    }
                  },
                  "additionalProperties": {}
                },
                "statusCode": 200,
                "body": {
                  "pass": "@true"
                }
              },
              "metadata": {
                "operationMetadataId": "5fb23166-e1f4-4a78-8511-67da135104e6"
              }
            },
            "Get_ID_Pass": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow_true": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              }
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          }
        },
        "Initialize_AppType_to_Canvas": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "AppType",
                "type": "integer",
                "value": 597910000
              }
            ]
          },
          "runAfter": {
            "Initialize_ActualConnectionsArray": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "2e2f5668-9ded-4b68-b70d-fb96d1aabb91"
          }
        },
        "Initialize_PoliciesViolatedArray": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "PoliciesViolatedArray",
                "type": "array"
              }
            ]
          },
          "runAfter": {
            "Initialize_AppType_to_Canvas": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "47547832-2485-4f2f-9e50-22756f4a573d"
          }
        }
      },
      "description": "This flow updates the inventory for a specific app based on current tenant properties for that app"
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}