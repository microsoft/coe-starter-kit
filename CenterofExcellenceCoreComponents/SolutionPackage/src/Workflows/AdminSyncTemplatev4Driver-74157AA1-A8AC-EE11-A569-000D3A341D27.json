{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseEnvRequest"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdminsEnvRequest"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_teams": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreTeams"
        },
        "api": {
          "name": "shared_teams"
        }
      },
      "shared_office365groups": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Groups"
        },
        "api": {
          "name": "shared_office365groups"
        }
      },
      "shared_powerappsforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAppsAdmin2"
        },
        "api": {
          "name": "shared_powerappsforadmins"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_3": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "DelayInventory (admin_DelayInventory)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_DelayInventory",
            "description": "Inventory - If Yes, will run a delay step to assist with the Dataverse health. Only turn to No for debugging. "
          }
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "Inventory and Telemetry in Azure Data Storage account (admin_InventoryandTelemetryinAzureDataStorageaccount)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_InventoryandTelemetryinAzureDataStorageaccount",
            "description": "Inventory - Have you set up data export in PPAC and is your inventory and telemetry in an Azure Data Storage folder (also referred to as Bring your own Datalake, self-serve analytics feature). Default no"
          }
        },
        "is All Environments Inventory (admin_isFullTenantInventory)": {
          "defaultValue": true,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_isFullTenantInventory",
            "description": "Inventory - If true, (the default) the CoE inventory tracks all environments. New environments added to the inventory will have their Excuse from Inventory to false. You can opt out individual environments.  If false, the CoE inventory tracks a subset of environments. New environments added to the inventory will have their Excuse from Inventory to true. You can opt in individual environments."
          }
        },
        "CoE System User ID (admin_CoESystemUserID)": {
          "defaultValue": "f039b642-ad47-ee11-be6d-000d3a3411d9",
          "type": "String",
          "metadata": {
            "schemaName": "admin_CoESystemUserID",
            "description": "in the maker table we store a user for system with an id. Storing here so that it can be referenced without having to look it up all the time."
          }
        }
      },
      "triggers": {
        "Recurrence": {
          "recurrence": {
            "frequency": "Day",
            "interval": 1,
            "schedule": {
              "hours": [
                "0"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "3c3ce999-3c1e-44d8-b7e6-a63d677236b3"
          },
          "type": "Recurrence"
        }
      },
      "actions": {
        "Get_Environments_fails_-_Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "authentication": "@parameters('$authentication')",
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            },
            "Terminate": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "authentication": "@parameters('$authentication')"
              }
            }
          },
          "runAfter": {
            "Sync_Template_Driver": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Initialize_systemMaker": {
          "runAfter": {
            "Delay_Inventory": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "34322142-9050-4db3-bb27-b6a0060a81a5"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "systemMaker",
                "type": "string"
              }
            ]
          }
        },
        "Delay_Inventory": {
          "actions": {
            "Delay_1_to_300_minutes": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f37a4a9d-c5b4-41ed-8484-636dca60ee81"
              },
              "type": "Wait",
              "inputs": {
                "interval": {
                  "count": "@rand(1, 300)",
                  "unit": "Minute"
                }
              },
              "description": "For Dataverse service health, we will randomize the start time of these flows for tenants within a 5 hour range"
            }
          },
          "runAfter": {
            "If_inventory_in_BYODL_terminate_here": [
              "Succeeded"
            ]
          },
          "expression": {
            "equals": [
              "@parameters('DelayInventory (admin_DelayInventory)')",
              true
            ]
          },
          "metadata": {
            "operationMetadataId": "49b3d120-232d-4694-b373-a97ecde35cc4"
          },
          "type": "If"
        },
        "If_inventory_in_BYODL_terminate_here": {
          "actions": {
            "Terminate_for_BYODL": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "b5f6975a-7731-4f8b-8e27-5fd452e901bb"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Succeeded"
              }
            }
          },
          "runAfter": {},
          "expression": {
            "equals": [
              "@parameters('Inventory and Telemetry in Azure Data Storage account (admin_InventoryandTelemetryinAzureDataStorageaccount)')",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "54988332-a904-4fb7-b5b3-40e6a1ceba99"
          },
          "type": "If"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Get_ID_Pass": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date"
            }
          },
          "runAfter": {
            "Get_Environments_fails_-_Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Sync_Template_Driver": {
          "actions": {
            "Get_Environments_and_some_tenant_wide_properties": {
              "actions": {
                "Get_Environments": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "96dbd66a-d8d5-4b0d-b2ea-73766104434e"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerplatformforadmins_1",
                      "operationId": "Get-AdminEnvironment",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                    },
                    "parameters": {
                      "api-version": "2021-03-01",
                      "$expand": "properties.capacity,properties.addons"
                    },
                    "authentication": "@parameters('$authentication')"
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_tenantID": {
                  "actions": {
                    "Select_Tenant_ID": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "6c1bd028-1451-472a-bbfb-b17dab4e9359"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('Get_Environments')?['body/value']",
                        "select": {
                          "GetTenantID": "@item()?['properties/createdBy/tenantId']"
                        }
                      }
                    },
                    "Filter_not_null": {
                      "runAfter": {
                        "Select_Tenant_ID": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "23061d38-71f2-4deb-8a97-5aabc12ecdf4"
                      },
                      "type": "Query",
                      "inputs": {
                        "from": "@body('Select_Tenant_ID')",
                        "where": "@not(equals(item()?['GetTenantID'], null))"
                      }
                    },
                    "Tenant_ID": {
                      "runAfter": {
                        "Filter_not_null": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "9fb0a5e5-63d2-4323-a655-f493234057e8"
                      },
                      "type": "Compose",
                      "inputs": "@first(body('Filter_not_null'))?['GetTenantID']"
                    }
                  },
                  "runAfter": {
                    "Get_Environments": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c954f863-69f7-45fa-b822-c342ca9163b2"
                  },
                  "type": "Scope"
                },
                "Get_System_User": {
                  "actions": {
                    "Is_System_Maker": {
                      "actions": {
                        "Create_Maker_record_for_SYSTEM": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "c83d583d-1569-487b-ae3f-0f3d0e088fef"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps",
                              "operationId": "CreateRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_makers",
                              "item/admin_displayname": "SYSTEM"
                            },
                            "authentication": "@parameters('$authentication')",
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        },
                        "Set_systemMaker_with_new_record": {
                          "runAfter": {
                            "Create_Maker_record_for_SYSTEM": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "3160ee45-9a51-4d89-a0bd-26b4277852c2"
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "systemMaker",
                            "value": "@outputs('Create_Maker_record_for_SYSTEM')?['body/admin_makerid']"
                          }
                        },
                        "Update_GUID_string": {
                          "runAfter": {
                            "Set_systemMaker_with_new_record": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ed6ce6b8-c54c-4e3f-8246-1b1044117646"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps_1",
                              "operationId": "UpdateRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_makers",
                              "recordId": "@variables('systemMaker')",
                              "item/admin_recordguidasstring": "@variables('systemMaker')"
                            },
                            "authentication": "@parameters('$authentication')"
                          }
                        }
                      },
                      "runAfter": {
                        "List_Makers": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_systemMaker_with_existing_record": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "0e2cd801-3c19-495a-84e7-84a0b96687b7"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "systemMaker",
                              "value": "@{first(body('List_Makers')?['value'])?['admin_makerid']}"
                            }
                          }
                        }
                      },
                      "expression": {
                        "equals": [
                          "@length(outputs('List_Makers')?['body/value'])",
                          0
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "8645a2a6-bfa1-42a0-98ce-a92b2c149cbb"
                      },
                      "type": "If"
                    },
                    "List_Makers": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "c4cecee4-c6a1-498a-a942-0054aa58fbad"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_makers",
                          "$select": "admin_makerid",
                          "$filter": "admin_displayname eq 'SYSTEM'"
                        },
                        "authentication": "@parameters('$authentication')",
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 10,
                          "interval": "PT10S"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Get_tenantID": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "de15e9bf-5a09-486f-8d39-230c345ca715"
                  },
                  "type": "Scope"
                },
                "Get_CoE_Specifics": {
                  "actions": {
                    "CoE_Envt": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "9d317ed4-37d6-4344-8ea1-6d850b008dc9"
                      },
                      "type": "Compose",
                      "inputs": "@substring(workflow()?['tags']['environmentName'], sub(length(workflow()?['tags']['environmentName']), 36), 36)"
                    },
                    "Default_Behavior_for_Excuse_from_Inventory": {
                      "runAfter": {
                        "CoE_Envt": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "25540d21-cbd1-4d87-ad4e-7fdb969e9b90"
                      },
                      "type": "Compose",
                      "inputs": "@if(equals(parameters('is All Environments Inventory (admin_isFullTenantInventory)'), true), false, true)"
                    }
                  },
                  "runAfter": {
                    "Get_System_User": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "41f28676-ccb3-4f4a-927e-eb888de88ec5"
                  },
                  "type": "Scope"
                },
                "Get_Tenant_DLP_Information": {
                  "actions": {
                    "List_DLP_Policies_V2": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "a4281f98-60ca-41fc-ae61-3b9615550532"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_powerplatformforadmins",
                          "operationId": "ListPoliciesV2",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                        },
                        "parameters": {},
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "Select_Policy": {
                      "runAfter": {
                        "List_DLP_Policies_V2": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "0c5774ed-ec00-45b3-bda2-af03fab1889a"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('List_DLP_Policies_V2')?['body/value']",
                        "select": {
                          "DLP_Name": "@item()?['displayName']",
                          "DLP_Type": "@item()?['environmentType']",
                          "DLP_Envts": "@join(item()?['environments'], ';')"
                        }
                      }
                    },
                    "Filter_to_All_Envt": {
                      "runAfter": {
                        "Select_Policy": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "994dbc06-168b-4320-9c3b-e32d6193c9b5"
                      },
                      "type": "Query",
                      "inputs": {
                        "from": "@body('Select_Policy')",
                        "where": "@equals(item()?['DLP_Type'], 'AllEnvironments')"
                      }
                    },
                    "Select_All_Envt_Names": {
                      "runAfter": {
                        "Filter_to_All_Envt": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "80de6ff2-55a7-4586-b19b-e748243ca936"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@body('Filter_to_All_Envt')",
                        "select": "@item()?['DLP_Name']"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_CoE_Specifics": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "5e9b6284-5d14-4df4-85fa-8f48985c57b5"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "5f28eab2-0a94-4df9-8802-9a77aaf315cd"
              },
              "type": "Scope"
            },
            "Store_environments_in_the_CoE_CDS_Entity": {
              "actions": {
                "Apply_to_each_Environment": {
                  "foreach": "@outputs('Get_Environments')?['body/value']",
                  "actions": {
                    "Get_Environment_as_Admin_-_see_if_still_exists": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "b4064108-7a47-4386-bbbb-35b3c52183c8"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_powerplatformforadmins",
                          "operationId": "GetSingleEnvironment",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                        },
                        "parameters": {
                          "environment": "@items('Apply_to_each_Environment')?['name']",
                          "api-version": "2018-10-01"
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "Inventory_environment": {
                      "actions": {
                        "teams_information": {
                          "actions": {
                            "Check_if_Teams_envt": {
                              "actions": {
                                "Parse_JSON": {
                                  "runAfter": {
                                    "get_connectedGroups": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "4689735a-9211-43c7-a196-6994f87f9e22"
                                  },
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@outputs('get_connectedGroups')",
                                    "schema": {
                                      "type": "object",
                                      "properties": {
                                        "id": {
                                          "type": "string"
                                        },
                                        "displayName": {
                                          "type": "string"
                                        },
                                        "state": {
                                          "type": "string"
                                        },
                                        "resources": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "type": {
                                                "type": "string"
                                              },
                                              "id": {
                                                "type": "string"
                                              }
                                            },
                                            "required": [
                                              "type",
                                              "id"
                                            ]
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "get_connectedGroups": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "1aa874ae-a93c-45dd-8d2c-f19e5bc84f31"
                                  },
                                  "type": "Compose",
                                  "inputs": "@first(items('Apply_to_each_Environment')?['properties/connectedGroups'])"
                                },
                                "TeamID": {
                                  "runAfter": {
                                    "Parse_JSON": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "7b07bcb3-8e12-492f-b270-bd650dff4f21"
                                  },
                                  "type": "Compose",
                                  "inputs": "@body('Parse_JSON')?['id']"
                                },
                                "Get_a_team": {
                                  "runAfter": {
                                    "TeamID": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "7f25f469-b278-477b-89ef-d1ea0d2c2fa8"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_teams",
                                      "operationId": "GetTeam",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams"
                                    },
                                    "parameters": {
                                      "teamId": "@outputs('TeamID')"
                                    },
                                    "authentication": "@parameters('$authentication')"
                                  }
                                },
                                "TeamURL": {
                                  "runAfter": {
                                    "Get_a_team": [
                                      "Succeeded",
                                      "Failed"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "875675a4-eb7a-406f-91f7-c989c2cc62b9"
                                  },
                                  "type": "Compose",
                                  "inputs": "@coalesce(outputs('Get_a_team')?['body/webUrl'], '')"
                                }
                              },
                              "runAfter": {},
                              "expression": {
                                "equals": [
                                  "@items('Apply_to_each_Environment')?['properties/environmentSku']",
                                  "Teams"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "075ce791-a673-4be9-9059-9ca401bda1a0"
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "security_group_information": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "708d9170-afd3-497d-a869-945573509fac"
                          },
                          "type": "Scope"
                        },
                        "Get_basics": {
                          "actions": {
                            "Get_Environment": {
                              "runAfter": {
                                "Get_Owner_Details": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "10bd46df-c321-464c-9b83-7c844a840d66"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "GetItem",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_environments",
                                  "recordId": "@outputs('EnvtGUID')",
                                  "$select": "admin_environmentid, admin_excusefrominventory"
                                },
                                "authentication": "@parameters('$authentication')",
                                "retryPolicy": {
                                  "type": "exponential",
                                  "count": 10,
                                  "interval": "PT10S"
                                }
                              }
                            },
                            "catch_-_not_yet_inventoried": {
                              "runAfter": {
                                "Get_Environment": [
                                  "Failed"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "fdd60069-d007-42ee-9dfd-008c6756f9ab"
                              },
                              "type": "Compose",
                              "inputs": "catch - not yet inventoried"
                            },
                            "Get_GUID": {
                              "actions": {
                                "For_Type_Legacy": {
                                  "actions": {
                                    "Get_with_Name": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "bec051d6-026d-4895-a374-77d4c7a89ec3"
                                      },
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connectionName": "shared_commondataserviceforapps",
                                          "operationId": "ListRecords",
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                        },
                                        "parameters": {
                                          "entityName": "admin_environments",
                                          "$select": "admin_environmentid, admin_excusefrominventory",
                                          "$filter": "admin_environmentname eq '@{items('Apply_to_each_Environment')?['name']}'"
                                        },
                                        "authentication": "@parameters('$authentication')",
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      }
                                    },
                                    "GUID_for_Legacy": {
                                      "runAfter": {
                                        "Get_with_Name": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "de6e6f51-ce4c-4765-8cb6-6c39b6029060"
                                      },
                                      "type": "Compose",
                                      "inputs": "@if(equals(length(outputs('Get_with_Name')?['body/value']), 0), guid(), first(outputs('Get_with_Name')?['body/value'])?['admin_environmentid'])"
                                    }
                                  },
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "42ac0132-4e59-4ded-86d1-9b93b1561b07"
                                  },
                                  "type": "Scope",
                                  "description": "Legacy and Default environments have the same GUID, prefixed by Legacy- or Default- which is causing issues as the Record Identifier is using the GUID as a unique identifier. We are therefore using a generated GUID for the entity."
                                },
                                "Name_Length": {
                                  "runAfter": {
                                    "For_Type_Legacy": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "4230ad8d-8c2a-41f7-870e-607f90350117"
                                  },
                                  "type": "Compose",
                                  "inputs": "@sub(length(items('Apply_to_each_Environment')?['name']),36)",
                                  "description": "Returns the index where the GUID starts"
                                },
                                "Remove_any_Environment_prefix": {
                                  "runAfter": {
                                    "Name_Length": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "364ae561-c6fe-4058-95a5-f5418a391a92"
                                  },
                                  "type": "Compose",
                                  "inputs": "@substring(items('Apply_to_each_Environment')?['name'], int(outputs('Name_Length')), 36)",
                                  "description": "Returns the GUID without any prefix (right 36 chars)"
                                },
                                "EnvtGUID": {
                                  "runAfter": {
                                    "Remove_any_Environment_prefix": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "9c58cb89-20ce-40b6-80d8-b119cc8b7424"
                                  },
                                  "type": "Compose",
                                  "inputs": "@if(contains(items('Apply_to_each_Environment')?['properties/creationType'], 'Legacy'), outputs('GUID_for_Legacy'), outputs('Remove_any_Environment_prefix'))"
                                }
                              },
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "78212a84-b94c-472c-947a-42e75034b784"
                              },
                              "type": "Scope"
                            },
                            "Get_Owner_Details": {
                              "actions": {
                                "If_not,_add_them": {
                                  "actions": {
                                    "Maker_Check": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "9b77404f-4d8e-4e72-992d-f09db75c4167"
                                      },
                                      "type": "Workflow",
                                      "inputs": {
                                        "host": {
                                          "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                        },
                                        "body": {
                                          "text": "@outputs('OwnerID')",
                                          "boolean": false
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "See_if_already_in_Maker_Table": [
                                      "Succeeded"
                                    ]
                                  },
                                  "expression": {
                                    "equals": [
                                      "@length(outputs('See_if_already_in_Maker_Table')?['body/value'])",
                                      0
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "b0599ae4-1806-47c1-9c32-955838f93048"
                                  },
                                  "type": "If"
                                },
                                "Get_Maker": {
                                  "runAfter": {
                                    "If_not,_add_them": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "ae6d172a-7fcb-44c7-88dc-32f5b1cec2c8"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "GetItem",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_makers",
                                      "recordId": "@outputs('OwnerID')"
                                    },
                                    "authentication": "@parameters('$authentication')",
                                    "retryPolicy": {
                                      "type": "exponential",
                                      "count": 20,
                                      "interval": "PT20S"
                                    }
                                  }
                                },
                                "catch_for_orphans_no_id": {
                                  "runAfter": {
                                    "Get_Maker": [
                                      "Failed"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "b420ec58-4b1d-4f34-8cf4-880c0c0b82ab"
                                  },
                                  "type": "Compose",
                                  "inputs": "catch for orphans no id"
                                },
                                "IsOrphan": {
                                  "runAfter": {
                                    "catch_for_orphans_no_id": [
                                      "Succeeded",
                                      "Skipped"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "5ba88760-724b-482e-b7c5-72b125a595a0"
                                  },
                                  "type": "Compose",
                                  "inputs": "@if(or(equals(outputs('OwnerID'), null), equals(length(outputs('OwnerID')), 0), equals(outputs('Get_Maker')?['body/admin_makerisorphaned'], true), equals(outputs('Get_Maker')?['body/admin_makerid'], null)), true, false)"
                                },
                                "OwnerID": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "56cfa7cf-65cb-4e51-b16a-430bc087d28c"
                                  },
                                  "type": "Compose",
                                  "inputs": "@if(equals(items('Apply_to_each_Environment')?['properties/createdBy/id'], null), if(equals(items('Apply_to_each_Environment')?['properties/createdBy/type'], 'NotSpecified'), parameters('CoE System User ID (admin_CoESystemUserID)'), ''), if(equals(items('Apply_to_each_Environment')?['properties/createdBy/id'], 'SYSTEM'), parameters('CoE System User ID (admin_CoESystemUserID)'), items('Apply_to_each_Environment')?['properties/createdBy/id']))"
                                },
                                "See_if_already_in_Maker_Table": {
                                  "runAfter": {
                                    "OwnerID": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "6a7ef4f9-5a59-45f9-a290-e89115a2f36d"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_makers",
                                      "$filter": "admin_makerid eq @{outputs('OwnerID')}"
                                    },
                                    "authentication": "@parameters('$authentication')",
                                    "retryPolicy": {
                                      "type": "exponential",
                                      "count": 20,
                                      "interval": "PT20S"
                                    }
                                  },
                                  "runtimeConfiguration": {
                                    "paginationPolicy": {
                                      "minimumItemCount": 100000
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Get_GUID": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "615c25ea-17df-47c6-b0b2-1620d61d03c7"
                              },
                              "type": "Scope"
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "23435baf-588a-4043-806a-261338540405"
                          },
                          "type": "Scope"
                        },
                        "cds_information": {
                          "actions": {
                            "hasCDS": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "800916c7-d231-4d4e-8e73-63e0c813d14b"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata'], null), false, true)"
                            },
                            "cds_URL": {
                              "runAfter": {
                                "hasCDS": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "18c0407f-2087-4ec6-acfe-04345d976c7d"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata'], null), false, concat('.', split(items('Apply_to_each_Environment')?['properties']?['linkedEnvironmentMetadata']?['instanceUrl'], '.')[1]))"
                            },
                            "CDS_Metadata_Name": {
                              "runAfter": {
                                "cds_URL": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "6ab09461-6027-43b2-bc21-9abcb593d214"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata'], null), concat('', ''), replace(concat(items('Apply_to_each_Environment')?['properties']?['linkedEnvironmentMetadata']?['uniqueName'], outputs('cds_URL')), '/', ''))"
                            }
                          },
                          "runAfter": {
                            "envt_information": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "141cbda7-357c-46c3-8d9c-7fdf3b4a35ba"
                          },
                          "type": "Scope"
                        },
                        "envt_information": {
                          "actions": {
                            "has_PCF_State": {
                              "runAfter": {
                                "Get_Org_Info": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "b6eedfb8-679e-4f9e-afb0-08fbb7cea864"
                              },
                              "type": "Compose",
                              "inputs": "@coalesce(if(equals(body('Parse_organization')?['iscustomcontrolsincanvasappsenabled'], true), 1, 0), 2)"
                            },
                            "has_Maker_Copilot_State": {
                              "runAfter": {
                                "has_PCF_State": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "98c3bd80-b4d1-47fe-9f89-61befe29b851"
                              },
                              "type": "Compose",
                              "inputs": "@coalesce(if(equals(body('Parse_organization')?['powerappsmakerbotenabled'], null), 1, if(equals(body('Parse_organization')?['powerappsmakerbotenabled'], true), 1, 0)), 2)"
                            },
                            "is_New_Envt": {
                              "runAfter": {
                                "has_Maker_Copilot_State": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "c9f73639-c949-440f-af5e-4525330d205e"
                              },
                              "type": "Compose",
                              "inputs": "@coalesce(if(equals(outputs('Get_Environment')?['body/admin_environmentid'], null), true, false), true)"
                            },
                            "Excused_From_Inventory": {
                              "runAfter": {
                                "is_New_Envt": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "6ee23676-557c-4755-8038-759509ecba8b"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(outputs('is_New_Envt'), true), outputs('Default_Behavior_for_Excuse_from_Inventory'), outputs('Get_Environment')?['body/admin_excusefrominventory'])"
                            },
                            "Get_Org_Info": {
                              "actions": {
                                "Get_organization": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "dec5dbe3-f476-4dfc-bcac-efc6d7717c6c"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_1",
                                      "operationId": "ListRecordsWithOrganization",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "organization": "@items('Apply_to_each_Environment')?['properties']?['linkedEnvironmentMetadata']?['instanceUrl']",
                                      "entityName": "organizations",
                                      "$top": 1
                                    },
                                    "authentication": "@parameters('$authentication')"
                                  }
                                },
                                "catch_for_legacy_connector_bug": {
                                  "runAfter": {
                                    "Get_organization": [
                                      "Failed"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "a7ab3de7-0e22-4a52-830a-f1c11e4c475d"
                                  },
                                  "type": "Compose",
                                  "inputs": "catch for legacy connector bug"
                                },
                                "Parse_organization": {
                                  "runAfter": {
                                    "catch_for_legacy_connector_bug": [
                                      "Skipped"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "15176924-3754-4dba-8d4a-e5db34a49ae1"
                                  },
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@first(outputs('Get_organization')?['body/value'])",
                                    "schema": {
                                      "type": "object",
                                      "properties": {
                                        "iscustomcontrolsincanvasappsenabled": {
                                          "type": "boolean"
                                        },
                                        "powerappsmakerbotenabled": {
                                          "type": "boolean"
                                        }
                                      }
                                    }
                                  }
                                }
                              },
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "f7af7d75-a38d-454c-b5e1-2802a3bb652e"
                              },
                              "type": "Scope"
                            },
                            "isCoE": {
                              "runAfter": {
                                "Excused_From_Inventory": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "5f898384-e30e-464b-b530-7f2f9328b47c"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(outputs('CoE_Envt'), outputs('Remove_any_Environment_prefix')), true, false)"
                            }
                          },
                          "runAfter": {
                            "Get_basics": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "19c7bec7-c9ce-416e-b595-3f924ea9d3e5"
                          },
                          "type": "Scope"
                        },
                        "See_if_need_to_add_to_inventory": {
                          "actions": {
                            "Update_after_check_orphan_status": {
                              "actions": {
                                "Upsert_Environment_(Orphaned)": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "3b39b303-3bdb-449f-b0b0-df11a9292183"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps",
                                      "operationId": "UpdateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_environments",
                                      "recordId": "@outputs('EnvtGUID')",
                                      "item/admin_displayname": "@items('Apply_to_each_Environment')?['properties/displayName']",
                                      "item/admin_administrationmode": "@coalesce(if(equals(items('Apply_to_each_Environment')?['properties/states/runtime/id'], 'AdminMode'), true, false), false)",
                                      "item/admin_backgroundoperationsenabled": "@coalesce(if(equals(items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata/backgroundOperationsState'], 'Disabled'), false, true), true)",
                                      "item/admin_connectionsinaccessible": "@outputs('connections_inaccessible')",
                                      "item/admin_dlppolicies": "@outputs('Impacting_DLPs')",
                                      "item/admin_environmentcdsinstanceurl": "@items('Apply_to_each_Environment')?['properties']?['linkedEnvironmentMetadata']?['instanceUrl']",
                                      "item/admin_environmentcdsmetadataname": "@outputs('CDS_Metadata_Name')",
                                      "item/admin_environmentcreatedon": "@items('Apply_to_each_Environment')?['properties']?['createdTime']",
                                      "item/admin_environmentdeleted": false,
                                      "item/admin_environmentdeletedon": "@null",
                                      "item/admin_environmentisorphaned": "Yes",
                                      "item/admin_environmentmodifiedon": "@items('Apply_to_each_Environment')?['properties']?['lastModifiedTime']",
                                      "item/admin_environmentpurposetext": "@items('Apply_to_each_Environment')?['properties/description']",
                                      "item/admin_environmentqueriedon": "@utcNow()",
                                      "item/admin_region": "@items('Apply_to_each_Environment')?['location']",
                                      "item/admin_environmentruntimestate": "@items('Apply_to_each_Environment')?['properties/states/runtime/id']",
                                      "item/admin_environmentsku": "@items('Apply_to_each_Environment')?['properties']?['environmentSku']",
                                      "item/admin_environmentstate": "@items('Apply_to_each_Environment')?['properties/states/management/id']",
                                      "item/admin_excusefrominventory": "@outputs('Excused_From_Inventory')",
                                      "item/admin_governanceprotectionlevel": "@items('Apply_to_each_Environment')?['properties/governanceConfiguration/protectionLevel']",
                                      "item/admin_hasdlppolicy": "@outputs('has_DLP')",
                                      "item/admin_hascds": "@outputs('hasCDS')",
                                      "item/admin_iscoe": "@outputs('isCoE')",
                                      "item/admin_makercopilotenabled": "@outputs('has_Maker_Copilot_State')",
                                      "item/admin_microsoftteamsid": "@outputs('TeamID')",
                                      "item/admin_microsoftteamsurl": "@outputs('TeamURL')",
                                      "item/admin_environmentname": "@items('Apply_to_each_Environment')?['name']",
                                      "item/admin_organizationid": "@items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata/resourceId']",
                                      "item/admin_pcfenabled": "@outputs('has_PCF_State')",
                                      "item/admin_recordguidasstring": "@outputs('EnvtGUID')",
                                      "item/admin_securitygroupid": "@outputs('securityGroupID')",
                                      "item/admin_securitygroupname": "@outputs('securityGroupName')",
                                      "item/admin_tenantid": "@outputs('Tenant_ID')"
                                    },
                                    "authentication": "@parameters('$authentication')",
                                    "retryPolicy": {
                                      "type": "exponential",
                                      "count": 10,
                                      "interval": "PT10S"
                                    }
                                  }
                                }
                              },
                              "runAfter": {},
                              "else": {
                                "actions": {
                                  "Upsert_Environment": {
                                    "runAfter": {},
                                    "metadata": {
                                      "operationMetadataId": "590a2ba8-bf09-464b-8c5a-ee001b9cf735"
                                    },
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "host": {
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord",
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                      },
                                      "parameters": {
                                        "entityName": "admin_environments",
                                        "recordId": "@outputs('EnvtGUID')",
                                        "item/admin_displayname": "@items('Apply_to_each_Environment')?['properties/displayName']",
                                        "item/admin_administrationmode": "@coalesce(if(equals(items('Apply_to_each_Environment')?['properties/states/runtime/id'], 'AdminMode'), true, false), false)",
                                        "item/admin_backgroundoperationsenabled": "@coalesce(if(equals(items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata/backgroundOperationsState'], 'Disabled'), false, true), true)",
                                        "item/admin_connectionsinaccessible": "@outputs('connections_inaccessible')",
                                        "item/admin_dlppolicies": "@outputs('Impacting_DLPs')",
                                        "item/admin_environmentcdsinstanceurl": "@items('Apply_to_each_Environment')?['properties']?['linkedEnvironmentMetadata']?['instanceUrl']",
                                        "item/admin_environmentcdsmetadataname": "@outputs('CDS_Metadata_Name')",
                                        "item/admin_environmentcreatedon": "@items('Apply_to_each_Environment')?['properties']?['createdTime']",
                                        "item/admin_environmentdeleted": false,
                                        "item/admin_environmentdeletedon": "@null",
                                        "item/admin_environmentisorphaned": "No",
                                        "item/admin_Maker@odata.bind": "admin_makers(@{outputs('Get_Maker')?['body/admin_makerid']})",
                                        "item/admin_environmentmakerdisplayname": "@outputs('Get_Maker')?['body/admin_displayname']",
                                        "item/admin_environmentmakerupn": "@outputs('Get_Maker')?['body/admin_userprincipalname']",
                                        "item/admin_environmentmodifiedon": "@items('Apply_to_each_Environment')?['properties']?['lastModifiedTime']",
                                        "item/admin_environmentpurposetext": "@items('Apply_to_each_Environment')?['properties/description']",
                                        "item/admin_environmentqueriedon": "@utcNow()",
                                        "item/admin_region": "@items('Apply_to_each_Environment')?['location']",
                                        "item/admin_environmentruntimestate": "@items('Apply_to_each_Environment')?['properties/states/runtime/id']",
                                        "item/admin_environmentsku": "@items('Apply_to_each_Environment')?['properties']?['environmentSku']",
                                        "item/admin_environmentstate": "@items('Apply_to_each_Environment')?['properties/states/management/id']",
                                        "item/admin_excusefrominventory": "@outputs('Excused_From_Inventory')",
                                        "item/admin_governanceprotectionlevel": "@items('Apply_to_each_Environment')?['properties/governanceConfiguration/protectionLevel']",
                                        "item/admin_hasdlppolicy": "@outputs('has_DLP')",
                                        "item/admin_hascds": "@outputs('hasCDS')",
                                        "item/admin_iscoe": "@outputs('isCoE')",
                                        "item/admin_makercopilotenabled": "@outputs('has_Maker_Copilot_State')",
                                        "item/admin_microsoftteamsid": "@outputs('TeamID')",
                                        "item/admin_microsoftteamsurl": "@outputs('TeamURL')",
                                        "item/admin_environmentname": "@items('Apply_to_each_Environment')?['name']",
                                        "item/admin_organizationid": "@items('Apply_to_each_Environment')?['properties/linkedEnvironmentMetadata/resourceId']",
                                        "item/admin_pcfenabled": "@outputs('has_PCF_State')",
                                        "item/admin_recordguidasstring": "@outputs('EnvtGUID')",
                                        "item/admin_securitygroupid": "@outputs('securityGroupID')",
                                        "item/admin_securitygroupname": "@outputs('securityGroupName')",
                                        "item/admin_tenantid": "@outputs('Tenant_ID')"
                                      },
                                      "authentication": "@parameters('$authentication')",
                                      "retryPolicy": {
                                        "type": "exponential",
                                        "count": 10,
                                        "interval": "PT10S"
                                      }
                                    }
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@outputs('IsOrphan')",
                                  "@true"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "99f26aa3-7f50-4a58-9051-f0d0a982596a"
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "Connection_accessibility": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "no_op_for_pre-existing_environments_excused_from_inventory": {
                                "runAfter": {},
                                "metadata": {
                                  "operationMetadataId": "ca6d5a96-e711-458a-81cd-d6738d2ca56f"
                                },
                                "type": "Compose",
                                "inputs": "no op for pre-existing environments excused from inventory"
                              }
                            }
                          },
                          "expression": {
                            "or": [
                              {
                                "equals": [
                                  "@outputs('is_New_Envt')",
                                  "@true"
                                ]
                              },
                              {
                                "equals": [
                                  "@outputs('Excused_From_Inventory')",
                                  "@false"
                                ]
                              }
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "70161892-7400-4e4f-aa74-36516b33eddf"
                          },
                          "type": "If",
                          "description": "inventory all envts not excused from inventory and all new envts so they can be updated with that setting. Hence [[ @outputs('is_New_Envt') = true OR @outputs('Excused_From_Inventory') = false ]]"
                        },
                        "security_group_information": {
                          "actions": {
                            "securityGroupID": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "b170ef9e-a147-4d5c-bbfb-d424bb11d54d"
                              },
                              "type": "Compose",
                              "inputs": "@coalesce(outputs('Get_Environment_as_Admin_-_see_if_still_exists')?['body/properties/linkedEnvironmentMetadata/securityGroupId'], '')"
                            },
                            "securityGroupName": {
                              "runAfter": {
                                "If_has_security_group": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "5015ef0e-a2d9-4522-91b5-5f097024f971"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(outputs('has_security_group'), true), outputs('hasGroup_securityGroupName'), 'Not assigned')"
                            },
                            "has_security_group": {
                              "runAfter": {
                                "securityGroupID": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "eaf06a68-730f-46e8-b882-06aaeedd1c36"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(length(outputs('securityGroupID')), 0), false, true)"
                            },
                            "If_has_security_group": {
                              "actions": {
                                "Get_Security_Group": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "dccb1c19-a045-4e08-b191-93b874368d18"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_office365groups",
                                      "operationId": "ListGroups",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                                    },
                                    "parameters": {
                                      "$filter": "id eq '@{outputs('securityGroupID')}'"
                                    },
                                    "authentication": "@parameters('$authentication')",
                                    "retryPolicy": {
                                      "type": "exponential",
                                      "count": 10,
                                      "interval": "PT10S"
                                    }
                                  }
                                },
                                "hasGroup_securityGroupName": {
                                  "runAfter": {
                                    "Get_Security_Group": [
                                      "Succeeded",
                                      "Failed"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "3464160e-fec9-4b5b-b426-ac2de9e9b1ac"
                                  },
                                  "type": "Compose",
                                  "inputs": "@if(equals(outputs('Get_Security_Group')?['body/error'], null), coalesce(first(outputs('Get_Security_Group')?['body/value'])?['displayName'], 'Error'), 'Error')"
                                }
                              },
                              "runAfter": {
                                "has_security_group": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "equals": [
                                  "@outputs('has_security_group')",
                                  "@true"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "cd09f79b-b285-4e6a-b75f-a02d0465da87"
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "cds_information": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "5ff09ca8-3375-4457-9e26-1d46278d4d2d"
                          },
                          "type": "Scope"
                        },
                        "Get_DLP_Information": {
                          "actions": {
                            "Filter_to_Only_Envt": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "994dbc06-168b-4320-9c3b-e32d6193c9b5"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_Policy')",
                                "where": "@and(contains(item()?['DLP_Envts'], items('Apply_to_each_Environment')?['name']), equals(item()?['DLP_Type'], 'OnlyEnvironments'))"
                              }
                            },
                            "Select_Only_Envt_Names": {
                              "runAfter": {
                                "Filter_to_Only_Envt": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "343edeb2-11f3-48b4-a0c0-a8772af9f54a"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Filter_to_Only_Envt')",
                                "select": "@item()?['DLP_Name']"
                              }
                            },
                            "Filter_to_Except_Environments": {
                              "runAfter": {
                                "Select_Only_Envt_Names": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "994dbc06-168b-4320-9c3b-e32d6193c9b5"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_Policy')",
                                "where": "@and(not(contains(item()?['DLP_Envts'], items('Apply_to_each_Environment')?['name'])), equals(item()?['DLP_Type'], 'ExceptEnvironments'))"
                              }
                            },
                            "Select_Except_Environments_Names": {
                              "runAfter": {
                                "Filter_to_Except_Environments": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "343edeb2-11f3-48b4-a0c0-a8772af9f54a"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Filter_to_Except_Environments')",
                                "select": "@item()?['DLP_Name']"
                              }
                            },
                            "Impacting_DLPs_Array": {
                              "runAfter": {
                                "Select_Except_Environments_Names": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "aa10a68d-82d6-426e-aea2-d9c3e6ad784d"
                              },
                              "type": "Compose",
                              "inputs": "@union(body('Select_All_Envt_Names'), body('Select_Only_Envt_Names'), body('Select_Except_Environments_Names'))"
                            },
                            "has_DLP": {
                              "runAfter": {
                                "Impacting_DLPs_Array": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "458a2e70-2c21-429c-bfa5-025eae5ad2bb"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(length(outputs('Impacting_DLPs_Array')), 0), false, true)"
                            },
                            "Impacting_DLPs": {
                              "runAfter": {
                                "has_DLP": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "27d5e4b9-8610-4d11-a915-4bbeb819f08a"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(outputs('has_DLP'), true), join(outputs('Impacting_DLPs_Array'), '; '), '')"
                            }
                          },
                          "runAfter": {
                            "teams_information": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "bef9123d-a05a-4efa-837b-37b199e23526"
                          },
                          "type": "Scope"
                        },
                        "Connection_accessibility": {
                          "actions": {
                            "Get_Connections_as_Admin": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "be5cdaa3-de57-44ed-8a12-1c41df4e1a90"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_powerappsforadmins",
                                  "operationId": "Get-AdminConnections",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerappsforadmins"
                                },
                                "parameters": {
                                  "environment": "@items('Apply_to_each_Environment')?['name']",
                                  "api-version": "2016-11-01",
                                  "$top": 1000
                                },
                                "authentication": "@parameters('$authentication')"
                              },
                              "runtimeConfiguration": {
                                "paginationPolicy": {
                                  "minimumItemCount": 100000
                                }
                              }
                            },
                            "Catch_-_are_connections_inaccessible": {
                              "runAfter": {
                                "Get_Connections_as_Admin": [
                                  "Failed"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "4ed49115-a635-4b83-8707-575290ce43d7"
                              },
                              "type": "Compose",
                              "inputs": "@true"
                            },
                            "connections_inaccessible": {
                              "runAfter": {
                                "Catch_-_are_connections_inaccessible": [
                                  "Succeeded",
                                  "Skipped"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "d7d3f4a5-1aca-4da8-b50b-5743ad547d48"
                              },
                              "type": "Compose",
                              "inputs": "@if(equals(outputs('Catch_-_are_connections_inaccessible'), null), false, true)"
                            }
                          },
                          "runAfter": {
                            "Get_DLP_Information": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "6f18b188-6ca9-4944-a889-ca1b0178593e"
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "catch_-_envt_deleted_since_flow_started": [
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "6a581d44-8aac-4c8c-8ae5-18e71ef73eb5"
                      },
                      "type": "Scope"
                    },
                    "catch_-_envt_deleted_since_flow_started": {
                      "runAfter": {
                        "Get_Environment_as_Admin_-_see_if_still_exists": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "7c69805f-565c-4f4b-87c5-5340c8fcd99a"
                      },
                      "type": "Compose",
                      "inputs": "catch - envt deleted since flow started"
                    }
                  },
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "cea01520-4a74-4b49-b231-23aaedb151ac"
                  },
                  "type": "Foreach"
                }
              },
              "runAfter": {
                "Get_Environments_and_some_tenant_wide_properties": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "2bc4bc7d-bdc5-4ea7-abc2-f0965a774fff"
              },
              "type": "Scope"
            },
            "Look_for_Deleted_Environments": {
              "actions": {
                "CurrentEnvtInventory": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "7c47d9de-dc3c-460c-a5a1-ec0b68e0a831"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_environments",
                      "$select": "admin_environmentid, admin_environmentsku, admin_environmentname, admin_environmentdeletedon",
                      "$filter": "admin_environmentdeleted eq false"
                    },
                    "authentication": "@parameters('$authentication')"
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_Inventory_-_Deleted_Envts": {
                  "actions": {
                    "Select_Inventory_-_Deleted_Envts": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "d9864193-358e-4194-9acd-28dab1de4882"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('CurrentEnvtInventory')?['body/value']",
                        "select": {
                          "EnvtName": "@item()?['admin_environmentname']"
                        }
                      }
                    },
                    "Parse_Inventory_-_Deleted_Envts": {
                      "runAfter": {
                        "Select_Inventory_-_Deleted_Envts": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "274daa1f-66a7-4bf4-be08-c3a0e2f758d7"
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Select_Inventory_-_Deleted_Envts')",
                        "schema": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "EnvtName": {
                                "type": "string"
                              }
                            },
                            "required": [
                              "EnvtName"
                            ]
                          }
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "CurrentEnvtInventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "61117d90-0e7a-40c6-8484-f0212a2b0cc4"
                  },
                  "type": "Scope"
                },
                "Get_Actual_-_Deleted_Envts": {
                  "actions": {
                    "Select_Actual_-_Deleted_Envts": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "8410edf3-be25-420e-9c3d-d5c2a4d8ef20"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('Get_Environments')?['body/value']",
                        "select": {
                          "EnvtName": "@item()?['name']"
                        }
                      }
                    },
                    "Parse_Actual_-_Deleted_Envts": {
                      "runAfter": {
                        "Select_Actual_-_Deleted_Envts": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "bb1cea14-82ae-4c5e-93a4-66f7d675861e"
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Select_Actual_-_Deleted_Envts')",
                        "schema": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "EnvtName": {
                                "type": "string"
                              }
                            },
                            "required": [
                              "EnvtName"
                            ]
                          }
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Inventory_-_Deleted_Envts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7343aee1-301c-4197-a13f-d3e6968adc8b"
                  },
                  "type": "Scope"
                },
                "DeletedEnvts": {
                  "runAfter": {
                    "Get_Actual_-_Deleted_Envts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "ec8ebf56-f3e3-4251-9491-440c69d207e4"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_Inventory_-_Deleted_Envts')",
                    "where": "@not(contains(body('Parse_Actual_-_Deleted_Envts'), item()))"
                  }
                },
                "Mark_deleted": {
                  "foreach": "@body('DeletedEnvts')",
                  "actions": {
                    "Find_it_for_GUID": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "e3e70db2-e0db-4ae1-84d3-c6ce5c58f6b2"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_3",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_environments",
                          "$select": "admin_environmentid",
                          "$filter": "admin_environmentname eq '@{items('Mark_deleted')?['EnvtName']}'"
                        },
                        "authentication": "@parameters('$authentication')",
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 20,
                          "interval": "PT20S"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "If_found_mark_deleted": {
                      "actions": {
                        "GUID_to_Delete": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "6018d853-c38a-49a0-88d4-df485285b7d8"
                          },
                          "type": "Compose",
                          "inputs": "@first(outputs('Find_it_for_GUID')?['body/value'])?['admin_environmentid']"
                        },
                        "Mark_record_deleted": {
                          "runAfter": {
                            "GUID_to_Delete": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e2f75959-76cd-4098-8c45-4cd839721198"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps_3",
                              "operationId": "UpdateRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_environments",
                              "recordId": "@outputs('GUID_to_Delete')",
                              "item/admin_environmentdeleted": true,
                              "item/admin_environmentdeletedon": "@utcNow()"
                            },
                            "authentication": "@parameters('$authentication')"
                          }
                        }
                      },
                      "runAfter": {
                        "Find_it_for_GUID": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "greater": [
                          "@length(outputs('Find_it_for_GUID')?['body/value'])",
                          0
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "5e4c45c8-c39c-4008-be30-46da7f5cc80f"
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {
                    "DeletedEnvts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "6db8b7e6-0fdd-4817-b396-693634e27477"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                }
              },
              "runAfter": {
                "Store_environments_in_the_CoE_CDS_Entity": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "23f2b89c-1cfd-428e-9c30-7820069d317e"
              },
              "type": "Scope"
            }
          },
          "runAfter": {
            "Initialize_systemMaker": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "842b4d24-6012-4729-929e-d2afacd3b04f"
          },
          "type": "Scope"
        }
      },
      "outputs": {}
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}