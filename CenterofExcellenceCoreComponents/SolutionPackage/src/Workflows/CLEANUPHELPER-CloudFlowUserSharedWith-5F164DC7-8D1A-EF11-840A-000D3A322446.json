{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse2"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdminsEnvRequest"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverseEnvRequest"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_office365groups": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Groups"
        },
        "api": {
          "name": "shared_office365groups"
        }
      },
      "shared_office365users_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Users"
        },
        "api": {
          "name": "shared_office365users"
        }
      },
      "shared_webcontents": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreHTTPWithAzureAD"
        },
        "api": {
          "name": "shared_webcontents"
        }
      },
      "shared_microsoftflowforadmins": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAutomateAdmin"
        },
        "api": {
          "name": "shared_microsoftflowforadmins"
        }
      },
      "shared_flowmanagement": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerAutomateManagement"
        },
        "api": {
          "name": "shared_flowmanagement"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "Graph URL Environment Variable (admin_GraphURLEnvironmentVariable)": {
          "defaultValue": "https://graph.microsoft.com/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_GraphURLEnvironmentVariable",
            "description": "Inventory - REQUIRED. The URL used to get graph information for your cloud. Ex https://graph.microsoft.com/"
          }
        },
        "CoE System User ID (admin_CoESystemUserID)": {
          "defaultValue": "6f018471-30d7-ef11-8ee9-000d3a328366",
          "type": "String",
          "metadata": {
            "schemaName": "admin_CoESystemUserID",
            "description": "in the maker table we store a user for system with an id. Storing here so that it can be referenced without having to look it up all the time."
          }
        }
      },
      "triggers": {
        "manual": {
          "metadata": {
            "operationMetadataId": "67710f6e-1529-45ee-bea1-e8c9691bab01"
          },
          "type": "Request",
          "kind": "Button",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "text": {
                  "title": "envtName",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                }
              },
              "required": [
                "text"
              ]
            }
          }
        }
      },
      "actions": {
        "Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_environmentname": "@outputs('EnvtDisplayName')",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            },
            "Terminate": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow_fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Respond_to_a_PowerApp_or_flow_fail": {
              "runAfter": {
                "not_in_metadata_yet_2": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "027932fc-fda8-479a-b590-799b0e00d7f4"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "returnvalue": "fail"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "returnvalue": {
                      "title": "returnValue",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            },
            "not_in_metadata_yet_2": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded",
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "65fa413d-dc83-45fe-b7b3-e96d32fad840"
              },
              "type": "Compose",
              "inputs": "not in metadata yet"
            }
          },
          "runAfter": {
            "Get_Power_Apps_User_Shared_With_Data": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Get_ID_Pass": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Respond_to_a_PowerApp_or_flow": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "b28449e1-bc60-41e2-b88f-3bc1962d6db4"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "returnvalue": "pass"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "returnvalue": {
                      "title": "returnValue",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            },
            "Catch_here": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch here"
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Get_Power_Apps_User_Shared_With_Data": {
          "actions": {
            "Recheck_envt_still_exists,_exit_if_not": {
              "actions": {
                "Get_Environment_as_Admin": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "43975f51-d8e5-4d7d-9648-0f5c8c032525"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_powerplatformforadmins",
                      "operationId": "GetSingleEnvironment",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins"
                    },
                    "parameters": {
                      "environment": "@triggerBody()['text']",
                      "api-version": "2018-10-01"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "Envt_Deleted_so_Exit": {
                  "actions": {
                    "Respond_to_a_PowerApp_or_flow_2": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "b28449e1-bc60-41e2-b88f-3bc1962d6db4"
                      },
                      "type": "Response",
                      "kind": "PowerApp",
                      "inputs": {
                        "statusCode": 200,
                        "body": {
                          "returnvalue": "pass"
                        },
                        "schema": {
                          "type": "object",
                          "properties": {
                            "returnvalue": {
                              "title": "returnValue",
                              "x-ms-dynamically-added": true,
                              "type": "string"
                            }
                          }
                        }
                      }
                    },
                    "Terminate_for_environments_recently_deleted": {
                      "runAfter": {
                        "Respond_to_a_PowerApp_or_flow_2": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c96f244b-3c1d-43b6-b930-9df94f180269"
                      },
                      "type": "Terminate",
                      "inputs": {
                        "runStatus": "Succeeded"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Environment_as_Admin": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c299c937-0303-4db4-93e9-900fcc68b0c4"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "92d470ee-d893-464b-8e9b-f1588f45626b"
              },
              "type": "Scope"
            },
            "Get_Envt_Names": {
              "actions": {
                "envtGUID": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "df954358-b63e-4486-97ab-c5767747ed56"
                  },
                  "type": "Compose",
                  "inputs": "@substring(triggerBody()['text'], sub(length(triggerBody()['text']), 36), 36)"
                },
                "Get_Envt_from_CoE_inventory": {
                  "runAfter": {
                    "envtGUID": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "113a32c5-e1c3-4a18-8128-ef22c91be344"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_1",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_environments",
                      "recordId": "@outputs('envtGUID')",
                      "$select": "admin_displayname, admin_environmentcdsinstanceurl"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "EnvtDisplayName": {
                  "runAfter": {
                    "Get_Envt_from_CoE_inventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "992adb7c-40b9-440c-b078-99617c2095d6"
                  },
                  "type": "Compose",
                  "inputs": "@outputs('Get_Envt_from_CoE_inventory')?['body/admin_displayname']"
                },
                "EnvtCDSURL": {
                  "runAfter": {
                    "EnvtDisplayName": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "992adb7c-40b9-440c-b078-99617c2095d6"
                  },
                  "type": "Compose",
                  "inputs": "@outputs('Get_Envt_from_CoE_inventory')?['body/admin_environmentcdsinstanceurl']"
                }
              },
              "runAfter": {
                "Recheck_envt_still_exists,_exit_if_not": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "2887cefe-51b3-431e-8893-10a77ba6b03d"
              },
              "type": "Scope"
            },
            "Walk_the_Flows_in_this_Envt": {
              "foreach": "@body('Filter_out_unpublished')",
              "actions": {
                "catch_not_yet_in_inventory": {
                  "runAfter": {
                    "Get_a_record": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "00575e45-924c-4269-a3c9-c56edc47619e"
                  },
                  "type": "Compose",
                  "inputs": "catch not yet in inventory"
                },
                "Update_Roles_Information": {
                  "actions": {
                    "Roles_exist": {
                      "actions": {
                        "Get_Counts_for_Flows": {
                          "actions": {
                            "Editor_count": {
                              "actions": {
                                "List_updated_role_list_for_this_flows_editors": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d8da4fe0-175f-4c91-864d-17b5cd73878f"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid, admin_rolename",
                                      "$filter": "_admin_environment_value eq @{outputs('envtGUID')} and _admin_flow_value eq @{items('Walk_the_Flows_in_this_Envt')?['name']} and admin_resourcetype eq 'Flow' and (admin_rolename eq 'CanEdit' or admin_rolename eq 'Owner')",
                                      "$expand": "admin_PowerPlatformUser($select=admin_grouphasguestusers, admin_userisguest, admin_groupsize, admin_type)"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Filter_to_Group_Editors": {
                                  "runAfter": {
                                    "List_updated_role_list_for_this_flows_editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "394e6dd9-fd0f-4aeb-a397-bcbc9c3c5c83"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_flows_editors')?['body/value']",
                                    "where": "@equals(item()?['admin_powerplatformuser/admin_type'], 'Group')"
                                  }
                                },
                                "Filter_to_Guests_Editors": {
                                  "runAfter": {
                                    "Filter_to_Group_Editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8ba06a41-6676-43fa-b981-e00bdc311580"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_flows_editors')?['body/value']",
                                    "where": "@or(equals(item()?['admin_powerplatformuser/admin_userisguest'], true), equals(item()?['admin_powerplatformuser/admin_grouphasguestusers'], true))"
                                  }
                                },
                                "Get_Total_User_Count_Editors": {
                                  "actions": {
                                    "Select_GroupSize_Editors": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "c9ffddbc-6fb8-4356-9302-1f06de5e7ada"
                                      },
                                      "type": "Select",
                                      "inputs": {
                                        "from": "@outputs('List_updated_role_list_for_this_flows_editors')?['body/value']",
                                        "select": "@item()?['admin_powerplatformuser/admin_groupsize']"
                                      }
                                    },
                                    "JSON_group_size_Editors": {
                                      "runAfter": {
                                        "Select_GroupSize_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ab8d6358-f73c-4acc-a9db-bcc6c1b134f3"
                                      },
                                      "type": "Compose",
                                      "inputs": {
                                        "root": {
                                          "Numbers": "@body('Select_GroupSize_Editors')"
                                        }
                                      }
                                    },
                                    "XML_group_size_Editors": {
                                      "runAfter": {
                                        "JSON_group_size_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "e99cf5d8-f7b3-451e-850c-73cd2a353812"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xml(outputs('JSON_group_size_Editors'))"
                                    },
                                    "Sum_total_users_Editors": {
                                      "runAfter": {
                                        "XML_group_size_Editors": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "09ee2e0b-25a0-43bf-ae74-992229d3cf33"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xpath(outputs('XML_group_size_Editors'), 'sum(/root/Numbers)')"
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_to_Guests_Editors": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "71e88d7f-60eb-44de-a811-a01cde34b19c"
                                  },
                                  "type": "Scope"
                                }
                              },
                              "runAfter": {
                                "Total_user_count": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a739c2f6-f207-4fbe-97d5-e133c390547b"
                              },
                              "type": "Scope"
                            },
                            "Total_user_count": {
                              "actions": {
                                "List_updated_role_list_for_this_flow": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d8da4fe0-175f-4c91-864d-17b5cd73878f"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid, admin_rolename",
                                      "$filter": "_admin_environment_value eq @{outputs('envtGUID')} and _admin_flow_value eq @{items('Walk_the_Flows_in_this_Envt')?['name']} and admin_resourcetype eq 'Flow'",
                                      "$expand": "admin_PowerPlatformUser($select=admin_grouphasguestusers, admin_userisguest, admin_groupsize, admin_type)"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Filter_to_Groups": {
                                  "runAfter": {
                                    "List_updated_role_list_for_this_flow": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "394e6dd9-fd0f-4aeb-a397-bcbc9c3c5c83"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_flow')?['body/value']",
                                    "where": "@equals(item()?['admin_powerplatformuser/admin_type'], 'Group')"
                                  }
                                },
                                "Filter_to_Guests": {
                                  "runAfter": {
                                    "Filter_to_Groups": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8ba06a41-6676-43fa-b981-e00bdc311580"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_flow')?['body/value']",
                                    "where": "@or(equals(item()?['admin_powerplatformuser/admin_userisguest'], true), equals(item()?['admin_powerplatformuser/admin_grouphasguestusers'], true))"
                                  }
                                },
                                "Get_Total_User_Count": {
                                  "actions": {
                                    "Select_GroupSize": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "c9ffddbc-6fb8-4356-9302-1f06de5e7ada"
                                      },
                                      "type": "Select",
                                      "inputs": {
                                        "from": "@outputs('List_updated_role_list_for_this_flow')?['body/value']",
                                        "select": "@item()?['admin_powerplatformuser/admin_groupsize']"
                                      }
                                    },
                                    "JSON_group_size": {
                                      "runAfter": {
                                        "Select_GroupSize": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ab8d6358-f73c-4acc-a9db-bcc6c1b134f3"
                                      },
                                      "type": "Compose",
                                      "inputs": {
                                        "root": {
                                          "Numbers": "@body('Select_GroupSize')"
                                        }
                                      }
                                    },
                                    "XML_group_size": {
                                      "runAfter": {
                                        "JSON_group_size": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "e99cf5d8-f7b3-451e-850c-73cd2a353812"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xml(outputs('JSON_group_size'))"
                                    },
                                    "Sum_total_users": {
                                      "runAfter": {
                                        "XML_group_size": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "09ee2e0b-25a0-43bf-ae74-992229d3cf33"
                                      },
                                      "type": "Compose",
                                      "inputs": "@xpath(outputs('XML_group_size'), 'sum(/root/Numbers)')"
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_to_Guests": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "71e88d7f-60eb-44de-a811-a01cde34b19c"
                                  },
                                  "type": "Scope"
                                }
                              },
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "303387fe-a50c-4bae-9023-2e1fd786acb0"
                              },
                              "type": "Scope"
                            },
                            "If_need_to_update_owner": {
                              "actions": {
                                "Update_flow_sharing_counts_and_owner": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "bfe93d5c-dd66-480d-922a-a76b49db9ad0"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "UpdateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_flows",
                                      "recordId": "@items('Walk_the_Flows_in_this_Envt')?['name']",
                                      "item/admin_flowsharededitors": "@outputs('Sum_total_users_Editors')",
                                      "item/admin_flowsharedgroups": "@length(body('Filter_to_Groups'))",
                                      "item/admin_flowsharedguesteditor": "@if(equals(length(body('Filter_to_Guests_Editors')), 0), false, true)",
                                      "item/admin_flowsharedguestowner": "@if(equals(length(body('Filter_to_Guests_Owner')), 0), false, true)",
                                      "item/admin_flowsharedguestuser": "@if(equals(length(body('Filter_to_Guests')), 0), false, true)",
                                      "item/admin_flowsharedusers": "@outputs('Sum_total_users')",
                                      "item/admin_inventoryme": true
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Owner_info": [
                                  "Succeeded"
                                ]
                              },
                              "else": {
                                "actions": {
                                  "Update_flow_sharing_counts": {
                                    "runAfter": {},
                                    "metadata": {
                                      "operationMetadataId": "bfe93d5c-dd66-480d-922a-a76b49db9ad0"
                                    },
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "host": {
                                        "connectionName": "shared_commondataserviceforapps_2",
                                        "operationId": "UpdateRecord",
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                      },
                                      "parameters": {
                                        "entityName": "admin_flows",
                                        "recordId": "@items('Walk_the_Flows_in_this_Envt')?['name']",
                                        "item/admin_flowsharededitors": "@outputs('Sum_total_users_Editors')",
                                        "item/admin_flowsharedgroups": "@length(body('Filter_to_Groups'))",
                                        "item/admin_flowsharedguesteditor": "@if(equals(length(body('Filter_to_Guests_Editors')), 0), false, true)",
                                        "item/admin_flowsharedguestowner": "@if(equals(length(body('Filter_to_Guests_Owner')), 0), false, true)",
                                        "item/admin_flowsharedguestuser": "@if(equals(length(body('Filter_to_Guests')), 0), false, true)",
                                        "item/admin_flowsharedusers": "@outputs('Sum_total_users')"
                                      },
                                      "authentication": {
                                        "type": "Raw",
                                        "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                      }
                                    }
                                  }
                                }
                              },
                              "expression": {
                                "equals": [
                                  "@outputs('Ownership_Changed_from_Inventory')",
                                  "@true"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "96e03daf-71e7-499e-9d2d-b69f46da32fb"
                              },
                              "type": "If"
                            },
                            "Owner_info": {
                              "actions": {
                                "List_updated_role_list_for_this_flows_owner": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d8da4fe0-175f-4c91-864d-17b5cd73878f"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid, admin_rolename",
                                      "$filter": "_admin_environment_value eq @{outputs('envtGUID')} and _admin_flow_value eq @{items('Walk_the_Flows_in_this_Envt')?['name']} and admin_resourcetype eq 'Flow' and admin_rolename eq 'Owner'",
                                      "$expand": "admin_PowerPlatformUser($select=admin_grouphasguestusers, admin_userisguest, admin_groupsize, admin_type)"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Filter_to_Guests_Owner": {
                                  "runAfter": {
                                    "List_updated_role_list_for_this_flows_owner": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8ba06a41-6676-43fa-b981-e00bdc311580"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_updated_role_list_for_this_flows_owner')?['body/value']",
                                    "where": "@equals(item()?['admin_powerplatformuser/admin_userisguest'], true)"
                                  }
                                }
                              },
                              "runAfter": {
                                "Editor_count": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a739c2f6-f207-4fbe-97d5-e133c390547b"
                              },
                              "type": "Scope"
                            }
                          },
                          "runAfter": {
                            "Ensure_all_other_User_Roles_exist": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "2594d35b-d45b-49ed-85c8-b032b2ba334b"
                          },
                          "type": "Scope"
                        },
                        "Ensure_all_other_User_Roles_exist": {
                          "actions": {
                            "Apply_to_each_role_to_delete": {
                              "foreach": "@body('Find_removed_roles_to_delete')",
                              "actions": {
                                "Find_it_to_delete": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "99057e07-7f9c-4c67-9df7-05e9d392e766"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "ListRecords",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "$select": "admin_powerplatformuserroleid",
                                      "$filter": "admin_resourceuserlink eq '@{items('Apply_to_each_role_to_delete')?['theUniqueName']}' and admin_rolename eq '@{items('Apply_to_each_role_to_delete')?['theRole']}'"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                },
                                "Delete_the_role": {
                                  "runAfter": {
                                    "Find_it_to_delete": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "97bdb1a0-4cd3-462b-8b1b-8bdff9875310"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "DeleteRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "recordId": "@first(outputs('Find_it_to_delete')?['body/value'])?['admin_powerplatformuserroleid']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Find_removed_roles_to_delete": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "92c5fd92-2225-48d0-8c54-d8b9cd4c937d"
                              },
                              "type": "Foreach"
                            },
                            "Find_removed_roles_to_delete": {
                              "runAfter": {
                                "Apply_to_each_role_to_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "872d6342-a74e-4e76-90c3-aa31d517a857"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_inventoried_roles')",
                                "where": "@not(contains(body('Select_actual_roles'), item()))"
                              }
                            },
                            "Apply_to_each_role_to_add": {
                              "foreach": "@body('Find_new_roles_to_add')",
                              "actions": {
                                "Add_a_new_role": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "81271791-9e2d-4e56-9484-cf74bb03e077"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "CreateRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "item/admin_name": "@items('Apply_to_each_role_to_add')?['theUniqueName']",
                                      "item/admin_Environment@odata.bind": "admin_environments(@{outputs('envtGUID')})",
                                      "item/admin_Flow@odata.bind": "admin_flows(@{outputs('Get_a_record')?['body/admin_flowid']})",
                                      "item/admin_PowerPlatformUser@odata.bind": "admin_powerplatformusers(@{items('Apply_to_each_role_to_add')?['theUserID']})",
                                      "item/admin_resourcetype": "Flow",
                                      "item/admin_resourceuserlink": "@items('Apply_to_each_role_to_add')?['theUniqueName']",
                                      "item/admin_rolename": "@items('Apply_to_each_role_to_add')?['theRole']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Find_new_roles_to_add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "020de533-932e-4c58-a689-0bf757c16e3f"
                              },
                              "type": "Foreach"
                            },
                            "Find_new_roles_to_add": {
                              "runAfter": {
                                "Select_actual_roles": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "436d44e0-ac8f-42e5-a99f-ea219c37f79a"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Select_actual_roles')",
                                "where": "@not(contains(body('Select_inventoried_roles'), item()))"
                              }
                            },
                            "Select_actual_roles": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "d64e772a-96a0-460d-8854-2ee1ccdfa6f5"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Non_Null_Full_Permissions')",
                                "select": {
                                  "theUniqueName": "@concat(item()?['name'], items('Walk_the_Flows_in_this_Envt')?['name'])",
                                  "theRole": "@item()?['properties/roleName']",
                                  "theUserID": "@item()?['properties']?['principal']?['id']"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Ensure_all_Users_exist": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "ac0cb6d4-b1d9-45e4-8858-c9f8bc8679a7"
                          },
                          "type": "Scope"
                        },
                        "Ensure_all_Users_exist": {
                          "actions": {
                            "Apply_to_each_New_User_to_Add": {
                              "foreach": "@body('New_Users_to_Add')",
                              "actions": {
                                "Switch_on_new_user_to_add_type": {
                                  "runAfter": {},
                                  "cases": {
                                    "Group": {
                                      "case": "Group",
                                      "actions": {
                                        "Upsert_Group_as_Orphan": {
                                          "runAfter": {
                                            "Get_new_group_information": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "ee2d4654-6ffe-4e13-987b-8b0d19b043f8"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 0,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Enter_Group_Info": {
                                          "actions": {
                                            "Upsert_New_Group": {
                                              "runAfter": {
                                                "flat_group_has_guests": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "1e0eeb5d-e025-43e1-9b68-bd2da6e10e36"
                                              },
                                              "type": "OpenApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connectionName": "shared_commondataserviceforapps_2",
                                                  "operationId": "UpdateRecord",
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                                },
                                                "parameters": {
                                                  "entityName": "admin_powerplatformusers",
                                                  "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                                  "item/admin_displayname": "@outputs('new_group_name')",
                                                  "item/admin_groupsize": "@outputs('flat_group_size')",
                                                  "item/admin_grouphasguestusers": "@outputs('flat_group_has_guests')",
                                                  "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                                  "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                                  "item/admin_userisorphaned": false,
                                                  "item/admin_userisguest": false
                                                },
                                                "authentication": {
                                                  "type": "Raw",
                                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                                }
                                              }
                                            },
                                            "flat_group_has_guests": {
                                              "runAfter": {
                                                "flat_group_size": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "42e58d09-24a2-4cfc-bffe-fc5687e9ca31"
                                              },
                                              "type": "Compose",
                                              "inputs": "@false",
                                              "description": "Cannot determine for flat so default to false"
                                            },
                                            "new_group_name": {
                                              "runAfter": {},
                                              "metadata": {
                                                "operationMetadataId": "c4edf1af-7fe0-43d6-84ea-7daa6471e63d"
                                              },
                                              "type": "Compose",
                                              "inputs": "@coalesce(first(outputs('Get_Group_for_Name')?['body/value'])?['displayName'], '')"
                                            },
                                            "flat_group_size": {
                                              "runAfter": {
                                                "new_group_name": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "abbc29f3-0a2b-4538-994b-7871affb9dee"
                                              },
                                              "type": "Compose",
                                              "inputs": "@length(outputs('List_group_members')?['body/value'])"
                                            }
                                          },
                                          "runAfter": {
                                            "Upsert_Group_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "9f98715f-4fb0-4d7c-bf5c-e87b9b69b4da"
                                          },
                                          "type": "Scope"
                                        },
                                        "Get_new_group_information": {
                                          "actions": {
                                            "Get_Group_for_Name": {
                                              "runAfter": {},
                                              "metadata": {
                                                "operationMetadataId": "c8811b52-8865-4d95-8e26-3aca9d23fca1"
                                              },
                                              "type": "OpenApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connectionName": "shared_office365groups",
                                                  "operationId": "ListGroups",
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                                                },
                                                "parameters": {
                                                  "$filter": "id eq '@{items('Apply_to_each_new_User_to_Add')?['UserID']}'"
                                                },
                                                "authentication": {
                                                  "type": "Raw",
                                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                                }
                                              }
                                            },
                                            "List_group_members": {
                                              "runAfter": {
                                                "Get_Group_for_Name": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "metadata": {
                                                "operationMetadataId": "0cc26fb1-15d1-4e9f-891d-42462fbf7171"
                                              },
                                              "type": "OpenApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connectionName": "shared_office365groups",
                                                  "operationId": "ListGroupMembers",
                                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                                                },
                                                "parameters": {
                                                  "groupId": "@items('Apply_to_each_new_User_to_Add')?['UserID']"
                                                },
                                                "authentication": {
                                                  "type": "Raw",
                                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                                }
                                              },
                                              "runtimeConfiguration": {
                                                "paginationPolicy": {
                                                  "minimumItemCount": 100000
                                                }
                                              }
                                            }
                                          },
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "6f218b71-c2dd-467c-beda-a17134306edb"
                                          },
                                          "type": "Scope"
                                        }
                                      }
                                    },
                                    "User": {
                                      "case": "User",
                                      "actions": {
                                        "Get_user_profile_(V2)": {
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "2b525fc7-14f9-4419-ae3d-4267eccb6f94"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_office365users_1",
                                              "operationId": "UserProfile_V2",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users"
                                            },
                                            "parameters": {
                                              "id": "@items('Apply_to_each_new_User_to_Add')?['UserID']"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_User_as_Orphan": {
                                          "runAfter": {
                                            "Get_user_profile_(V2)": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "41019a1d-e102-4460-9d75-ecc1f93709b7"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "Unknown",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": "@if(equals(outputs('Get_user_profile_(V2)')?['body/userType'], 'Guest'), true, false)"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_New_User": {
                                          "runAfter": {
                                            "Upsert_User_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "7110afbe-a6d1-48c5-8679-1e060eaf0c02"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@outputs('Get_user_profile_(V2)')?['body/displayName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": false,
                                              "item/admin_userisguest": "@if(equals(outputs('Get_user_profile_(V2)')?['body/userType'], 'Guest'), true, false)"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "ServicePrincipal": {
                                      "case": "ServicePrincipal",
                                      "actions": {
                                        "Look_up_in_AD_for_Service_Principle": {
                                          "runAfter": {},
                                          "metadata": {
                                            "operationMetadataId": "aa370c3e-42f1-4f16-8144-dfc42fc9e94b"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_webcontents",
                                              "operationId": "InvokeHttp",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                                            },
                                            "parameters": {
                                              "request/method": "GET",
                                              "request/url": "@{parameters('Graph URL Environment Variable (admin_GraphURLEnvironmentVariable)')}v1.0/servicePrincipals?$filter=Id eq '@{items('Apply_to_each_new_User_to_Add')?['UserID']}'"
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_Service_Principle_as_Orphan": {
                                          "runAfter": {
                                            "Look_up_in_AD_for_Service_Principle": [
                                              "Failed"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "02933be4-f388-41ef-ae86-1157070b0445"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": true,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        },
                                        "Upsert_New_Service_Principle": {
                                          "runAfter": {
                                            "Upsert_Service_Principle_as_Orphan": [
                                              "Skipped"
                                            ]
                                          },
                                          "metadata": {
                                            "operationMetadataId": "c63e07bc-ac39-4ee2-ad72-6983e015853a"
                                          },
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "host": {
                                              "connectionName": "shared_commondataserviceforapps_2",
                                              "operationId": "UpdateRecord",
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                            },
                                            "parameters": {
                                              "entityName": "admin_powerplatformusers",
                                              "recordId": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_displayname": "@items('Apply_to_each_new_User_to_Add')?['UserName']",
                                              "item/admin_groupsize": 1,
                                              "item/admin_grouphasguestusers": false,
                                              "item/admin_recordguidasstring": "@items('Apply_to_each_new_User_to_Add')?['UserID']",
                                              "item/admin_type": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                              "item/admin_userisorphaned": false,
                                              "item/admin_userisguest": false
                                            },
                                            "authentication": {
                                              "type": "Raw",
                                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "default": {
                                    "actions": {}
                                  },
                                  "expression": "@items('Apply_to_each_new_User_to_Add')?['UserType']",
                                  "metadata": {
                                    "operationMetadataId": "0ead0260-3cc4-40cc-b558-5679ab739a40"
                                  },
                                  "type": "Switch"
                                }
                              },
                              "runAfter": {
                                "New_Users_to_Add": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "02e8cffb-7cf4-4e39-8a2f-2d7a7bfc5194"
                              },
                              "type": "Foreach"
                            },
                            "Actual_Users": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "9609b370-feaf-45b2-95ab-4dc349f9286d"
                              },
                              "type": "Select",
                              "inputs": {
                                "from": "@body('Non_Null_Full_Permissions')",
                                "select": {
                                  "UserID": "@item()?['properties/principal/id']",
                                  "UserType": "@item()?['properties/principal/type']"
                                }
                              }
                            },
                            "New_Users_to_Add": {
                              "runAfter": {
                                "Actual_Users": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "b87104d1-5371-4ae2-b545-29b1a3234e7f"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Actual_Users')",
                                "where": "@not(contains(body('Inventory_Users'), item()))"
                              }
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "068933ab-510e-4721-85d8-771a160ad9ea"
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "No_Roles_Exist": [
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "80300340-f77d-4a01-b41a-8628662b70c7"
                      },
                      "type": "Scope"
                    },
                    "No_Roles_Exist": {
                      "actions": {
                        "Delete_all_the_roles": {
                          "actions": {
                            "List_all_roles_for_this_flow": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "803b216b-5cc9-46cb-9581-e74a87d33622"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps_2",
                                  "operationId": "ListRecords",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "entityName": "admin_powerplatformuserroles",
                                  "$select": "admin_powerplatformuserroleid",
                                  "$filter": "_admin_flow_value eq @{outputs('Get_a_record')?['body/admin_flowid']}"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                }
                              }
                            },
                            "Delete_all_roles_for_this_flow": {
                              "foreach": "@outputs('List_all_roles_for_this_flow')?['body/value']",
                              "actions": {
                                "Delete_roles_for_this_flow": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "d35d7848-fc94-4f5d-8e5e-9ffd5806f951"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_commondataserviceforapps_2",
                                      "operationId": "DeleteRecord",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                    },
                                    "parameters": {
                                      "entityName": "admin_powerplatformuserroles",
                                      "recordId": "@items('Delete_all_roles_for_this_flow')?['admin_powerplatformuserroleid']"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "List_all_roles_for_this_flow": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "94d46914-6e97-4304-b850-612d16305085"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "af844ad1-6b90-4f3e-9fbb-06ae21b7b48b"
                          },
                          "type": "Scope"
                        },
                        "Update_flow_sharing_counts_to_zero": {
                          "runAfter": {
                            "Delete_all_the_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "b720205d-cc96-4aad-9fa8-557edc18f1f9"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps_2",
                              "operationId": "UpdateRecord",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_flows",
                              "recordId": "@items('Walk_the_Flows_in_this_Envt')?['name']",
                              "item/admin_flowsharededitors": 0,
                              "item/admin_flowsharedgroups": 0,
                              "item/admin_flowsharedguesteditor": false,
                              "item/admin_flowsharedguestuser": false,
                              "item/admin_flowsharedusers": 0
                            },
                            "authentication": {
                              "type": "Raw",
                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Get_Flow_Shared_With_Actual": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c566aade-4cf9-483c-bbba-ab29d5ce7d88"
                      },
                      "type": "Scope"
                    },
                    "Get_Inventoried_Roles": {
                      "actions": {
                        "List_inventoried_roles": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "9331c727-0014-45cb-a9f8-4aa0e2ba9393"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_commondataserviceforapps_2",
                              "operationId": "ListRecords",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                            },
                            "parameters": {
                              "entityName": "admin_powerplatformuserroles",
                              "$select": "admin_powerplatformuserroleid, admin_name, admin_rolename, _admin_powerplatformuser_value",
                              "$filter": "_admin_environment_value eq @{outputs('envtGUID')} and _admin_flow_value eq @{items('Walk_the_Flows_in_this_Envt')?['name']} and admin_resourcetype eq 'Flow'"
                            },
                            "authentication": {
                              "type": "Raw",
                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                            }
                          }
                        },
                        "Select_inventoried_roles": {
                          "runAfter": {
                            "List_inventoried_roles": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "adbd1989-bd4b-494e-abe8-d18201be3edb"
                          },
                          "type": "Select",
                          "inputs": {
                            "from": "@outputs('List_inventoried_roles')?['body/value']",
                            "select": {
                              "theUniqueName": "@item()?['admin_name']",
                              "theRole": "@item()?['admin_rolename']",
                              "theUserID": "@item()?['_admin_powerplatformuser_value']"
                            }
                          }
                        }
                      },
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "1d1528a4-16a5-4b72-85ec-d3c2f8ec19e9"
                      },
                      "type": "Scope"
                    },
                    "Get_Flow_Shared_With_Actual": {
                      "actions": {
                        "Full_Permissions": {
                          "runAfter": {
                            "Owner_Object": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "522bcde7-273f-4e28-bd61-d9520b36bf91"
                          },
                          "type": "Compose",
                          "inputs": "@union(outputs('Owner_Object'), body('Filter_to_not_owner'))"
                        },
                        "Owner_Object": {
                          "runAfter": {
                            "Primary_Owner_Type": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "d778619c-4791-4601-bc0f-9685506cce49"
                          },
                          "type": "Compose",
                          "inputs": [
                            {
                              "name": "@outputs('Primary_Owner')",
                              "properties": {
                                "roleName": "Owner",
                                "permissionType": "Principal",
                                "principal": {
                                  "id": "@outputs('Primary_Owner')",
                                  "type": "@outputs('Primary_Owner_Type')"
                                }
                              }
                            }
                          ]
                        },
                        "Primary_Owner": {
                          "runAfter": {
                            "if_no_owner_listed": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "de15b033-5075-418d-ab3d-aa44833f69ea"
                          },
                          "type": "Compose",
                          "inputs": "@if(equals(length(body('Filter_to_owner')), 0), if(equals(outputs('Get_owner_from_System_User')?['body/fullname'], 'SYSTEM'), parameters('CoE System User ID (admin_CoESystemUserID)'), outputs('Get_owner_from_System_User')?['body/azureactivedirectoryobjectid']), first(body('Filter_to_owner'))?['properties/principal/id'])"
                        },
                        "if_no_owner_listed": {
                          "actions": {
                            "Get_owner_from_System_User": {
                              "runAfter": {
                                "Get_actual_object_for_owner": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "1de3b3af-dc33-4ef8-847d-38b190ce47c3"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "GetItemWithOrganization",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "organization": "@outputs('EnvtCDSURL')",
                                  "entityName": "systemusers",
                                  "recordId": "@first(outputs('Get_actual_object_for_owner')?['body/value'])?['_ownerid_value']",
                                  "$select": "azureactivedirectoryobjectid, fullname"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                }
                              }
                            },
                            "Get_actual_object_for_owner": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "1e286c1e-5347-402c-8623-7c25932d5020"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_commondataserviceforapps",
                                  "operationId": "ListRecordsWithOrganization",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                },
                                "parameters": {
                                  "organization": "@outputs('EnvtCDSURL')",
                                  "entityName": "workflows",
                                  "$select": "_ownerid_value, name",
                                  "$filter": "name eq '@{outputs('Get_a_record')?['body/admin_displayname']}'"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                }
                              },
                              "runtimeConfiguration": {
                                "paginationPolicy": {
                                  "minimumItemCount": 100000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_to_not_owner": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "equals": [
                              "@length(body('Filter_to_owner'))",
                              0
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "fb2f2c61-9ece-4442-8051-9591030745b5"
                          },
                          "type": "If"
                        },
                        "Filter_to_not_owner": {
                          "runAfter": {
                            "Filter_to_owner": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "abb7ea0d-1a16-4aab-b05a-5e48e900824e"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Filter_to_permissionType_Principal')",
                            "where": "@not(equals(item()?['properties/roleName'], 'Owner'))"
                          }
                        },
                        "Filter_to_owner": {
                          "runAfter": {
                            "Filter_to_permissionType_Principal": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "abb7ea0d-1a16-4aab-b05a-5e48e900824e"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Filter_to_permissionType_Principal')",
                            "where": "@equals(item()?['properties/roleName'], 'Owner')"
                          }
                        },
                        "Get_Flow_Owner_Role_as_Admin": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "4b99055f-1400-48e6-b4fa-36f65b8183c7"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "host": {
                              "connectionName": "shared_microsoftflowforadmins",
                              "operationId": "Get-AdminFlowOwnerRole",
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_microsoftflowforadmins"
                            },
                            "parameters": {
                              "environment": "@triggerBody()['text']",
                              "flow": "@items('Walk_the_Flows_in_this_Envt')?['name']",
                              "api-version": "2016-11-01"
                            },
                            "authentication": {
                              "type": "Raw",
                              "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                            }
                          }
                        },
                        "Ownership_Changed_from_Inventory": {
                          "runAfter": {
                            "Non_Null_Full_Permissions": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e6e01022-2b04-42bd-8aaa-0065ac8a819a"
                          },
                          "type": "Compose",
                          "inputs": "@if(equals(outputs('Get_a_record')?['body/admin_issolutionflow'], false), false, if(equals(outputs('Get_a_record')?['body/_admin_derivedowner_value'], outputs('Primary_Owner')), false, true))"
                        },
                        "Primary_Owner_Type": {
                          "runAfter": {
                            "Primary_Owner": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "de15b033-5075-418d-ab3d-aa44833f69ea"
                          },
                          "type": "Compose",
                          "inputs": "@if(equals(length(body('Filter_to_owner')), 0), if(equals(outputs('Get_owner_from_System_User')?['body/fullname'], 'SYSTEM'), 'SYSTEM', 'ServicePrincipal'), first(body('Filter_to_owner'))?['properties/principal/type'])"
                        },
                        "Filter_to_permissionType_Principal": {
                          "runAfter": {
                            "Get_Flow_Owner_Role_as_Admin": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "52a4c459-f4f0-4c24-a846-d8b2fb200d68"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('Get_Flow_Owner_Role_as_Admin')?['body/value']",
                            "where": "@equals(item()?['properties/permissionType'], 'Principal')"
                          }
                        },
                        "Non_Null_Full_Permissions": {
                          "runAfter": {
                            "Full_Permissions": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "014840ee-1d29-48ce-99be-8832d58b2882"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('Full_Permissions')",
                            "where": "@not(equals(item()?['name'], null))"
                          }
                        }
                      },
                      "runAfter": {
                        "Get_Inventoried_Roles": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "b7e9daca-419d-4e4f-8639-dc229e5c2c39"
                      },
                      "type": "Scope"
                    }
                  },
                  "runAfter": {
                    "catch_not_yet_in_inventory": [
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3b1d2a5a-d9d5-4129-80f4-c8a20a342cef"
                  },
                  "type": "Scope"
                },
                "Get_a_record": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "58a1b4b1-9ea6-44af-a087-de9645d26eff"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_flows",
                      "recordId": "@items('Walk_the_Flows_in_this_Envt')?['name']",
                      "$expand": "admin_DerivedOwner($select=admin_displayname)"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                }
              },
              "runAfter": {
                "Filter_out_unpublished": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e2239ac-f88e-4e82-a925-a3650d07fe9c"
              },
              "type": "Foreach",
              "runtimeConfiguration": {
                "concurrency": {
                  "repetitions": 50
                }
              }
            },
            "Get_User_Types": {
              "actions": {
                "Get_Groups": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_grouphasguestusers",
                      "$filter": "admin_type eq 'Group'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_Users": {
                  "runAfter": {
                    "Get_Groups": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest",
                      "$filter": "admin_type eq 'User'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_ServicePrincipals": {
                  "runAfter": {
                    "Get_Users": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest",
                      "$filter": "admin_type eq 'ServicePrincipal'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Get_Non_Tenant_Users": {
                  "runAfter": {
                    "Get_ServicePrincipals": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "90b2ba83-c24a-4ece-9a1d-30aabe4b1d38"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_powerplatformusers",
                      "$select": "admin_powerplatformuserid, admin_groupsize, admin_userisguest, admin_type, admin_displayname",
                      "$filter": "admin_type ne 'Tenant'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Inventory_Users": {
                  "runAfter": {
                    "Get_Non_Tenant_Users": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "19df4b28-605b-4c15-8ca9-a960522f5ea2"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@outputs('Get_Non_Tenant_Users')?['body/value']",
                    "select": {
                      "UserID": "@item()?['admin_powerplatformuserid']",
                      "UserType": "@item()?['admin_type']"
                    }
                  }
                }
              },
              "runAfter": {
                "Get_Envt_Names": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "063f3dc4-8137-4fd4-ba15-efb4c5938012"
              },
              "type": "Scope"
            },
            "List_Flows_as_Admin_(V2)": {
              "runAfter": {
                "Get_User_Types": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "df11a6ad-6630-408c-9a9b-7861df5a671d"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_flowmanagement",
                  "operationId": "ListFlowsInEnvironment_V2",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_flowmanagement"
                },
                "parameters": {
                  "environmentName": "@triggerBody()['text']"
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            },
            "Filter_out_unpublished": {
              "runAfter": {
                "List_Flows_as_Admin_(V2)": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "b7994244-2471-4a3f-aad3-df8726065f11"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Flows_as_Admin_(V2)')?['body/value']",
                "where": "@not(equals(equals(item()?['name'], item()?['properties/workflowUniqueId']), true))"
              }
            }
          },
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "866325b8-169b-4d4f-83f9-45e4f7cf1ce7"
          },
          "type": "Scope"
        }
      },
      "outputs": {}
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}