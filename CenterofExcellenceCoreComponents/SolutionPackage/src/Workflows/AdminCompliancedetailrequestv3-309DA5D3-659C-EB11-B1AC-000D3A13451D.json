{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps_1": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "runtimeSource": "embedded"
      },
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Compliance – Apps – Number Launches Last 30 Days (admin_ComplianceAppsNumberLaunchesLast30Days)": {
          "defaultValue": 30,
          "type": "Int",
          "metadata": {
            "schemaName": "admin_ComplianceAppsNumberLaunchesLast30Days",
            "description": "Compliance – If the app was launched at least this many times in the last 30, ask for business justification. Default 30."
          }
        },
        "Compliance – Apps - Number Users Shared (admin_ComplianceAppsNumberUsersShared)": {
          "defaultValue": 20,
          "type": "Int",
          "metadata": {
            "schemaName": "admin_ComplianceAppsNumberUsersShared",
            "description": "Compliance – If the app is shared with this many or more users, ask for business justification. Default 20"
          }
        },
        "Compliance – Apps – Number Groups Shared (admin_ComplianceAppsNumberGroupsShared)": {
          "defaultValue": 1,
          "type": "Int",
          "metadata": {
            "schemaName": "admin_ComplianceAppsNumberGroupsShared",
            "description": "Compliance – If the app is shared with this many or more groups, ask for business justification. Default 1"
          }
        },
        "Compliance – Chatbots – Number Launches (admin_ComplianceChatbotsNumberLaunches)": {
          "defaultValue": 50,
          "type": "Int",
          "metadata": {
            "schemaName": "admin_ComplianceChatbotsNumberLaunches",
            "description": "Compliance – If the chatbot is launched this many or more times, ask for business justification. Default 50"
          }
        },
        "Compliance – Apps – Number Days Since Published (admin_ComplianceAppsNumberDaysSincePublished)": {
          "defaultValue": 60,
          "type": "Int",
          "metadata": {
            "schemaName": "admin_ComplianceAppsNumberDaysSincePublished",
            "description": "Compliance – If an app is broadly shared and was last published this many days ago or older, then they are asked to publish to stay compliant. Default 60"
          }
        },
        "Developer Compliance Center URL (admin_DeveloperComplianceCenterURL)": {
          "defaultValue": "https://peddacattoolsdev.crm.dynamics.com/main.aspx?appid=c711a5f8-8c10-432f-af65-96d4ee63a306",
          "type": "String",
          "metadata": {
            "schemaName": "admin_DeveloperComplianceCenterURL",
            "description": "Compliance – LEAVE EMPTY ON IMPORT.  URL to Developer Compliance Center Canvas App. "
          }
        },
        "ProductionEnvironment (admin_ProductionEnvironment)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_ProductionEnvironment",
            "description": "Inventory - Yes by default. Set to No if you are creating a dev type envt. This will allow some flows to set target users to the admin instead of resource owners"
          }
        },
        "Admin eMail (admin_AdminMail)": {
          "defaultValue": "hannescoeadmins@powercattools.onmicrosoft.com",
          "type": "String",
          "metadata": {
            "schemaName": "admin_AdminMail",
            "description": "Inventory - CoE Admin eMail. Email address used in flows to send notifications to admins; this should be either your email address or a distribution list"
          }
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        }
      },
      "triggers": {
        "Recurrence": {
          "type": "Recurrence",
          "recurrence": {
            "frequency": "Week",
            "interval": 1,
            "schedule": {
              "weekDays": [
                "Monday"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "de85ebb2-658b-4d06-9a9f-27d4f8f899a5"
          }
        }
      },
      "actions": {
        "Initialize_varAssignee": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "varAssignee",
                "type": "string"
              }
            ]
          },
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "be05b098-9f03-4b1b-b8c7-a25a00631dc3"
          }
        },
        "Initialize_NumberUsersShared": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "NumberUsersShared",
                "type": "integer",
                "value": "@parameters('Compliance – Apps - Number Users Shared (admin_ComplianceAppsNumberUsersShared)')"
              }
            ]
          },
          "runAfter": {
            "Initialize_varAssignee": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "33d288a8-ceaf-4eb5-9191-1ae4300a1804"
          }
        },
        "Initialize_NumberGroupsShared": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "NumberGroupsShared",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Groups Shared (admin_ComplianceAppsNumberGroupsShared)')"
              }
            ]
          },
          "runAfter": {
            "Initialize_NumberUsersShared": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "12ef889e-4143-4c8a-90ef-d187f9dc5706"
          }
        },
        "Initialize_NumberChatbotLaunches": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "NumberChatbotLaunches",
                "type": "integer",
                "value": "@parameters('Compliance – Chatbots – Number Launches (admin_ComplianceChatbotsNumberLaunches)')"
              }
            ]
          },
          "runAfter": {
            "Initialize_NumberLaunchesLast30Days": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "521c896e-c64e-431b-a990-a47b3d2f9f7f"
          }
        },
        "Initialize_NumberDaysSincePublished": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "NumberDaysSincePublished",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Days Since Published (admin_ComplianceAppsNumberDaysSincePublished)')"
              }
            ]
          },
          "runAfter": {
            "Initialize_NumberGroupsShared": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "de1e511b-2c30-45d4-97ed-4a1ee3168be7"
          }
        },
        "Initialize_NumberLaunchesLast30Days": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "NumberLaunchesLast30Days",
                "type": "integer",
                "value": "@parameters('Compliance – Apps – Number Launches Last 30 Days (admin_ComplianceAppsNumberLaunchesLast30Days)')"
              }
            ]
          },
          "runAfter": {
            "Initialize_NumberDaysSincePublished": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "08497d29-29f7-421f-b0c0-59501a16a08f"
          }
        },
        "Compliance_due_to_heavy_usage": {
          "type": "Scope",
          "actions": {
            "List_Environments_not_excused_from_compliance": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_environments",
                  "$select": "admin_environmentsku, admin_environmentname, admin_environmentid",
                  "$filter": "admin_excusefromcomplianceflow ne true and admin_environmentdeleted\nne true"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps_1"
                }
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              },
              "metadata": {
                "operationMetadataId": "179da2b0-82c9-4c17-9470-738cc219be0d"
              }
            },
            "Apply_to_each_envt": {
              "type": "Foreach",
              "foreach": "@outputs('List_Environments_not_excused_from_compliance')?['body/value']",
              "actions": {
                "Send_Compliance_Request_email_for_Chatbots": {
                  "type": "Scope",
                  "actions": {
                    "Apply_to_each_chatbot": {
                      "type": "Foreach",
                      "foreach": "@outputs('List_chatbots')?['body/value']",
                      "actions": {
                        "Get_Assignee_for_Bots": {
                          "type": "If",
                          "expression": {
                            "or": [
                              {
                                "equals": [
                                  "@parameters('ProductionEnvironment (admin_ProductionEnvironment)')",
                                  "@false"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_chatbot')?['admin_pvaisorphaned']",
                                  "yes"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_chatbot')?['admin_pvaowner/admin_userisserviceprinciple']",
                                  "@true"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_chatbot')?['_admin_pvaowner_value']",
                                  "@null"
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Set_variable_2": {
                              "type": "SetVariable",
                              "inputs": {
                                "name": "varAssignee",
                                "value": "@parameters('Admin eMail (admin_AdminMail)')"
                              },
                              "metadata": {
                                "operationMetadataId": "4c1af51d-c6f1-4217-a16a-8cf0fad6c610"
                              }
                            }
                          },
                          "else": {
                            "actions": {
                              "Recheck_Orphan_2": {
                                "type": "Workflow",
                                "inputs": {
                                  "host": {
                                    "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                  },
                                  "body": {
                                    "text": "@items('Apply_to_each_chatbot')?['_admin_pvaowner_value']",
                                    "boolean": false
                                  }
                                },
                                "metadata": {
                                  "operationMetadataId": "ab7dc79c-03d7-46d9-b5e6-4b5522ecf8ee"
                                }
                              },
                              "See_if_now_orphaned_2": {
                                "type": "If",
                                "expression": {
                                  "equals": [
                                    "@outputs('Recheck_Orphan_2')?['Body']?['userisorphan']",
                                    "@true"
                                  ]
                                },
                                "actions": {
                                  "Set_variable_to_Approval_the_Admin_2": {
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "varAssignee",
                                      "value": "@parameters('Admin eMail (admin_AdminMail)')"
                                    },
                                    "metadata": {
                                      "operationMetadataId": "302316b0-671f-47c2-b1bc-f67d4cc079c0"
                                    }
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Set_Assignee_to_app_Owner_2": {
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "varAssignee",
                                        "value": "@outputs('Recheck_Orphan_2')?['Body']?['useremail']"
                                      },
                                      "metadata": {
                                        "operationMetadataId": "bfee0e05-b688-4624-9f45-81b04b7fe8bd"
                                      }
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Recheck_Orphan_2": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "83044cd2-6972-4da2-b64b-b50b652c9539"
                                }
                              }
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "a68ae48f-87aa-4aa4-8df6-32e84b6baef8"
                          }
                        },
                        "NumLaunchesWithNullCheck": {
                          "type": "Compose",
                          "inputs": "@coalesce(items('Apply_to_each_chatbot')?['admin_pvanumberlaunches'], 0)",
                          "runAfter": {
                            "Get_Assignee_for_Bots": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "5cd3f2b9-6aae-4cf1-b81d-b027fcd6e976"
                          }
                        },
                        "Condition:_Audit_chatbots_that_are_highly_used_or_admin_has_requested_audit": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "greaterOrEquals": [
                                  "@outputs('NumLaunchesWithNullCheck')",
                                  "@variables('NumberChatbotLaunches')"
                                ]
                              },
                              {
                                "not": {
                                  "equals": [
                                    "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                    597910003
                                  ]
                                }
                              }
                            ]
                          },
                          "actions": {
                            "Check_if_any_of_the_requirements_are_not_yet_complete_-_bots": {
                              "type": "If",
                              "expression": {
                                "or": [
                                  {
                                    "equals": [
                                      "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                      597910001
                                    ]
                                  },
                                  {
                                    "equals": [
                                      "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                      597910000
                                    ]
                                  }
                                ]
                              },
                              "actions": {
                                "Update_bot_Risk_Assessment_State_to_Requested": {
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "parameters": {
                                      "entityName": "admin_pvas",
                                      "recordId": "@items('Apply_to_each_chatbot')?['admin_pvaid']",
                                      "item/admin_adminrequirementriskassessmentstate": 597910001
                                    },
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "operationId": "UpdateRecord",
                                      "connectionName": "shared_commondataserviceforapps_1"
                                    }
                                  },
                                  "runAfter": {
                                    "If_BPF_not_already_started_for_this_chatbot,_start_it": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "d3df044b-707c-4f52-b20e-68679c13700c"
                                  }
                                },
                                "List_BPFs_for_this_Chatbot": {
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "parameters": {
                                      "entityName": "new_chatbotapprovalbpfs",
                                      "$select": "businessprocessflowinstanceid",
                                      "$filter": "_bpf_admin_pvaid_value eq '@{items('Apply_to_each_chatbot')?['admin_pvaid']}'"
                                    },
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "operationId": "ListRecords",
                                      "connectionName": "shared_commondataserviceforapps_1"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "7e033382-64c1-4d2c-8a01-af0b98b26058"
                                  }
                                },
                                "If_BPF_not_already_started_for_this_chatbot,_start_it": {
                                  "type": "If",
                                  "expression": {
                                    "equals": [
                                      "@length(outputs('List_BPFs_for_this_Chatbot')?['body/value'])",
                                      0
                                    ]
                                  },
                                  "actions": {
                                    "Start_Chatbot_Approval_Business_Process_Flow": {
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "parameters": {
                                          "entityName": "new_chatbotapprovalbpfs",
                                          "item/bpf_name": "Audit for @{items('Apply_to_each_chatbot')?['admin_pvadisplayname']}",
                                          "item/activestagestartedon": "@utcNow()",
                                          "item/bpf_admin_pvaid@odata.bind": "admin_pvas(@{items('Apply_to_each_chatbot')?['admin_pvaid']})"
                                        },
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "connectionName": "shared_commondataserviceforapps_1"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "0103b2ab-19ea-44ae-87d8-27c1308cbb4a"
                                      }
                                    }
                                  },
                                  "else": {
                                    "actions": {}
                                  },
                                  "runAfter": {
                                    "List_BPFs_for_this_Chatbot": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e3dca296-c910-46c3-ad71-7874005c701f"
                                  }
                                }
                              },
                              "else": {
                                "actions": {
                                  "If_not_already_submitted_or_complete,_mark_bot_as_submitted": {
                                    "type": "If",
                                    "expression": {
                                      "and": [
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                              597910003
                                            ]
                                          }
                                        },
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_chatbot')?['admin_adminrequirementriskassessmentstate']",
                                              597910002
                                            ]
                                          }
                                        }
                                      ]
                                    },
                                    "actions": {
                                      "Update_bots_Risk_Assessment_State_to_Submitted": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_pvas",
                                            "recordId": "@items('Apply_to_each_chatbot')?['admin_pvaid']",
                                            "item/admin_adminrequirementriskassessmentstate": 597910002
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "UpdateRecord",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "c2fcdaa8-6559-43ee-b6ac-14848382f198"
                                        }
                                      }
                                    },
                                    "else": {
                                      "actions": {}
                                    },
                                    "metadata": {
                                      "operationMetadataId": "67f884d1-52d2-4836-add9-68ae64b68b66"
                                    }
                                  }
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "c8a85408-377c-4620-9e9b-e93ed1ec78f4"
                              }
                            }
                          },
                          "else": {
                            "actions": {
                              "No-op,_not_heavily_used": {
                                "type": "Compose",
                                "inputs": "No-op, not heavily used",
                                "metadata": {
                                  "operationMetadataId": "9477e17b-b44b-4ad0-b87e-17925627be17"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "NumLaunchesWithNullCheck": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "3a834620-9be5-4344-949e-6092a174042c"
                          }
                        }
                      },
                      "runAfter": {
                        "List_chatbots": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "d56186d8-2cde-4a4b-aad9-a3149b3898e9"
                      }
                    },
                    "List_chatbots": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_pvas",
                          "$select": "admin_pvadisplayname,admin_makerrequirementbusinessimpact,admin_makerrequirementbusinessjustification,admin_makersubmittedrequirements,admin_mitigationplanprovided,admin_pvanumberlaunches,admin_pvaisorphaned, admin_pvaenvironmentdisplayname, admin_makerrequirementaccessmanagement, admin_makerrequirementdependencies, admin_pvaid, admin_chatbotdescription, admin_adminrequirementriskassessmentstate, _admin_pvaowner_value",
                          "$filter": "admin_PVAOwner/admin_displayname ne 'SYSTEM' and admin_pvadeleted ne true and _admin_pvaenvironment_value eq '@{items('Apply_to_each_envt')?['admin_environmentid']}' and admin_chatbotexcusedfromcompliance ne true",
                          "$expand": "admin_PVAOwner($select=admin_userisserviceprinciple, admin_displayname)"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps_1"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "fa5163c6-51cb-4b19-965f-ccce99dd83a2"
                      }
                    }
                  },
                  "runAfter": {
                    "Send_Compliance_Request_email_for_Apps": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "f58a0e7a-f063-42d7-b49a-2b80ec1d3629"
                  }
                },
                "Send_Compliance_Request_email_for_Apps": {
                  "type": "Scope",
                  "actions": {
                    "Apply_to_each_envt_App": {
                      "type": "Foreach",
                      "foreach": "@outputs('List_this_envt_apps')?['body/value']",
                      "actions": {
                        "Condition:_Audit_apps_that_are_broadly_shared_or_admin_has_requested_audit": {
                          "type": "If",
                          "expression": {
                            "or": [
                              {
                                "greaterOrEquals": [
                                  "@add(0, coalesce(items('Apply_to_each_envt_App')?['admin_appsharedusers'], 0))",
                                  "@variables('NumberUsersShared')"
                                ]
                              },
                              {
                                "greaterOrEquals": [
                                  "@add(0, coalesce(items('Apply_to_each_envt_App')?['admin_appsharedgroups'], 0))",
                                  "@variables('NumberGroupsShared')"
                                ]
                              },
                              {
                                "greaterOrEquals": [
                                  "@variables('AppSessionsLast30Days')",
                                  "@variables('NumberLaunchesLast30Days')"
                                ]
                              },
                              {
                                "not": {
                                  "equals": [
                                    "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                    597910000
                                  ]
                                }
                              }
                            ]
                          },
                          "actions": {
                            "If_still_or_ready_for_Requested_state": {
                              "type": "If",
                              "expression": {
                                "or": [
                                  {
                                    "equals": [
                                      "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                      597910001
                                    ]
                                  },
                                  {
                                    "equals": [
                                      "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                      597910000
                                    ]
                                  }
                                ]
                              },
                              "actions": {
                                "List_BPFs_for_this_App": {
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "parameters": {
                                      "entityName": "new_bpf_ffa183a676d64ec9aee6a558129651a2s",
                                      "$select": "businessprocessflowinstanceid",
                                      "$filter": "_bpf_admin_appid_value eq '@{items('Apply_to_each_envt_App')?['admin_appid']}'"
                                    },
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "operationId": "ListRecords",
                                      "connectionName": "shared_commondataserviceforapps_1"
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "38657fe9-1fb8-406b-931b-61995e23c97d"
                                  }
                                },
                                "If_BPF_not_already_started_for_this_app,_start_it": {
                                  "type": "If",
                                  "expression": {
                                    "equals": [
                                      "@length(outputs('List_BPFs_for_this_App')?['body/value'])",
                                      0
                                    ]
                                  },
                                  "actions": {
                                    "Start_App_Audit_BPF": {
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "parameters": {
                                          "entityName": "new_bpf_ffa183a676d64ec9aee6a558129651a2s",
                                          "item/bpf_name": "Audit for @{items('Apply_to_each_envt_App')?['admin_displayname']}",
                                          "item/activestagestartedon": "@utcNow()",
                                          "item/bpf_admin_appid@odata.bind": "admin_apps(@{items('Apply_to_each_envt_App')?['admin_appid']})"
                                        },
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "operationId": "CreateRecord",
                                          "connectionName": "shared_commondataserviceforapps_1"
                                        },
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "ac86b0d9-2e77-430a-b3ba-a481ef2b84ca"
                                      }
                                    }
                                  },
                                  "else": {
                                    "actions": {}
                                  },
                                  "runAfter": {
                                    "List_BPFs_for_this_App": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "5ef038f2-c89f-4a80-a15e-d97a488087ab"
                                  }
                                },
                                "Update_requested_date_AND_state_or_just_state": {
                                  "type": "If",
                                  "expression": {
                                    "or": [
                                      {
                                        "not": {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                            597910001
                                          ]
                                        }
                                      },
                                      {
                                        "equals": [
                                          "@items('Apply_to_each_envt_App')?['admin_compliancerequestedon']",
                                          "@null"
                                        ]
                                      }
                                    ]
                                  },
                                  "actions": {
                                    "Update_apps_Risk_Assessment_State_to_Requested_and_Requested_Date": {
                                      "type": "OpenApiConnection",
                                      "inputs": {
                                        "parameters": {
                                          "entityName": "admin_apps",
                                          "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']",
                                          "item/admin_adminrequirementriskassessmentstate": 597910001,
                                          "item/admin_compliancerequestedon": "@utcNow()"
                                        },
                                        "host": {
                                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                          "operationId": "UpdateRecord",
                                          "connectionName": "shared_commondataserviceforapps_1"
                                        },
                                        "retryPolicy": {
                                          "type": "exponential",
                                          "count": 10,
                                          "interval": "PT10S"
                                        }
                                      },
                                      "metadata": {
                                        "operationMetadataId": "9d8bfece-6bfe-4f86-b62f-c6a74c2b0c0d"
                                      }
                                    }
                                  },
                                  "else": {
                                    "actions": {
                                      "Update_apps_Risk_Assessment_State_to_Requested": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_apps",
                                            "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']",
                                            "item/admin_adminrequirementriskassessmentstate": 597910001
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "UpdateRecord",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          },
                                          "retryPolicy": {
                                            "type": "exponential",
                                            "count": 10,
                                            "interval": "PT10S"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "9d8bfece-6bfe-4f86-b62f-c6a74c2b0c0d"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "If_BPF_not_already_started_for_this_app,_start_it": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "f3935faf-e93b-4736-ab99-cbde53563502"
                                  }
                                }
                              },
                              "else": {
                                "actions": {
                                  "If_not_already_submitted_or_complete,_mark_as_submitted": {
                                    "type": "If",
                                    "expression": {
                                      "and": [
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                              597910003
                                            ]
                                          }
                                        },
                                        {
                                          "not": {
                                            "equals": [
                                              "@items('Apply_to_each_envt_App')?['admin_adminrequirementriskassessmentstate']",
                                              597910002
                                            ]
                                          }
                                        }
                                      ]
                                    },
                                    "actions": {
                                      "Update_apps_Risk_Assessment_State_to_Submitted": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_apps",
                                            "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']",
                                            "item/admin_adminrequirementriskassessmentstate": 597910002
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "UpdateRecord",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          },
                                          "retryPolicy": {
                                            "type": "exponential",
                                            "count": 10,
                                            "interval": "PT10S"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "12c35ea5-cec4-40f8-905c-5df209828f2e"
                                        }
                                      }
                                    },
                                    "else": {
                                      "actions": {}
                                    },
                                    "metadata": {
                                      "operationMetadataId": "cceeb40e-9ace-47e5-9bab-58f2e2e2ba9c"
                                    }
                                  },
                                  "If_not_recently_published,_send_for_testing_and_republish": {
                                    "type": "If",
                                    "expression": {
                                      "or": [
                                        {
                                          "equals": [
                                            "@items('Apply_to_each_envt_App')?['admin_apppublished']",
                                            "@null"
                                          ]
                                        },
                                        {
                                          "less": [
                                            "@addDays(items('Apply_to_each_envt_App')?['admin_apppublished'], variables('NumberDaysSincePublished'))",
                                            "@utcNow()"
                                          ]
                                        }
                                      ]
                                    },
                                    "actions": {
                                      "Update_apps_Republish_State_to_Requested": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_apps",
                                            "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']",
                                            "item/admin_adminrequirementrepublishstate": 597910001
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "UpdateRecord",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          },
                                          "retryPolicy": {
                                            "type": "exponential",
                                            "count": 10,
                                            "interval": "PT10S"
                                          }
                                        },
                                        "metadata": {
                                          "operationMetadataId": "146d1792-766a-45fb-9afb-18181a269be7"
                                        }
                                      },
                                      "emailGUID_to_en-US_2": {
                                        "type": "Compose",
                                        "inputs": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                        "runAfter": {
                                          "Update_apps_Republish_State_to_Requested": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "d19afed8-4f91-4914-9cb7-fe89e74e1a6c"
                                        }
                                      },
                                      "List_emails_for_preferred_language_2": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_customizedemails",
                                            "$select": "admin_customizedemailid",
                                            "$filter": "admin_basedon eq '@{outputs('emailGUID_to_en-US_2')}' and admin_language eq '@{outputs('Run_a_Child_Flow')?['Body']?['userpreferredlanguage']}'"
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "ListRecords",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          }
                                        },
                                        "runAfter": {
                                          "emailGUID_to_en-US_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "29188a43-3a3a-46da-a4f6-f162180d8254"
                                        }
                                      },
                                      "Set_emailGUID_to_localized_row_2": {
                                        "type": "SetVariable",
                                        "description": "if(greater(length(outputs('List_emails_for_preferred_language_2')?['body/value']), 0), first(body('List_emails_for_preferred_language_2')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_2'))",
                                        "inputs": {
                                          "name": "emailGUID",
                                          "value": "@{if(greater(length(outputs('List_emails_for_preferred_language_2')?['body/value']), 0), first(body('List_emails_for_preferred_language_2')?['value'])['admin_customizedemailid'], outputs('emailGUID_to_en-US_2'))}"
                                        },
                                        "runAfter": {
                                          "List_emails_for_preferred_language_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "4c1f823f-63a0-4d98-b489-df53e0e934b7"
                                        }
                                      },
                                      "Get_a_row_by_ID_2": {
                                        "type": "OpenApiConnection",
                                        "inputs": {
                                          "parameters": {
                                            "entityName": "admin_customizedemails",
                                            "recordId": "@variables('emailGUID')",
                                            "$select": "admin_body, admin_cc, admin_replyto, admin_sendonbehalf, admin_subject, admin_importance"
                                          },
                                          "host": {
                                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                            "operationId": "GetItem",
                                            "connectionName": "shared_commondataserviceforapps_1"
                                          }
                                        },
                                        "runAfter": {
                                          "Set_emailGUID_to_localized_row_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "c34df6f5-d327-47a2-8e25-e33c207762e2"
                                        }
                                      },
                                      "Send_Republish_Mail_to_Owner_Apps": {
                                        "type": "Workflow",
                                        "description": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                        "inputs": {
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          },
                                          "body": {
                                            "email": "@variables('varAssignee')",
                                            "text": "@outputs('Get_a_row_by_ID_2')?['body/admin_subject']",
                                            "text_1": "@{outputs('Get_a_row_by_ID_2')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL (admin_DeveloperComplianceCenterURL)')}&pagetype=custom&name=admin_developercompliancecenterapppage_775de&etn=admin_app&id=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n<b><u>App Details</u></b>\n<p><b>Display Name:</b> @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>@{items('Apply_to_each_envt_App')?['admin_appenvironment/admin_displayname']}</p>\n",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_replyto'])",
                                            "text_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_importance'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_importance'])"
                                          }
                                        },
                                        "runAfter": {
                                          "Get_a_row_by_ID_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        }
                                      },
                                      "Send_Republish_Mail_to_Admin_Apps": {
                                        "type": "Workflow",
                                        "description": "4169820e-ca41-ec11-8c62-00224829b4c1",
                                        "inputs": {
                                          "host": {
                                            "workflowReferenceName": "5625768c-bd3d-ec11-8c63-00224829720b"
                                          },
                                          "body": {
                                            "email": "@variables('varAssignee')",
                                            "text": "@{outputs('Get_a_row_by_ID_2')?['body/admin_subject']}- REASSIGNED TO ADMIN",
                                            "text_1": "REASSIGNED TO ADMIN <br>\n@{outputs('Get_a_row_by_ID_2')?['body/admin_body']}\n\n<a href='@{parameters('Developer Compliance Center URL (admin_DeveloperComplianceCenterURL)')}&pagetype=custom&name=admin_developercompliancecenterapppage_775de&etn=admin_app&id=@{items('Apply_to_each_envt_App')?['admin_appid']}'>Developer Compliance Center</a><br><br>\n\n\n<b><u>App Details</u></b>\n<p><b>Display Name:</b> @{items('Apply_to_each_envt_App')?['admin_displayname']}</p>\n<p><b>Environment:</b>@{items('Apply_to_each_envt_App')?['admin_appenvironment/admin_displayname']}</p>\n",
                                            "email_1": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_cc'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_cc'])",
                                            "email_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_sendonbehalf'])",
                                            "email_3": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_replyto'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_replyto'])",
                                            "text_2": "@if(equals(outputs('Get_a_row_by_ID_2')?['body/admin_importance'], null), '', outputs('Get_a_row_by_ID_2')?['body/admin_importance'])"
                                          }
                                        },
                                        "runAfter": {
                                          "Send_Republish_Mail_to_Owner_Apps": [
                                            "Failed"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "cde22ca8-5369-47d5-bc3e-5a4c6f3c5660"
                                        }
                                      }
                                    },
                                    "else": {
                                      "actions": {
                                        "Update_apps_Republish_State_to_Complete": {
                                          "type": "OpenApiConnection",
                                          "inputs": {
                                            "parameters": {
                                              "entityName": "admin_apps",
                                              "recordId": "@items('Apply_to_each_envt_App')?['admin_appid']",
                                              "item/admin_adminrequirementrepublishstate": 597910003
                                            },
                                            "host": {
                                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                              "operationId": "UpdateRecord",
                                              "connectionName": "shared_commondataserviceforapps_1"
                                            }
                                          },
                                          "metadata": {
                                            "operationMetadataId": "10ecfecb-fcc7-46c4-9359-66c812b658ba"
                                          }
                                        }
                                      }
                                    },
                                    "runAfter": {
                                      "If_not_already_submitted_or_complete,_mark_as_submitted": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "38054c5d-652b-44aa-ae97-58a44371520c"
                                    }
                                  }
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "2713395c-57a1-4b74-968b-d512fc3db214"
                              }
                            }
                          },
                          "else": {
                            "actions": {
                              "No-op,_not_broadly_used_or_shared": {
                                "type": "Compose",
                                "inputs": "No-op, not broadly used or shared",
                                "metadata": {
                                  "operationMetadataId": "b2c59efa-852b-4eb8-abd4-a23ba1f409e2"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Get_Session_Count_last_30_days": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "16330166-15bd-4af0-bad0-6c50901a3d20"
                          }
                        },
                        "Get_Session_Count_last_30_days": {
                          "type": "Scope",
                          "actions": {
                            "If_App_Launches_are_0,_get_data_from_Audit_Log_table": {
                              "type": "If",
                              "description": "If Inventory is not via BYODL but via sync flows, get app launches from Audit Log instead",
                              "expression": {
                                "equals": [
                                  "@variables('AppSessionsLast30Days')",
                                  0
                                ]
                              },
                              "actions": {
                                "List_launches_for_this_app_last_30_days": {
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "parameters": {
                                      "entityName": "admin_auditlogs",
                                      "$select": "admin_auditlogid",
                                      "$filter": "admin_appid eq '@{items('Apply_to_each_envt_App')?['admin_appid']}' and admin_creationtime gt @{addDays(utcNow(), -30)} and admin_operation eq 'LaunchPowerApp'"
                                    },
                                    "host": {
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                      "operationId": "ListRecords",
                                      "connectionName": "shared_commondataserviceforapps_1"
                                    }
                                  },
                                  "runtimeConfiguration": {
                                    "paginationPolicy": {
                                      "minimumItemCount": 100000
                                    }
                                  },
                                  "metadata": {
                                    "operationMetadataId": "0739d59d-0ab3-4d5d-89fb-a367558abf87"
                                  }
                                },
                                "Set_App_Launches_from_Audit_Log_table": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "AppSessionsLast30Days",
                                    "value": "@length(outputs('List_launches_for_this_app_last_30_days')?['body/value'])"
                                  },
                                  "runAfter": {
                                    "List_launches_for_this_app_last_30_days": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e3ee08d3-7e77-45f5-8df7-9f76ef4a0d3f"
                                  }
                                }
                              },
                              "else": {
                                "actions": {}
                              },
                              "runAfter": {
                                "Set_App_Launches_from_PowerApps_table": [
                                  "Succeeded",
                                  "Failed"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "76c00537-51ca-4ef3-86d0-2690470ea07e"
                              }
                            },
                            "Set_App_Launches_from_PowerApps_table": {
                              "type": "SetVariable",
                              "description": "Number of sessions in the past 30 days are populated in this field from BYODL ",
                              "inputs": {
                                "name": "AppSessionsLast30Days",
                                "value": "@coalesce(items('Apply_to_each_envt_App')?['admin_launchesinthepast30days'], 0)"
                              },
                              "metadata": {
                                "operationMetadataId": "5efcce5c-f79d-4f4c-8e77-eb62ca2047fe"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_Assignee_apps": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "4ed49aaa-5a8e-442f-b438-19a9cb48220e"
                          }
                        },
                        "Get_Assignee_apps": {
                          "type": "If",
                          "expression": {
                            "or": [
                              {
                                "equals": [
                                  "@parameters('ProductionEnvironment (admin_ProductionEnvironment)')",
                                  "@false"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_envt_App')?['cr5d5_appisorphaned']",
                                  "yes"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_envt_App')?['admin_appowner/admin_userisserviceprinciple']",
                                  "@true"
                                ]
                              },
                              {
                                "equals": [
                                  "@items('Apply_to_each_envt_App')?['_admin_appowner_value']",
                                  "@null"
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Set_Assignee_to_Admin": {
                              "type": "SetVariable",
                              "inputs": {
                                "name": "varAssignee",
                                "value": "@parameters('Admin eMail (admin_AdminMail)')"
                              },
                              "metadata": {
                                "operationMetadataId": "d6778a8c-1d43-47a0-adac-4bf7de2c65a0"
                              }
                            }
                          },
                          "else": {
                            "actions": {
                              "Run_a_Child_Flow": {
                                "type": "Workflow",
                                "inputs": {
                                  "host": {
                                    "workflowReferenceName": "9301f01a-cb40-ec11-8c62-00224829b4c1"
                                  },
                                  "body": {
                                    "text": "@items('Apply_to_each_envt_App')?['_admin_appowner_value']",
                                    "boolean": false
                                  }
                                },
                                "metadata": {
                                  "operationMetadataId": "89e3b046-4975-4c2d-a743-b2c00f942884"
                                }
                              },
                              "See_if_now_orphaned": {
                                "type": "If",
                                "expression": {
                                  "equals": [
                                    "@outputs('Run_a_Child_Flow')?['Body']?['userisorphan']",
                                    "@true"
                                  ]
                                },
                                "actions": {
                                  "Set_variable_to_Approval_the_Admin": {
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "varAssignee",
                                      "value": "@parameters('Admin eMail (admin_AdminMail)')"
                                    },
                                    "metadata": {
                                      "operationMetadataId": "f70a1e92-f284-4cda-beb6-8337a8c18758"
                                    }
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Set_Assignee_to_app_Owner": {
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "varAssignee",
                                        "value": "@outputs('Run_a_Child_Flow')?['Body']?['useremail']"
                                      },
                                      "metadata": {
                                        "operationMetadataId": "578f6c6d-4084-492e-bc9e-e59e4e0eb47b"
                                      }
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Run_a_Child_Flow": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "a76192c2-6ad7-4197-ba2c-5476cbeade19"
                                }
                              }
                            }
                          },
                          "metadata": {
                            "operationMetadataId": "cff7d5a1-9a8a-416c-a8d9-87d2714a2ee5"
                          }
                        }
                      },
                      "runAfter": {
                        "List_this_envt_apps": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "9d686fa6-3f70-4d3d-892b-3e8b6905adbc"
                      }
                    },
                    "List_this_envt_apps": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_apps",
                          "$select": "admin_appdescription,admin_displayname,admin_apppublished,admin_appsharedgroups,admin_appsharedusers,admin_requirement_2,admin_requirement_1,admin_requirement_3,admin_requirement_4,admin_requirement_6,admin_makersubmittedrequirements,admin_requirement_5,cr5d5_appisorphaned,_admin_appowner_value, admin_appenvironmentdisplayname, admin_adminrequirementriskassessmentstate, admin_adminrequirementrepublishstate,admin_compliancerequestedon,admin_launchesinthepast30days",
                          "$filter": "admin_powerappstype eq 597910000 and _admin_appowner_value ne null and admin_appdeleted ne true and admin_appownerdisplayname ne 'SYSTEM' and _admin_appenvironment_value  eq '@{items('Apply_to_each_envt')?['admin_environmentid']}' and admin_appexcusedfromcompliance ne true",
                          "$expand": "admin_AppOwner($select=admin_userisserviceprinciple, admin_displayname), admin_AppEnvironment($select=admin_displayname)"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps_1"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "07d52006-6e63-4c00-b1e5-21bf1a6f4299"
                      }
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "0feb9d43-1010-434d-a0e3-d4bb0dfdad3f"
                  }
                }
              },
              "runAfter": {
                "List_Environments_not_excused_from_compliance": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "99e6ea0f-c0c6-4ea5-956b-c8d2dfddcdc3"
              }
            }
          },
          "runAfter": {
            "Initialize_AppSessionsLast30Days": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "ab92ac8f-3523-4fcb-b6a3-2343afcb776c"
          }
        },
        "Initialize_emailGUID": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "emailGUID",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Initialize_NumberChatbotLaunches": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "dad8eca6-7937-47c0-aa57-f2d48dd1c5a2"
          }
        },
        "Initialize_AppSessionsLast30Days": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "AppSessionsLast30Days",
                "type": "integer",
                "value": 0
              }
            ]
          },
          "runAfter": {
            "Initialize_emailGUID": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "f83a2fe5-d043-42de-8d8b-249a42c25d13"
          }
        },
        "Error_Handling": {
          "type": "Scope",
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              },
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              }
            },
            "Terminate": {
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Compliance Details Failed"
                }
              },
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              }
            },
            "Get_ID_Fail": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              }
            },
            "Update_Last_Run_Fail": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              }
            }
          },
          "runAfter": {
            "Compliance_due_to_heavy_usage": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          }
        },
        "Update_last_run_as_pass": {
          "type": "Scope",
          "actions": {
            "Update_Last_Run_Successful": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              }
            },
            "Get_ID_Pass": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date",
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "2dc8526f-f5ca-479a-beb0-ec299be5512e"
              }
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          }
        }
      },
      "outputs": {},
      "description": "This flow works in conjunction with other apps and flows in the CoE Starter Kit to facilitate the process described in App auditing process. Compliance detail request emails are sent for apps and chatbots."
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}