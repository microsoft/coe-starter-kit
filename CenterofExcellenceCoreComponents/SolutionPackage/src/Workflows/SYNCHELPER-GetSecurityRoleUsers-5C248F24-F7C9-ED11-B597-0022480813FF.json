{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_office365groups": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Groups"
        },
        "api": {
          "name": "shared_office365groups"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        }
      },
      "triggers": {
        "manual": {
          "metadata": {
            "operationMetadataId": "cec898c9-9368-4ba8-85ac-f8446de7f205"
          },
          "type": "Request",
          "kind": "Button",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "text": {
                  "title": "EnvtID",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "text_1": {
                  "title": "SecurityRoleName",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "text_2": {
                  "title": "BusinessUnitID",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                },
                "boolean": {
                  "title": "SecurityRoleHasID",
                  "type": "boolean",
                  "x-ms-dynamically-added": true,
                  "description": "Please select yes or no",
                  "x-ms-content-hint": "BOOLEAN"
                },
                "text_3": {
                  "title": "SecurityRoleTID",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your input",
                  "x-ms-content-hint": "TEXT"
                }
              },
              "required": [
                "text",
                "text_1",
                "text_2",
                "boolean",
                "text_3"
              ]
            }
          }
        }
      },
      "actions": {
        "Get_Security_Role_Users": {
          "actions": {
            "Get_Inventory_SR_membership": {
              "actions": {
                "Select_inventory": {
                  "runAfter": {
                    "List_Inventoried_SR_Members": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "af4be2fe-ed80-41d8-8baf-2572411ab04d"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@outputs('List_Inventoried_SR_Members')?['body/value']",
                    "select": {
                      "UserName": "@item()?['admin_name']",
                      "UserID": "@item()?['admin_userid']",
                      "AssignedVia": "@item()?['admin_assignedvia']",
                      "GroupName": "@item()?['admin_groupname']",
                      "GroupID": "@item()?['admin_groupid']",
                      "SRName": "@item()?['admin_securityrolename']",
                      "SRId": "@item()?['admin_securityroleid']",
                      "SRTemplateID": "@item()?['admin_securityroletemplateid']",
                      "BusinessUnitName": "@item()?['admin_businessunitname']",
                      "UserStatus": "@item()?['admin_userstatus']"
                    }
                  }
                },
                "Parse_inventory": {
                  "runAfter": {
                    "Select_inventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "f837f9f6-b112-481e-a572-50e00e7df2af"
                  },
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@body('Select_inventory')",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "UserName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "UserID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "AssignedVia": {
                            "type": "string"
                          },
                          "GroupName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "GroupID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "SRName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "SRId": {
                            "type": "string"
                          },
                          "SRTemplateID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "BusinessUnitName": {
                            "type": "string"
                          },
                          "UserStatus": {
                            "type": [
                              "string",
                              "null"
                            ]
                          }
                        },
                        "required": [
                          "AssignedVia",
                          "SRName",
                          "SRId",
                          "BusinessUnitName"
                        ]
                      }
                    }
                  }
                },
                "Filter_inventory": {
                  "runAfter": {
                    "Parse_inventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "778b6f7b-14d0-49db-893f-4de8483d9a0e"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_inventory')",
                    "where": "@not(equals(item()['UserName'], null))"
                  }
                },
                "List_Inventoried_SR_Members": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "dfde3174-81aa-4643-8367-cd695f0bfb9d"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_environmentsecurityrolepermissions",
                      "$select": "admin_name, admin_userid, admin_assignedvia, admin_groupname, admin_groupid, admin_securityrolename, admin_securityroleid, admin_securityroletemplateid, admin_businessunitname, admin_userstatus",
                      "$filter": "_admin_environment_value eq @{triggerBody()['text']} and admin_securityrolename eq '@{triggerBody()['text_1']}' and admin_businessunitname eq '@{outputs('RemoveSpecialCharactersBU')}'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                }
              },
              "runAfter": {
                "Get_Actual_SR_membership": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "ced5d6dc-d17b-41a0-b6a2-0ac15f2380df"
              },
              "type": "Scope"
            },
            "Remove_deleted_ones_from_inventory": {
              "actions": {
                "RemoveFromInventory": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "149bbf22-b97b-4566-99b6-4354571954d9"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Filter_inventory')",
                    "where": "@not(contains(body('Filter_actual'), item()))"
                  }
                },
                "Remove_deleted_from_inventory": {
                  "foreach": "@body('RemoveFromInventory')",
                  "actions": {
                    "Delete_it": {
                      "runAfter": {
                        "Find_it_for_ID": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "2a24646e-b8a2-414b-8dc9-c24d18dbd5ec"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "DeleteRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_environmentsecurityrolepermissions",
                          "recordId": "@first(outputs('Find_it_for_ID')?['body/value'])?['admin_environmentsecurityrolepermissionid']"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        },
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 20,
                          "interval": "PT20S"
                        }
                      }
                    },
                    "Find_it_for_ID": {
                      "runAfter": {
                        "Remove_It_filter": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "34225f64-09d2-4a30-8e8a-f88203204ab7"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_environmentsecurityrolepermissions",
                          "$select": "admin_environmentsecurityrolepermissionid",
                          "$filter": "@outputs('Remove_It_filter')"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      }
                    },
                    "Remove_It_Filter_-_Direct": {
                      "runAfter": {
                        "Remove_It_Filter_-_Group": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "11bec781-6c5f-4f9a-9804-e2cbe4c7a066"
                      },
                      "type": "Compose",
                      "inputs": "_admin_environment_value eq @{triggerBody()['text']} and admin_name eq '@{outputs('RemoveSpecialChars')}' and admin_assignedvia eq '@{items('Remove_deleted_from_inventory')?['AssignedVia']}'  and admin_securityrolename eq '@{items('Remove_deleted_from_inventory')?['SRName']}' and admin_businessunitname eq '@{outputs('RemoveSpecialCharactersBU')}'"
                    },
                    "Remove_It_filter": {
                      "runAfter": {
                        "Remove_It_Filter_-_Direct": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "40f98d96-a9c5-4663-95e4-14d1d09c0400"
                      },
                      "type": "Compose",
                      "inputs": "@if(equals(items('Remove_deleted_from_inventory')?['AssignedVia'], 'Direct'), outputs('Remove_It_Filter_-_Direct'), outputs('Remove_It_Filter_-_Group'))"
                    },
                    "RemoveSpecialChars": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "347169be-01ed-4421-91e9-ce78742ae7bc"
                      },
                      "type": "Compose",
                      "inputs": "@if(equals(items('Remove_deleted_from_inventory')?['UserName'], null), null, replace(items('Remove_deleted_from_inventory')?['UserName'],'''',''''''))"
                    },
                    "Remove_It_Filter_-_Group": {
                      "runAfter": {
                        "RemoveSpecialChars": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "6052ea2c-5cc0-4c27-a4b8-3bc9fef1be92"
                      },
                      "type": "Compose",
                      "inputs": "_admin_environment_value eq @{triggerBody()['text']} and admin_name eq '@{outputs('RemoveSpecialChars')}' and admin_assignedvia eq '@{items('Remove_deleted_from_inventory')?['AssignedVia']}' and admin_securityrolename  eq '@{items('Remove_deleted_from_inventory')?['SRName']}' and admin_businessunitname eq '@{outputs('RemoveSpecialCharactersBU')}' and admin_groupid eq '@{items('Remove_deleted_from_inventory')?['GroupID']}'"
                    }
                  },
                  "runAfter": {
                    "RemoveFromInventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "28675072-fed2-4037-8362-c437ea2e3666"
                  },
                  "type": "Foreach"
                }
              },
              "runAfter": {
                "Get_Inventory_SR_membership": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "1462a234-fef4-4340-9fe1-a74a402e2698"
              },
              "type": "Scope"
            },
            "Add_new_ones_to_inventory": {
              "actions": {
                "AddToInventory": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "7bc4c19b-dff9-4e6d-9330-409b322e1262"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Filter_actual')",
                    "where": "@not(contains(body('Filter_inventory'), item()))"
                  }
                },
                "Add_new_to_inventory": {
                  "foreach": "@body('AddToInventory')",
                  "actions": {
                    "Add_new_SR_User": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "693cedbf-af7b-4cc7-bdaf-43092e680ccb"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps",
                          "operationId": "CreateRecord",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "entityName": "admin_environmentsecurityrolepermissions",
                          "item/admin_name": "@items('Add_new_to_inventory')?['UserName']",
                          "item/admin_assignedvia": "@items('Add_new_to_inventory')?['AssignedVia']",
                          "item/admin_businessunitname": "@outputs('Business_Unit_Name')",
                          "item/admin_Environment@odata.bind": "admin_environments(@{triggerBody()['text']})",
                          "item/admin_groupid": "@items('Add_new_to_inventory')?['GroupID']",
                          "item/admin_groupname": "@items('Add_new_to_inventory')?['GroupName']",
                          "item/admin_securityroleid": "@items('Add_new_to_inventory')?['SRId']",
                          "item/admin_securityrolename": "@items('Add_new_to_inventory')?['SRName']",
                          "item/admin_securityroletemplateid": "@items('Add_new_to_inventory')?['SRTemplateID']",
                          "item/admin_userid": "@items('Add_new_to_inventory')?['UserID']",
                          "item/admin_userstatus": "@items('Add_new_to_inventory')?['UserStatus']"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "AddToInventory": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "cd782c08-b244-4109-a40a-a6f6c9249684"
                  },
                  "type": "Foreach"
                }
              },
              "runAfter": {
                "Remove_deleted_ones_from_inventory": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "46fe9e2b-1629-4a45-8c6c-167399b13b1b"
              },
              "type": "Scope"
            },
            "Get_Actual_SR_membership": {
              "actions": {
                "Apply_to_each_Direct_Access": {
                  "foreach": "@outputs('Direct_System_User_Access')?['body/value']",
                  "actions": {
                    "Append_to_array_variable": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "ccd44d0d-a49b-4a9d-86e0-a352e9b56574"
                      },
                      "type": "AppendToArrayVariable",
                      "inputs": {
                        "name": "ActualSrMembers",
                        "value": {
                          "Name": "@items('Apply_to_each_Direct_Access')?['fullname']",
                          "UserID": "@items('Apply_to_each_Direct_Access')?['azureactivedirectoryobjectid']",
                          "UserStatus": "@if(equals(items('Apply_to_each_Direct_Access')?['isdisabled'], false), 'Enabled', 'Disabled')",
                          "Assigned Via": "Direct",
                          "Group Name": "@null",
                          "Group ID": "@null"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Direct_System_User_Access": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a6f46313-c07d-49cb-86c1-e32584a2167c"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "Apply_to_each_Team": {
                  "foreach": "@outputs('Teams_with_Access')?['body/value']",
                  "actions": {
                    "List_group_members": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "5e2fa560-2d89-4b7b-a9ae-ca92bea3c650"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_office365groups",
                          "operationId": "ListGroupMembers",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                        },
                        "parameters": {
                          "groupId": "@items('Apply_to_each_Team')?['azureactivedirectoryobjectid']"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "continue_if_group_exists": {
                      "actions": {
                        "Filter_array_to_Group_Memebers": {
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "b3fe4fa6-51a7-4895-89cd-f613b8c82cbd"
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@outputs('List_group_members')?['body/value']",
                            "where": "@equals(item()?['@odata.type'], '#microsoft.graph.group')"
                          }
                        },
                        "if_no_sub_groups_add_group_here": {
                          "actions": {
                            "Append_to_GroupsToAdd_no_sub_groups": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "5a1f4585-28df-44b7-8e69-bb48f5b7b555"
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "GroupsToAdd",
                                "value": "@items('Apply_to_each_Team')?['azureactivedirectoryobjectid']"
                              }
                            },
                            "List_group_members_no_sub_groups": {
                              "runAfter": {
                                "Append_to_naming_map_no_sub_groups": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "a54804a6-cd15-4d62-b807-97a78d340d5e"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_office365groups",
                                  "operationId": "ListGroupMembers",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                                },
                                "parameters": {
                                  "groupId": "@items('Apply_to_each_Team')?['azureactivedirectoryobjectid']"
                                },
                                "authentication": {
                                  "type": "Raw",
                                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                }
                              }
                            },
                            "Add_each_user_no_sub_groups": {
                              "foreach": "@outputs('List_group_members_no_sub_groups')?['body/value']",
                              "actions": {
                                "Append_to_ActualSrMembers_no_sub_groups": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "2ad9277f-e051-4295-ad8f-664816ad2d21"
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "ActualSrMembers",
                                    "value": {
                                      "Name": "@items('Add_each_user_no_sub_groups')?['displayName']",
                                      "UserID": "@items('Add_each_user_no_sub_groups')?['id']",
                                      "UserStatus": "Enabled",
                                      "Assigned Via": "Group",
                                      "Group Name": "@items('Apply_to_each_Team')?['name']",
                                      "Group ID": "@items('Apply_to_each_Team')?['azureactivedirectoryobjectid']"
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "List_group_members_no_sub_groups": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "cbce8529-7053-40ef-83fa-b3135196d45a"
                              },
                              "type": "Foreach",
                              "runtimeConfiguration": {
                                "concurrency": {
                                  "repetitions": 50
                                }
                              }
                            },
                            "Append_to_naming_map_no_sub_groups": {
                              "runAfter": {
                                "Append_to_GroupsToAdd_no_sub_groups": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "0674db37-5bb2-44df-a869-d42ea78b5481"
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "GroupID_Name_Map",
                                "value": {
                                  "GroupName": "@items('Apply_to_each_Team')?['name']",
                                  "GroupID": "@items('Apply_to_each_Team')?['azureactivedirectoryobjectid']"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_array_to_Group_Memebers": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "equals": [
                              "@length(body('Filter_array_to_Group_Memebers'))",
                              0
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "13fef3b2-bb26-4ef7-83de-addb2fc9e65e"
                          },
                          "type": "If"
                        },
                        "Append_to_add_and_check_variables": {
                          "foreach": "@body('Filter_array_to_Group_Memebers')",
                          "actions": {
                            "Append_to_GroupsToAdd": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "5a1f4585-28df-44b7-8e69-bb48f5b7b555"
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "GroupsToAdd",
                                "value": "@items('Append_to_add_and_check_variables')?['id']"
                              }
                            },
                            "Append_to_GroupsToCheck": {
                              "runAfter": {
                                "Append_to_GroupsToAdd": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "d5b93c1f-c468-4f7d-8ba1-2bb9f548d37b"
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "GroupsToCheck",
                                "value": "@items('Append_to_add_and_check_variables')?['id']"
                              }
                            },
                            "Append_to_Map": {
                              "runAfter": {
                                "Append_to_GroupsToCheck": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "3e8a4dc2-94be-469b-af93-0cd81aa54db8"
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "GroupID_Name_Map",
                                "value": {
                                  "GroupName": "@items('Append_to_add_and_check_variables')?['displayname']",
                                  "GroupID": "@items('Append_to_add_and_check_variables')?['id']"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "if_no_sub_groups_add_group_here": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "a403c53e-8294-4577-bd79-5e4611881537"
                          },
                          "type": "Foreach"
                        },
                        "Do_until": {
                          "actions": {
                            "Copy_GroupsToCheck_to_tempVar": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "0dddb978-2cc7-4cad-9aab-3207069e0713"
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "tempVar",
                                "value": "@variables('GroupsToCheck')"
                              }
                            },
                            "Clear_GroupsToCheck": {
                              "runAfter": {
                                "Copy_GroupsToCheck_to_tempVar": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "b983b932-fc70-40b6-8a80-e2758eb7139e"
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "GroupsToCheck",
                                "value": []
                              }
                            },
                            "Apply_to_each_group_-_loop": {
                              "foreach": "@variables('tempVar')",
                              "actions": {
                                "Filter_array_to_Group_Members_-_loop": {
                                  "runAfter": {
                                    "Add_each_user_in_group": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "196b7236-e4c5-4134-8cb4-b1e00e80c57f"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_group_members_-_loop')?['body/value']",
                                    "where": "@equals(item()?['@odata.type'], '#microsoft.graph.group')"
                                  }
                                },
                                "List_group_members_-_loop": {
                                  "runAfter": {},
                                  "metadata": {
                                    "operationMetadataId": "5e2fa560-2d89-4b7b-a9ae-ca92bea3c650"
                                  },
                                  "type": "OpenApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connectionName": "shared_office365groups",
                                      "operationId": "ListGroupMembers",
                                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365groups"
                                    },
                                    "parameters": {
                                      "groupId": "@items('Apply_to_each_group_-_loop')"
                                    },
                                    "authentication": {
                                      "type": "Raw",
                                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                                    }
                                  },
                                  "runtimeConfiguration": {
                                    "paginationPolicy": {
                                      "minimumItemCount": 100000
                                    }
                                  }
                                },
                                "Filter_array_to_Groups_not_already_in_Add_list": {
                                  "runAfter": {
                                    "Filter_array_to_Group_Members_-_loop": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "e33eee68-5adb-414a-89a6-5af40f0214ac"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@body('Filter_array_to_Group_Members_-_loop')",
                                    "where": "@not(contains(variables('GroupsToAdd'), item()?['id']))"
                                  }
                                },
                                "Append_to_add_and_check_variables_-_loop": {
                                  "foreach": "@body('Filter_array_to_Groups_not_already_in_Add_list')",
                                  "actions": {
                                    "Append_to_GroupsToAdd_-_loop": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "0d65847d-40bb-4ece-90ce-1f5ae7c6714a"
                                      },
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "GroupsToAdd",
                                        "value": "@items('Append_to_add_and_check_variables_-_loop')?['id']"
                                      }
                                    },
                                    "Append_to_GroupsToCheck_-_loop": {
                                      "runAfter": {
                                        "Append_to_GroupsToAdd_-_loop": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "f00e75a7-9fd5-4c56-a7c8-738f2299fc5b"
                                      },
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "GroupsToCheck",
                                        "value": "@items('Append_to_add_and_check_variables_-_loop')?['id']"
                                      }
                                    },
                                    "Append_to_Map_-_loop": {
                                      "runAfter": {
                                        "Append_to_GroupsToCheck_-_loop": [
                                          "Succeeded"
                                        ]
                                      },
                                      "metadata": {
                                        "operationMetadataId": "0464a5a7-04a4-4253-a036-f9418062b037"
                                      },
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "GroupID_Name_Map",
                                        "value": {
                                          "GroupName": "@items('Append_to_add_and_check_variables_-_loop')?['displayName']",
                                          "GroupID": "@items('Append_to_add_and_check_variables_-_loop')?['id']"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_array_to_Groups_not_already_in_Add_list": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "164c0939-432f-42f5-9e8a-a6819e601a01"
                                  },
                                  "type": "Foreach"
                                },
                                "Filter_array_to_non_Group_Members": {
                                  "runAfter": {
                                    "This_Team_Name": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "196b7236-e4c5-4134-8cb4-b1e00e80c57f"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@outputs('List_group_members_-_loop')?['body/value']",
                                    "where": "@not(equals(item()?['@odata.type'], '#microsoft.graph.group'))"
                                  }
                                },
                                "Add_each_user_in_group": {
                                  "foreach": "@body('Filter_array_to_non_Group_Members')",
                                  "actions": {
                                    "Append_to_ActualSrMembers_this_group": {
                                      "runAfter": {},
                                      "metadata": {
                                        "operationMetadataId": "b1b185f1-23f9-424c-bdb4-2a526bc8da91"
                                      },
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "ActualSrMembers",
                                        "value": {
                                          "Name": "@if(equals(items('Add_each_user_in_group')?['@odata.type'], '#microsoft.graph.device'), 'Device', items('Add_each_user_in_group')?['displayName'])",
                                          "UserID": "@items('Add_each_user_in_group')?['id']",
                                          "UserStatus": "Enabled",
                                          "Assigned Via": "Group",
                                          "Group Name": "@outputs('This_Team_Name')",
                                          "Group ID": "@items('Apply_to_each_group_-_loop')"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_array_to_non_Group_Members": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "27f9d96e-db8a-4a74-80cd-a8a1c4ae9872"
                                  },
                                  "type": "Foreach",
                                  "runtimeConfiguration": {
                                    "concurrency": {
                                      "repetitions": 50
                                    }
                                  }
                                },
                                "Get_Team_for_Name": {
                                  "runAfter": {
                                    "List_group_members_-_loop": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "312ad3dd-d28a-4442-8673-fefdf65751e8"
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@variables('GroupID_Name_Map')",
                                    "where": "@equals(item()?['GroupID'], items('Apply_to_each_group_-_loop'))"
                                  }
                                },
                                "This_Team_Name": {
                                  "runAfter": {
                                    "Get_Team_for_Name": [
                                      "Succeeded"
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "77ee8bfa-901c-42fd-bfe1-a38596e7bfa6"
                                  },
                                  "type": "Compose",
                                  "inputs": "@first(body('Get_Team_for_Name'))?['GroupName']"
                                }
                              },
                              "runAfter": {
                                "Clear_GroupsToCheck": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "db10d53c-5fde-404e-ab4e-d8aaf0533f61"
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Append_to_add_and_check_variables": [
                              "Succeeded"
                            ]
                          },
                          "expression": "@equals(length(variables('GroupsToCheck')), 0)",
                          "limit": {
                            "count": 60,
                            "timeout": "PT1H"
                          },
                          "metadata": {
                            "operationMetadataId": "e5179d2f-59f8-487c-869f-ff0b7559d71e"
                          },
                          "type": "Until"
                        }
                      },
                      "runAfter": {
                        "catch_-_for_now_aad_groups_only": [
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "feffdd7e-d138-486c-8faa-22dc662c5caf"
                      },
                      "type": "Scope"
                    },
                    "catch_-_for_now_aad_groups_only": {
                      "runAfter": {
                        "List_group_members": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "067742ce-a87a-485c-addf-8fdbd114e130"
                      },
                      "type": "Compose",
                      "inputs": "catch - for now aad groups only"
                    }
                  },
                  "runAfter": {
                    "Teams_with_Access": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7fec29d7-6496-4409-aaa2-61aa0c479e47"
                  },
                  "type": "Foreach"
                },
                "Parse_actual": {
                  "runAfter": {
                    "Select_actual": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c41b3296-27ee-4aea-93a9-a97daa00d7fd"
                  },
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@body('Select_actual')",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "UserName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "UserID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "AssignedVia": {
                            "type": "string"
                          },
                          "GroupName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "GroupID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "SRName": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "SRId": {
                            "type": "string"
                          },
                          "SRTemplateID": {
                            "type": [
                              "string",
                              "null"
                            ]
                          },
                          "BusinessUnitName": {
                            "type": "string"
                          },
                          "UserStatus": {
                            "type": [
                              "string",
                              "null"
                            ]
                          }
                        },
                        "required": [
                          "AssignedVia",
                          "SRName",
                          "SRId",
                          "BusinessUnitName"
                        ]
                      }
                    }
                  }
                },
                "Select_actual": {
                  "runAfter": {
                    "Apply_to_each_Team": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "6e62b214-4139-4546-8af7-bebf07ae2c3c"
                  },
                  "type": "Select",
                  "inputs": {
                    "from": "@variables('ActualSrMembers')",
                    "select": {
                      "UserName": "@item()?['Name']",
                      "UserID": "@item()?['UserID']",
                      "AssignedVia": "@item()?['Assigned Via']",
                      "GroupName": "@item()?['Group Name']",
                      "GroupID": "@item()?['Group ID']",
                      "SRName": "@triggerBody()['text_1']",
                      "SRId": "@outputs('Security_Role_ID')",
                      "SRTemplateID": "@outputs('SecurityRoleTemplateID')",
                      "BusinessUnitName": "@outputs('Business_Unit_Name')",
                      "UserStatus": "@item()?['UserStatus']"
                    }
                  }
                },
                "Filter_actual": {
                  "runAfter": {
                    "Parse_actual": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "0ff3f36c-6231-4fc1-8232-9e9cd58f7ce2"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_actual')",
                    "where": "@not(equals(item()['UserName'], null))"
                  }
                },
                "Direct_System_User_Access": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "99bceb37-81f2-4d61-aca4-7e649b9b34b4"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecordsWithOrganization",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                      "entityName": "systemusers",
                      "$select": "fullname, azureactivedirectoryobjectid, isdisabled",
                      "$filter": "(systemuserroles_association/any(o1:(o1/name eq '@{outputs('Security_Role_Display_Name')}')))"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "Teams_with_Access": {
                  "runAfter": {
                    "Apply_to_each_Direct_Access": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "aeaaf458-24be-4592-8c13-77f853d70e55"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecordsWithOrganization",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                      "entityName": "teams",
                      "$select": "azureactivedirectoryobjectid",
                      "$filter": "_businessunitid_value eq '@{triggerBody()['text_2']}' and teamtype ne 0 and teamtype ne 1 and (teamroles_association/any(o1:(o1/name eq '@{outputs('Security_Role_Display_Name')}')))"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                }
              },
              "runAfter": {
                "get_basics_and_early_exit_if_inaccessible": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "2a694e49-8966-4cbb-bda9-5e6882c1711e"
              },
              "type": "Scope"
            },
            "get_basics_and_early_exit_if_inaccessible": {
              "actions": {
                "Get_EnvtMetadataName": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "8312d2c8-6e84-4cce-bf81-5d92991eaf3d"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_environments",
                      "recordId": "@triggerBody()['text']"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "if_no_or_inaccessible_tables_": {
                  "actions": {
                    "Set_SRsInaccessible_true_-_envt_properties": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "db8b67ca-da67-4982-bdac-7972d26aa6c1"
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "SRsInaccessible",
                        "value": "@true"
                      }
                    }
                  },
                  "runAfter": {
                    "Get_EnvtMetadataName": [
                      "Succeeded"
                    ]
                  },
                  "expression": {
                    "equals": [
                      "@outputs('Get_EnvtMetadataName')?['body/admin_hascds']",
                      false
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7ca6f863-9bdd-4ece-a20e-7bcef43aec6b"
                  },
                  "type": "If"
                },
                "Security_Role_Display_Name": {
                  "runAfter": {
                    "SecurityRoleTemplateID": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "0a1d4b62-ea71-4409-81f9-c128a8e122f5"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('Get_SR')?['body/value'])['name']"
                },
                "Security_Role_ID": {
                  "runAfter": {
                    "RemoveSpecialCharactersBU": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a788d140-5c9c-428b-8ac3-4cf2b135c558"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('Get_SR')?['body/value'])['roleid']"
                },
                "Set_SRsInaccessible_true_-_failed_to_get_SR": {
                  "runAfter": {
                    "Get_SR": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "74f3e7e5-dd3a-466d-b6aa-49777677a6cb"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SRsInaccessible",
                    "value": "@true"
                  }
                },
                "see_if_need_to_exit_early": {
                  "actions": {
                    "Respond_to_a_PowerApp_or_flow_early_exit": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "205f8f3e-da0a-46cb-a7ce-2df5a6580667"
                      },
                      "type": "Response",
                      "kind": "PowerApp",
                      "inputs": {
                        "statusCode": 200,
                        "body": {
                          "called": "pass"
                        },
                        "schema": {
                          "type": "object",
                          "properties": {
                            "called": {
                              "title": "Called",
                              "x-ms-dynamically-added": true,
                              "type": "string"
                            }
                          }
                        }
                      }
                    },
                    "Terminate_-_cannot_get_values": {
                      "runAfter": {
                        "Respond_to_a_PowerApp_or_flow_early_exit": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "611fc439-c983-4f36-b07e-8f9783c547d7"
                      },
                      "type": "Terminate",
                      "inputs": {
                        "runStatus": "Succeeded"
                      }
                    }
                  },
                  "runAfter": {
                    "Set_SRsInaccessible_true_-_failed_to_get_BU": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "expression": {
                    "equals": [
                      "@variables('SRsInaccessible')",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "cca1b881-dd5f-4e62-94d0-9c76bd74266c"
                  },
                  "type": "If"
                },
                "Set_SRsInaccessible_true_-_failed_to_get_BU": {
                  "runAfter": {
                    "Get_BU": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "74f3e7e5-dd3a-466d-b6aa-49777677a6cb"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SRsInaccessible",
                    "value": "@true"
                  }
                },
                "Business_Unit_Name": {
                  "runAfter": {
                    "Security_Role_Display_Name": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "fd5fc424-988b-454b-8e44-f0ef0887ea87"
                  },
                  "type": "Compose",
                  "inputs": "@first(outputs('Get_BU')?['body/value'])['name']"
                },
                "RemoveSpecialCharactersBU": {
                  "runAfter": {
                    "Business_Unit_Name": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c50cd7f4-c96d-4e9b-84d2-68d210273139"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(outputs('Business_Unit_Name'), null), null, replace(outputs('Business_Unit_Name'), '''', ''''''))"
                },
                "Get_SR": {
                  "runAfter": {
                    "SRID_for_fetch": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "2bd7b631-3e58-488a-9107-4eb67f88f769"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecordsWithOrganization",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                      "entityName": "roles",
                      "$filter": "roleid eq '@{outputs('SRID_for_fetch')}' and _businessunitid_value eq '@{triggerBody()['text_2']}'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "Get_BU": {
                  "runAfter": {
                    "Set_SRsInaccessible_true_-_failed_to_get_SR": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "2bd7b631-3e58-488a-9107-4eb67f88f769"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps_2",
                      "operationId": "ListRecordsWithOrganization",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                      "entityName": "businessunits",
                      "$filter": "businessunitid eq '@{triggerBody()['text_2']}'"
                    },
                    "authentication": {
                      "type": "Raw",
                      "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                    }
                  }
                },
                "Get_Role_based_on_Type": {
                  "actions": {
                    "Get_SR_by_TID": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "2bd7b631-3e58-488a-9107-4eb67f88f769"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_commondataserviceforapps_2",
                          "operationId": "ListRecordsWithOrganization",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                        },
                        "parameters": {
                          "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                          "entityName": "roles",
                          "$select": "roleid",
                          "$filter": "_roletemplateid_value eq '@{triggerBody()['text_3']}' and _businessunitid_value eq '@{triggerBody()['text_2']}'"
                        },
                        "authentication": {
                          "type": "Raw",
                          "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                        }
                      }
                    },
                    "Set_SRsInaccessible_true_-_failed_to_get_SR_by_TID": {
                      "runAfter": {
                        "Get_SR_by_TID": [
                          "Failed"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "74f3e7e5-dd3a-466d-b6aa-49777677a6cb"
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "SRsInaccessible",
                        "value": "@true"
                      }
                    }
                  },
                  "runAfter": {
                    "if_no_or_inaccessible_tables_": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Get_SR_by_Name": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "2bd7b631-3e58-488a-9107-4eb67f88f769"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_commondataserviceforapps_2",
                            "operationId": "ListRecordsWithOrganization",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                          },
                          "parameters": {
                            "organization": "@outputs('Get_EnvtMetadataName')?['body/admin_environmentcdsinstanceurl']",
                            "entityName": "roles",
                            "$select": "roleid",
                            "$filter": "name eq '@{triggerBody()['text_1']}' and _businessunitid_value eq '@{triggerBody()['text_2']}'"
                          },
                          "authentication": {
                            "type": "Raw",
                            "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                          }
                        }
                      },
                      "Set_SRsInaccessible_true_-_failed_to_get_SR_by_Name": {
                        "runAfter": {
                          "Get_SR_by_Name": [
                            "Failed"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "74f3e7e5-dd3a-466d-b6aa-49777677a6cb"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "SRsInaccessible",
                          "value": "@true"
                        }
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@triggerBody()['boolean']",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "d3fc5f83-7eb1-42a2-b0c8-bfd639babd7c"
                  },
                  "type": "If"
                },
                "SRID_for_fetch": {
                  "runAfter": {
                    "Get_Role_based_on_Type": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "d054ad93-f3c5-418b-955a-5d11e75b7098"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(triggerBody()['boolean'], true), if(equals(length(outputs('Get_SR_by_TID')?['body/value']), 0), 'unknown', first(outputs('Get_SR_by_TID')?['body/value'])['roleid']), if(equals(length(outputs('Get_SR_by_Name')?['body/value']), 0), 'unknown', first(outputs('Get_SR_by_Name')?['body/value'])['roleid']))"
                },
                "SecurityRoleTemplateID": {
                  "runAfter": {
                    "see_if_need_to_exit_early": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "d23b1e7b-a00e-4d79-95f0-1940db45fc34"
                  },
                  "type": "Compose",
                  "inputs": "@if(equals(triggerBody()['boolean'], true), triggerBody()['text_3'], '')"
                }
              },
              "runAfter": {
                "assumes_all_records_have_a_BU_and_a_user_name": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "df1e0810-84d7-4894-b2f6-458a43d394c1"
              },
              "type": "Scope"
            },
            "assumes_all_records_have_a_BU_and_a_user_name": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "55ded974-2e86-4170-b7df-f273616e3c89"
              },
              "type": "Compose",
              "inputs": "assumes all records have a BU and a user name"
            }
          },
          "runAfter": {
            "Initialize_SRsInaccessible": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "8e197d49-aa41-483b-8e2c-8456d51260cb"
          },
          "type": "Scope"
        },
        "Initialize_ActualSrMembers": {
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "62b42c59-3fb6-4053-93b9-b9b663d36172"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ActualSrMembers",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_GroupsToAdd": {
          "runAfter": {
            "Initialize_ActualSrMembers": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "e9686eff-0c33-4fc3-aa39-10545d96b361"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "GroupsToAdd",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_GroupsToCheck": {
          "runAfter": {
            "Initialize_GroupsToAdd": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "661fb040-faba-454a-a399-eb9b078341d2"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "GroupsToCheck",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_GroupID_Name_Map": {
          "runAfter": {
            "Initialize_GroupsToCheck": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "6bce275b-d3b2-48e9-b714-025a3798b93c"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "GroupID_Name_Map",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_tempVar": {
          "runAfter": {
            "Initialize_GroupID_Name_Map": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "108b214a-e423-4992-932d-18527c54ec63"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "tempVar",
                "type": "array"
              }
            ]
          }
        },
        "Error_Handling": {
          "actions": {
            "Terminate": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500",
                  "message": "Get Environments Failed"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Respond_to_a_PowerApp_or_flow_-_failed": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "205f8f3e-da0a-46cb-a7ce-2df5a6580667"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "called": "fail"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "called": {
                      "title": "Called",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            },
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow_-_failed": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_environmentname": "@{outputs('Get_EnvtMetadataName')?['body/admin_displayname']} - @{first(outputs('Get_SR')?['body/value'])?['name']} - @{first(outputs('Get_BU')?['body/value'])?['name']}",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            }
          },
          "runAfter": {
            "Get_Security_Role_Users": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date"
            },
            "Respond_to_a_PowerApp_or_flow": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "205f8f3e-da0a-46cb-a7ce-2df5a6580667"
              },
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "statusCode": 200,
                "body": {
                  "called": "pass"
                },
                "schema": {
                  "type": "object",
                  "properties": {
                    "called": {
                      "title": "Called",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  }
                }
              }
            },
            "Get_ID_Pass": {
              "runAfter": {
                "Respond_to_a_PowerApp_or_flow": [
                  "Succeeded",
                  "Skipped"
                ]
              },
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "authentication": {
                  "type": "Raw",
                  "value": "@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"
                }
              }
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Initialize_SRsInaccessible": {
          "runAfter": {
            "Initialize_tempVar": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "5ec710c0-ca66-4549-897c-3b6138c8b21a"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "SRsInaccessible",
                "type": "boolean",
                "value": "@false"
              }
            ]
          }
        }
      }
    },
    "templateName": ""
  },
  "schemaVersion": "1.0.0.0"
}