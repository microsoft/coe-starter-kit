{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_powerplatformforadmins_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECorePowerPlatformforAdmins"
        },
        "api": {
          "name": "shared_powerplatformforadmins"
        }
      },
      "shared_commondataserviceforapps_2": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_3": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_sharedcommondataserviceforapps_98924"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Also Delete From CoE (admin_DeleteFromCoE)": {
          "defaultValue": "yes",
          "type": "String",
          "metadata": {
            "schemaName": "admin_DeleteFromCoE",
            "description": "Inventory - when we run \"Admin | Sync Template v4 (Check Deleted)\", delete the items from CoE (yes) or just mark deleted (no)"
          }
        },
        "Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)": {
          "defaultValue": "https://flow.microsoft.com/manage/environments/",
          "type": "String",
          "metadata": {
            "schemaName": "admin_PowerAutomateEnvironmentVariable",
            "description": "Inventory - REQUIRED. Environment, including geographic location, for Power Automate - Ex for commercial: https://flow.microsoft.com/manage/environments/"
          }
        },
        "DelayInventory (admin_DelayInventory)": {
          "defaultValue": false,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_DelayInventory",
            "description": "Inventory - If Yes, will run a delay step to assist with the Dataverse health. Only turn to No for debugging. "
          }
        }
      },
      "triggers": {
        "Recurrence": {
          "recurrence": {
            "frequency": "Week",
            "interval": 1,
            "schedule": {
              "weekDays": [
                "Sunday"
              ],
              "hours": [
                "12"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "1309ceff-cca9-4e22-a480-7ab3e793bddd"
          },
          "type": "Recurrence"
        }
      },
      "actions": {
        "Initialize_DeleteFromCoE": {
          "runAfter": {
            "Delay_Inventory": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "86218be8-8f1e-486b-ac72-d181fd12591f"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "DeleteFromCoE",
                "type": "boolean",
                "value": "@if(equals(tolower(parameters('Also Delete From CoE (admin_DeleteFromCoE)')), 'yes'), true, false)"
              }
            ]
          }
        },
        "Error_Handling": {
          "actions": {
            "Create_a_new_record_-_Sync_Flow_Errors": {
              "metadata": {
                "operationMetadataId": "87961ff0-e261-4890-9ab9-a53f88fe0de5"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_syncflowerrorses",
                  "item/admin_name": "@workflow()?['tags']['flowDisplayName']",
                  "item/admin_flowinstanceurl": "@concat(parameters('Power Automate Environment Variable (admin_PowerAutomateEnvironmentVariable)'), workflow()?['tags']['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']['name'])"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                },
                "retryPolicy": {
                  "type": "exponential",
                  "count": 10,
                  "interval": "PT10S"
                }
              }
            },
            "Terminate": {
              "runAfter": {
                "Update_Last_Run_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9e5a2a18-dba2-47a1-96d5-3356f4348e5a"
              },
              "type": "Terminate",
              "inputs": {
                "runStatus": "Failed",
                "runError": {
                  "code": "500"
                }
              }
            },
            "Get_ID_Fail": {
              "runAfter": {
                "Create_a_new_record_-_Sync_Flow_Errors": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "47329bf2-8aac-400d-9778-a793b4f1180f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              }
            },
            "Update_Last_Run_Fail": {
              "runAfter": {
                "Get_ID_Fail": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c63eb7cc-6101-4567-b520-a4a8881264e9"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Fail')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": false
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              }
            }
          },
          "runAfter": {
            "Check_Deleted_Scope": [
              "Failed"
            ]
          },
          "metadata": {
            "operationMetadataId": "38ae684e-622d-42ea-abd2-ee571aee3a5f"
          },
          "type": "Scope"
        },
        "Update_last_run_as_pass": {
          "actions": {
            "Update_Last_Run_Successful": {
              "runAfter": {
                "Get_ID_Pass": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "78ef70e5-7f67-4737-9a02-8533f12caa19"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "recordId": "@first(outputs('Get_ID_Pass')?['body/value'])?['admin_coesolutionmetadataid']",
                  "item/admin_lastrun": "@utcNow()",
                  "item/admin_lastrunpassed": true
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              }
            },
            "Get_ID_Pass": {
              "metadata": {
                "operationMetadataId": "f4f314b6-89d3-4056-af1c-73115e7d6bd1"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "admin_coesolutionmetadatas",
                  "$select": "admin_coesolutionmetadataid",
                  "$filter": "admin_objectname eq '@{workflow()?['tags']['flowDisplayName']}'",
                  "$top": 1
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "connectionName": "shared_commondataserviceforapps"
                }
              }
            },
            "Catch_-_not_ready_to_take_last_run_date": {
              "runAfter": {
                "Update_Last_Run_Successful": [
                  "Failed"
                ]
              },
              "metadata": {
                "operationMetadataId": "f88cdefe-c402-49d7-8f4a-934475e6f741"
              },
              "type": "Compose",
              "inputs": "Catch - not ready to take last run date"
            }
          },
          "runAfter": {
            "Error_Handling": [
              "Skipped"
            ]
          },
          "metadata": {
            "operationMetadataId": "5c140442-d939-4ca4-8ec8-d1ee2bed4a81"
          },
          "type": "Scope"
        },
        "Check_Deleted_Scope": {
          "actions": {
            "Get_Basics": {
              "actions": {
                "Get_Environments": {
                  "metadata": {
                    "operationMetadataId": "df9ec811-25ed-4574-a7be-c4537561ea3b"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "api-version": "2020-09-01"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_powerplatformforadmins",
                      "operationId": "Get-AdminEnvironment",
                      "connectionName": "shared_powerplatformforadmins_1"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "CurrentEnvtInventory": {
                  "runAfter": {
                    "Get_Environments": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7c47d9de-dc3c-460c-a5a1-ec0b68e0a831"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_environments",
                      "$select": "admin_environmentid, admin_environmentsku, admin_environmentname, admin_environmentdeletedon",
                      "$filter": "admin_environmentdeleted eq false"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps_2"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                }
              },
              "metadata": {
                "operationMetadataId": "ce2b2a01-54a3-493a-a425-a3a096fabf14"
              },
              "type": "Scope"
            },
            "Deleted_Environments": {
              "actions": {
                "Mark_deleted": {
                  "foreach": "@body('DeletedEnvts')",
                  "actions": {
                    "Find_it_for_GUID": {
                      "metadata": {
                        "operationMetadataId": "e3e70db2-e0db-4ae1-84d3-c6ce5c58f6b2"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_environments",
                          "$select": "admin_environmentid",
                          "$filter": "admin_environmentname eq '@{items('Mark_deleted')?['EnvtName']}'"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps_3"
                        },
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 20,
                          "interval": "PT20S"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "If_found_mark_deleted": {
                      "actions": {
                        "GUID_to_Delete": {
                          "metadata": {
                            "operationMetadataId": "6018d853-c38a-49a0-88d4-df485285b7d8"
                          },
                          "type": "Compose",
                          "inputs": "@first(outputs('Find_it_for_GUID')?['body/value'])?['admin_environmentid']"
                        },
                        "Mark_record_deleted": {
                          "runAfter": {
                            "GUID_to_Delete": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "e2f75959-76cd-4098-8c45-4cd839721198"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_environments",
                              "recordId": "@outputs('GUID_to_Delete')",
                              "item/admin_environmentdeleted": true,
                              "item/admin_environmentdeletedon": "@utcNow()"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "UpdateRecord",
                              "connectionName": "shared_commondataserviceforapps_3"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Find_it_for_GUID": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {}
                      },
                      "expression": {
                        "greater": [
                          "@length(outputs('Find_it_for_GUID')?['body/value'])",
                          0
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "5e4c45c8-c39c-4008-be30-46da7f5cc80f"
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {
                    "DeletedEnvts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "6db8b7e6-0fdd-4817-b396-693634e27477"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "DeletedEnvts": {
                  "runAfter": {
                    "Get_Actual_-_Deleted_Envts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "ec8ebf56-f3e3-4251-9491-440c69d207e4"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_Inventory_-_Deleted_Envts')",
                    "where": "@not(contains(body('Parse_Actual_-_Deleted_Envts'), item()))"
                  }
                },
                "Get_Actual_-_Deleted_Envts": {
                  "actions": {
                    "Select_Actual_-_Deleted_Envts": {
                      "metadata": {
                        "operationMetadataId": "8410edf3-be25-420e-9c3d-d5c2a4d8ef20"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('Get_Environments')?['body/value']",
                        "select": {
                          "EnvtName": "@item()?['name']"
                        }
                      }
                    },
                    "Parse_Actual_-_Deleted_Envts": {
                      "runAfter": {
                        "Select_Actual_-_Deleted_Envts": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "bb1cea14-82ae-4c5e-93a4-66f7d675861e"
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Select_Actual_-_Deleted_Envts')",
                        "schema": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "EnvtName": {
                                "type": "string"
                              }
                            },
                            "required": [
                              "EnvtName"
                            ]
                          }
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Get_Inventory_-_Deleted_Envts": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "7343aee1-301c-4197-a13f-d3e6968adc8b"
                  },
                  "type": "Scope"
                },
                "Get_Inventory_-_Deleted_Envts": {
                  "actions": {
                    "Select_Inventory_-_Deleted_Envts": {
                      "metadata": {
                        "operationMetadataId": "d9864193-358e-4194-9acd-28dab1de4882"
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@outputs('CurrentEnvtInventory')?['body/value']",
                        "select": {
                          "EnvtName": "@item()?['admin_environmentname']"
                        }
                      }
                    },
                    "Parse_Inventory_-_Deleted_Envts": {
                      "runAfter": {
                        "Select_Inventory_-_Deleted_Envts": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "274daa1f-66a7-4bf4-be08-c3a0e2f758d7"
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Select_Inventory_-_Deleted_Envts')",
                        "schema": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "EnvtName": {
                                "type": "string"
                              }
                            },
                            "required": [
                              "EnvtName"
                            ]
                          }
                        }
                      }
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "61117d90-0e7a-40c6-8484-f0212a2b0cc4"
                  },
                  "type": "Scope"
                }
              },
              "runAfter": {
                "Get_Basics": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "de0550c1-ea17-43aa-b1c5-cd092ef8f517"
              },
              "type": "Scope"
            },
            "Clean_up_branch": {
              "runAfter": {
                "Deleted_Environments": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "e9c4286a-0b90-4dc9-9792-b3f28d960aa4"
              },
              "type": "Compose",
              "inputs": "this side is doing a bunch of cleanup work"
            },
            "Remove_old_deleted_items_from_CoE_inventory": {
              "actions": {
                "Check_if_they_want_to_delete_from_CoE": {
                  "actions": {
                    "Delete_Each_Environment": {
                      "foreach": "@outputs('List_Envts_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_Environment": {
                          "metadata": {
                            "operationMetadataId": "2220c6f4-76a0-49d6-bd1f-6d50b3f5ffdb"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_environments",
                              "recordId": "@items('Delete_Each_Environment')?['admin_environmentid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Envts_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "20c570c3-b601-4fc2-b69f-4abdf1d6b459"
                      },
                      "type": "Foreach"
                    },
                    "Delete_Each_Flow": {
                      "foreach": "@outputs('List_Flows_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_Flow": {
                          "metadata": {
                            "operationMetadataId": "65d87cb0-1ef5-4cde-9805-8da80102b6a7"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_flows",
                              "recordId": "@items('Delete_Each_Flow')?['admin_flowid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Flows_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c87fb516-ffa5-4e82-84ad-a29974070886"
                      },
                      "type": "Foreach"
                    },
                    "Delete_Each_Flow_Action": {
                      "foreach": "@outputs('List_Flow_Actions_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_Flow_Action": {
                          "metadata": {
                            "operationMetadataId": "75984ee3-9717-4d38-99b4-ecc07de1fae5"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_flowactiondetails",
                              "recordId": "@items('Delete_Each_Flow_Action')?['admin_flowactiondetailid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Flow_Actions_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "bcb382f6-cc7e-4e95-956c-06b8855e5a98"
                      },
                      "type": "Foreach"
                    },
                    "Delete_Each_PVA": {
                      "foreach": "@outputs('List_PVAs_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_PVA": {
                          "metadata": {
                            "operationMetadataId": "0b45cc2f-97a8-4ddc-bcf2-d0850204cf86"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_pvas",
                              "recordId": "@items('Delete_Each_PVA')?['admin_pvaid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_PVAs_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "7c2652c6-ec6f-4179-b52e-5025f50ed552"
                      },
                      "type": "Foreach"
                    },
                    "List_Envts_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_Model": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "01d667b6-6242-4f0a-b6de-5b99f83f9dbd"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_environments",
                          "$select": "admin_environmentid",
                          "$filter": "admin_environmentdeleted eq true and admin_environmentdeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "List_Flow_Actions_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_Flow": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "63bf55ff-77d2-4957-b437-bddd1ac1d9f6"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_flowactiondetails",
                          "$select": "admin_flowactiondetailid",
                          "$filter": "admin_flowactiondetaildeleted eq true and admin_flowactiondetaildeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "List_Flows_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_BPF": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "61b9b48f-499a-4e03-b70a-ba50a2c10df3"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_flows",
                          "$select": "admin_flowid",
                          "$filter": "admin_flowdeleted eq true and admin_flowdeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "List_PVAs_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_Flow_Action": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "3da35011-b120-4432-9414-a6144b42be2a"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_pvas",
                          "$select": "admin_pvaid",
                          "$filter": "admin_pvadeleted eq true and admin_pvadeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "List_BPFs_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_App": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "28c44cda-d5b8-40b9-82f0-8676978e02b5"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_businessprocessflowses",
                          "$select": "admin_businessprocessflowsid",
                          "$filter": "admin_businessprocessflowdeleted eq true and admin_businessprocessflowdeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps_1"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Delete_Each_BPF": {
                      "foreach": "@outputs('List_BPFs_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_BPF": {
                          "metadata": {
                            "operationMetadataId": "48d1bde4-b912-4b9a-9ecc-a92a053da035"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_businessprocessflowses",
                              "recordId": "@items('Delete_Each_BPF')?['admin_businessprocessflowsid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps_1"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_BPFs_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "75c73087-1dd8-4290-bc6c-9d71d433dcf1"
                      },
                      "type": "Foreach"
                    },
                    "Delete_Each_Solution": {
                      "foreach": "@outputs('List_Solutions_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_Solution": {
                          "metadata": {
                            "operationMetadataId": "11efa780-a23d-4003-a1aa-b3985fdb08f4"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_solutions",
                              "recordId": "@items('Delete_Each_Solution')?['admin_solutionid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps_1"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Solutions_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "65e10bdb-b655-4c6f-afa0-eaa2eec5b55e"
                      },
                      "type": "Foreach"
                    },
                    "List_Solutions_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_PVA": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "01d667b6-6242-4f0a-b6de-5b99f83f9dbd"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_solutions",
                          "$select": "admin_solutionid",
                          "$filter": "admin_solutiondeleted eq true and admin_solutiondeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "List_Models_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Delete_Each_Solution": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "825642bc-9a28-41fd-8886-b34e452c83a6"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_aibuildermodels",
                          "$select": "admin_aibuildermodelid",
                          "$filter": "admin_aideleted eq true and admin_aideletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Delete_Each_Model": {
                      "foreach": "@outputs('List_Models_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_Model": {
                          "metadata": {
                            "operationMetadataId": "dae29cbc-1654-4798-8a5d-093657969192"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_aibuildermodels",
                              "recordId": "@items('Delete_Each_Model')?['admin_aibuildermodelid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Models_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "6ab2ab5c-41a4-4eb9-8314-baa3d1302cc2"
                      },
                      "type": "Foreach"
                    },
                    "Delete_Each_App": {
                      "foreach": "@outputs('List_Apps_Marked_Deleted_To_Delete')?['body/value']",
                      "actions": {
                        "Delete_App": {
                          "metadata": {
                            "operationMetadataId": "54d6934e-e2e6-46c8-93b9-c869882b00e4"
                          },
                          "type": "OpenApiConnection",
                          "inputs": {
                            "parameters": {
                              "entityName": "admin_apps",
                              "recordId": "@items('Delete_Each_App')?['admin_appid']"
                            },
                            "host": {
                              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                              "operationId": "DeleteRecord",
                              "connectionName": "shared_commondataserviceforapps"
                            },
                            "retryPolicy": {
                              "type": "exponential",
                              "count": 10,
                              "interval": "PT10S"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "List_Apps_Marked_Deleted_To_Delete": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "992de43a-1ac0-4f7b-8c46-98740496eaf9"
                      },
                      "type": "Foreach"
                    },
                    "List_Apps_Marked_Deleted_To_Delete": {
                      "runAfter": {
                        "Get_old_deletes_time": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "302736ff-0ca3-438a-9841-1f095783dad6"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_apps",
                          "$select": "admin_appid",
                          "$filter": "admin_appdeleted eq true and admin_appdeletedon lt @{body('Get_old_deletes_time')}"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "ListRecords",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "runtimeConfiguration": {
                        "paginationPolicy": {
                          "minimumItemCount": 100000
                        }
                      }
                    },
                    "Get_old_deletes_time": {
                      "metadata": {
                        "operationMetadataId": "26a71c88-67da-4ac8-aa96-dcb8fd628069"
                      },
                      "type": "Expression",
                      "kind": "GetPastTime",
                      "inputs": {
                        "interval": 2,
                        "timeUnit": "Month"
                      }
                    }
                  },
                  "else": {
                    "actions": {}
                  },
                  "expression": {
                    "equals": [
                      "@variables('DeleteFromCoE')",
                      "@true"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "8e34a6de-0863-44b0-8ef3-bd5d5ae66d7c"
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "Clean_up_branch": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "2f5b781f-79ef-4856-8fd4-c3aa6372445c"
              },
              "type": "Scope",
              "description": "If set to clean up old deletes do that for things marked delete gt 2 months ago"
            },
            "Environment_Marked_Deleted": {
              "actions": {
                "List_Solns_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_AiModels_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3b50cd16-059b-4dcc-ba77-081a5e1ca69a"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_solutions",
                      "$select": "admin_solutionid",
                      "$filter": "admin_solutiondeleted ne true and admin_SolutionEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Mark_Solns_Deleted": {
                  "foreach": "@outputs('List_Solns_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_Soln_Deleted": {
                      "metadata": {
                        "operationMetadataId": "ffadd678-30e2-495e-9ad3-e7ea0ffc1386"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_solutions",
                          "recordId": "@items('Mark_Solns_Deleted')?['admin_solutionid']",
                          "item/admin_solutiondeleted": true,
                          "item/admin_solutiondeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Solns_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "99436055-161e-4f25-bd93-2d2731b2de78"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_BPFs_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_Solns_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "d1a6b2aa-e468-4af4-93d2-71a890b16cfb"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_businessprocessflowses",
                      "$select": "admin_businessprocessflowsid",
                      "$filter": "admin_businessprocessflowdeleted ne true and admin_BusinessProcessFlowEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    }
                  }
                },
                "Mark_BPFs_Deleted": {
                  "foreach": "@outputs('List_BPFs_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_BPF_Deleted": {
                      "metadata": {
                        "operationMetadataId": "e0b767ce-979f-40cc-914a-50212b6380e0"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_businessprocessflowses",
                          "recordId": "@items('Mark_BPFs_Deleted')?['admin_businessprocessflowsid']",
                          "item/admin_businessprocessflowdeleted": true,
                          "item/admin_businessprocessflowdeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_BPFs_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "50c96b44-345d-430b-8067-6dc5227a03b5"
                  },
                  "type": "Foreach"
                },
                "List_Desktop_Flows_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_BPFs_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "d1a6b2aa-e468-4af4-93d2-71a890b16cfb"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_rpas",
                      "$select": "admin_rpaid",
                      "$filter": "admin_rpadeleted ne true and admin_DesktopflowEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    }
                  }
                },
                "Mark_Desktop_Flows_Deleted": {
                  "foreach": "@outputs('List_Desktop_Flows_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_Desktop_Flow_Deleted": {
                      "metadata": {
                        "operationMetadataId": "683a8ac5-09ae-418e-9edd-ff5be10edc50"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_rpas",
                          "recordId": "@items('Mark_Desktop_Flows_Deleted')?['admin_rpaid']",
                          "item/admin_rpadeleted": true,
                          "item/admin_rpadeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Desktop_Flows_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "47576a0d-e1ab-489c-81ee-afd97f469d4b"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_Custom_Connection_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_Desktop_Flows_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a822f38c-1864-4a13-84a8-37e5c41c1f10"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_connectors",
                      "$select": "admin_connectorid",
                      "$filter": "admin_connectordeleted ne true and admin_EnvironmentCustomConnector/admin_environmentdeleted eq true and admin_iscustomapi eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Mark_Custom_Connection_Deleted": {
                  "foreach": "@outputs('List_Custom_Connection_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_Custom_Connection_as_Deleted": {
                      "metadata": {
                        "operationMetadataId": "42380516-a9ff-452d-8b7a-b564618c7ab9"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_connectors",
                          "recordId": "@items('Mark_Custom_Connection_Deleted')?['admin_connectorid']",
                          "item/admin_connectordeleted": true,
                          "item/admin_connectordeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Custom_Connection_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e66f5aeb-4fc1-4ed1-843c-4abffd52eb9c"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_Bots_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_Custom_Connection_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1ef1e7bf-102f-418f-b028-ea0bbf08d221"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_pvas",
                      "$select": "admin_pvaid",
                      "$filter": "admin_pvadeleted ne true and admin_PVAEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Mark_Bots_Deleted": {
                  "foreach": "@outputs('List_Bots_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_Bot_Deleted": {
                      "metadata": {
                        "operationMetadataId": "550f40ef-40f5-40d2-b9dc-8988e5bd2e11"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_pvas",
                          "recordId": "@items('Mark_Bots_Deleted')?['admin_pvaid']",
                          "item/admin_pvadeleted": true,
                          "item/admin_pvadeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Bots_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "abdf3ded-beef-4b54-b625-289adb2439b6"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_AiModels_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_Flows_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3b50cd16-059b-4dcc-ba77-081a5e1ca69a"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_aibuildermodels",
                      "$select": "admin_aibuildermodelid",
                      "$filter": "admin_aideleted ne true and admin_AiEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Mark_AiModels_Deleted": {
                  "foreach": "@outputs('List_AiModels_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_AiModel_Deleted": {
                      "metadata": {
                        "operationMetadataId": "12154320-38bd-4a6d-9ada-bab2e239c4a5"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_aibuildermodels",
                          "recordId": "@items('Mark_AiModels_Deleted')?['admin_aibuildermodelid']",
                          "item/admin_aideleted": true,
                          "item/admin_aideletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_AiModels_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "99436055-161e-4f25-bd93-2d2731b2de78"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "Mark_Flows_Deleted": {
                  "foreach": "@outputs('List_Flow_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_Flow_Deleted": {
                      "metadata": {
                        "operationMetadataId": "885b5faa-0369-4bbb-981c-6956bc7baaf1"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_flows",
                          "recordId": "@items('Mark_Flows_Deleted')?['admin_flowid']",
                          "item/admin_flowdeleted": true,
                          "item/admin_flowdeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Flow_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "a73b3d78-661c-47ab-a7c1-e563525d4c1b"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_Flow_with_Environment_Marked_Deleted": {
                  "runAfter": {
                    "Mark_Apps_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "709748e0-aa9b-4929-9686-9c3219628faf"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_flows",
                      "$select": "admin_flowid",
                      "$filter": "admin_flowdeleted ne true and admin_FlowEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                },
                "Mark_Apps_Deleted": {
                  "foreach": "@outputs('List_Apps_with_Environment_Marked_Deleted')?['body/value']",
                  "actions": {
                    "Mark_App_Deleted": {
                      "metadata": {
                        "operationMetadataId": "4440438d-c71a-4984-8481-b033c543ca73"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "admin_apps",
                          "recordId": "@items('Mark_Apps_Deleted')?['admin_appid']",
                          "item/admin_appdeleted": true,
                          "item/admin_appdeletedon": "@utcNow()"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "UpdateRecord",
                          "connectionName": "shared_commondataserviceforapps_2"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_Apps_with_Environment_Marked_Deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "8dd95172-956f-4eea-b3b8-54ed2a82e270"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_Apps_with_Environment_Marked_Deleted": {
                  "metadata": {
                    "operationMetadataId": "3b50cd16-059b-4dcc-ba77-081a5e1ca69a"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_apps",
                      "$select": "admin_appid",
                      "$filter": "admin_appdeleted ne true and admin_AppEnvironment/admin_environmentdeleted eq true"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                }
              },
              "runAfter": {
                "Remove_old_deleted_items_from_CoE_inventory": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "44cd3fae-4e15-49b5-b1a9-1cfec29e0f4a"
              },
              "type": "Scope"
            },
            "Deleted_Objects_in_Existing_Environments": {
              "actions": {
                "Apply_to_each_environment": {
                  "foreach": "@outputs('List_CoE_Environments_not_marked_deleted')?['body/value']",
                  "actions": {
                    "Call_each_object_type_helper_for_this_environment": {
                      "metadata": {
                        "operationMetadataId": "7a969d84-fb74-428a-a3d0-2f4bdfb17a58"
                      },
                      "type": "Compose",
                      "inputs": "Call each object type helper for this environment"
                    },
                    "Call_Custom_Connector_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "11cfe8d8-8e77-41af-b767-2498fea9e0ff"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "2b878801-21ac-ee11-be37-000d3a3411d9"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_Canvas_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "5010d1c4-babf-42c8-a935-9a9dbbd97acc"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "d8cdff83-d68f-ee11-8179-000d3a341fff"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_Cloud_Flows_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "c692c61f-9768-49d3-b9a0-03bdebe38c99"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "e15181fb-5590-ee11-8179-000d3a341b0e"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_MDA_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "147f2b96-7c9a-41e6-840a-f35e1ea705e1"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "5c1d1891-d68f-ee11-8179-000d3a341fff"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_PVA_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "77bc805d-53b8-4caf-93f9-4995956df05f"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "7b2c0ee8-7e93-ee11-be37-000d3a341d27"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_BPF_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "769325e0-d4b7-4d72-a4a1-ac58b8dbf641"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "2a285d04-4c94-ee11-be37-000d3a341fff"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_AiModel_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "2e6af1c1-5690-4f1d-93bd-1534b24859b7"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "ae6e90ed-4b94-ee11-be37-000d3a341fff"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_Soln_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "2e6af1c1-5690-4f1d-93bd-1534b24859b7"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "3f5c06d9-8494-ee11-be37-000d3a341b0e"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_RPA_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "cb2d2eaf-e74a-4fdc-9604-1598f26711d8"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "fb942241-a794-ee11-be37-000d3a341d27"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    },
                    "Call_Portal_Helper_-_check_deleted": {
                      "runAfter": {
                        "Call_each_object_type_helper_for_this_environment": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "45e9618b-a080-4a4c-ada8-da2fb183a34b"
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "workflowReferenceName": "abb45c39-a794-ee11-be37-000d3a3411d9"
                        },
                        "body": {
                          "text": "@items('Apply_to_each_environment')?['admin_environmentid']",
                          "text_1": "@items('Apply_to_each_environment')?['admin_environmentname']"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "List_CoE_Environments_not_marked_deleted": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1806028d-8aa4-4ac9-bb6e-81d76c6c60de"
                  },
                  "type": "Foreach",
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 50
                    }
                  }
                },
                "List_CoE_Environments_not_marked_deleted": {
                  "metadata": {
                    "operationMetadataId": "f914913a-70ee-4c6e-8311-885e2c122032"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "admin_environments",
                      "$select": "admin_environmentid, admin_environmentsku, admin_hascds, admin_environmentname, admin_environmentcdsmetadataname, admin_environmentdeletedon",
                      "$filter": "admin_environmentdeleted eq false and admin_excusefrominventory eq false"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    },
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  },
                  "runtimeConfiguration": {
                    "paginationPolicy": {
                      "minimumItemCount": 100000
                    }
                  }
                }
              },
              "runAfter": {
                "Deleted_Environments": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "d9ec4c6e-66c0-4f2a-884c-406034f46edd"
              },
              "type": "Scope"
            }
          },
          "runAfter": {
            "Initialize_DeleteFromCoE": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "66327624-653f-426c-b35e-c3fb186a1482"
          },
          "type": "Scope"
        },
        "Delay_Inventory": {
          "actions": {
            "Delay_1_to_300_minutes": {
              "metadata": {
                "operationMetadataId": "f37a4a9d-c5b4-41ed-8484-636dca60ee81"
              },
              "type": "Wait",
              "inputs": {
                "interval": {
                  "count": "@rand(1, 300)",
                  "unit": "Minute"
                }
              },
              "description": "For Dataverse service health, we will randomize the start time of these flows for tenants within a 5 hour range"
            }
          },
          "runAfter": {},
          "else": {
            "actions": {}
          },
          "expression": {
            "equals": [
              "@parameters('DelayInventory (admin_DelayInventory)')",
              true
            ]
          },
          "metadata": {
            "operationMetadataId": "49b3d120-232d-4694-b373-a97ecde35cc4"
          },
          "type": "If"
        }
      },
      "outputs": {}
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}