MainScreen As screen:
    LoadingSpinnerColor: =RGBA(0, 120, 212, 1)
    OnVisible: |
        =UpdateContext(
                {
                    var_pivotkey: "tabMembers",
                    var_ShowShimmer: true,
                    var_ShowSpinner: false,
                    ctxSortCol: "Name",
                    ctxSortAsc: true
                }
            );
        
        Concurrent(
        //get app details
            Set(SelectedRecordID,
                If(IsBlank(Param("recordId")),
                    First(Filter('PowerApps Apps', 'App Type' = 'PowerApps Type'.Canvas && 'App Deleted' = 'App Deleted (PowerApps Apps)'.No)).App,
                    LookUp('PowerApps Apps', App = GUID(Param("recordId"))).App)),
            Set(EnvironmentName,
                If(IsBlank(Param("recordId")),
                    First(Filter('PowerApps Apps', 'App Type' = 'PowerApps Type'.Canvas && 'App Deleted' = 'App Deleted (PowerApps Apps)'.No)).'App Environment'.Name,
                    LookUp('PowerApps Apps', App = GUID(Param("recordId"))).'App Environment'.Name)),
            Set(
                SelectedAppID,
                If(
                    IsBlank(Param("recordId")),
                    First(Filter('PowerApps Apps', 'App Type' = 'PowerApps Type'.Canvas && 'App Deleted' = 'App Deleted (PowerApps Apps)'.No)).App,
                    LookUp(
                        'PowerApps Apps',
                        App = GUID(Param("recordId"))
                    ).App
                )
            )
        );
        
        //get permissions
        Select(Hidden_UpdateTable_App);
        
        Concurrent(
            UpdateContext({var_ShowShimmer: false}),
            ClearCollect(
                DefaultUserCollection,
                User()
            );
            ClearCollect(
                DefaultUserCollection,
                Blank()
            );
            
        );

    Hidden_UpdateTable_App As Button:
        ButtonType: ='Button.ButtonType'.Standard
        DisplayMode: =DisplayMode.Edit
        Height: =0
        OnSelect: |-
            =If(
                !false && !false,
                ClearCollect(
                    temproleAssignmentsCollection,
                    PowerAppsforAdmins.GetAdminAppRoleAssignment(
                        EnvironmentName,
                        SelectedAppID
                    ).value
                );
                ClearCollect(
                    roleAssignmentsCollection,
                    AddColumns(temproleAssignmentsCollection,
                        "RowKey", properties.principal.id,
            
                        "Name",
                        //tenant
                        If(properties.principal.type = "Tenant", "Entire Org",
                        //group
                        If(properties.principal.type = "Group", 
                            If(IsError(Office365Groups.ListGroups({'$filter': "id eq " & "'" & properties.principal.id & "'"}).value), "Unknown Group",
                            "Group: " & First(Office365Groups.ListGroups({'$filter': "id eq " & "'" & properties.principal.id & "'"}).value).displayName),
                        //service principal
                        If(properties.principal.type = "ServicePrincipal", 
                            properties.principal.displayName,
                        //user
                        If(!IsError(Office365Users.UserProfile(properties.principal.id).DisplayName),
                            Office365Users.UserProfile(properties.principal.id).DisplayName,
                        //orphan
                        If(CountRows(Filter('Power Platform Users', 'Record GUID as String' = name))>0,
                            LookUp('Power Platform Users', 'Record GUID as String' = name).'Display Name',
                            "Unknown user"))))),
            
                        "Image",
                        If(
                            !IsBlank(properties.principal.id),
                            If(properties.principal.type <> "User", 
                            Substitute(JSON(PersonPlaceholder, JSONFormat.IncludeBinaryData), """", ""),
                            If(IfError(Office365Users.UserPhotoMetadata(properties.principal.id).HasPhoto, false),
                                Substitute(JSON(Office365Users.UserPhotoV2(properties.principal.id), JSONFormat.IncludeBinaryData), """", ""),
                                Substitute(JSON(LookUp('Power Platform Users', 'Record GUID as String'=properties.principal.id).admin_PhotoObjectId, 
                                      JSONFormat.IncludeBinaryData), """", "")))),
            
                        "Email",
                        properties.principal.email,
                        "Role",
                        properties.roleName,
                        "Type", 
                        If(properties.principal.type = "Tenant", "Tenant", If(properties.principal.type = "Group", "Group", "User"))
            
                    )
                )
            );
        Text: ="load apps"
        Visible: =false
        Width: =0
        X: =0
        Y: =0
        ZIndex: =1

    "PermissionsDetailListElevation As 'Fluent Elevation (1.0.20)'":
        Depth: ='PowerCAT.Elevation.Depth'.Depth4
        DisplayMode: =DisplayMode.Edit
        Height: =PermissionsDetailsList.Height
        HoverDepth: ='PowerCAT.Elevation.HoverDepth'.Depth4
        Visible: =PermissionsDetailsList.Visible
        Width: =PermissionsDetailsList.Width + 10
        X: =MainContainer.X
        Y: =MainContainer.Y
        ZIndex: =2

    MainContentContainer As groupContainer.verticalAutoLayoutContainer:
        Height: =Parent.Height
        LayoutAlignItems: =LayoutAlignItems.Center
        LayoutDirection: =LayoutDirection.Vertical
        LayoutGap: =8
        LayoutJustifyContent: =LayoutJustifyContent.Center
        LayoutMode: =LayoutMode.Auto
        PaddingLeft: =15
        PaddingRight: =15
        PaddingTop: =20
        Width: =Parent.Width
        ZIndex: =3

        SubtitleContainer As groupContainer.horizontalAutoLayoutContainer:
            FillPortions: =0
            Height: =32
            LayoutGap: =5
            LayoutMinHeight: =40
            LayoutMinWidth: =250
            LayoutMode: =LayoutMode.Auto
            X: =40
            Y: =40
            ZIndex: =1

            "icoBackPrev As 'Fluent Icon (1.0.20)'":
                DisplayMode: =DisplayMode.Edit
                FontSize: =18
                Height: =32
                IconName: ="Back"
                IconSize: =18
                IconType: ='PowerCAT.Icon.IconType'.IconButon
                LayoutMinHeight: =200
                LayoutMinWidth: =200
                OnChange: |+
                    =UpdateContext({var_pivotkey: "tabMembers"});
                    
                Theme: =AppThemeJson
                Visible: =If(var_pivotkey = "tabAddUser" || var_pivotkey = "tabAddGroup",true,false)
                Width: =32
                X: =40
                Y: =40
                ZIndex: =1

            lblPanelSubtitle As Label:
                Alignment: =Align.Justify
                DisplayMode: =DisplayMode.Edit
                FontSize: =12
                FontWeight: =FontWeight.Semibold
                Height: =32
                LayoutMinHeight: =32
                LayoutMinWidth: =320
                Text: =If(var_pivotkey = "tabAddUser","Grant permission to a user", If(var_pivotkey = "tabAddGroup", "Grant permission to a group", "List of members"))
                Width: =Parent.Width - Parent.PaddingLeft
                X: =0
                Y: =0
                ZIndex: =2

        MainContainer As groupContainer.manualLayoutContainer:
            AlignInContainer: =AlignInContainer.Start
            Height: =Parent.Height
            LayoutMinHeight: =100
            LayoutMinWidth: =250
            PaddingBottom: =20
            PaddingLeft: =20
            PaddingRight: =20
            PaddingTop: =20
            Width: =Parent.Width -Parent.PaddingLeft -Parent.PaddingRight
            ZIndex: =4

            pagingContainer As groupContainer.horizontalAutoLayoutContainer:
                BorderColor: =RGBA(0, 0, 0, 0)
                BorderStyle: =BorderStyle.None
                DropShadow: =DropShadow.Light
                Height: =24
                LayoutMode: =LayoutMode.Auto
                RadiusBottomLeft: =4
                RadiusBottomRight: =4
                RadiusTopLeft: =4
                RadiusTopRight: =4
                Visible: =PermissionsDetailsList.Visible
                Width: =PermissionsDetailsList.Width+10
                Y: =PermissionsDetailsList.Y+PermissionsDetailsList.Height
                ZIndex: =1

                "icoFirst As 'Fluent Icon (1.0.20)'":
                    DisplayMode: =If(PermissionsDetailsList.HasPreviousPage,DisplayMode.Edit,DisplayMode.Disabled)
                    Height: =24
                    IconName: ="Previous"
                    LayoutMinHeight: =200
                    LayoutMinWidth: =200
                    OnChange: =Set(varGridEvent,"LoadFirstPage" & Text(Rand()));
                    Theme: =AppThemeJson
                    Width: =24
                    X: =0
                    Y: =0
                    ZIndex: =1

                "icoBack As 'Fluent Icon (1.0.20)'":
                    DisplayMode: =If(PermissionsDetailsList.HasPreviousPage,DisplayMode.Edit,DisplayMode.Disabled)
                    Height: =24
                    IconName: ="Back"
                    LayoutMinHeight: =200
                    LayoutMinWidth: =200
                    OnChange: =Set(varGridEvent,"LoadPreviousPage" & Text(Rand()));
                    Theme: =AppThemeJson
                    Width: =24
                    X: =icoFirst.X+icoFirst.Width
                    Y: =0
                    ZIndex: =2

                lblPageCount As label:
                    Align: =Align.Center
                    AlignInContainer: =AlignInContainer.Stretch
                    BorderColor: =RGBA(0, 0,0,0)
                    BorderStyle: =BorderStyle.None
                    Color: =ColorValue(AppTheme.palette.neutralPrimary)
                    DisabledColor: =RGBA(166, 166, 166, 1)
                    FillPortions: =1
                    Font: =Font.'Segoe UI'
                    Height: =24
                    LayoutMinHeight: =24
                    Size: =8
                    Text: ="Page " & PermissionsDetailsList.PageNumber
                    Visible: =PermissionsDetailsList.Visible
                    Width: =50
                    X: =icoBack.X+icoBack.Width
                    ZIndex: =3

                "icoNext As 'Fluent Icon (1.0.20)'":
                    DisplayMode: =If(PermissionsDetailsList.HasNextPage,DisplayMode.Edit,DisplayMode.Disabled)
                    Height: =24
                    IconName: ="Forward"
                    LayoutMinHeight: =200
                    LayoutMinWidth: =200
                    OnChange: =Set(varGridEvent,"LoadNextPage" & Text(Rand()));
                    Theme: =AppThemeJson
                    Width: =24
                    X: =lblPageCount.X + lblPageCount.Width
                    Y: =0
                    ZIndex: =4

            "PermissionsDetailsList As 'Fluent Details List (1.0.20)'.pcfdataset":
                AlternateRowColor: =
                columns_Items: |-
                    =Table(
                        {
                            ColName: "Image",
                            ColDisplayName: "",
                            ColImageWidth: 37,
                            ColWidth: 40,
                            ColPaddingTop: 5,
                            ColCellType: "image"
                        },
                        {
                            ColName: "Name",
                            ColDisplayName: "Name",
                            ColWidth: Self.Width - Parent.PaddingLeft - Parent.PaddingRight - 100,
                            ColIsBold: true,
                            ColSortable: true
                        },
                        {
                            ColName: "Role",
                            ColDisplayName: "Role",
                            ColIsBold: false,
                            ColSortable: true,
                            ColSubTextRow: true,
                            ColShowAsSubTextOf: "Name"
                        },
                        {
                            ColName: "Email",
                            ColDisplayName: "Email",
                            ColIsBold: false,
                            ColSortable: true,
                            ColSubTextRow: false,
                            ColShowAsSubTextOf: "Name"
                        }
                    )
                Compact: =true
                CurrentSortColumn: =ctxSortCol
                CurrentSortDirection: |-
                    =If(ctxSortAsc,
                        'PowerCAT.FluentDetailsList.CurrentSortDirection'.Ascending,
                        'PowerCAT.FluentDetailsList.CurrentSortDirection'.Descending) 
                DisplayMode: =DisplayMode.Edit
                HeaderVisible: =false
                Height: =Parent.Height -25 - pagingContainer.Height -AddEditUserCommandBar.Height
                InputEvent: =varGridEvent
                Items: =SortByColumns(roleAssignmentsCollection,ctxSortCol,If(ctxSortAsc,SortOrder.Ascending,SortOrder.Descending))
                LargeDatasetPaging: =false
                OnChange: |
                    =/* Runs when selected row changes and control property 'Raise OnRowSelection event' is true */
                    If(
                        Self.EventName = "OnRowSelectionChange",
                         If(!IsBlank(Self.EventRowKey),UpdateContext({SelectedUserID: PermissionsDetailsList.Selected.RowKey}), UpdateContext({SelectedUserID: Blank()}));    
                    );
                    If(
                        Self.EventName = "Sort",
                        UpdateContext(
                            {
                                ctxSortCol: Self.SortEventColumn,
                                ctxSortAsc: If(
                                    Self.SortEventDirection = 'PowerCAT.FluentDetailsList.SortEventDirection'.Ascending,
                                    true,
                                    false
                                )
                            }
                        )
                    );
                PageSize: =14
                RaiseOnRowSelectionChangeEvent: =true
                RecordKey: =""
                SelectionAlwaysVisible: =true
                SelectionType: ='PowerCAT.FluentDetailsList.SelectionType'.Single
                SelectRowsOnFocus: =false
                Theme: =AppThemeJson
                Visible: =If(var_pivotkey = "tabMembers" && !var_ShowShimmer,true,false)
                Width: =Parent.Width - Parent.PaddingLeft/1.4
                X: =0
                Y: =0
                ZIndex: =2

                Name1 As pcfDataField.textualColumn:
                    FieldDisplayName: ="Name"
                    FieldName: ="Name"
                    FieldType: ="s"
                    FieldVariantName: ="textualColumn"
                    Order: =3
                    ZIndex: =7

                Role1 As pcfDataField.textualColumn:
                    FieldDisplayName: ="Role"
                    FieldName: ="Role"
                    FieldType: ="s"
                    FieldVariantName: ="textualColumn"
                    Order: =4
                    ZIndex: =8

                Image1 As pcfDataField.textualColumn:
                    FieldDisplayName: ="Image"
                    FieldName: ="Image"
                    FieldType: ="s"
                    FieldVariantName: ="textualColumn"
                    Order: =3
                    ZIndex: =9

                Email1 As pcfDataField.textualColumn:
                    FieldDisplayName: ="Email"
                    FieldName: ="Email"
                    FieldType: ="s"
                    FieldVariantName: ="textualColumn"
                    Order: =4
                    ZIndex: =12

            AddUsersContainer As groupContainer.verticalAutoLayoutContainer:
                Height: =Parent.Height
                LayoutDirection: =LayoutDirection.Vertical
                LayoutGap: =5
                LayoutMode: =LayoutMode.Auto
                PaddingBottom: =20
                PaddingLeft: =10
                PaddingRight: =10
                PaddingTop: =20
                Visible: =If(var_pivotkey = "tabAddUser",true,false)
                Width: =Parent.Width
                ZIndex: =3

                lblAddUsers As Label:
                    DisplayMode: =DisplayMode.Edit
                    FontSize: =11
                    FontWeight: =FontWeight.Semibold
                    Height: =30
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Text: ="Select User"
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    X: =24
                    Y: =102
                    ZIndex: =1

                "PeoplePicker1 As 'Fluent PeoplePicker (1.0.20) Preview'.pcfdataset":
                    DisplayMode: =DisplayMode.Edit
                    Height: =47
                    Items: =DefaultUserCollection
                    LayoutMinHeight: =200
                    LayoutMinWidth: =200
                    MaxPeople: =1
                    OnSearch: |-
                        =ClearCollect(
                            UserCollection,
                            AddColumns(
                                    Office365Users.SearchUser(
                                        {
                                            searchTerm: Self.SearchText,
                                            top: 500
                                        }
                                    ),
                                "SuggestionImgUrl",
                                Substitute(
                                    JSON(
                                        Office365Users.UserPhotoV2(Id),
                                        JSONFormat.IncludeBinaryData
                                    ),
                                    """",
                                    ""
                                ),
                                "SuggestionKey",
                                Id,
                                "SuggestionName",
                                DisplayName,
                                "SuggestionRole",
                                JobTitle
                            )
                        )
                    PeoplePickerType: ='PowerCAT.PeoplePicker.PeoplePickerType'.NormalPeoplePicker
                    ShowSecondaryText: =true
                    Suggestions_Items: =UserCollection
                    Theme: =AppThemeJson
                    Width: =320
                    X: =0
                    Y: =0
                    ZIndex: =2

                lblSelectedUserRole As Label:
                    DisplayMode: =DisplayMode.Edit
                    FontSize: =11
                    FontWeight: =FontWeight.Semibold
                    Height: =35
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Text: ="Select User Role"
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    X: =24
                    Y: =88
                    ZIndex: =4

                "ddSelectedRole As 'Combo box'.pcfdataset":
                    AccessibleLabel: ="Align"
                    DefaultSelectedItems: |-
                        =Table(
                            {
                                Name: "Can View",
                                Key: "CanView"
                            }
                        )
                    DisplayMode: =DisplayMode.Edit
                    Height: =32
                    Items: |-
                        =Table(
                            {
                                Name: "Can View",
                                Key: "CanView"
                            },
                            {
                                Name: "Can Edit",
                                Key: "CanEdit"
                            },
                            {
                                Name: "Owner",
                                Key: "Owner"
                            }
                        )
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    OnChange: =false
                    OnSelect: =
                    Text: =Self.Selected.Name
                    Visible: =true
                    Width: =320
                    X: =24
                    Y: =137
                    ZIndex: =5

                    Name5_3 As pcfDataField.textualColumn:
                        FieldDisplayName: ="Name"
                        FieldName: ="Name"
                        FieldVariantName: ="textualColumn"
                        Order: =1
                        ZIndex: =11

                PanelFooterContainer As groupContainer.manualLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    Height: =Parent.Height - Self.Y
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    ZIndex: =6

                    btnAddUser As Button:
                        AccessibleLabel: ="Add User Button"
                        ButtonType: ='Button.ButtonType'.Primary
                        DisplayMode: =If(!false && !IsBlank(ddSelectedRole.Selected.Key),DisplayMode.Edit,DisplayMode.Disabled)
                        FillColor: =ColorValue(AppTheme.palette.themePrimary)
                        Height: =32
                        OnSelect: |
                            =Concurrent(
                                UpdateContext(
                                    {
                                        var_Spinnerlabel: "Assigning Permission...",
                                        var_ShowSpinner: true,
                                        var_RoleAssignment: ddSelectedRole.Selected.Key
                                    }
                                ),
                                Set(
                                    var_selectedUser,
                                    First(PeoplePicker1.SelectedPeople)
                                ),
                                Set(
                                    var_selectedUserID,
                                    Office365Users.UserProfileV2(First(PeoplePicker1.SelectedPeople).PersonaKey).id
                                )
                            );
                            //if viewer or editor
                            If(
                                var_RoleAssignment <> "Owner",
                                UpdateContext(
                                    {
                                        var_ResponseMessage: 'HELPER-ObjectOperations'.Run(
                                            var_selectedUserID,
                                            SelectedRecordID,
                                            EnvironmentName,
                                            If(
                                                var_RoleAssignment = "CanView",
                                                "addviewer",
                                                "addeditor"
                                            ),
                                            "app"
                                        ).thereturnstring
                                    }
                                );
                                If(
                                    var_ResponseMessage <> "pass",
                                    Notify(
                                        var_ResponseMessage,
                                        NotificationType.Error
                                    ),
                                    Notify(
                                        "Permission granted to " & var_selectedUser.PersonaName,
                                        NotificationType.Success
                                    );
                                    // Workaround for now to reset people picker
                                    ClearCollect(
                                        DefaultUserCollection,
                                        User()
                                    );
                                    ClearCollect(
                                        DefaultUserCollection,
                                        Blank()
                                    );
                                ),
                                //else owner
                                UpdateContext(
                                    {
                                        var_ResponseMessage: 'HELPER-ObjectOperations'.Run(
                                            var_selectedUserID, // var_selectedUser.PersonaKey,
                                            SelectedRecordID,
                                            EnvironmentName,
                                            "assign",
                                            "app"
                                        ).thereturnstring
                                    }
                                );
                                If(
                                    var_ResponseMessage <> "pass",
                                    Notify(
                                        var_ResponseMessage,
                                        NotificationType.Error
                                    ),
                                    Notify(
                                        "Permission granted to " & var_selectedUser.PersonaName,
                                        NotificationType.Success
                                    );
                                    ClearCollect(
                                        DefaultUserCollection,
                                        User()
                                    );
                                    ClearCollect(
                                        DefaultUserCollection,
                                        Blank()
                                    );
                                )
                            );
                            // Update Permission detail list
                            UpdateContext(
                                {
                                    var_ShowSpinner: false,
                                    var_ShowShimmer: true
                                }
                            );
                            If(
                                var_ResponseMessage = "pass",
                                //update permissions table
                                Select(Hidden_UpdateTable_App);
                            
                            );
                            UpdateContext({var_ShowShimmer: false});
                        Text: =If(IsBlank(SelectedUserID),"Add User","Update Permission")
                        TextColor: =ColorValue(AppTheme.palette.white)
                        Visible: =true
                        Width: =96
                        X: =0
                        Y: =Parent.Height - Self.Height -10
                        ZIndex: =1

                    icoFooterDivider As rectangle:
                        BorderColor: =ColorValue(AppTheme.palette.neutralLight)
                        BorderThickness: =0.1
                        DisabledFill: =RGBA(166, 166, 166, 1)
                        Fill: =RGBA(0, 120, 212, 1)
                        FocusedBorderColor: =RGBA(0, 120, 212, 1)
                        Height: =0.1
                        HoverFill: =RGBA(0, 120, 212, 1)
                        PressedFill: =RGBA(0, 120, 212, 1)
                        Width: =Parent.Width
                        Y: =btnAddUser.Y - 10
                        ZIndex: =2

            AddGroupsContainer As groupContainer.verticalAutoLayoutContainer:
                Height: =Parent.Height
                LayoutDirection: =LayoutDirection.Vertical
                LayoutGap: =5
                LayoutMode: =LayoutMode.Auto
                PaddingBottom: =20
                PaddingLeft: =10
                PaddingRight: =10
                PaddingTop: =20
                Visible: =If(var_pivotkey = "tabAddGroup",true,false)
                Width: =Parent.Width
                ZIndex: =4

                lblAddGroups As Label:
                    DisplayMode: =DisplayMode.Edit
                    FontSize: =11
                    FontWeight: =FontWeight.Semibold
                    Height: =30
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Text: ="Select Group"
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    X: =24
                    Y: =102
                    ZIndex: =1

                "filterGroups As 'Text box'":
                    DisplayMode: =DisplayMode.Edit
                    Height: =32
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Placeholder: ="Enter group name to filter list"
                    Value: =""
                    Width: =320
                    X: =0
                    Y: =0
                    ZIndex: =2

                "SelectGroup As 'Combo box'.pcfdataset":
                    AllowSearching: =true
                    DefaultSelectedItems: =If(IsBlank(SelectedUserID), [], [First(SortByColumns(Filter(Office365Groups.ListGroups().value, id = PermissionsDetailsList.Selected.RowKey), "displayName"))])
                    DisplayMode: =DisplayMode.Edit
                    Height: =32
                    Items: |-
                        =//SortByColumns(Filter(Office365Groups.ListGroups().value, !IsBlank(mail) ), "displayName")
                        SortByColumns(Filter(Office365Groups.ListGroups().value, filterGroups.Value in displayName), "displayName")
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Width: =320
                    X: =0
                    Y: =0
                    ZIndex: =3

                    displayName1 As pcfDataField.textualColumn:
                        FieldDisplayName: ="displayName"
                        FieldName: ="displayName"
                        FieldType: ="s"
                        FieldVariantName: ="textualColumn"
                        Order: =1
                        ZIndex: =13

                lblSelectedUserRole_1 As Label:
                    DisplayMode: =DisplayMode.Edit
                    FontSize: =11
                    FontWeight: =FontWeight.Semibold
                    Height: =35
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    Text: ="Select User Role"
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    X: =24
                    Y: =88
                    ZIndex: =4

                "ddSelectedRole_1 As 'Combo box'.pcfdataset":
                    AccessibleLabel: ="Align"
                    DefaultSelectedItems: |-
                        =Table(
                            {
                                Name: "Can View",
                                Key: "CanView"
                            }
                        )
                    DisplayMode: =DisplayMode.Edit
                    Height: =32
                    Items: |-
                        =Table(
                            {
                                Name: "Can View",
                                Key: "CanView"
                            },
                            {
                                Name: "Can Edit",
                                Key: "CanEdit"
                            }
                        )
                    LayoutMinHeight: =32
                    LayoutMinWidth: =320
                    OnChange: =false
                    OnSelect: =
                    Text: =Self.Selected.Name
                    Visible: =true
                    Width: =320
                    X: =24
                    Y: =137
                    ZIndex: =5

                    Name5_4 As pcfDataField.textualColumn:
                        FieldDisplayName: ="Name"
                        FieldName: ="Name"
                        FieldVariantName: ="textualColumn"
                        Order: =1
                        ZIndex: =11

                PanelFooterContainer_1 As groupContainer.manualLayoutContainer:
                    AlignInContainer: =AlignInContainer.SetByContainer
                    Height: =Parent.Height - Self.Y
                    LayoutMinHeight: =100
                    LayoutMinWidth: =250
                    Width: =Parent.Width - Parent.PaddingLeft * 2
                    ZIndex: =6

                    btnAddroup As Button:
                        AccessibleLabel: ="Add User Button"
                        ButtonType: ='Button.ButtonType'.Primary
                        DisplayMode: =If(!false && !IsBlank(ddSelectedRole_1.Selected.Key),DisplayMode.Edit,DisplayMode.Disabled)
                        FillColor: =ColorValue(AppTheme.palette.themePrimary)
                        Height: =32
                        OnSelect: |
                            =Concurrent(
                                UpdateContext(
                                    {
                                        var_Spinnerlabel: "Assigning Permission...",
                                        var_ShowSpinner: true,
                                        var_RoleAssignment: ddSelectedRole_1.Selected.Key
                                    }
                                ),
                                Set(
                                    var_selectedGroup,
                                    First(SelectGroup.SelectedItems)
                                ),
                                Set(
                                    var_selectedGroupID,
                                    First(SelectGroup.SelectedItems).id
                                )
                            );
                            //add permissions for view or edit
                            UpdateContext(
                                {
                                    var_ResponseMessage: 'HELPER-ObjectOperations'.Run(
                                        var_selectedGroupID,
                                        SelectedRecordID,
                                        EnvironmentName,
                                        If(
                                            var_RoleAssignment = "CanView",
                                            "addviewer",
                                            "addeditor"
                                        ),
                                        "app",
                                        {boolean: true}
                                    ).thereturnstring
                                }
                            );
                            If(
                                var_ResponseMessage <> "pass",
                                Notify(
                                    var_ResponseMessage,
                                    NotificationType.Error
                                ),
                                Notify(
                                    "Permission granted to " & var_selectedGroup.displayName,
                                    NotificationType.Success
                                );
                                
                            );
                            // Update Permission detail list
                            UpdateContext(
                                {
                                    var_ShowSpinner: false,
                                    var_ShowShimmer: true
                                }
                            );
                            If(
                                var_ResponseMessage = "pass",
                                //update permissions table
                                Select(Hidden_UpdateTable_App);
                                
                            );
                            UpdateContext({var_ShowShimmer: false});
                        Text: =If(IsBlank(SelectedUserID),"Add Group","Update Permission")
                        TextColor: =ColorValue(AppTheme.palette.white)
                        Visible: =true
                        Width: =96
                        X: =0
                        Y: =Parent.Height - Self.Height -10
                        ZIndex: =1

                    icoFooterDivider_1 As rectangle:
                        BorderColor: =ColorValue(AppTheme.palette.neutralLight)
                        BorderThickness: =0.1
                        DisabledFill: =RGBA(166, 166, 166, 1)
                        Fill: =RGBA(0, 120, 212, 1)
                        FocusedBorderColor: =RGBA(0, 120, 212, 1)
                        Height: =0.1
                        HoverFill: =RGBA(0, 120, 212, 1)
                        PressedFill: =RGBA(0, 120, 212, 1)
                        Width: =Parent.Width
                        Y: =btnAddroup.Y - 10
                        ZIndex: =2

            "PermissionsDetailsListShimmer As 'Fluent Shimmer (1.0.20) Preview'.pcfdataset":
                DisplayMode: =DisplayMode.Edit
                Height: =PermissionsDetailsList.Height
                Items: |-
                    =Table({
                            ItemWidth: "14",
                            ItemHeight: 12,
                            ItemType: "line"
                        },
                        {
                            ItemWidth: "5",
                            ItemHeight: 10,
                            ItemType: "gap"
                        },
                        {
                            ItemWidth: "120",
                            ItemHeight: 5,
                            ItemType: "line"
                        }
                    )
                RowCount: =3
                SpacebetweenShimmer: ='PowerCAT.Shimmer.SpacebetweenShimmer'.'0px'
                Theme: =AppThemeJson
                Visible: =If(var_pivotkey = "tabMembers" && var_ShowShimmer,true,false)
                Width: =PermissionsDetailsList.Width
                X: =PermissionsDetailsList.X
                Y: =PermissionsDetailsList.Y
                ZIndex: =5

            "AddEditUserCommandBar As 'Fluent Command Bar (1.0.20)'.pcfdataset":
                DisplayMode: =DisplayMode.Edit
                Height: =40
                Items: |-
                    =If(
                        PermissionsDetailsList.Visible,
                        Table(
                            {
                                ItemKey: "addedituser",
                                ItemDisplayName: If(
                                    !IsBlank(SelectedUserID) && PermissionsDetailsList.Selected.Role <> "Owner",
                                    "Change Permission",
                                    "Add User"
                                ),
                                ItemIconName: "AddFriend"
                            },
                            {
                                ItemKey: "addgroup",
                                ItemDisplayName: "Add Group",
                                ItemVisible: If(IsBlank(SelectedUserID),true, false),
                                ItemIconName: "PeopleAdd"
                            },
                            {
                                ItemKey: "removeuser",
                                ItemDisplayName: "Remove",
                                ItemIconName: "UserRemove",
                                ItemEnabled: If(
                                    (!IsBlank(SelectedUserID) && PermissionsDetailsList.Selected.Role <> "Owner"),
                                    true,
                                    false
                                )
                            }
                        ),
                        Table(
                            {
                                ItemKey: "addedituser",
                                ItemDisplayName: If(
                                    !IsBlank(SelectedUserID) && PermissionsDetailsList.Selected.Role <> "Owner",
                                    "Change Permission",
                                    "Add User"
                                ),
                                ItemIconName: "AddFriend"
                            }
                        )
                    )
                OnSelect: |-
                    =Switch(
                        Self.Selected.ItemKey,
                        "addedituser",
                    
                        If(!IsBlank(SelectedUserID) && PermissionsDetailsList.Selected.Type = "Group",
                            //if group
                            Reset(SelectGroup);
                            UpdateContext({var_pivotkey: "tabAddGroup"});    
                            ,
                            //not group
                            If(IsBlank(SelectedUserID) || PermissionsDetailsList.Selected.Role = "Owner",
                            ClearCollect(
                                DefaultUserCollection,
                                User()
                            );
                            ClearCollect(
                                DefaultUserCollection,
                                Blank()
                            ),
                            ClearCollect(
                                DefaultUserTempCollection,
                                Office365Users.UserProfile(SelectedUserID)
                            );
                            ClearCollect(
                                DefaultUserCollection,
                                AddColumns(
                                    DefaultUserTempCollection,
                                    "PersonaKey",
                                    Mail,
                                    "PersonaRole",
                                    JobTitle,
                                    "PersonaName",
                                    DisplayName,
                                    "PersonaImgUrl",
                            //Get base64 image data
                                    Substitute(
                                        JSON(
                                            Office365Users.UserPhotoV2(SelectedUserID),
                                            JSONFormat.IncludeBinaryData
                                        ),
                                        """",
                                        ""
                                    )
                                )
                            );
                        );
                        UpdateContext({var_pivotkey: "tabAddUser"});
                        );,
                    
                        "addgroup",
                        UpdateContext({var_pivotkey: "tabAddGroup"});,
                            
                        "removeuser",
                        UpdateContext(
                            {
                                var_Spinnerlabel: "Removing User...",
                                var_ShowSpinner: true
                            }
                        );
                            UpdateContext(
                            {
                                var_ResponseMessage: 'HELPER-ObjectOperations'.Run(
                                    PermissionsDetailsList.Selected.RowKey,
                                    SelectedRecordID,
                                    EnvironmentName,
                                    "removeuser",
                                    "app", {boolean: If(PermissionsDetailsList.Selected.Type = "Group", true, false)}
                                ).thereturnstring
                            }
                        );
                        If(
                            var_ResponseMessage <> "pass",
                            Notify(
                                var_ResponseMessage,
                                NotificationType.Error
                            ),
                            Notify(
                                "Permission removed",
                                NotificationType.Success
                            );
                        );
                        // Update Permission detail list
                        UpdateContext(
                            {
                                var_ShowSpinner: false,
                                var_ShowShimmer: true
                            }
                        );
                        If(
                            var_ResponseMessage = "pass",
                            //update permissions table
                            Select(Hidden_UpdateTable_App);
                    
                        );
                        UpdateContext({var_ShowShimmer: false});
                    
                    );
                Theme: =AppThemeJson
                Visible: =PermissionsDetailsList.Visible
                Width: =Parent.Width
                X: =0
                Y: =Parent.Height - Self.Height -5
                ZIndex: =6

    "Spinner As 'Fluent Spinner (1.0.20) Preview'":
        BackgroundColor: |-
            ="#00000010"
        DisplayMode: =DisplayMode.Edit
        Height: =Parent.Height
        Label: =var_Spinnerlabel
        LabelPosition: ='PowerCAT.Spinner.LabelPosition'.Bottom
        SpinnerAlignment: ='PowerCAT.Spinner.SpinnerAlignment'.Center
        SpinnerSize: ='PowerCAT.Spinner.SpinnerSize'.Large
        Theme: =AppThemeJson
        Visible: =var_ShowSpinner
        Width: =Parent.Width
        X: =0
        Y: =0
        ZIndex: =4

