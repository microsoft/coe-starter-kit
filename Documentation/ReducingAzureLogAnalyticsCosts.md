# Reducing Azure Log Analytics Costs from CoE Starter Kit Service Account Sign-in Logs

## Issue Summary

Organizations implementing the CoE Starter Kit may experience high Azure Log Analytics costs due to a large volume of non-interactive sign-in logs generated by CoE Starter Kit service accounts. This document provides guidance on understanding the issue, available options, and best practices for reducing these costs.

## Background

The CoE Starter Kit Core Components use Cloud Flows with connections authenticated by user accounts (service accounts) to perform inventory and telemetry collection. Each time a flow runs and calls Power Platform or Microsoft 365 APIs, it generates a non-interactive sign-in event that is logged in Azure Active Directory (now Microsoft Entra ID). When these logs are collected by Azure Log Analytics, they contribute to ingestion and storage costs.

### Why Do Non-Interactive Sign-in Logs Occur?

- **Frequency of Inventory Scans**: The CoE Starter Kit inventory flows run on a regular schedule (typically daily or more frequently) to keep data up-to-date
- **Number of API Calls**: Each inventory flow makes multiple API calls to collect information about apps, flows, connectors, environments, and other Power Platform resources
- **Multiple Connections**: The Core Components solution uses various connections (Power Platform for Admins, Office 365, Dataverse, etc.) that each generate authentication events
- **Scale**: In large organizations with many environments and resources, the number of API calls increases proportionally

## Current Architecture and Limitations

### How CoE Starter Kit Connections Work

The CoE Starter Kit Core Components currently use **user-based connections** for the following reasons:

1. **Power Platform Connector Limitations**: Many Power Platform connectors (including Power Platform for Admins connector) do not currently support Service Principal authentication
2. **Delegated Permissions**: Some operations require delegated permissions that are only available with user authentication
3. **API Coverage**: Not all Power Platform Admin APIs support Service Principal authentication patterns

### Service Principal Support Status

As of the current version of the CoE Starter Kit:

- **Limited Support**: Service Principal authentication is supported for some Azure AD-based operations and certain API calls
- **Power Platform Admin Connector**: The primary connector used for inventory collection (Power Platform for Admins) requires user-based authentication for most operations
- **Dataverse Connector**: Supports Application Users (similar to Service Principals) but still generates authentication logs
- **Future Direction**: Microsoft is working to expand Service Principal support across Power Platform admin capabilities

## Options for Reducing Log Analytics Costs

### Option 1: Exclude CoE Service Account Sign-in Logs from Collection (Recommended)

**Description**: Configure Azure Log Analytics to exclude non-interactive sign-in logs from specific service accounts used by the CoE Starter Kit.

**Implementation Steps**:

1. **Identify CoE Service Accounts**: Document all service accounts used by CoE Starter Kit flows
2. **Configure Diagnostic Settings**: In Azure Portal, modify the Azure AD diagnostic settings to exclude specific users or use Log Analytics query-time filtering
3. **Use Workspace Transformation Rules**: Create transformation rules to filter out logs from CoE service accounts before ingestion

**Pros**:
- Immediately reduces ingestion costs
- No changes required to CoE Starter Kit implementation
- Maintains full CoE Starter Kit functionality
- Simple to implement

**Cons**:
- Loses visibility into CoE service account sign-in patterns (security trade-off)
- May need to update filters when adding new service accounts
- Requires Azure AD and Log Analytics administrative permissions

**Reference**: [Azure Monitor data collection transformation](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-transformations)

### Option 2: Optimize Log Analytics Retention and Sampling

**Description**: Reduce retention periods for sign-in logs and implement log sampling strategies.

**Implementation Steps**:

1. **Adjust Retention Period**: Set shorter retention for `SigninLogs` and `AADNonInteractiveUserSignInLogs` tables
2. **Implement Sampling**: Use Azure Monitor transformation rules to sample (e.g., keep 10% of logs) rather than collect all logs
3. **Archive to Cheaper Storage**: Move older logs to Azure Storage for long-term retention at lower cost

**Pros**:
- Maintains some visibility into sign-in patterns
- Flexible cost-to-visibility trade-off
- Can be combined with other options

**Cons**:
- Still incurs some costs
- Incomplete historical data
- Compliance considerations may limit retention reduction

**Reference**: [Manage log data retention in Azure Monitor](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-retention-configure)

### Option 3: Reduce CoE Inventory Scan Frequency

**Description**: Decrease how often inventory flows run to reduce the number of API calls and authentication events.

**Implementation Steps**:

1. **Review Flow Schedules**: Audit all Core Components flows and their recurrence settings
2. **Adjust Recurrence**: Change daily flows to run every 2-3 days, or weekly flows to run bi-weekly
3. **Stagger Flow Runs**: Spread out flow execution times to distribute load

**Pros**:
- Simple to implement through Power Automate
- Directly reduces sign-in log volume
- No infrastructure changes required

**Cons**:
- **Data Freshness Impact**: CoE dashboards and reports will have less current data
- **Detection Delays**: Longer gaps between inventory scans delay detection of new apps, flows, and compliance issues
- **User Experience**: Makers may see outdated information in CoE applications
- **May not meet organizational requirements** for up-to-date governance data

**Note**: You mentioned wanting to avoid this option to keep data up-to-date, which is a valid business requirement.

### Option 4: Use Application Users for Dataverse Operations

**Description**: Where possible, configure flows to use Application Users (Service Principals) instead of user accounts for Dataverse operations.

**Implementation Steps**:

1. **Create Application User**: Register an Azure AD application and create a corresponding Application User in Dataverse
2. **Grant Permissions**: Assign appropriate security roles to the Application User
3. **Update Connections**: Modify Dataverse connections in flows to use Service Principal authentication
4. **Test Thoroughly**: Validate that all Dataverse operations work correctly

**Pros**:
- Reduces user-based sign-in logs for Dataverse operations
- More secure (no user credentials to manage)
- Better aligns with zero-trust principles

**Cons**:
- **Limited Scope**: Only applies to Dataverse connector operations
- **Does NOT reduce logs from Power Platform Admin connector** (the primary source of logs)
- Requires Application User setup and permission management
- May require solution customizations

**Partial Solution**: This addresses only a subset of the authentication events.

**Reference**: [Application users in Dataverse](https://learn.microsoft.com/en-us/power-platform/admin/manage-application-users)

### Option 5: Implement Custom Connector with Service Principal (Advanced)

**Description**: Create custom connectors that use Service Principal authentication to call Power Platform Admin APIs directly.

**Implementation Steps**:

1. **Evaluate API Coverage**: Identify which Power Platform Admin APIs support Service Principal auth
2. **Create Custom Connectors**: Build custom connectors that use client credentials flow
3. **Modify Flows**: Update CoE inventory flows to use custom connectors instead of built-in connectors
4. **Maintain Solution**: Track connector updates and maintain custom code

**Pros**:
- Maximum control over authentication patterns
- Can use Service Principal for supported APIs
- Potentially reduces sign-in logs

**Cons**:
- **High Complexity**: Requires significant development and maintenance effort
- **Creates Unmanaged Layer**: Makes upgrading CoE Starter Kit more difficult (you specifically want to avoid this)
- **Limited API Support**: Not all admin APIs support Service Principal authentication
- **Ongoing Maintenance**: Custom connectors need updates as APIs evolve
- **Support Implications**: Moves away from supported CoE Starter Kit architecture

**Not Recommended**: This contradicts your stated goal of avoiding managed layers for easier updates.

## Recommended Approach

Based on the requirements stated (maintain inventory frequency, avoid unmanaged layers, minimize costs), the **recommended combination** is:

### Primary Strategy: Exclude CoE Service Account Logs from Collection (Option 1)

Implement Log Analytics filtering or transformation rules to exclude non-interactive sign-in logs from CoE service accounts. This provides:
- ✅ Maintains current inventory scan frequency
- ✅ No changes to CoE Starter Kit (preserves managed solution for easy updates)
- ✅ Immediate and significant cost reduction
- ✅ Simple to implement and maintain

### Supplementary Strategy: Optimize Log Analytics (Option 2)

Additionally, implement log retention optimization:
- Set appropriate retention periods based on compliance requirements
- Use sampling for non-CoE sign-in logs if needed
- Archive older logs to cheaper storage tiers

### Considerations for Application Users (Option 4)

As a secondary enhancement, consider using Application Users for Dataverse-specific operations where it doesn't impact updates. This is a smaller improvement but aligns with security best practices.

## Implementation Guide: Excluding CoE Service Account Logs

### Step 1: Identify CoE Service Accounts

1. Document all service accounts used for CoE Starter Kit connections
2. Note their User Principal Names (UPNs)
3. Confirm which accounts are used exclusively for CoE automation

### Step 2: Configure Log Analytics Transformation Rules

```kql
// Example transformation rule to exclude CoE service accounts
SigninLogs
| where UserPrincipalName !in ("coe-service@contoso.com", "powerplatform-admin@contoso.com")
```

### Step 3: Apply Data Collection Rules

1. In Azure Portal, navigate to your Log Analytics workspace
2. Go to **Settings > Data Collection Rules**
3. Create a new transformation rule for AADSignInLogs
4. Apply the exclusion filter
5. Monitor cost changes over 1-2 weeks

### Step 4: Verify and Monitor

1. Confirm logs from CoE service accounts are no longer ingested
2. Monitor CoE Starter Kit functionality to ensure no impact
3. Track cost reduction in Azure Cost Management

## Alternative: Azure AD Diagnostic Settings Approach

If transformation rules are not available or suitable:

1. Go to Azure Active Directory > Monitoring > Diagnostic settings
2. Create or modify the diagnostic setting sending logs to Log Analytics
3. Consider creating separate diagnostic settings:
   - One that includes all logs but excludes specific tables
   - One specifically for audit logs needed for compliance
4. This is a coarser control but may be sufficient

## Cost Estimation

**Example Scenario**:
- Organization: 5,000 users, 200 environments
- CoE Inventory Flows: Run daily (24 flows)
- API Calls per Run: ~500 per flow
- Sign-in Logs Generated: ~12,000 per day
- Log Size: ~1 KB per log
- Daily Ingestion: ~12 MB
- Monthly Ingestion: ~360 MB
- Cost at $2.50/GB: ~$0.90/month for logs alone

**Actual impact varies significantly** based on:
- Number of environments and resources
- Flow run frequency
- Number of connections used
- Organization size

**Cost Reduction**: Excluding these logs can reduce costs by 100% for this specific log category.

## Frequently Asked Questions

### Q: Will excluding these logs impact security monitoring?

**A**: CoE service accounts should be tightly controlled and monitored through other means. The non-interactive sign-in logs primarily show expected automation activity. Consider:
- Keeping audit logs for changes made by service accounts
- Implementing alerts for unexpected activity patterns
- Maintaining logs for the first 24-48 hours to detect anomalies

### Q: Can I use Service Principals for all CoE Starter Kit connections?

**A**: Not currently. The Power Platform for Admins connector, which is central to CoE inventory collection, requires user-based authentication for most operations. Microsoft is working to expand Service Principal support.

### Q: Will this be addressed in future versions of CoE Starter Kit?

**A**: As Power Platform expands Service Principal support for admin APIs, future versions of the CoE Starter Kit may offer more options for Service Principal authentication. Monitor the [CoE Starter Kit releases](https://github.com/microsoft/coe-starter-kit/releases) and [Microsoft Power Platform roadmap](https://powerplatform.microsoft.com/roadmap/) for updates.

### Q: What about Managed Identity instead of Service Principals?

**A**: Managed Identities are Azure-specific and currently cannot be used with Power Platform Cloud Flows. Service Principals (via Application Users) are the closest equivalent for Power Platform scenarios.

## Additional Resources

- [CoE Starter Kit Documentation](https://learn.microsoft.com/en-us/power-platform/guidance/coe/starter-kit)
- [CoE Starter Kit Setup Guide](https://learn.microsoft.com/en-us/power-platform/guidance/coe/setup)
- [Power Platform Admin Connectors](https://learn.microsoft.com/en-us/connectors/powerplatformforadmins/)
- [Application Users in Dataverse](https://learn.microsoft.com/en-us/power-platform/admin/manage-application-users)
- [Azure Monitor Data Transformation](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-transformations)
- [Azure Monitor Cost Optimization](https://learn.microsoft.com/en-us/azure/azure-monitor/best-practices-cost)
- [Azure AD Sign-in Logs](https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins)

## Summary

The most effective approach to reduce Azure Log Analytics costs from CoE Starter Kit service account sign-in logs is to **exclude these logs from collection using Log Analytics transformation rules or diagnostic settings configuration**. This approach:

1. ✅ Maintains inventory scan frequency for up-to-date governance data
2. ✅ Preserves the managed solution architecture for easy updates
3. ✅ Provides immediate and significant cost reduction
4. ✅ Requires minimal effort to implement and maintain
5. ✅ Does not impact CoE Starter Kit functionality

While Service Principal support is limited today, this is an evolving area, and future updates may provide additional authentication options as the Power Platform admin APIs expand their support for Service Principal authentication.

## Contributing

If you have discovered additional approaches or have feedback on these recommendations, please contribute to the [CoE Starter Kit GitHub repository](https://github.com/microsoft/coe-starter-kit).

---

**Document Version**: 1.0  
**Last Updated**: January 2026  
**Applies to**: CoE Starter Kit Core Components v2.x and later
