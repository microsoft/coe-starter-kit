{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoEGovDataverse"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_office365users": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "new_CoEGovO365Users"
        },
        "api": {
          "name": "shared_office365users"
        }
      },
      "shared_office365": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "admin_CoECoreO365Outlook"
        },
        "api": {
          "name": "shared_office365"
        }
      },
      "shared_teams": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "new_CoEGovTeams"
        },
        "api": {
          "name": "shared_teams"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "Admin eMail (admin_AdminMail)": {
          "defaultValue": "adelev@pplatform.onmicrosoft.com",
          "type": "String",
          "metadata": {
            "schemaName": "admin_AdminMail",
            "description": "CoE Admin eMail. Email address used in flows to send notifications to admins; this should be either your email address or a distribution list"
          }
        },
        "ProductionEnvironment (admin_ProductionEnvironment)": {
          "defaultValue": true,
          "type": "Bool",
          "metadata": {
            "schemaName": "admin_ProductionEnvironment",
            "description": "true by default. set to false if you are creating a dev type envt. this will allow some flows to set target users to the admin instead of object owners"
          }
        },
        "Individual Admin (admin_ApprovalAdmin)": {
          "defaultValue": "adelev@pplatform.onmicrosoft.com",
          "type": "String",
          "metadata": {
            "schemaName": "admin_ApprovalAdmin",
            "description": "An individual admin's email. Some actions (approvals / team chats) cannot accept a group/DL. So this env variable is for those instances in the kit. "
          }
        }
      },
      "triggers": {
        "Recurrence": {
          "recurrence": {
            "frequency": "Week",
            "interval": 1
          },
          "metadata": {
            "operationMetadataId": "fe40f14e-af37-458e-bb0d-d51d2f0c37fb"
          },
          "type": "Recurrence"
        }
      },
      "actions": {
        "Initialize_AdminEmail": {
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "8336252e-ea5f-437b-ab48-ebd8c9dc25d1"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "AdminEmail",
                "type": "string",
                "value": "@parameters('Admin eMail (admin_AdminMail)')"
              }
            ]
          }
        },
        "Initialize_ManagersWithOrphans": {
          "runAfter": {
            "Initialize_AdminEmail": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "63907c7f-6922-40ab-8546-c1b6503cce6b"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ManagersWithOrphans",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_OrphanedApps": {
          "runAfter": {
            "Initialize_ManagersWithOrphans": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "b161465e-dfca-4d5c-b327-b88c8a170088"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "OrphanedApps",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_OrphanedFlows": {
          "runAfter": {
            "Initialize_OrphanedApps": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "9da19850-ff76-4ec8-bf5b-2530b778ca0c"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "OrphanedFlows",
                "type": "array"
              }
            ]
          }
        },
        "Initialize_OrphanedObject": {
          "runAfter": {
            "Initialize_OrphanedFlows": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "668d09fa-da76-4473-aa7e-3447535448f2"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "OrphanedObject",
                "type": "object"
              }
            ]
          }
        },
        "Initialize_flowOwner": {
          "runAfter": {
            "Initialize_OrphanedObject": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "db50f422-295f-4711-944f-4647658441f7"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "flowOwner",
                "type": "string"
              }
            ]
          }
        },
        "Initialize_SendToAdmin": {
          "runAfter": {
            "Initialize_flowOwner": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "f5783ece-714d-4488-a250-e3f01ff46860"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "SendToAdmin",
                "type": "boolean",
                "value": "@false"
              }
            ]
          }
        },
        "Create_Arrays_of_Orphaned_Objects_with_Manager_Info": {
          "actions": {
            "List_orphaned_Canvas_Apps": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "157bf3bb-78da-4c9f-affa-9f611fadd941"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_apps",
                  "$select": "admin_appmodifiedon, admin_applastlaunchedon, admin_appownerdisplayname, admin_displayname,_admin_appowner_value",
                  "$filter": "admin_appdeleted eq false and admin_powerappstype eq 597910000 and cr5d5_appisorphaned eq 'yes'",
                  "$expand": "admin_AppEnvironment($select=admin_displayname)"
                },
                "authentication": "@parameters('$authentication')"
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            },
            "Apply_to_each_Orphaned_App": {
              "foreach": "@outputs('List_orphaned_Canvas_Apps')?['body/value']",
              "actions": {
                "Reset_SendToAdmin_for_Apps": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "1f2669d4-b098-4bef-9a59-f8c55a8364fc"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SendToAdmin",
                    "value": "@false"
                  }
                },
                "Get_App_Owners_Manager": {
                  "runAfter": {
                    "Reset_SendToAdmin_for_Apps": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e4773658-4d46-4bde-ba4c-81fa1062ebe3"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_makers",
                      "recordId": "@items('Apply_to_each_Orphaned_App')?['_admin_appowner_value']"
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                },
                "Catch_No_App_Manager": {
                  "runAfter": {
                    "Get_App_Owners_Manager": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "34c37e4d-b0eb-4948-85db-dfac870d6f7e"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SendToAdmin",
                    "value": "@true"
                  }
                },
                "If_blank,_send_to_admin": {
                  "actions": {
                    "Create_this_app_object_with_admin": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "6996b3b2-c581-4a50-8304-b28cbcdc2713"
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "OrphanedObject",
                        "value": {
                          "LastModified": "@items('Apply_to_each_Orphaned_App')?['admin_appmodifiedon']",
                          "LastLaunched": "@items('Apply_to_each_Orphaned_App')?['admin_applastlaunchedon']",
                          "OwnerDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_appownerdisplayname']",
                          "AppDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_displayname']",
                          "EnvtDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_appenvironment/admin_displayname']",
                          "AppOwnerID": "@items('Apply_to_each_Orphaned_App')?['_admin_appowner_value']",
                          "Manager": "xxx",
                          "AsAdmin": "@true"
                        }
                      }
                    },
                    "Append_to_OrphanedApps_with_admin_for_manager": {
                      "runAfter": {
                        "Create_this_app_object_with_admin": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "d31f05e8-14ef-4269-bb58-bd071f9d3ae4"
                      },
                      "type": "AppendToArrayVariable",
                      "inputs": {
                        "name": "OrphanedApps",
                        "value": "@variables('OrphanedObject')"
                      }
                    }
                  },
                  "runAfter": {
                    "Catch_No_App_Manager": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Validate_manager_profile_-_apps": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "147d2ab6-a847-4a50-a4cc-c1a86e7d7b90"
                        },
                        "type": "OpenApiConnection",
                        "inputs": {
                          "host": {
                            "connectionName": "shared_office365users",
                            "operationId": "UserProfile_V2",
                            "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365users"
                          },
                          "parameters": {
                            "id": "@outputs('Get_App_Owners_Manager')?['body/admin_managerprinciplename']",
                            "$select": "statusCode"
                          },
                          "authentication": "@parameters('$authentication')",
                          "retryPolicy": {
                            "type": "exponential",
                            "count": 10,
                            "interval": "PT10S"
                          }
                        }
                      },
                      "Switch": {
                        "runAfter": {
                          "Validate_manager_profile_-_apps": [
                            "Succeeded",
                            "Failed"
                          ]
                        },
                        "cases": {
                          "200_Success": {
                            "case": 200,
                            "actions": {
                              "Create_this_app_object_with_manager": {
                                "runAfter": {},
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "OrphanedObject",
                                  "value": {
                                    "LastModified": "@items('Apply_to_each_Orphaned_App')?['admin_appmodifiedon']",
                                    "LastLaunched": "@items('Apply_to_each_Orphaned_App')?['admin_applastlaunchedon']",
                                    "OwnerDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_appownerdisplayname']",
                                    "AppDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_displayname']",
                                    "EnvtDisplayName": "@items('Apply_to_each_Orphaned_App')?['admin_appenvironment/admin_displayname']",
                                    "AppOwnerID": "@items('Apply_to_each_Orphaned_App')?['_admin_appowner_value']",
                                    "Manager": "@outputs('Get_App_Owners_Manager')?['body/admin_managerprinciplename']",
                                    "AsAdmin": "@false"
                                  }
                                }
                              },
                              "Append_to_OrphanedApps": {
                                "runAfter": {
                                  "Create_this_app_object_with_manager": [
                                    "Succeeded"
                                  ]
                                },
                                "type": "AppendToArrayVariable",
                                "inputs": {
                                  "name": "OrphanedApps",
                                  "value": "@variables('OrphanedObject')"
                                }
                              },
                              "if_manager_not_already_in_list,_add_them": {
                                "actions": {
                                  "Append_to_ManagersWithOrphans": {
                                    "runAfter": {},
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                      "name": "ManagersWithOrphans",
                                      "value": "@outputs('Get_App_Owners_Manager')?['body/admin_managerprinciplename']"
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Append_to_OrphanedApps": [
                                    "Succeeded"
                                  ]
                                },
                                "expression": {
                                  "not": {
                                    "contains": [
                                      "@variables('ManagersWithOrphans')",
                                      "@outputs('Get_App_Owners_Manager')?['body/admin_managerprinciplename']"
                                    ]
                                  }
                                },
                                "type": "If"
                              }
                            }
                          },
                          "404_File_Not_Found": {
                            "case": 404,
                            "actions": {
                              "Update_manager_for_next_run": {
                                "actions": {
                                  "Get_M2_Manager": {
                                    "runAfter": {},
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "host": {
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "GetItem",
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                      },
                                      "parameters": {
                                        "entityName": "admin_makers",
                                        "recordId": "@items('Apply_to_each_Orphaned_App')?['_admin_appowner_value']"
                                      },
                                      "authentication": "@parameters('$authentication')",
                                      "retryPolicy": {
                                        "type": "exponential",
                                        "count": 10,
                                        "interval": "PT10S"
                                      }
                                    }
                                  },
                                  "Update_manager_to_m2_and_clear_m2": {
                                    "runAfter": {
                                      "Get_M2_Manager": [
                                        "Succeeded"
                                      ]
                                    },
                                    "type": "OpenApiConnection",
                                    "inputs": {
                                      "host": {
                                        "connectionName": "shared_commondataserviceforapps",
                                        "operationId": "UpdateRecord",
                                        "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                                      },
                                      "parameters": {
                                        "entityName": "admin_makers",
                                        "recordId": "@items('Apply_to_each_Orphaned_App')?['_admin_appowner_value']",
                                        "item/admin_m2managerprinciplename": "@null",
                                        "item/admin_managerprinciplename": "@outputs('Get_M2_Manager')?['body/admin_m2managerprinciplename']"
                                      },
                                      "authentication": "@parameters('$authentication')",
                                      "retryPolicy": {
                                        "type": "exponential",
                                        "count": 10,
                                        "interval": "PT10S"
                                      }
                                    }
                                  }
                                },
                                "runAfter": {},
                                "type": "Scope"
                              }
                            }
                          }
                        },
                        "default": {
                          "actions": {}
                        },
                        "expression": "@outputs('Validate_manager_profile_-_apps')['statusCode']",
                        "metadata": {
                          "operationMetadataId": "17a432c9-f203-4ece-a075-5e4f6c60f1c0"
                        },
                        "type": "Switch"
                      }
                    }
                  },
                  "expression": {
                    "or": [
                      {
                        "equals": [
                          "@variables('SendToAdmin')",
                          "@true"
                        ]
                      },
                      {
                        "equals": [
                          "@outputs('Get_App_Owners_Manager')?['body/admin_managerprinciplename']",
                          "@null"
                        ]
                      }
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "5008a7e1-5974-4815-9108-2ae8d59f6b7b"
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "List_orphaned_Canvas_Apps": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "84179f64-4956-4c19-a9b4-7e4118a149c5"
              },
              "type": "Foreach"
            },
            "Parse_JSON_OrphanedApps": {
              "runAfter": {
                "Apply_to_each_Orphaned_App": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "74af6ea4-e2a5-4753-99f3-2d76bfbc56a4"
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@variables('OrphanedApps')",
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "LastModified": {
                        "type": "string"
                      },
                      "LastLaunched": {},
                      "OwnerDisplayName": {
                        "type": [
                          "string",
                          "null"
                        ]
                      },
                      "AppDisplayName": {
                        "type": "string"
                      },
                      "EnvtDisplayName": {
                        "type": "string"
                      },
                      "AppOwnerID": {
                        "type": [
                          "string",
                          "null"
                        ]
                      },
                      "Manager": {
                        "type": "string"
                      },
                      "AsAdmin": {
                        "type": "boolean"
                      }
                    },
                    "required": [
                      "AppDisplayName",
                      "EnvtDisplayName",
                      "Manager",
                      "AsAdmin"
                    ]
                  }
                }
              }
            },
            "List_orphaned_Cloud_Flows": {
              "runAfter": {
                "Parse_JSON_OrphanedApps": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "10cde192-49bf-48be-80dc-c4f74d7b516a"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "admin_flows",
                  "$select": "admin_flowmodifiedon, admin_flowmakerdisplayname, admin_flowstate, admin_displayname, _admin_flowcreator_value,  _admin_derivedowner_value",
                  "$filter": "admin_flowdeleted eq false and cr5d5_flowisorphaned eq 'yes'",
                  "$expand": "admin_FlowEnvironment($select=admin_displayname)"
                },
                "authentication": "@parameters('$authentication')"
              },
              "runtimeConfiguration": {
                "paginationPolicy": {
                  "minimumItemCount": 100000
                }
              }
            },
            "Apply_to_each_Orphaned_Flow": {
              "foreach": "@outputs('List_orphaned_Cloud_Flows')?['body/value']",
              "actions": {
                "If_no_Derived_Owner,_set_to_Maker": {
                  "actions": {
                    "Set_flowOwner_to_Maker": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "3f3b17ea-fe19-482f-a268-6847897735fa"
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "flowOwner",
                        "value": "@items('Apply_to_each_Orphaned_Flow')?['_admin_flowcreator_value']"
                      }
                    }
                  },
                  "runAfter": {},
                  "else": {
                    "actions": {
                      "Set_flowOwner_to_DerivedOwner": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "4478327e-6d34-4696-997f-17b4b43dc24f"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "flowOwner",
                          "value": "@items('Apply_to_each_Orphaned_Flow')?['_admin_derivedowner_value']"
                        }
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@items('Apply_to_each_Orphaned_Flow')?['_admin_derivedowner_value']",
                      "@null"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "0cbef025-cc5e-49e0-b70e-9c01a84b09ef"
                  },
                  "type": "If"
                },
                "Reset_SendToAdmin_for_Flows": {
                  "runAfter": {
                    "If_no_Derived_Owner,_set_to_Maker": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "f339c7d2-08c1-4abf-ac86-eaf3d2a5ccd6"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SendToAdmin",
                    "value": "@false"
                  }
                },
                "Get_Flow_Owners_Manager": {
                  "runAfter": {
                    "Reset_SendToAdmin_for_Flows": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "460c9130-0171-40f1-a7e0-361f0b016cb1"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_commondataserviceforapps",
                      "operationId": "GetItem",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                    },
                    "parameters": {
                      "entityName": "admin_makers",
                      "recordId": "@variables('flowOwner')"
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                },
                "Catch_No_Flow_Manager": {
                  "runAfter": {
                    "Get_Flow_Owners_Manager": [
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "c0042c7f-aa8f-4ec4-87ed-56a8cc19ab81"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "SendToAdmin",
                    "value": "@true"
                  }
                },
                "If_blank_manager,_send_to_admin": {
                  "actions": {
                    "Create_this_flow_object_with_admin": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "5073e1fa-69e7-4c52-b2a4-a17755249b98"
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "OrphanedObject",
                        "value": {
                          "LastModified": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowmodifiedon']",
                          "FlowState": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowstate']",
                          "OwnerDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowmakerdisplayname']",
                          "FlowDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_displayname']",
                          "EnvtDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowenvironment/admin_displayname']",
                          "AppOwnerID": "@variables('flowOwner')",
                          "Manager": "xxx",
                          "AsAdmin": "@true"
                        }
                      }
                    },
                    "Append_to_OrphanedFlows_with_admin_for_manager": {
                      "runAfter": {
                        "Create_this_flow_object_with_admin": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "70b56220-99fa-4294-8927-6452fcbf8f9e"
                      },
                      "type": "AppendToArrayVariable",
                      "inputs": {
                        "name": "OrphanedFlows",
                        "value": "@variables('OrphanedObject')"
                      }
                    }
                  },
                  "runAfter": {
                    "Catch_No_Flow_Manager": [
                      "Succeeded",
                      "Skipped"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Create_this_flow_object_with_manager": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "51a8c331-da3d-47e1-8816-86b4b976f44e"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "OrphanedObject",
                          "value": {
                            "LastModified": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowmodifiedon']",
                            "FlowState": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowstate']",
                            "OwnerDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowmakerdisplayname']",
                            "FlowDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_displayname']",
                            "EnvtDisplayName": "@items('Apply_to_each_Orphaned_Flow')?['admin_flowenvironment/admin_displayname']",
                            "AppOwnerID": "@variables('flowOwner')",
                            "Manager": "@outputs('Get_Flow_Owners_Manager')?['body/admin_managerprinciplename']",
                            "AsAdmin": "@false"
                          }
                        }
                      },
                      "Append_to_OrphanedFlows": {
                        "runAfter": {
                          "Create_this_flow_object_with_manager": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "90f1e5f3-4bd8-4ad3-833f-984f41f3e1bd"
                        },
                        "type": "AppendToArrayVariable",
                        "inputs": {
                          "name": "OrphanedFlows",
                          "value": "@variables('OrphanedObject')"
                        }
                      },
                      "if_manager_not_already_in_list,_add_them_-_flow": {
                        "actions": {
                          "Append_to_ManagersWithOrphans_-_flow": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "18f12d2a-4dfd-4283-9ba7-3fa8368f1334"
                            },
                            "type": "AppendToArrayVariable",
                            "inputs": {
                              "name": "ManagersWithOrphans",
                              "value": "@outputs('Get_Flow_Owners_Manager')?['body/admin_managerprinciplename']"
                            }
                          }
                        },
                        "runAfter": {
                          "Append_to_OrphanedFlows": [
                            "Succeeded"
                          ]
                        },
                        "expression": {
                          "not": {
                            "contains": [
                              "@variables('ManagersWithOrphans')",
                              "@outputs('Get_Flow_Owners_Manager')?['body/admin_managerprinciplename']"
                            ]
                          }
                        },
                        "metadata": {
                          "operationMetadataId": "6e94fec4-6669-4bec-9449-ce3c46e9b226"
                        },
                        "type": "If"
                      }
                    }
                  },
                  "expression": {
                    "or": [
                      {
                        "equals": [
                          "@variables('SendToAdmin')",
                          "@true"
                        ]
                      },
                      {
                        "equals": [
                          "@outputs('Get_Flow_Owners_Manager')?['body/admin_managerprinciplename']",
                          "@null"
                        ]
                      }
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "20bb4974-83c2-4f4a-8ece-5d2b2087ce38"
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "List_orphaned_Cloud_Flows": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "77cc12ee-111f-487a-aef1-33cb714a787b"
              },
              "type": "Foreach"
            },
            "Parse_JSON_OrphanedFlows": {
              "runAfter": {
                "Apply_to_each_Orphaned_Flow": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "8724e27a-d34c-4df2-b0f4-a6617e881c4e"
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@variables('OrphanedFlows')",
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "LastModified": {
                        "type": "string"
                      },
                      "FlowState": {
                        "type": "string"
                      },
                      "OwnerDisplayName": {
                        "type": [
                          "string",
                          "null"
                        ]
                      },
                      "FlowDisplayName": {
                        "type": "string"
                      },
                      "EnvtDisplayName": {
                        "type": [
                          "string",
                          "null"
                        ]
                      },
                      "AppOwnerID": {
                        "type": [
                          "string",
                          "null"
                        ]
                      },
                      "Manager": {
                        "type": "string"
                      },
                      "AsAdmin": {
                        "type": "boolean"
                      }
                    },
                    "required": [
                      "FlowDisplayName",
                      "EnvtDisplayName",
                      "Manager",
                      "AsAdmin"
                    ]
                  }
                }
              }
            }
          },
          "runAfter": {
            "Initialize_FailedForManagerList": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "b04a92cb-a734-4c3d-bd9e-21ef9fd69dbf"
          },
          "type": "Scope"
        },
        "Send_items_without_managers_to_admins": {
          "actions": {
            "Filter_apps_to_admin_assigned": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "2b2bbdd1-9645-45ea-9766-bbe6c2d133b3"
              },
              "type": "Query",
              "inputs": {
                "from": "@body('Parse_JSON_OrphanedApps')",
                "where": "@equals(item()['AsAdmin'], true)"
              }
            },
            "Filter_flows_to_admin_assigned": {
              "runAfter": {
                "Create_HTML_table_of_apps_for_admins": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "99ef3127-dbd4-4941-b0b2-e9c114b86602"
              },
              "type": "Query",
              "inputs": {
                "from": "@body('Parse_JSON_OrphanedFlows')",
                "where": "@equals(item()['AsAdmin'], true)"
              }
            },
            "Create_HTML_table_of_apps_for_admins": {
              "runAfter": {
                "Admin_Apps_reduced": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "4f68d223-5be8-4cf4-9803-a35b362ecc69"
              },
              "type": "Table",
              "inputs": {
                "from": "@body('Admin_Apps_reduced')",
                "format": "HTML"
              }
            },
            "Create_HTML_table_of_flows_for_admins": {
              "runAfter": {
                "Admin_Flows_reduced": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "60d9b0a2-ade2-4f37-8cd2-3d6ecfd95847"
              },
              "type": "Table",
              "inputs": {
                "from": "@body('Admin_Flows_reduced')",
                "format": "HTML"
              }
            },
            "if_either_arrays_contain_data_then_send_mail": {
              "actions": {
                "Send_admin_email_of_orphans_they_will_need_to_resolve": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "5fc88ddf-f582-464b-ae10-e5076354c042"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_office365",
                      "operationId": "SendEmailV2",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365"
                    },
                    "parameters": {
                      "emailMessage/To": "@variables('AdminEmail')",
                      "emailMessage/Subject": "Orphaned Power Platform objects without managers",
                      "emailMessage/Body": "<p>Hello, there are Power Platform objects in your tenant who's owner has left the company and so they are orphaned.<br>\n<br>\nWe have sent these to the former manager for those that are known, but there are a set for whom we do not have a manager on file.<br>\n<br>\nPlease clean these up via the Set App Permissions and Set Flow Permissions apps from your CoE.<br>\n<br>\n<u><strong>APPS</strong></u><br>\n@{body('Create_HTML_table_of_apps_for_admins')}<br>\n<br>\n<u><strong>FLOWS</strong></u><br>\n@{body('Create_HTML_table_of_flows_for_admins')}</p>"
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                }
              },
              "runAfter": {
                "Create_HTML_table_of_flows_for_admins": [
                  "Succeeded"
                ]
              },
              "expression": {
                "or": [
                  {
                    "greater": [
                      "@length(body('Filter_apps_to_admin_assigned'))",
                      0
                    ]
                  },
                  {
                    "greater": [
                      "@length(body('Filter_flows_to_admin_assigned'))",
                      0
                    ]
                  }
                ]
              },
              "metadata": {
                "operationMetadataId": "7d87763f-7d80-4060-9206-b0ded2737711"
              },
              "type": "If"
            },
            "Admin_Apps_reduced": {
              "runAfter": {
                "Filter_apps_to_admin_assigned": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "da69bc55-37ce-449d-8ddd-8f0d70475ea4"
              },
              "type": "Select",
              "inputs": {
                "from": "@body('Filter_apps_to_admin_assigned')",
                "select": {
                  "Environment": "@item()?['EnvtDisplayName']",
                  "||": "||",
                  "App": "@item()?['AppDisplayName']",
                  "|||": "|||",
                  "Previous Owner": "@if(equals(item()?['OwnerDisplayName'], null), 'unknown', item()?['OwnerDisplayName'])"
                }
              }
            },
            "Admin_Flows_reduced": {
              "runAfter": {
                "Filter_flows_to_admin_assigned": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c2c15460-bad2-408b-9ca0-8e7e9f84015b"
              },
              "type": "Select",
              "inputs": {
                "from": "@body('Filter_flows_to_admin_assigned')",
                "select": {
                  "Environment": "@item()?['EnvtDisplayName']",
                  "||": "||",
                  "Flow": "@item()?['FlowDisplayName']",
                  "|||": "|||",
                  "Previous Owner": "@if(equals(item()?['OwnerDisplayName'], null), 'unknown', item()?['OwnerDisplayName'])"
                }
              }
            }
          },
          "runAfter": {
            "Create_Arrays_of_Orphaned_Objects_with_Manager_Info": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0b86c991-814f-499f-a531-1480717d42c1"
          },
          "type": "Scope"
        },
        "Send_managers_teams_note_and_kick_off_child_flows": {
          "actions": {
            "Apply_to_each_Manager_with_Orphaned_Objects": {
              "foreach": "@variables('ManagersWithOrphans')",
              "actions": {
                "Run_a_Child_Flow": {
                  "runAfter": {
                    "Send_Intro_Card_to_Manager": [
                      "Succeeded",
                      "Failed"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "eb3ad526-c555-4d43-ae5d-c37e8252bcac"
                  },
                  "type": "Workflow",
                  "inputs": {
                    "host": {
                      "workflowReferenceName": "a405dd4c-78e5-eb11-bacb-000d3a8edeaa"
                    },
                    "body": {
                      "text": "@items('Apply_to_each_Manager_with_Orphaned_Objects')"
                    }
                  }
                },
                "Filter_apps_to_this_managers": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "c85239a8-f00a-4e44-aa57-6febd703fb8f"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_JSON_OrphanedApps')",
                    "where": "@equals(item()['Manager'], items('Apply_to_each_Manager_with_Orphaned_Objects'))"
                  }
                },
                "Filter_flows_to_this_managers": {
                  "runAfter": {
                    "Filter_apps_to_this_managers": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1fe4e6e3-8471-484d-9f83-c439c699e8cf"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@body('Parse_JSON_OrphanedFlows')",
                    "where": "@equals(item()['Manager'], items('Apply_to_each_Manager_with_Orphaned_Objects'))"
                  }
                },
                "Send_Intro_Card_to_Manager": {
                  "runAfter": {
                    "Filter_flows_to_this_managers": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "1c0e1b46-6823-4c9f-b025-1d6ea1d65130"
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_teams",
                      "operationId": "PostUserAdaptiveCard",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams"
                    },
                    "parameters": {
                      "PostAdaptiveCardRequest/recipient/to": "@{if(equals(parameters('ProductionEnvironment (admin_ProductionEnvironment)'), false), parameters('Individual Admin (admin_ApprovalAdmin)'), items('Apply_to_each_Manager_with_Orphaned_Objects'))};",
                      "PostAdaptiveCardRequest/messageBody": "{\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"type\": \"AdaptiveCard\",\n    \"version\": \"1.2\",\n    \"body\": [\n        {\n            \"type\": \"TextBlock\",\n            \"text\": \"Former employees of yours have left the company with Power Platform objects left behind. These require reassignment or deletion in order to keep our tenant tidy of objects. \",\n            \"wrap\": true,\n            \"weight\": \"Bolder\"\n        },\n        {\n            \"type\": \"TextBlock\",\n            \"text\": \"Note also that if these objects are important to your team, not having a current owner could lead to them breaking later due to many reasons. Ex expired connections or tenant changes that will not have an owner to notify. \",\n            \"wrap\": true,\n            \"weight\": \"Bolder\"\n        },\n        {\n            \"type\": \"ColumnSet\",\n            \"columns\": [\n                {\n                    \"type\": \"Column\",\n                    \"items\": [\n                        {\n                            \"type\": \"TextBlock\",\n                            \"weight\": \"bolder\",\n                            \"text\": \"Number of Orphaned Apps\"\n                        },\n                        {\n                            \"type\": \"TextBlock\",\n                            \"separator\": true,\n                            \"text\": \"@{length(body('Filter_apps_to_this_managers'))}\"\n                        }\n                    ],\n                    \"width\": \"stretch\"\n                },\n                {\n                    \"type\": \"Column\",\n                    \"items\": [\n                        {\n                            \"type\": \"TextBlock\",\n                            \"weight\": \"bolder\",\n                            \"text\": \"Number of Orphaned Flows\"\n                        },\n                        {\n                            \"type\": \"TextBlock\",\n                            \"separator\": true,\n                            \"text\": \"@{length(body('Filter_flows_to_this_managers'))}\"\n                        }\n                    ],\n                    \"width\": \"auto\"\n                }\n            ]\n        }\n    ]\n}",
                      "PostAdaptiveCardRequest/messageTitle": "Please reassign Power Platform objects"
                    },
                    "authentication": "@parameters('$authentication')",
                    "retryPolicy": {
                      "type": "exponential",
                      "count": 10,
                      "interval": "PT10S"
                    }
                  }
                },
                "check_if_succeeded": {
                  "actions": {
                    "Send_conclusion_message": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "643087d4-d360-4e33-89e8-dddf7f210790"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_teams",
                          "operationId": "PostUserNotification",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams"
                        },
                        "parameters": {
                          "PostNotificationRequest/recipient/to": "@{if(equals(parameters('ProductionEnvironment (admin_ProductionEnvironment)'), false), parameters('Individual Admin (admin_ApprovalAdmin)'), items('Apply_to_each_Manager_with_Orphaned_Objects'))};",
                          "PostNotificationRequest/messageBody": "Thank you for helping keep the tenant tidy. We will return with any remaining or new orphans to clean. ",
                          "PostNotificationRequest/messageTitle": "Thank you"
                        },
                        "authentication": "@parameters('$authentication')",
                        "retryPolicy": {
                          "type": "exponential",
                          "count": 10,
                          "interval": "PT10S"
                        }
                      }
                    }
                  },
                  "runAfter": {
                    "Run_a_Child_Flow": [
                      "Succeeded",
                      "TimedOut",
                      "Failed"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Append_current_manager_to_FailedForManagerList": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "58185590-f79c-4759-a303-1334c1b55757"
                        },
                        "type": "AppendToArrayVariable",
                        "inputs": {
                          "name": "FailedForManagerList",
                          "value": {
                            "Manager": "@items('Apply_to_each_Manager_with_Orphaned_Objects')"
                          }
                        }
                      }
                    }
                  },
                  "expression": {
                    "equals": [
                      "@body('Run_a_Child_Flow')?['success']",
                      200
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3aae2b9c-6463-44ce-b352-77d41e9e43b3"
                  },
                  "type": "If"
                }
              },
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "a043ddc1-5869-417c-a220-f30154228792"
              },
              "type": "Foreach",
              "runtimeConfiguration": {
                "concurrency": {
                  "repetitions": 50
                }
              }
            }
          },
          "runAfter": {
            "Send_items_without_managers_to_admins": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "b2aafeaf-f41e-41b5-823f-35461392d778"
          },
          "type": "Scope"
        },
        "Initialize_FailedForManagerList": {
          "runAfter": {
            "Initialize_SendToAdmin": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "84381b15-10fe-491b-b191-dddcf88456ee"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "FailedForManagerList",
                "type": "array"
              }
            ]
          }
        },
        "Send_list_of_managers_that_ignored_request_to_admin_": {
          "actions": {
            "Create_HTML_table_of_Ignoring_Managers": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "3a19417a-055c-42b7-9059-9ff092552138"
              },
              "type": "Table",
              "inputs": {
                "from": "@variables('FailedForManagerList')",
                "format": "HTML"
              }
            },
            "Send_list_of_ignoring_managers_to_admin": {
              "runAfter": {
                "Create_HTML_table_of_Ignoring_Managers": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "c55a326d-f8b8-4d11-8854-fcb833527ab8"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_office365",
                  "operationId": "SendEmailV2",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365"
                },
                "parameters": {
                  "emailMessage/To": "@variables('AdminEmail')",
                  "emailMessage/Subject": "Orphaned Power Platform objects - managers who ignored requests to clean",
                  "emailMessage/Body": "<p>Hello, there are Power Platform objects in your tenant who's owner has left the company and so they are orphaned.<br>\n<br>\nWe have sent these to the former manager for those that are known, but these managers did not respond to the request to clean.<br>\n<br>\nIf you see them persistenty ignoring the request you may need to reach out in some other manner.<br>\n<br>\n@{body('Create_HTML_table_of_Ignoring_Managers')}</p>"
                },
                "authentication": "@parameters('$authentication')"
              }
            }
          },
          "runAfter": {
            "Send_managers_teams_note_and_kick_off_child_flows": [
              "Succeeded"
            ]
          },
          "else": {
            "actions": {
              "Terminate_Success": {
                "runAfter": {},
                "metadata": {
                  "operationMetadataId": "c10e082b-207f-41d7-a30d-32af5ac4130f"
                },
                "type": "Terminate",
                "inputs": {
                  "runStatus": "Succeeded"
                }
              }
            }
          },
          "expression": {
            "greater": [
              "@length(variables('FailedForManagerList'))",
              0
            ]
          },
          "metadata": {
            "operationMetadataId": "8948d984-2cc0-4b59-86f8-2d6cbcb7f142"
          },
          "type": "If"
        }
      },
      "outputs": {}
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}